<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Detalhes Equipamentos Sala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">`n    <script src="static/js/demo-banner.js"></script>
    <link rel="icon" type="image/png" href="static/img/favicon-lupa.png">
    <script>
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
        // Atualizar logo da empresa quando o tema mudar
        updateEmpresaLogo();
      }
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
</head>
<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
    <div class="relative w-full max-w-6xl mx-auto bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-8 mt-8">
        <button onclick="window.history.back()" class="absolute top-4 left-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-2 transition-colors" title="Voltar">
            <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="empresa-logada" class="absolute top-4 right-4 text-indigo-500 font-bold bg-gray-800 dark:bg-transparent rounded-lg p-2"></div>
        <button onclick="toggleDarkMode()" class="absolute top-4 left-16 bg-gray-200 dark:bg-gray-700 rounded-full p-2 transition-colors" title="Alternar modo escuro">
            <span class="dark:hidden">🌙</span><span class="hidden dark:inline">☀️</span>
        </button>
        <div class="text-center mt-8 mb-8">
            <div class="text-center mt-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4" id="equipSalaTopo">
                <i class="fas fa-cogs text-indigo-600 dark:text-indigo-400 mr-3"></i>
                Sala
            </h1>
            <p class="text-gray-600 dark:text-gray-300">Equipamentos da sala selecionada</p>
        </div>
        </div>
        <div class="flex justify-end gap-2 mb-4">
            <button id="btnAddEquipSala" style="display:none" class="px-3 py-1.5 rounded-full border border-gray-300/60 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-200 bg-gray-100/60 dark:bg-gray-800/60 hover:bg-green-50 dark:hover:bg-green-900 hover:text-green-700 dark:hover:text-green-300 transition-colors flex items-center gap-2" title="Adicionar equipamento novo nesta sala">
                <i class="fas fa-plus"></i>
                <span>Novo</span>
            </button>
            <button id="btnVincularEstoque" style="display:none" class="px-3 py-1.5 rounded-full border border-gray-300/60 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-200 bg-gray-100/60 dark:bg-gray-800/60 hover:bg-teal-50 dark:hover:bg-teal-900 hover:text-teal-700 dark:hover:text-teal-300 transition-colors flex items-center gap-2" title="Vincular equipamento do estoque (sem sala)">
                <i class="fas fa-plug"></i>
                <span>Do estoque</span>
            </button>
        </div>
        <div id="equipamentosSalaContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>
    <!-- Modal Vincular do Estoque -->
    <div id="modalEstoque" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;" class="flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-900 rounded-xl shadow-2xl w-full max-w-3xl max-h-[85vh] overflow-hidden flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">Vincular equipamentos do estoque</h3>
                <button id="fecharModalEstoque" class="px-3 py-1.5 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600">Fechar</button>
            </div>
            <div class="p-4 flex items-center gap-2">
                <input id="buscaEstoque" type="text" placeholder="Buscar por nome, tipo, marca, modelo, série..." class="flex-1 px-3 py-2 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100">
                <button id="atualizarEstoque" class="px-3 py-2 rounded bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-200">Atualizar</button>
            </div>
            <div id="listaEstoque" class="p-4 overflow-auto flex-1"></div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
                <button id="cancelarVinculoEstoque" class="px-4 py-2 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600">Cancelar</button>
                <button id="confirmarVinculoEstoque" class="px-4 py-2 rounded bg-teal-600 hover:bg-teal-700 text-white">Vincular selecionados</button>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Novo Equipamento -->
    <div id="modalAdd" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;" class="flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-900 rounded-xl shadow-2xl w-full max-w-3xl max-h-[85vh] overflow-auto">
            <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">Adicionar equipamento (novo)</h3>
                <button id="fecharModalAdd" class="px-3 py-1.5 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600">Fechar</button>
            </div>
            <form id="formAdd" class="p-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="sm:col-span-2"><label class="block text-sm mb-1 text-gray-700 dark:text-white">Nome</label><input id="add-nome" type="text" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100" required></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">Tipo</label><select id="add-tipo" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100"><option value="">Selecione...</option></select></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">Marca</label><select id="add-marca" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100"><option value="">Selecione o tipo primeiro</option></select></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">Modelo</label><select id="add-modelo" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100"><option value="">Selecione a marca primeiro</option></select></div>
                <div class="sm:col-span-2"><label class="block text-sm mb-1 text-gray-700 dark:text-white">Descrição</label><input id="add-descricao" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">Part Number</label><input id="add-partnumber" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">Tamanho</label><input id="add-tamanho" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">Firmware</label><input id="add-firmware" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">Série</label><input id="add-serie" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">IP 1</label><input id="add-ip1" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">MAC 1</label><input id="add-mac1" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">IP 2</label><input id="add-ip2" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">MAC 2</label><input id="add-mac2" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div class="sm:col-span-2 flex justify-end gap-2 pt-2">
                    <button type="button" id="cancelarAdd" class="px-4 py-2 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-white">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar Equipamento -->
    <div id="modalEdit" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;" class="flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-900 rounded-xl shadow-2xl w-full max-w-3xl max-h-[85vh] overflow-auto">
            <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">Editar equipamento</h3>
                <button id="fecharModalEdit" class="px-3 py-1.5 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600">Fechar</button>
            </div>
            <form id="formEdit" class="p-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="sm:col-span-2"><label class="block text-sm mb-1 text-gray-700 dark:text-white">Nome</label><input id="edit-nome" type="text" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100" required></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">Tipo</label><select id="edit-tipo" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100"><option value="">Selecione...</option></select></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">Marca</label><select id="edit-marca" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100"><option value="">Selecione o tipo primeiro</option></select></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">Modelo</label><select id="edit-modelo" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100"><option value="">Selecione a marca primeiro</option></select></div>
                <div class="sm:col-span-2"><label class="block text-sm mb-1 text-gray-700 dark:text-white">Descrição</label><input id="edit-descricao" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">Part Number</label><input id="edit-partnumber" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">Tamanho</label><input id="edit-tamanho" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">Firmware</label><input id="edit-firmware" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">Série</label><input id="edit-serie" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">IP 1</label><input id="edit-ip1" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">MAC 1</label><input id="edit-mac1" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">IP 2</label><input id="edit-ip2" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div><label class="block text-sm mb-1 text-gray-700 dark:text-white">MAC 2</label><input id="edit-mac2" type="text" class="w-full px-3 py-2 rounded border"></div>
                <div class="sm:col-span-2 flex justify-end gap-2 pt-2">
                    <button type="button" id="cancelarEdit" class="px-4 py-2 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-700 text-white">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Excluir Equipamento -->
    <div id="modalDel" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;" class="flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-900 rounded-xl shadow-2xl w-full max-w-lg">
            <div class="p-5">
                <div class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-3">Confirmar exclusão</div>
                <div class="text-sm text-gray-700 dark:text-gray-300">Tem certeza que deseja excluir este equipamento? Esta ação não pode ser desfeita.</div>
                <div class="flex justify-end gap-2 mt-6">
                    <button id="cancelarDel" class="px-4 py-2 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100">Cancelar</button>
                    <button id="confirmarDel" class="px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Enviar para Estoque -->
    <div id="modalEstoqueEquip" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;" class="flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-900 rounded-xl shadow-2xl w-full max-w-lg">
            <div class="p-5">
                <div class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-3">
                    <i class="fas fa-box text-orange-500 mr-2"></i>
                    Enviar para Estoque
                </div>
                <div class="text-sm text-gray-700 dark:text-gray-300 mb-4">
                    Tem certeza que deseja enviar este equipamento para o estoque?
                </div>
                <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-700 rounded-lg p-3 mb-4">
                    <div class="text-sm text-orange-800 dark:text-orange-200 font-medium mb-2">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        Atenção: Esta ação irá:
                    </div>
                    <ul class="text-xs text-orange-700 dark:text-orange-300 space-y-1 ml-4">
                        <li>• Remover o equipamento desta sala</li>
                        <li>• Desfazer todas as conexões com cabos</li>
                        <li>• Desfazer conexões com switches</li>
                        <li>• Desfazer conexões com patch panels</li>
                    </ul>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button id="cancelarEstoqueEquip" class="px-4 py-2 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100">Cancelar</button>
                    <button id="confirmarEstoqueEquip" class="px-4 py-2 rounded bg-orange-600 hover:bg-orange-700 text-white">
                        <i class="fas fa-box mr-1"></i>
                        Enviar para Estoque
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script src="static/js/logo-manager.js"></script>
    <script>
    // Listas locais de apoio (mesmas usadas nas outras telas)
    const marcasPorTipo = {
        Projetor: ["Epson", "Outro"],
        TV: ["LG", "Sony", "Outro"],
        Tap: ["Logitech", "Outro"],
        Microfone: ["Shure", "Logitech", "Jabra", "Outro"],
        Speaker: ["JBL", "Shure", "Logitech", "Outro"],
        Camera: ["Logitech", "Huddly", "Yealink", "Jabra", "Outro"],
        Meetup: ["Logitech", "Outro"],
        Painel: ["Crestron", "Outro"],
        Sensor: ["Crestron", "Outro"],
        PC: ["CTL", "Asus", "BlueTech", "Outro"],
        Hub: ["Logitech", "Outro"],
        Clickshare: ["Barco", "Outro"],
        AVIO: ["Dante", "Outro"],
        Extensores: ["Extron", "Kramer", "Outro"],
        Dongle: ["Logitech", "Outro"],
        "Tela Led": ["LG", "Leyard", "Outro"],
        Switcher: ["Kramer", "Extron", "RGBlink", "Outro"],
        Serial: ["Controlart", "Outro"],
        Antena: ["Shure", "Outro"],
        Mixer: ["Shure", "Outro"],
        Amplificador: ["QSC", "Outro"],
        Receptor: ["Shure", "Outro"],
        Poe: ["Logitech", "Outro"],
        Adaptador: ["Kramer", "Generico", "Outro"],
        Fonte: ["Logitech", "Universal", "Outro"],
        Controladora: ["LG", "Leyard", "Nova Star", "Outro"],
        Splitter: ["Logitech", "Outro"],
        Outro: ["Outro"]
    };
    const modelosPorTipoMarca = {
        Projetor: { Epson: ["PowerLite X41+", "Outro"], Outro: ["Outro"] },
        TV: {
            LG: ["32LM621CBSB", "50UP751C0SF", "55UN731C0SC", "75UN801C0SB", "75UP801C0SB", "82UN8000PSB", "50UL3G-BJ", "43UN731C0SC", "50UN731C0SC", "32SM5KE-BJ", "Outro"],
            Sony: ["Bravia", "Outro"],
            Outro: ["Outro"]
        },
        "Tela Led": { LG: ["LG", "Outro"], Leyard: ["MGS Series", "Outro"], Outro: ["Outro"] },
        Tap: { Logitech: ["Tap Poe", "Tap USB", "Outro"], Outro: ["Outro"] },
        Microfone: { Shure: ["MXA710", "MXA910", "MXA920", "SM58", "BLX1", "Outro"], Logitech: ["Rally Mic Pod", "Outro"], Jabra: ["Jabra Speak", "Outro"], Outro: ["Outro"] },
        Speaker: { JBL: ["JBL CBT 1000E", "Outro"], Logitech: ["Rally", "Outro"], Shure: ["MXN5W-C", "Outro"], Outro: ["Outro"] },
        Camera: { Logitech: ["Rally", "Outro"], Huddly: ["Huddly Go", "Outro"], Yealink: ["Yealink W52P", "Outro"], Jabra: ["Panacast", "Outro"], Outro: ["Outro"] },
        Meetup: { Logitech: ["Meetup", "Outro"], Outro: ["Outro"] },
        Painel: { Crestron: ["TSW-770-B-S", "TSW-770-W-S", "Outro"], Outro: ["Outro"] },
        Sensor: { Crestron: ["CEN-ODT-C-POE", "Outro"], Outro: ["Outro"] },
        PC: { CTL: ["CTL-1000", "Outro"], Asus: ["Asus", "Outro"], BlueTech: ["BlueTech", "Outro"], Outro: ["Outro"] },
        Hub: { Logitech: ["Display", "Table", "Mic Pod", "Outro"], Outro: ["Outro"] },
        Clickshare: { Barco: ["C5", "C10", "CSE-200", "Outro"], Outro: ["Outro"] },
        AVIO: { Dante: ["2CH USB IO Adapter", "2CH Analog Output Adapter", "1CH Analog Input Adapter", "1CH Analog Output Adapter", "2CH Analog Input Adapter", "Outro"], Outro: ["Outro"] },
        Extensores: { Extron: ["DTP HDMI 230 Tx", "USB EXTENDER Plus T", "USB EXTENDER Plus R", "Outro"], Kramer: ["PT571", "Outro"], Outro: ["Outro"] },
        Dongle: { Logitech: ["Logitech", "Outro"], Outro: ["Outro"] },
        Switcher: { Kramer: ["VP-440X", "Outro"], Extron: ["SW2 USB", "Outro"], RGBlink: ["X1PRO-E", "Outro"], Outro: ["Outro"] },
        Serial: { Controlart: ["rs-232"] },
        Antena: { Shure: ["UA864", "Outro"], Outro: ["Outro"] },
        Mixer: { Shure: ["ANI22", "Outro"], Outro: ["Outro"] },
        Amplificador: { QSC: ["DPA4.2Q", "Outro"], Outro: ["Outro"] },
        Receptor: { Shure: ["ULXD4Q", "Outro"], Outro: ["Outro"] },
        Poe: { Logitech: ["KIT CAT5E", "Outro"], Outro: ["Outro"] },
        Adaptador: { Kramer: ["HDMI F to HDMI F", "Outro"], Generico: ["USBA to HDMI", "Outro"], Outro: ["USBA F to USBA F", "Outro"] },
        Fonte: { Logitech: ["TAP", "Table Hub", "Display Hub", "Meetup", "Rally Camera", "Outro"], Universal: ["Chromebox", "Outro"], Outro: ["Outro"] },
        Controladora: { LG: ["xxxxx", "Outro"], Leyard: ["SM700-1", "Outro"], "Nova Star": ["MCTRL700", "Outro"], Outro: ["Outro"] },
        Splitter: { Logitech: ["Rally Camera Power Splitter", "Outro"], Outro: ["Outro"] },
        Outro: { Outro: ["Outro"] }
    };

    function preencherTiposSelect(selectEl, valor) {
        // Lista hardcoded igual à tela adicionar-equipamento.html
        const tipos = [
            'Projetor', 'TV', 'Tela Led', 'Tap', 'Microfone', 'Speaker', 'Camera', 
            'Meetup', 'Painel', 'Sensor', 'PC', 'Hub', 'Clickshare', 'AVIO', 
            'Extensores', 'Dongle', 'Switcher', 'Serial', 'Antena', 'Mixer', 
            'Amplificador', 'Receptor', 'Poe', 'Adaptador', 'Fonte', 'Controladora', 
            'Splitter', 'Outro'
        ];
        
        selectEl.innerHTML = '<option value="">Selecione...</option>';
        
        tipos.forEach(tipo => {
            const opt = document.createElement('option');
            opt.value = tipo;
            opt.textContent = tipo;
            selectEl.appendChild(opt);
        });
        
        if (valor) selectEl.value = valor;
    }
    async function preencherMarcasSelect(tipo, selectEl, valor) {
        try {
            const resp = await fetch(`/marcas-equipamento?tipo=${encodeURIComponent(tipo)}`);
            const marcas = await resp.json();
            selectEl.innerHTML = '<option value="">Selecione...</option>';
            // Priorizar dados locais se disponíveis, senão usar API
            const opcoes = (marcasPorTipo[tipo] && marcasPorTipo[tipo].length > 0) ? marcasPorTipo[tipo] : (marcas && marcas.length > 0 ? marcas : []);
            opcoes.forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.textContent = m; selectEl.appendChild(opt); });
            if (valor) selectEl.value = valor;
        } catch {
            selectEl.innerHTML = '<option value="">Selecione...</option>';
            (marcasPorTipo[tipo] || []).forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.textContent = m; selectEl.appendChild(opt); });
            if (valor) selectEl.value = valor;
        }
    }
    async function preencherModelosSelect(tipo, marca, selectEl, valor) {
        try {
            const resp = await fetch(`/modelos-equipamento?tipo=${encodeURIComponent(tipo)}&marca=${encodeURIComponent(marca)}`);
            const modelos = await resp.json();
            selectEl.innerHTML = '<option value="">Selecione...</option>';
            
            // Combinar modelos da API com modelos locais
            let todosModelos = [];
            
            // Adiciona modelos da API
            if (modelos && Array.isArray(modelos)) {
                todosModelos = todosModelos.concat(modelos.filter(m => m && m.trim() !== ''));
            }
            
            // Adiciona modelos locais se disponíveis
            if (modelosPorTipoMarca[tipo] && modelosPorTipoMarca[tipo][marca]) {
                modelosPorTipoMarca[tipo][marca].forEach(modelo => {
                    if (!todosModelos.includes(modelo)) {
                        todosModelos.push(modelo);
                    }
                });
            }
            
            // Ordenar alfabeticamente
            todosModelos.sort((a, b) => a.localeCompare(b, 'pt-BR'));
            
            // Adicionar opções ordenadas
            todosModelos.forEach(m => { 
                const opt = document.createElement('option'); 
                opt.value = m; 
                opt.textContent = m; 
                selectEl.appendChild(opt); 
            });
            
            if (valor) selectEl.value = valor;
        } catch {
            selectEl.innerHTML = '<option value="">Selecione...</option>';
            
            // Fallback: usar apenas modelos locais ordenados
            const modelosLocais = (modelosPorTipoMarca[tipo] && modelosPorTipoMarca[tipo][marca] ? modelosPorTipoMarca[tipo][marca] : []);
            modelosLocais.sort((a, b) => a.localeCompare(b, 'pt-BR')).forEach(m => { 
                const opt = document.createElement('option'); 
                opt.value = m; 
                opt.textContent = m; 
                selectEl.appendChild(opt); 
            });
            
            if (valor) selectEl.value = valor;
        }
    }
    let perfilNivel = null;
    let currentSalaId = null;
    let equipamentosSalaAtuais = [];
    async function carregarEquipamentosSala() {
        const params = new URLSearchParams(window.location.search);
        const salaId = params.get('id');
        currentSalaId = salaId;
        if (!salaId) return;
        // Busca dados da sala
        let salaNome = '';
        const respSala = await fetch(`/salas/${salaId}`);
        if (respSala.ok) {
            const sala = await respSala.json();
            salaNome = sala.nome;
        }
        document.getElementById('equipSalaTopo').innerText = salaNome || 'Sala';
        // Busca equipamentos da sala
        const respEq = await fetch(`/equipamentos?sala_id=${salaId}`);
        const equipamentos = await respEq.json();
        equipamentosSalaAtuais = equipamentos.map(e => String(e.id));
        // Busca conexões ativas
        const respCon = await fetch('/conexoes');
        const conexoes = await respCon.json();
        const container = document.getElementById('equipamentosSalaContainer');
        // Limpa antes de renderizar novamente para refletir mudanças imediatamente
        container.innerHTML = '';
        if (equipamentos.length === 0) {
            container.innerHTML = '<div class="col-span-full text-center text-gray-500 dark:text-gray-400 text-lg italic">Nenhum equipamento vinculado a esta sala.</div>';
            return;
        }
        equipamentos.forEach(eq => {
            let iconesHtml = '';
            if (eq.modelo) iconesHtml += `<div class='flex flex-col items-center text-gray-600 dark:text-gray-400 text-sm'><i class='fas fa-cube text-lg mb-1'></i><span class='text-center'>${eq.modelo}</span></div>`;
            if (eq.dados && eq.dados.serie) iconesHtml += `<div class='flex flex-col items-center text-gray-600 dark:text-gray-400 text-sm'><i class='fas fa-barcode text-lg mb-1'></i><span class='text-center'>${eq.dados.serie}</span></div>`;
            if (eq.dados && eq.dados.firmware) iconesHtml += `<div class='flex flex-col items-center text-gray-600 dark:text-gray-400 text-sm'><i class='fas fa-microchip text-lg mb-1'></i><span class='text-center'>${eq.dados.firmware}</span></div>`;
            if (eq.dados && eq.dados.partnumber) iconesHtml += `<div class='flex flex-col items-center text-gray-600 dark:text-gray-400 text-sm'><i class='fas fa-hashtag text-lg mb-1'></i><span class='text-center'>${eq.dados.partnumber}</span></div>`;
            if (eq.dados && eq.dados.tamanho) iconesHtml += `<div class='flex flex-col items-center text-gray-600 dark:text-gray-400 text-sm'><i class='fas fa-ruler-combined text-lg mb-1'></i><span class='text-center'>${eq.dados.tamanho}</span></div>`;
            if (eq.icone) iconesHtml += `<div class='flex flex-col items-center text-gray-600 dark:text-gray-400 text-sm'><img src='${eq.icone.startsWith('img/') ? 'static/' + eq.icone : eq.icone}' alt='Ícone' class='w-6 h-6 mb-1'></div>`;
            // Pares de IP/MAC ocupando linha inteira
            let redePairedHtml = '';
            if (eq.dados && (eq.dados.ip1 || eq.dados.mac1)) {
                redePairedHtml += `<div class='col-span-2 flex items-center justify-center gap-4 text-gray-600 dark:text-gray-400 text-sm'>
                    ${eq.dados.ip1 ? `<span class='flex items-center gap-1'><i class='fas fa-network-wired text-lg'></i><span>${eq.dados.ip1}</span></span>` : ''}
                    ${eq.dados.mac1 ? `<span class='flex items-center gap-1'><i class='fas fa-ethernet text-lg'></i><span class='mac'>${eq.dados.mac1}</span></span>` : ''}
                </div>`;
            }
            if (eq.dados && (eq.dados.ip2 || eq.dados.mac2)) {
                redePairedHtml += `<div class='col-span-2 flex items-center justify-center gap-4 text-gray-600 dark:text-gray-400 text-sm'>
                    ${(eq.dados.ip2 && eq.dados.mac2) ? `<img src='static/img/dante.png' alt='Dante' title='Dante' class='w-8 h-8 mr-2' style='display:inline-block;vertical-align:middle;'>` : ''}
                    ${eq.dados.ip2 ? `<span class='flex items-center gap-1'><i class='fas fa-network-wired text-lg'></i><span>${eq.dados.ip2}</span></span>` : ''}
                    ${eq.dados.mac2 ? `<span class='flex items-center gap-1'><i class='fas fa-ethernet text-lg'></i><span class='mac'>${eq.dados.mac2}</span></span>` : ''}
                </div>`;
            }
            // Busca conexão deste equipamento
            const conexao = conexoes.find(c => c.equipamento_id === eq.id && c.status === 'ativa');
            let redeHtml = '';
            if (conexao && conexao.switch && conexao.porta) {
                redeHtml = `<div class='flex items-center justify-center gap-2 text-gray-600 dark:text-gray-400 text-sm mt-2'><i class='fas fa-network-wired'></i> <span class='font-semibold'>Switch:</span> ${conexao.switch} <span class='font-semibold'>Porta:</span> ${conexao.porta}</div>`;
            }
            // Adiciona ícone de rede se tiver ip ou mac
            const temRede = (eq.dados && (eq.dados.ip1 || eq.dados.ip2 || eq.dados.mac1 || eq.dados.mac2));
            const mostrarAcoes = (perfilNivel === 'admin' || perfilNivel === 'tecnico');
            let acoesHtml = '';
            if (mostrarAcoes) {
                acoesHtml = `
                    <div class='mt-3 w-full flex justify-end gap-2'>
                        <button class=\"px-3 py-1.5 rounded-full border border-gray-300/60 dark:border-gray-600 text-xs text-gray-700 dark:text-gray-200 bg-gray-100/60 dark:bg-gray-800/60 hover:bg-indigo-50 dark:hover:bg-indigo-900 hover:text-indigo-700 dark:hover:text-indigo-300 transition-colors flex items-center gap-2\" title=\"Editar equipamento\" onclick=\"abrirModalEditar(${eq.id})\">
                            <i class="fas fa-pen"></i>
                            <span>Editar</span>
                        </button>
                        <button class=\"px-3 py-1.5 rounded-full border border-orange-200 dark:border-orange-700 text-xs text-orange-600 dark:text-orange-300 bg-orange-50/70 dark:bg-orange-900/20 hover:bg-orange-100 dark:hover:bg-orange-900/40 transition-colors flex items-center gap-2\" title=\"Enviar equipamento para o estoque (desfaz todas as conexões)\" onclick=\"abrirModalEnviarEstoque(${eq.id})\">
                            <i class="fas fa-box"></i>
                            <span>Estoque</span>
                        </button>
                        <button class=\"px-3 py-1.5 rounded-full border border-red-200 dark:border-red-700 text-xs text-red-600 dark:text-red-300 bg-red-50/70 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors flex items-center gap-2\" title=\"Excluir equipamento\" onclick=\"abrirModalExcluir(${eq.id})\">
                            <i class="fas fa-trash"></i>
                            <span>Excluir</span>
                        </button>
                    </div>
                `;
            }
            container.innerHTML += `
                <div class='bg-gray-100 dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center relative'>
                    ${temRede ? `<i class='fas fa-network-wired absolute top-3 right-3 text-green-500 text-lg bg-white dark:bg-gray-700 rounded-md p-1 shadow-md' title='Necessita de rede'></i>` : ''}
                    ${(eq.marca ? LogoManager.renderMarcaLogo(eq.marca) : '')}
                    <div class='text-xl font-bold text-gray-800 dark:text-white text-center mb-4'>${eq.nome || 'Equipamento'}</div>
                    <div class='flex justify-center mb-4'>${eq.foto ? `<img src='${eq.foto.startsWith('img/') ? 'static/' + eq.foto : eq.foto}' alt='${eq.nome}' class='w-32 h-20 object-contain rounded-lg'>` : ''}</div>
                                         <div class='flex gap-4 justify-center mb-4 text-yellow-600 dark:text-yellow-400 text-sm font-semibold border-b border-gray-300 dark:border-gray-600 pb-2'>
                         <div><span class='font-bold'>Tipo:</span> ${eq.tipo || '-'}</div>
                         <div><span class='font-bold'>Série:</span> ${(eq.dados && eq.dados.serie) ? eq.dados.serie : '-'}</div>
                     </div>
                     ${eq.descricao ? `<div class='text-center mb-4 text-gray-600 dark:text-gray-400 text-sm italic border-l-4 border-gray-300 dark:border-gray-600 pl-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-r-lg'>${eq.descricao}</div>` : ''}
                    <div class='grid grid-cols-2 gap-4 mb-4'>${iconesHtml}${redePairedHtml}</div>
                    ${redeHtml}
                    ${acoesHtml}
                </div>
            `;
        });
    }
    // Buscar perfil antes de carregar os equipamentos, para controlar a visibilidade dos botões e o botão de adicionar
    window.addEventListener('DOMContentLoaded', function() {
        fetch('/perfil')
            .then(resp => resp.json())
            .then(perfil => {
                perfilNivel = perfil && perfil.nivel ? perfil.nivel : null;
                const btnAdd = document.getElementById('btnAddEquipSala');
                const btnEstoque = document.getElementById('btnVincularEstoque');
                if (perfilNivel === 'admin' || perfilNivel === 'tecnico') {
                    btnAdd.style.display = 'inline-flex';
                    btnEstoque.style.display = 'inline-flex';
                }
                btnAdd.onclick = function() { abrirModalAdd(); };
                btnEstoque.onclick = function() {
                    abrirModalEstoque();
                };
                carregarEquipamentosSala();
                // Inicializa selects do modal Add
                preencherTiposSelect(document.getElementById('add-tipo'));
                document.getElementById('add-tipo').addEventListener('focus', function(){ preencherTiposSelect(this); });
                document.getElementById('add-tipo').addEventListener('change', function(){
                    preencherMarcasSelect(this.value, document.getElementById('add-marca'));
                    document.getElementById('add-modelo').innerHTML = '<option value="">Selecione a marca primeiro</option>';
                });
                document.getElementById('add-marca').addEventListener('change', function(){
                    const tipo = document.getElementById('add-tipo').value;
                    preencherModelosSelect(tipo, this.value, document.getElementById('add-modelo'));
                });
                // Inicializa selects do modal Edit
                preencherTiposSelect(document.getElementById('edit-tipo'));
                document.getElementById('edit-tipo').addEventListener('focus', function(){ preencherTiposSelect(this); });
                document.getElementById('edit-tipo').addEventListener('change', function(){
                    preencherMarcasSelect(this.value, document.getElementById('edit-marca'));
                    document.getElementById('edit-modelo').innerHTML = '<option value="">Selecione a marca primeiro</option>';
                });
                document.getElementById('edit-marca').addEventListener('change', function(){
                    const tipo = document.getElementById('edit-tipo').value;
                    preencherModelosSelect(tipo, this.value, document.getElementById('edit-modelo'));
                });
            })
            .catch(() => carregarEquipamentosSala());
    });

    // --- Modal Estoque ---
    async function abrirModalEstoque() {
        const modal = document.getElementById('modalEstoque');
        modal.style.display = 'flex';
        await carregarListaEstoque();
    }
    function fecharModalEstoque() {
        document.getElementById('modalEstoque').style.display = 'none';
    }
    async function carregarListaEstoque() {
        const listaDiv = document.getElementById('listaEstoque');
        listaDiv.innerHTML = '<div class="text-gray-500 dark:text-gray-400">Carregando...</div>';
        const resp = await fetch(`/equipamentos-disponiveis?t=${Date.now()}`);
        let estoque = await resp.json();
        // Filtrar equipamentos do tipo "Ponto Usuário" (filtro adicional no frontend)
        estoque = estoque.filter(e => {
            const tipo = (e.tipo || '').toLowerCase();
            const nome = (e.nome || '').toLowerCase();
            return !tipo.includes('ponto') && !nome.includes('ponto usuário') && !nome.includes('ponto usuario');
        });
        const termo = document.getElementById('buscaEstoque').value.trim().toLowerCase();
        if (termo) {
            estoque = estoque.filter(e => (
                (e.nome || '').toLowerCase().includes(termo) ||
                (e.tipo || '').toLowerCase().includes(termo) ||
                (e.marca || '').toLowerCase().includes(termo) ||
                (e.modelo || '').toLowerCase().includes(termo) ||
                (e.dados?.serie || '').toLowerCase().includes(termo)
            ));
        }
        if (estoque.length === 0) {
            listaDiv.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-8">Nenhum equipamento disponível no estoque.</div>';
            return;
        }
        let html = '<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">';
        estoque.forEach(e => {
            html += `
                <label class='flex gap-3 items-center p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800'>
                    <input type='checkbox' class='cb-estoque' value='${e.id}'>
                    <div class='flex-1'>
                        <div class='font-semibold text-gray-800 dark:text-gray-100'>${e.nome || ''}</div>
                        <div class='text-sm text-gray-600 dark:text-gray-300'>${e.tipo || ''} ${e.marca || ''} ${e.modelo || ''}</div>
                        ${e.dados?.serie ? `<div class='text-xs text-gray-500 dark:text-gray-400'>Série: ${e.dados.serie}</div>` : ''}
                    </div>
                </label>
            `;
        });
        html += '</div>';
        listaDiv.innerHTML = html;
    }
    async function confirmarVinculoEstoque() {
        if (!currentSalaId) return;
        // Coleta selecionados
        const selecionados = Array.from(document.querySelectorAll('#listaEstoque .cb-estoque:checked')).map(cb => String(cb.value));
        if (selecionados.length === 0) { fecharModalEstoque(); return; }
        // Busca dados atuais da sala
        const respSala = await fetch(`/salas/${currentSalaId}`);
        if (!respSala.ok) { fecharModalEstoque(); return; }
        const sala = await respSala.json();
        const equipamentos_ids = Array.from(new Set([...(equipamentosSalaAtuais || []), ...selecionados]));
        const body = {
            nome: sala.nome,
            tipo: sala.tipo,
            descricao: sala.descricao,
            foto: sala.foto,
            fotos: sala.fotos,
            andar_id: sala.andar_id,
            equipamentos_ids
        };
        const respPut = await fetch(`/salas/${currentSalaId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        if (respPut.ok) {
            fecharModalEstoque();
            carregarEquipamentosSala();
        } else {
            alert('Não foi possível vincular equipamentos (verifique permissões).');
        }
    }
    // Eventos do modal
    document.addEventListener('DOMContentLoaded', function() {
        const fechar = document.getElementById('fecharModalEstoque');
        const cancelar = document.getElementById('cancelarVinculoEstoque');
        const confirmar = document.getElementById('confirmarVinculoEstoque');
        const atualizar = document.getElementById('atualizarEstoque');
        const busca = document.getElementById('buscaEstoque');
        if (fechar) fechar.onclick = fecharModalEstoque;
        if (cancelar) cancelar.onclick = fecharModalEstoque;
        if (confirmar) confirmar.onclick = confirmarVinculoEstoque;
        if (atualizar) atualizar.onclick = carregarListaEstoque;
        if (busca) busca.addEventListener('input', carregarListaEstoque);
        // Add modal events
        const modalAdd = document.getElementById('modalAdd');
        const fecharAdd = document.getElementById('fecharModalAdd');
        const cancelarAdd = document.getElementById('cancelarAdd');
        const formAdd = document.getElementById('formAdd');
        if (fecharAdd) fecharAdd.onclick = () => {
            modalAdd.style.display = 'none';
            limparFormularioAdd();
        };
        if (cancelarAdd) cancelarAdd.onclick = () => {
            modalAdd.style.display = 'none';
            limparFormularioAdd();
        };
        if (formAdd) formAdd.onsubmit = async function(e) {
            e.preventDefault();
            console.log('Formulário submetido, currentSalaId:', currentSalaId);
            
            // Validação dos campos obrigatórios
            const nome = document.getElementById('add-nome').value.trim();
            const tipo = document.getElementById('add-tipo').value.trim();
            const marca = document.getElementById('add-marca').value.trim();
            const modelo = document.getElementById('add-modelo').value.trim();
            
            if (!nome) {
                alert('Nome é obrigatório!');
                return;
            }
            if (!tipo) {
                alert('Tipo é obrigatório!');
                return;
            }
            if (!marca) {
                alert('Marca é obrigatória!');
                return;
            }
            if (!modelo) {
                alert('Modelo é obrigatório!');
                return;
            }
            
            if (!currentSalaId) {
                alert('ID da sala não encontrado!');
                return;
            }
            
            const payload = {
                nome: nome,
                tipo: tipo,
                marca: marca,
                modelo: modelo,
                descricao: document.getElementById('add-descricao').value.trim(),
                sala_id: parseInt(currentSalaId),
                dados: {
                    partnumber: document.getElementById('add-partnumber').value.trim(),
                    tamanho: document.getElementById('add-tamanho').value.trim(),
                    firmware: document.getElementById('add-firmware').value.trim(),
                    serie: document.getElementById('add-serie').value.trim(),
                    ip1: document.getElementById('add-ip1').value.trim(),
                    mac1: document.getElementById('add-mac1').value.trim(),
                    ip2: document.getElementById('add-ip2').value.trim(),
                    mac2: document.getElementById('add-mac2').value.trim()
                }
            };
            
            console.log('Payload enviado:', payload);
            
            try {
                const resp = await fetch('/equipamentos', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload),
                    credentials: 'same-origin' // Garantir que os cookies de sessão sejam enviados
                });
                
                console.log('Resposta da API:', resp.status, resp.statusText);
                
                if (resp.ok) {
                    const result = await resp.json();
                    console.log('Resultado:', result);
                    modalAdd.style.display = 'none';
                    limparFormularioAdd();
                    carregarEquipamentosSala();
                    alert('Equipamento adicionado com sucesso!');
                } else {
                    const error = await resp.text();
                    console.error('Erro na API:', error);
                    alert('Falha ao adicionar: ' + error);
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
                alert('Erro de conexão: ' + error.message);
            }
        };
        // Edit modal events
        const modalEdit = document.getElementById('modalEdit');
        const fecharEdit = document.getElementById('fecharModalEdit');
        const cancelarEdit = document.getElementById('cancelarEdit');
        const formEdit = document.getElementById('formEdit');
        if (fecharEdit) fecharEdit.onclick = () => modalEdit.style.display = 'none';
        if (cancelarEdit) cancelarEdit.onclick = () => modalEdit.style.display = 'none';
        if (formEdit) formEdit.onsubmit = salvarEdicaoEquipamento;
        // Delete modal events
        const modalDel = document.getElementById('modalDel');
        const cancelarDel = document.getElementById('cancelarDel');
        const confirmarDel = document.getElementById('confirmarDel');
        if (cancelarDel) cancelarDel.onclick = () => modalDel.style.display = 'none';
        if (confirmarDel) confirmarDel.onclick = confirmarExclusaoEquipamento;
        
        // Estoque modal events
        const modalEstoqueEquip = document.getElementById('modalEstoqueEquip');
        const cancelarEstoqueEquip = document.getElementById('cancelarEstoqueEquip');
        const confirmarEstoqueEquip = document.getElementById('confirmarEstoqueEquip');
        if (cancelarEstoqueEquip) cancelarEstoqueEquip.onclick = () => modalEstoqueEquip.style.display = 'none';
        if (confirmarEstoqueEquip) confirmarEstoqueEquip.onclick = confirmarEnvioEstoque;
    });

    function limparFormularioAdd() {
        document.getElementById('add-nome').value = '';
        document.getElementById('add-tipo').value = '';
        document.getElementById('add-marca').innerHTML = '<option value="">Selecione o tipo primeiro</option>';
        document.getElementById('add-modelo').innerHTML = '<option value="">Selecione a marca primeiro</option>';
        document.getElementById('add-descricao').value = '';
        document.getElementById('add-partnumber').value = '';
        document.getElementById('add-tamanho').value = '';
        document.getElementById('add-firmware').value = '';
        document.getElementById('add-serie').value = '';
        document.getElementById('add-ip1').value = '';
        document.getElementById('add-mac1').value = '';
        document.getElementById('add-ip2').value = '';
        document.getElementById('add-mac2').value = '';
    }
    
    function abrirModalAdd() {
        const modalAdd = document.getElementById('modalAdd');
        limparFormularioAdd();
        preencherTiposSelect(document.getElementById('add-tipo'));
        document.getElementById('add-marca').innerHTML = '<option value="">Selecione o tipo primeiro</option>';
        document.getElementById('add-modelo').innerHTML = '<option value="">Selecione a marca primeiro</option>';
        modalAdd.style.display = 'flex';
    }
    let editEquipId = null;
    async function abrirModalEditar(id) {
        editEquipId = id;
        const resp = await fetch(`/equipamentos/${id}`);
        if (!resp.ok) { alert('Não foi possível carregar o equipamento.'); return; }
        const eq = await resp.json();
        document.getElementById('edit-nome').value = eq.nome || '';
        // Preenche selects respeitando dependências
        await preencherTiposSelect(document.getElementById('edit-tipo'), eq.tipo || '');
        await preencherMarcasSelect(eq.tipo || '', document.getElementById('edit-marca'), eq.marca || '');
        await preencherModelosSelect(eq.tipo || '', eq.marca || '', document.getElementById('edit-modelo'), eq.modelo || '');
        document.getElementById('edit-descricao').value = eq.descricao || '';
        document.getElementById('edit-partnumber').value = (eq.dados && eq.dados.partnumber) || '';
        document.getElementById('edit-tamanho').value = (eq.dados && eq.dados.tamanho) || '';
        document.getElementById('edit-firmware').value = (eq.dados && eq.dados.firmware) || '';
        document.getElementById('edit-serie').value = (eq.dados && eq.dados.serie) || '';
        document.getElementById('edit-ip1').value = (eq.dados && eq.dados.ip1) || '';
        document.getElementById('edit-mac1').value = (eq.dados && eq.dados.mac1) || '';
        document.getElementById('edit-ip2').value = (eq.dados && eq.dados.ip2) || '';
        document.getElementById('edit-mac2').value = (eq.dados && eq.dados.mac2) || '';
        document.getElementById('modalEdit').style.display = 'flex';
    }
    async function salvarEdicaoEquipamento(e) {
        e.preventDefault();
        if (!editEquipId) return;
        const payload = {
            nome: document.getElementById('edit-nome').value,
            tipo: document.getElementById('edit-tipo').value,
            marca: document.getElementById('edit-marca').value,
            modelo: document.getElementById('edit-modelo').value,
            descricao: document.getElementById('edit-descricao').value,
            dados: {
                partnumber: document.getElementById('edit-partnumber').value,
                tamanho: document.getElementById('edit-tamanho').value,
                firmware: document.getElementById('edit-firmware').value,
                serie: document.getElementById('edit-serie').value,
                ip1: document.getElementById('edit-ip1').value,
                mac1: document.getElementById('edit-mac1').value,
                ip2: document.getElementById('edit-ip2').value,
                mac2: document.getElementById('edit-mac2').value
            }
        };
        const resp = await fetch(`/equipamentos/${editEquipId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (resp.ok) {
            document.getElementById('modalEdit').style.display = 'none';
            carregarEquipamentosSala();
        } else {
            alert('Falha ao salvar (verifique permissões).');
        }
    }
    let deleteEquipId = null;
    function abrirModalExcluir(id) { deleteEquipId = id; document.getElementById('modalDel').style.display = 'flex'; }
    async function confirmarExclusaoEquipamento() {
        if (!deleteEquipId) return;
        const resp = await fetch(`/equipamentos/${deleteEquipId}`, { method: 'DELETE' });
        if (resp.ok) {
            document.getElementById('modalDel').style.display = 'none';
            carregarEquipamentosSala();
        } else {
            alert('Falha ao excluir (verifique permissões).');
        }
    }

    // --- Modal Enviar para Estoque ---
    let estoqueEquipId = null;
    function abrirModalEnviarEstoque(id) { 
        estoqueEquipId = id; 
        document.getElementById('modalEstoqueEquip').style.display = 'flex'; 
    }
    
    async function confirmarEnvioEstoque() {
        if (!estoqueEquipId) return;
        
        try {
            // Primeiro, buscar todas as conexões ativas do equipamento
            const respConexoes = await fetch('/conexoes');
            if (!respConexoes.ok) {
                throw new Error('Erro ao buscar conexões');
            }
            const conexoes = await respConexoes.json();
            
            // Filtrar conexões do equipamento específico
            const conexoesEquipamento = conexoes.filter(c => c.equipamento_id === estoqueEquipId);
            
            // Desfazer cada conexão individualmente
            for (const conexao of conexoesEquipamento) {
                try {
                    const respDelete = await fetch(`/conexoes/${conexao.id}`, { method: 'DELETE' });
                    if (!respDelete.ok) {
                        console.warn(`Aviso: Não foi possível desfazer conexão ${conexao.id}`);
                    }
                } catch (error) {
                    console.warn(`Erro ao desfazer conexão ${conexao.id}:`, error);
                }
            }
            
            // Desfazer conexões de cabos do equipamento
            try {
                const respConexoesCabos = await fetch('/conexoes-cabos');
                if (respConexoesCabos.ok) {
                    const conexoesCabos = await respConexoesCabos.json();
                    const conexoesCabosEquipamento = conexoesCabos.filter(c => 
                        c.equipamento_origem_id === estoqueEquipId || c.equipamento_destino_id === estoqueEquipId
                    );
                    
                    for (const conexaoCabo of conexoesCabosEquipamento) {
                        try {
                            await fetch(`/conexoes-cabos/${conexaoCabo.id}`, { method: 'DELETE' });
                        } catch (error) {
                            console.warn(`Erro ao desfazer conexão de cabo ${conexaoCabo.id}:`, error);
                        }
                    }
                }
            } catch (error) {
                console.warn('Erro ao buscar conexões de cabos:', error);
            }
            
            // Desconectar de patch panels se necessário
            try {
                const respEquipamento = await fetch(`/equipamentos/${estoqueEquipId}`);
                if (respEquipamento.ok) {
                    const equipamento = await respEquipamento.json();
                    if (equipamento.keystone) {
                        // Limpar keystone do equipamento
                        await fetch(`/equipamentos/${estoqueEquipId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ keystone: null })
                        });
                    }
                }
            } catch (error) {
                console.warn('Erro ao limpar keystone:', error);
            }
            
            // Finalmente, remover o equipamento da sala usando a rota de atualização de sala
            // Primeiro, buscar os dados atuais da sala
            const respSalaAtual = await fetch(`/salas/${currentSalaId}`);
            if (!respSalaAtual.ok) {
                throw new Error('Erro ao buscar dados da sala');
            }
            const salaAtual = await respSalaAtual.json();
            
            // Buscar dados do equipamento para atualizar a descrição
            const respEquipamentoAtual = await fetch(`/equipamentos/${estoqueEquipId}`);
            if (!respEquipamentoAtual.ok) {
                throw new Error('Erro ao buscar dados do equipamento');
            }
            const equipamentoAtual = await respEquipamentoAtual.json();
            
            // Atualizar descrição do equipamento com informação de origem
            const dataAtual = new Date().toLocaleDateString('pt-BR');
            const descricaoOriginal = equipamentoAtual.descricao || '';
            const novaDescricao = descricaoOriginal 
                ? `${descricaoOriginal} | Retirado da sala "${salaAtual.nome}" em ${dataAtual}`
                : `Retirado da sala "${salaAtual.nome}" em ${dataAtual}`;
            
            // Atualizar equipamento com nova descrição
            const dadosEquipamentoAtualizado = {
                nome: equipamentoAtual.nome,
                tipo: equipamentoAtual.tipo,
                marca: equipamentoAtual.marca,
                modelo: equipamentoAtual.modelo,
                descricao: novaDescricao,
                dados: equipamentoAtual.dados || {}
            };
            
            const respAtualizarEquipamento = await fetch(`/equipamentos/${estoqueEquipId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dadosEquipamentoAtualizado)
            });
            
            if (!respAtualizarEquipamento.ok) {
                console.warn('Aviso: Não foi possível atualizar a descrição do equipamento, mas continuando...');
            }
            
            // Buscar todos os equipamentos atuais da sala
            const respEquipamentosSala = await fetch(`/equipamentos?sala_id=${currentSalaId}`);
            if (!respEquipamentosSala.ok) {
                throw new Error('Erro ao buscar equipamentos da sala');
            }
            const equipamentosSala = await respEquipamentosSala.json();
            
            // Filtrar o equipamento que queremos remover
            const equipamentosRestantes = equipamentosSala
                .filter(eq => eq.id !== estoqueEquipId)
                .map(eq => eq.id);
            
            // Atualizar a sala removendo o equipamento específico
            const dadosAtualizacaoSala = {
                nome: salaAtual.nome,
                tipo: salaAtual.tipo,
                descricao: salaAtual.descricao,
                foto: salaAtual.foto,
                fotos: salaAtual.fotos,
                andar_id: salaAtual.andar_id,
                equipamentos_ids: equipamentosRestantes // Lista sem o equipamento removido
            };
            
            const respSala = await fetch(`/salas/${currentSalaId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dadosAtualizacaoSala)
            });
            
            if (respSala.ok) {
                document.getElementById('modalEstoqueEquip').style.display = 'none';
                carregarEquipamentosSala();
                alert('Equipamento enviado para o estoque com sucesso! Todas as conexões foram desfeitas.');
            } else {
                const errorData = await respSala.json().catch(() => ({}));
                console.error('Erro ao atualizar sala:', errorData);
                alert('Falha ao enviar equipamento para o estoque. Verifique o console para mais detalhes.');
            }
        } catch (error) {
            console.error('Erro ao enviar equipamento para estoque:', error);
            alert('Erro ao enviar equipamento para o estoque: ' + error.message);
        }
    }

    window.addEventListener('DOMContentLoaded', function() {
        fetch('/empresa_atual')
            .then(resp => resp.json())
            .then(data => {
                LogoManager.loadEmpresaLogo(data);
            });
    });
    </script>
</body>
</html>

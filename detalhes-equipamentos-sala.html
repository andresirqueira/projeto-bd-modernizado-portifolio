<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Equipamentos da Sala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
        // Atualizar logo da empresa quando o tema mudar
        updateEmpresaLogo();
      }
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
</head>
<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
    <div class="relative w-full max-w-6xl mx-auto bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-8 mt-8">
        <button onclick="window.history.back()" class="absolute top-4 left-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-2 transition-colors" title="Voltar">
            <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="empresa-logada" class="absolute top-4 right-4 text-indigo-500 font-bold bg-gray-800 dark:bg-transparent rounded-lg p-2"></div>
        <button onclick="toggleDarkMode()" class="absolute top-4 left-16 bg-gray-200 dark:bg-gray-700 rounded-full p-2 transition-colors" title="Alternar modo escuro">
            <span class="dark:hidden">üåô</span><span class="hidden dark:inline">‚òÄÔ∏è</span>
        </button>
        <div class="text-center mt-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4" id="equipSalaTopo">Sala</h1>
        </div>
        <div id="equipamentosSalaContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>
    <script src="static/js/logo-manager.js"></script>
    <script>
    async function carregarEquipamentosSala() {
        const params = new URLSearchParams(window.location.search);
        const salaId = params.get('id');
        if (!salaId) return;
        // Busca dados da sala
        let salaNome = '';
        const respSala = await fetch(`/salas/${salaId}`);
        if (respSala.ok) {
            const sala = await respSala.json();
            salaNome = sala.nome;
        }
        document.getElementById('equipSalaTopo').innerText = salaNome || 'Sala';
        // Busca equipamentos da sala
        const respEq = await fetch(`/equipamentos?sala_id=${salaId}`);
        const equipamentos = await respEq.json();
        // Busca conex√µes ativas
        const respCon = await fetch('/conexoes');
        const conexoes = await respCon.json();
        const container = document.getElementById('equipamentosSalaContainer');
        if (equipamentos.length === 0) {
            container.innerHTML = '<div class="col-span-full text-center text-gray-500 dark:text-gray-400 text-lg italic">Nenhum equipamento vinculado a esta sala.</div>';
            return;
        }
        equipamentos.forEach(eq => {
            let iconesHtml = '';
            if (eq.modelo) iconesHtml += `<div class='flex flex-col items-center text-gray-600 dark:text-gray-400 text-sm'><i class='fas fa-cube text-lg mb-1'></i><span class='text-center'>${eq.modelo}</span></div>`;
            if (eq.dados && eq.dados.serie) iconesHtml += `<div class='flex flex-col items-center text-gray-600 dark:text-gray-400 text-sm'><i class='fas fa-barcode text-lg mb-1'></i><span class='text-center'>${eq.dados.serie}</span></div>`;
            if (eq.dados && eq.dados.firmware) iconesHtml += `<div class='flex flex-col items-center text-gray-600 dark:text-gray-400 text-sm'><i class='fas fa-microchip text-lg mb-1'></i><span class='text-center'>${eq.dados.firmware}</span></div>`;
            if (eq.dados && eq.dados.partnumber) iconesHtml += `<div class='flex flex-col items-center text-gray-600 dark:text-gray-400 text-sm'><i class='fas fa-hashtag text-lg mb-1'></i><span class='text-center'>${eq.dados.partnumber}</span></div>`;
            if (eq.dados && eq.dados.tamanho) iconesHtml += `<div class='flex flex-col items-center text-gray-600 dark:text-gray-400 text-sm'><i class='fas fa-ruler-combined text-lg mb-1'></i><span class='text-center'>${eq.dados.tamanho}</span></div>`;
            if (eq.dados && eq.dados.ip1) iconesHtml += `<div class='flex flex-col items-center text-gray-600 dark:text-gray-400 text-sm'><i class='fas fa-network-wired text-lg mb-1'></i><span class='text-center'>${eq.dados.ip1 || '-'}</span></div>`;
            if (eq.dados && eq.dados.mac1) iconesHtml += `<div class='flex flex-col items-center text-gray-600 dark:text-gray-400 text-sm'><i class='fas fa-ethernet text-lg mb-1'></i><span class='text-center mac'>${eq.dados.mac1 || '-'}</span></div>`;
            if (eq.dados && eq.dados.ip2) iconesHtml += `<div class='flex flex-col items-center text-gray-600 dark:text-gray-400 text-sm'><i class='fas fa-network-wired text-lg mb-1'></i><span class='text-center'>${eq.dados.ip2 || '-'}</span></div>`;
            if (eq.dados && eq.dados.mac2) iconesHtml += `<div class='flex flex-col items-center text-gray-600 dark:text-gray-400 text-sm'><i class='fas fa-ethernet text-lg mb-1'></i><span class='text-center mac'>${eq.dados.mac2 || '-'}</span></div>`;
            if (eq.icone) iconesHtml += `<div class='flex flex-col items-center text-gray-600 dark:text-gray-400 text-sm'><img src='${eq.icone.startsWith('img/') ? 'static/' + eq.icone : eq.icone}' alt='√çcone' class='w-6 h-6 mb-1'></div>`;
            // Busca conex√£o deste equipamento
            const conexao = conexoes.find(c => c.equipamento === eq.nome && c.status === 'ativa');
            let redeHtml = '';
            if (conexao && conexao.switch && conexao.porta) {
                redeHtml = `<div class='flex items-center justify-center gap-2 text-gray-600 dark:text-gray-400 text-sm mt-2'><i class='fas fa-network-wired'></i> <span class='font-semibold'>Switch:</span> ${conexao.switch} <span class='font-semibold'>Porta:</span> ${conexao.porta}</div>`;
            }
            // Adiciona √≠cone de rede se tiver ip ou mac
            const temRede = (eq.dados && (eq.dados.ip1 || eq.dados.ip2 || eq.dados.mac1 || eq.dados.mac2));
            container.innerHTML += `
                <div class='bg-gray-100 dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center relative'>
                    ${temRede ? `<i class='fas fa-network-wired absolute top-3 left-3 text-green-500 text-lg bg-white dark:bg-gray-700 rounded-md p-1 shadow-md' title='Necessita de rede'></i>` : ''}
                    ${(eq.marca ? LogoManager.renderMarcaLogo(eq.marca) : '')}
                    <div class='text-xl font-bold text-gray-800 dark:text-white text-center mb-4'>${eq.nome || 'Equipamento'}</div>
                    <div class='flex justify-center mb-4'>${eq.foto ? `<img src='${eq.foto.startsWith('img/') ? 'static/' + eq.foto : eq.foto}' alt='${eq.nome}' class='w-32 h-20 object-contain rounded-lg'>` : ''}</div>
                    <div class='flex gap-4 justify-center mb-4 text-yellow-600 dark:text-yellow-400 text-sm font-semibold border-b border-gray-300 dark:border-gray-600 pb-2'>
                        <div><span class='font-bold'>Tipo:</span> ${eq.tipo || '-'}</div>
                        <div><span class='font-bold'>S√©rie:</span> ${(eq.dados && eq.dados.serie) ? eq.dados.serie : '-'}</div>
                    </div>
                    <div class='grid grid-cols-2 gap-4 mb-4'>${iconesHtml}</div>
                    ${redeHtml}
                </div>
            `;
        });
    }
    carregarEquipamentosSala();

    window.addEventListener('DOMContentLoaded', function() {
        fetch('/empresa_atual')
            .then(resp => resp.json())
            .then(data => {
                LogoManager.loadEmpresaLogo(data);
            });
    });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Detalhes Sala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="static/img/favicon-lupa.png">
    <script src="static/js/demo-banner.js"></script>
    <script>
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
        // Atualizar logo da empresa quando o tema mudar
        updateEmpresaLogo();
      }
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
</head>
<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
    <div class="relative w-full max-w-4xl mx-auto bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-8 mt-8">
        <button onclick="window.location.href='ver-salas.html'" class="absolute top-4 left-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-2 transition-colors" title="Voltar">
            <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="empresa-logada" class="absolute top-4 right-4 text-indigo-500 font-bold bg-gray-800 dark:bg-transparent rounded-lg p-2"></div>
        <button onclick="toggleDarkMode()" class="absolute top-4 left-16 bg-gray-200 dark:bg-gray-700 rounded-full p-2 transition-colors" title="Alternar modo escuro">
            <span class="dark:hidden">üåô</span><span class="hidden dark:inline">‚òÄÔ∏è</span>
        </button>
        <div class="text-center mt-8 mb-8">
            <div class="text-center mt-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4" id="salaTitulo">
                <i class="fas fa-door-open text-indigo-600 dark:text-indigo-400 mr-3"></i>
                Sala
            </h1>
            <p class="text-gray-600 dark:text-gray-300">Detalhes completos da sala selecionada</p>
        </div>
            <div id="salaFoto" class="flex justify-center mb-6"></div>
            <div id="salaDesc" class="text-lg text-gray-700 dark:text-gray-300 mb-4"></div>
            <!-- A√ß√µes da sala: Editar (admin/t√©cnico) e Excluir (apenas admin) -->
            <div id="salaActionButtons" class="flex justify-end gap-2 mb-8">
                <button id="btnEditarSala" style="display:none" class="px-3 py-1.5 rounded-full border border-gray-300/60 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-200 bg-gray-100/60 dark:bg-gray-800/60 hover:bg-indigo-50 dark:hover:bg-indigo-900 hover:text-indigo-700 dark:hover:text-indigo-300 transition-colors flex items-center gap-2" title="Editar sala">
                    <i class="fas fa-pen"></i>
                    <span>Editar</span>
                </button>
                <button id="btnExcluirSala" style="display:none" class="px-3 py-1.5 rounded-full border border-red-200 dark:border-red-700 text-sm text-red-600 dark:text-red-300 bg-red-50/70 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors flex items-center gap-2" title="Excluir sala">
                    <i class="fas fa-trash"></i>
                    <span>Excluir</span>
                </button>
            </div>
        </div>
        <!-- Modal Editar Sala -->
        <div id="modalEditSala" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;" class="flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-900 rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden">
                <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">Editar sala</h3>
                    <button id="fecharModalEditSala" class="px-3 py-1.5 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600">Fechar</button>
                </div>
                <form id="formEditSala" class="p-4 grid grid-cols-1 gap-3">
                    <label class="text-gray-700 dark:text-white">Nome da Sala:</label>
                    <input id="editSala-nome" type="text" class="px-3 py-2 rounded border dark:bg-gray-800 dark:text-gray-100 dark:border-gray-600" required>
                    <label class="text-gray-700 dark:text-white">Tipo:</label>
                    <input id="editSala-tipo" type="text" class="px-3 py-2 rounded border dark:bg-gray-800 dark:text-gray-100 dark:border-gray-600">
                    <label class="text-gray-700 dark:text-white">Descri√ß√£o:</label>
                    <textarea id="editSala-descricao" class="px-3 py-2 rounded border dark:bg-gray-800 dark:text-gray-100 dark:border-gray-600"></textarea>
                    <div id="editSala-fotoPreview" class="mb-2"></div>
                    <label class="text-gray-700 dark:text-white">Escolher imagem j√° enviada:</label>
                    <select id="editSala-fotoExistente" class="px-3 py-2 rounded border dark:bg-gray-800 dark:text-gray-100 dark:border-gray-600 mb-2"></select>
                    <label class="text-gray-700 dark:text-white">Andar ID:</label>
                    <select id="editSala-andar" class="px-3 py-2 rounded border dark:bg-gray-800 dark:text-gray-100 dark:border-gray-600">
                        <option value="">Selecione...</option>
                        <script>for (let i = 0; i < 200; i++) { document.write(`<option value='${i}'>${i}</option>`); }</script>
                    </select>
                    <div class="flex justify-end gap-2 pt-2">
                        <button type="button" id="cancelarEditSala" class="px-4 py-2 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100">Cancelar</button>
                        <button type="submit" class="px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-700 text-white">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Modal Excluir Sala -->
        <div id="modalDelSala" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;" class="flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-900 rounded-xl shadow-2xl w-full max-w-lg">
                <div class="p-5">
                    <div class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-3">Confirmar exclus√£o</div>
                    <div id="delSalaAviso" class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-line max-h-64 overflow-auto text-left">Tem certeza que deseja excluir esta sala? Esta a√ß√£o n√£o pode ser desfeita.</div>
                    <div class="flex justify-end gap-2 mt-6">
                        <button id="cancelarDelSala" class="px-4 py-2 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100">Cancelar</button>
                        <button id="confirmarDelSala" class="px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white">Excluir</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 justify-items-center">
            <div class="bg-blue-500 hover:bg-blue-600 text-white rounded-xl shadow-lg p-6 flex flex-col items-center w-full max-w-48 cursor-pointer transition-colors" onclick="window.location.href='detalhes-equipamentos-sala.html?id=' + getIdFromUrl()">
                <i class="fas fa-list text-3xl mb-3"></i>
                <span class="font-semibold text-center">Equipamentos</span>
            </div>
            <div class="bg-green-500 hover:bg-green-600 text-white rounded-xl shadow-lg p-6 flex flex-col items-center w-full max-w-48 cursor-pointer transition-colors" onclick="window.location.href='visualizar-layout-sala.html?sala_id=' + getIdFromUrl()">
                <i class="fas fa-random text-3xl mb-3"></i>
                <span class="font-semibold text-center">Conex√µes</span>
            </div>
            <div class="bg-cyan-500 hover:bg-cyan-600 text-white rounded-xl shadow-lg p-6 flex flex-col items-center w-full max-w-48 cursor-pointer transition-colors" onclick="window.location.href='detalhes-cabos-sala.html?id=' + getIdFromUrl()">
                <i class="fas fa-plug text-3xl mb-3"></i>
                <span class="font-semibold text-center">Cabos</span>
            </div>
            <div class="bg-purple-500 hover:bg-purple-600 text-white rounded-xl shadow-lg p-6 flex flex-col items-center w-full max-w-48 cursor-pointer transition-colors">
                <i class="fas fa-map-marker-alt text-3xl mb-3"></i>
                <span class="font-semibold text-center">Localiza√ß√£o</span>
            </div>
            <div class="bg-orange-500 hover:bg-orange-600 text-white rounded-xl shadow-lg p-6 flex flex-col items-center w-full max-w-48 cursor-pointer transition-colors" id="acao-switch">
                <i class="fas fa-server text-3xl mb-3"></i>
                <span class="font-semibold text-center">Switch</span>
            </div>
            <div class="bg-gray-500 hover:bg-gray-600 text-white rounded-xl shadow-lg p-6 flex flex-col items-center w-full max-w-48 cursor-pointer transition-colors" id="acao-historico">
                <i class="fas fa-undo text-3xl mb-3"></i>
                <span class="font-semibold text-center">Hist√≥rico</span>
            </div>
            <div class="bg-yellow-500 hover:bg-yellow-600 text-white rounded-xl shadow-lg p-6 flex flex-col items-center w-full max-w-48 cursor-pointer transition-colors" id="acao-dashboard">
                <i class="fas fa-chart-bar text-3xl mb-3"></i>
                <span class="font-semibold text-center">Dashboard</span>
            </div>
        </div>
    </div>
    <script>
    function getIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('id');
    }
    async function abrirModalEditarSala() {
        const id = getIdFromUrl();
        const resp = await fetch(`/salas/${id}`);
        if (!resp.ok) return;
        const sala = await resp.json();
        document.getElementById('editSala-nome').value = sala.nome || '';
        document.getElementById('editSala-tipo').value = sala.tipo || '';
        document.getElementById('editSala-descricao').value = sala.descricao || '';
        // Foto existente
        try {
            const respFotos = await fetch('/fotos-salas');
            const data = await respFotos.json();
            const select = document.getElementById('editSala-fotoExistente');
            select.innerHTML = '<option value="">Nenhuma</option>';
            (data.imagens||[]).forEach(url => { const nome = url.split('/').pop(); select.innerHTML += `<option value="${url}">${nome}</option>`; });
            // Normaliza valor salvo
            let fotoBanco = sala.foto || '';
            let fotoSelectValue = '';
            if (fotoBanco.startsWith('static/')) fotoSelectValue = '/' + fotoBanco;
            else if (fotoBanco.startsWith('/static/')) fotoSelectValue = fotoBanco;
            else if (fotoBanco.startsWith('/img/fotos-salas/')) fotoSelectValue = fotoBanco;
            else if (fotoBanco.startsWith('img/fotos-salas/')) fotoSelectValue = '/static/' + fotoBanco;
            else fotoSelectValue = fotoBanco;
            select.value = fotoSelectValue;
            const preview = document.getElementById('editSala-fotoPreview');
            if (fotoSelectValue) preview.innerHTML = `<img src='${fotoSelectValue}' alt='Foto da sala' style='max-width:180px;max-height:90px;object-fit:cover;border-radius:6px;'>`;
            else if (sala.foto) preview.innerHTML = `<img src='${sala.foto.startsWith('img/') ? 'static/' + sala.foto : sala.foto}' alt='Foto da sala' style='max-width:180px;max-height:90px;object-fit:cover;border-radius:6px;'>`;
            else preview.innerHTML = "<span style='color:#aaa;'>Sem foto cadastrada</span>";
        } catch {}
        document.getElementById('editSala-andar').value = sala.andar_id || '';
        document.getElementById('modalEditSala').style.display = 'flex';
    }
    async function salvarSala(e) {
        e.preventDefault();
        const id = getIdFromUrl();
        const body = {
            nome: document.getElementById('editSala-nome').value,
            tipo: document.getElementById('editSala-tipo').value,
            descricao: document.getElementById('editSala-descricao').value,
            foto: document.getElementById('editSala-fotoExistente').value || null,
            fotos: null,
            andar_id: document.getElementById('editSala-andar').value || null,
            equipamentos_ids: []
        };
        const resp = await fetch(`/salas/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        if (resp.ok) {
            document.getElementById('modalEditSala').style.display = 'none';
            carregarSala();
        } else {
            alert('Falha ao salvar sala (verifique permiss√µes).');
        }
    }
    async function abrirModalExcluirSala() {
        const id = getIdFromUrl();
        const avisoDiv = document.getElementById('delSalaAviso');
        if (avisoDiv) avisoDiv.innerHTML = 'Carregando...';
        try {
            const respEq = await fetch(`/equipamentos?sala_id=${id}`);
            const equipamentos = await respEq.json();
            if (Array.isArray(equipamentos) && equipamentos.length > 0) {
                const lista = equipamentos.map(eq => `- ${eq.nome}${eq.modelo ? ' (' + eq.modelo + ')' : ''}`).join('\n');
                if (avisoDiv) avisoDiv.textContent = `Aten√ß√£o! Os seguintes equipamentos est√£o vinculados a esta sala e ser√£o desvinculados:\n\n${lista}\n\nEles ficar√£o dispon√≠veis para vincular a outras salas.`;
            } else {
                if (avisoDiv) avisoDiv.textContent = 'Tem certeza que deseja excluir esta sala? Esta a√ß√£o n√£o pode ser desfeita.';
            }
        } catch (e) {
            if (avisoDiv) avisoDiv.textContent = 'Tem certeza que deseja excluir esta sala? Esta a√ß√£o n√£o pode ser desfeita.';
        }
        document.getElementById('modalDelSala').style.display = 'flex';
    }
    async function excluirSala() {
        const id = getIdFromUrl();
        // Aviso igual ao excluir-sala: listar equipamentos vinculados
        try {
            const respEq = await fetch(`/equipamentos?sala_id=${id}`);
            const equipamentos = await respEq.json();
            let msg = '';
            if (Array.isArray(equipamentos) && equipamentos.length > 0) {
                msg = 'Aten√ß√£o! Os seguintes equipamentos est√£o vinculados a esta sala e ser√£o desvinculados:\n\n';
                msg += equipamentos.map(eq => `- ${eq.nome}${eq.modelo ? ' (' + eq.modelo + ')' : ''}`).join('\n');
                msg += '\n\nEles ficar√£o dispon√≠veis para vincular a outras salas.';
            } else {
                msg = 'Tem certeza que deseja excluir esta sala?';
            }
            if (!confirm(msg)) return;
        } catch (e) {
            if (!confirm('Tem certeza que deseja excluir esta sala?')) return;
        }
        document.getElementById('modalDelSala').style.display = 'none';
        const resp = await fetch(`/salas/${id}`, { method: 'DELETE' });
        if (resp.ok) {
            window.location.href = 'ver-salas.html';
        } else {
            alert('Falha ao excluir sala (verifique permiss√µes).');
        }
    }
    async function carregarSala() {
        const id = getIdFromUrl();
        if (!id) return;
        const resp = await fetch(`/salas/${id}`);
        if (!resp.ok) return;
        const sala = await resp.json();
        document.getElementById('salaTitulo').innerText = sala.nome || 'Sala';
        // Foto
        const fotoDiv = document.getElementById('salaFoto');
        fotoDiv.innerHTML = sala.foto ? `<img src='${sala.foto.startsWith('img/') ? 'static/' + sala.foto : sala.foto}' alt='${sala.nome}' class='rounded-xl shadow-2xl max-w-full max-h-80 object-cover'>` : '';
        // Descri√ß√£o
        document.getElementById('salaDesc').innerText = sala.descricao || '';
    }
    carregarSala();

    window.addEventListener('DOMContentLoaded', function() {
        fetch('/empresa_atual')
            .then(resp => resp.json())
            .then(data => {
                LogoManager.loadEmpresaLogo(data);
            });
        // Carregar perfil e habilitar bot√µes de a√ß√£o conforme permiss√£o
        fetch('/perfil')
            .then(resp => resp.json())
            .then(perfil => {
                const btnEditar = document.getElementById('btnEditarSala');
                const btnExcluir = document.getElementById('btnExcluirSala');
                if (!perfil) return;
                if (perfil.nivel === 'admin' || perfil.nivel === 'tecnico') {
                    btnEditar.style.display = 'inline-flex';
                }
                if (perfil.nivel === 'admin') {
                    btnExcluir.style.display = 'inline-flex';
                }
            });
        // Adiciona evento ao bot√£o Switch
        const btnSwitch = document.getElementById('acao-switch');
        if (btnSwitch) {
            btnSwitch.onclick = function() {
                window.location.href = 'visualizar-switch-sala.html?sala_id=' + getIdFromUrl();
            };
        }
        // Adiciona evento ao bot√£o Hist√≥rico
        const btnHistorico = document.getElementById('acao-historico');
        if (btnHistorico) {
            btnHistorico.onclick = function() {
                window.location.href = 'historico-sala.html?id=' + getIdFromUrl();
            };
        }
        // Adiciona evento ao bot√£o Dashboard
        const btnDashboard = document.getElementById('acao-dashboard');
        if (btnDashboard) {
            btnDashboard.onclick = function() {
                window.location.href = 'dashboard-sala.html?id=' + getIdFromUrl();
            };
        }
        // Clique dos bot√µes Editar / Excluir -> abrir modais
        const btnEditar = document.getElementById('btnEditarSala');
        if (btnEditar) {
            btnEditar.onclick = abrirModalEditarSala;
        }
        const btnExcluir = document.getElementById('btnExcluirSala');
        if (btnExcluir) {
            btnExcluir.onclick = abrirModalExcluirSala;
        }
        // Eventos modais
        const fecharEdit = document.getElementById('fecharModalEditSala');
        const cancelarEdit = document.getElementById('cancelarEditSala');
        if (fecharEdit) fecharEdit.onclick = () => document.getElementById('modalEditSala').style.display = 'none';
        if (cancelarEdit) cancelarEdit.onclick = () => document.getElementById('modalEditSala').style.display = 'none';
        const selectFoto = document.getElementById('editSala-fotoExistente');
        if (selectFoto) selectFoto.addEventListener('change', function(){
            const url = this.value; const preview = document.getElementById('editSala-fotoPreview');
            if (url) { preview.innerHTML = `<img src='${url}' alt='Foto da sala' style='max-width:180px;max-height:90px;object-fit:cover;border-radius:6px;'>`; }
            else { preview.innerHTML = "<span style='color:#aaa;'>Sem foto cadastrada</span>"; }
        });
        const cancelarDelSala = document.getElementById('cancelarDelSala');
        if (cancelarDelSala) cancelarDelSala.onclick = () => document.getElementById('modalDelSala').style.display = 'none';
        const confirmarDelSala = document.getElementById('confirmarDelSala');
        if (confirmarDelSala) confirmarDelSala.onclick = excluirSala;
        const formEditSala = document.getElementById('formEditSala');
        if (formEditSala) formEditSala.onsubmit = salvarSala;
    });
    </script>
    <script src="static/js/logo-manager.js"></script>
    </body>
</html> 
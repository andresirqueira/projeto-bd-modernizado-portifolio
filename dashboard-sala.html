<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Sala</title>
  <link rel="icon" type="image/png" href="static/img/favicon-dashboard.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' };</script>
  <link rel="stylesheet" href="css/estilo-base.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> <script src="static/js/demo-banner.js"></script>
  <script src="static/js/chart.min.js"></script>
  <style>
    .dashboard-card {
      background: linear-gradient(135deg, #6366f1 0%, #60a5fa 100%);
      color: #fff;
      border-radius: 1.2rem;
      box-shadow: 0 4px 24px #0002;
      padding: 1.3rem 1rem 1rem 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 110px;
      position: relative;
      overflow: hidden;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .dashboard-card:hover {
      transform: translateY(-4px) scale(1.03);
      box-shadow: 0 8px 32px #0003;
    }
    .dashboard-card .icon-bg {
      position: absolute;
      top: -24px;
      right: -24px;
      font-size: 5.5rem;
      color: #fff2;
      pointer-events: none;
      z-index: 0;
    }
    .dashboard-card .icon {
      font-size: 1.5rem;
      margin-bottom: 0.3rem;
      z-index: 1;
    }
    .dashboard-card .title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.1rem;
      z-index: 1;
      letter-spacing: 0.01em;
    }
    .dashboard-card .value {
      font-size: 1.6rem;
      font-weight: 800;
      z-index: 1;
      margin-bottom: 0.1rem;
    }
    .dashboard-card .desc {
      font-size: 0.85rem;
      color: #e0e7ff;
      z-index: 1;
    }
    @media (max-width: 640px) {
      .dashboard-card { min-height: 80px; padding: 0.7rem 0.4rem; }
      .dashboard-card .value { font-size: 1.1rem; }
      .dashboard-card .icon-bg { font-size: 2.2rem; }
    }
    .chart-container {
      background: #fff;
      border-radius: 1.2rem;
      box-shadow: 0 4px 24px #0001;
      padding: 1.5rem 1.2rem;
      margin-bottom: 2rem;
      min-height: 340px;
      transition: box-shadow 0.15s;
    }
    .dark .chart-container {
      background: #181e2a;
    }
    .chart-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #3730a3;
      margin-bottom: 1.2rem;
    }
    .dark .chart-title {
      color: #a5b4fc;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen flex flex-col items-center justify-center dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
  <button onclick="voltarDetalhesSala()" class="fixed top-6 left-6 z-50 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-3 transition-colors shadow-lg" title="Voltar para detalhes da sala">
    <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
  </button>
  <div class="w-full max-w-5xl mx-auto mt-10 mb-10 px-2">
    <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
      <h1 class="text-3xl font-bold text-gray-800 dark:text-white" id="tituloSala">
        <i class="fas fa-chart-bar text-indigo-600 dark:text-indigo-400 mr-3"></i>
        Dashboard da Sala
      </h1>
      <div class="flex gap-2">
        <button onclick="toggleDarkMode()" class="bg-gray-200 dark:bg-gray-700 rounded-full p-3 transition-colors ml-1" title="Alternar modo escuro">
          <span class="dark:hidden">🌙</span><span class="hidden dark:inline">☀️</span>
        </button>
      </div>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-10" id="cardsResumo"></div>
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
      <div class="chart-container">
        <div class="chart-title">Equipamentos por Tipo</div>
        <canvas id="chartTipos"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">Equipamentos Dependentes de Rede</div>
        <canvas id="chartRede"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">Equipamentos por Marca</div>
        <canvas id="chartMarcas"></canvas>
      </div>
    </div>
  </div>
  <script>
    function getSalaIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }
    function voltarDetalhesSala() {
      const id = getSalaIdFromUrl();
      if (id) {
        window.location.href = 'detalhes-sala.html?id=' + id;
      } else {
        window.history.back();
      }
    }
    function toggleDarkMode() {
      if (document.documentElement.classList.contains('dark')) {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', 'light');
      } else {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme', 'dark');
      }
    }
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
    } else if (localStorage.getItem('theme') === 'light') {
      document.documentElement.classList.remove('dark');
    }

    let equipamentos = [];
    let sala = null;
    let conexoesCabos = [];
    async function fetchData() {
      const salaId = getSalaIdFromUrl();
      if (!salaId) return;
      // Buscar dados da sala
      const salaResp = await fetch('/salas/' + salaId);
      if (salaResp.ok) {
        sala = await salaResp.json();
        document.getElementById('tituloSala').innerText = 'Dashboard da Sala: ' + (sala.nome || '');
      }
      // Buscar equipamentos da sala
      const eqResp = await fetch('/equipamentos?sala_id=' + salaId);
      equipamentos = await eqResp.json();
      // Buscar conexões de cabos da sala
      const cabosResp = await fetch('/conexoes-cabos/sala/' + salaId);
      if (cabosResp.ok) {
        conexoesCabos = await cabosResp.json();
      }
      renderCards();
      renderCharts();
    }
    function renderCards() {
      const tipos = {};
      let funcionando = 0, defeito = 0, indisponivel = 0, rede = 0;
      equipamentos.forEach(eq => {
        if (!tipos[eq.tipo]) tipos[eq.tipo] = 0;
        tipos[eq.tipo]++;
        const defeitoValue = parseInt(eq.defeito) || 0;
        if (defeitoValue === 1) {
          defeito++;
        } else if (defeitoValue === 2) {
          indisponivel++;
        } else {
          funcionando++;
        }
        if (eq.dados && (eq.dados.ip1 || eq.dados.mac1 || eq.dados.ip2 || eq.dados.mac2)) {
          rede++;
        }
      });
      const cards = [
        {
          icon: 'fa-boxes',
          iconBg: 'fa-cubes',
          title: 'Total de Equipamentos',
          value: equipamentos.length,
          desc: 'Equipamentos nesta sala',
          bg: 'from-indigo-500 to-blue-500'
        },
        {
          icon: 'fa-network-wired',
          iconBg: 'fa-wifi',
          title: 'Dependem de Rede',
          value: rede,
          desc: 'Equipamentos com IP ou MAC',
          bg: 'from-emerald-500 to-teal-500'
        },
        {
          icon: 'fa-check-circle',
          iconBg: 'fa-heart',
          title: 'Funcionando',
          value: funcionando,
          desc: 'Equipamentos sem defeito',
          bg: 'from-green-500 to-lime-500'
        },
        {
          icon: 'fa-exclamation-triangle',
          iconBg: 'fa-bug',
          title: 'Com Defeito',
          value: defeito,
          desc: 'Equipamentos com defeito',
          bg: 'from-red-500 to-pink-500'
        },
        {
          icon: 'fa-exclamation-triangle',
          iconBg: 'fa-ban',
          title: 'Indisponíveis',
          value: indisponivel,
          desc: 'Equipamentos enviados para outra unidade',
          bg: 'from-orange-500 to-yellow-500'
        },
        {
          icon: 'fa-plug',
          iconBg: 'fa-plug',
          title: 'Conexões de Cabos',
          value: conexoesCabos.filter(c => !c.data_desconexao).length,
          desc: 'Cabos ativos nesta sala',
          bg: 'from-blue-500 to-cyan-500'
        },
        {
          icon: 'fa-unlink',
          iconBg: 'fa-times-circle',
          title: 'Conexões Inativas',
          value: conexoesCabos.filter(c => c.data_desconexao).length,
          desc: 'Cabos desconectados',
          bg: 'from-gray-500 to-slate-500'
        }
      ];
      const html = cards.map(card => `
        <div class="dashboard-card">
          <i class="fas ${card.icon} icon"></i>
          <div class="icon-bg"><i class="fas ${card.iconBg}"></i></div>
          <div class="title">${card.title}</div>
          <div class="value">${card.value}</div>
          <div class="desc">${card.desc}</div>
        </div>
      `).join('');
      document.getElementById('cardsResumo').innerHTML = html;
    }
    function renderCharts() {
      // Tipos
      const tipos = {};
      equipamentos.forEach(eq => {
        if (!tipos[eq.tipo]) tipos[eq.tipo] = 0;
        tipos[eq.tipo]++;
      });
      if (window.chartTipos && typeof window.chartTipos.destroy === 'function') window.chartTipos.destroy();
      window.chartTipos = new Chart(document.getElementById('chartTipos'), {
        type: 'bar',
        data: {
          labels: Object.keys(tipos),
          datasets: [{
            label: 'Equipamentos',
            data: Object.values(tipos),
            backgroundColor: '#6366f1',
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: getComputedStyle(document.body).color } },
            y: { ticks: { color: getComputedStyle(document.body).color } }
          }
        }
      });
      // Rede
      let rede = 0, semRede = 0;
      equipamentos.forEach(eq => {
        if (eq.dados && (eq.dados.ip1 || eq.dados.mac1 || eq.dados.ip2 || eq.dados.mac2)) {
          rede++;
        } else {
          semRede++;
        }
      });
      if (window.chartRede && typeof window.chartRede.destroy === 'function') window.chartRede.destroy();
      window.chartRede = new Chart(document.getElementById('chartRede'), {
        type: 'doughnut',
        data: {
          labels: ['Com Rede', 'Sem Rede'],
          datasets: [{
            data: [rede, semRede],
            backgroundColor: ['#10b981', '#f59e42'],
          }]
        },
        options: {
          plugins: { legend: { labels: { color: getComputedStyle(document.body).color } } }
        }
      });
      // Marcas
      const marcas = {};
      equipamentos.forEach(eq => {
        if (!marcas[eq.marca]) marcas[eq.marca] = 0;
        marcas[eq.marca]++;
      });
      if (window.chartMarcas && typeof window.chartMarcas.destroy === 'function') window.chartMarcas.destroy();
      window.chartMarcas = new Chart(document.getElementById('chartMarcas'), {
        type: 'bar',
        data: {
          labels: Object.keys(marcas),
          datasets: [{
            label: 'Equipamentos',
            data: Object.values(marcas),
            backgroundColor: '#a21caf',
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: getComputedStyle(document.body).color } },
            y: { ticks: { color: getComputedStyle(document.body).color } }
          }
        }
      });
    }
    fetchData();
    // Atualizar gráficos ao alternar dark mode
    document.querySelector('button[onclick="toggleDarkMode()"]')?.addEventListener('click', () => {
      setTimeout(renderCharts, 300);
    });
  </script>
</body>
</html> 

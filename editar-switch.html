<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Editar Switch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
        // Atualizar logo da empresa quando o tema mudar
        updateEmpresaLogo();
      }
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
</head>

<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
    <div class="relative w-full max-w-2xl mx-auto bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-8 mt-8">
        <button onclick="voltarPainelConfig()" class="absolute top-4 left-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-2 transition-colors" title="Voltar">
            <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="empresa-logada" class="absolute top-4 right-4 text-indigo-500 font-bold bg-gray-800 dark:bg-transparent rounded-lg p-2"></div>
        <button onclick="toggleDarkMode()" class="absolute top-4 left-16 bg-gray-200 dark:bg-gray-700 rounded-full p-2 transition-colors" title="Alternar modo escuro">
            <span class="dark:hidden">üåô</span><span class="hidden dark:inline">‚òÄÔ∏è</span>
        </button>
        <div class="text-center mt-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">Editar Switch</h1>
        </div>
        
        <div class="mb-6">
            <label for="switchSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Selecione o Switch:</label>
            <select id="switchSelect" onchange="carregarSwitch()" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white dark:border-gray-600">
                <option value="">Selecione um switch...</option>
            </select>
        </div>

        <div id="switchInfo" class="mb-6 p-4 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg border border-indigo-200 dark:border-indigo-700" style="display: none;">
            <h3 class="text-lg font-semibold text-indigo-800 dark:text-indigo-200 mb-3">Informa√ß√µes do Switch</h3>
            <div class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                <p><strong>ID:</strong> <span id="switchId"></span></p>
                <p><strong>Data de Cria√ß√£o:</strong> <span id="switchDataCriacao"></span></p>
            </div>
        </div>

        <form id="formEditarSwitch" class="space-y-6">
            <div class="space-y-2">
                <label for="nome" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nome:</label>
                <input type="text" id="nome" name="nome" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white dark:border-gray-600 disabled:bg-gray-100 dark:disabled:bg-gray-700 disabled:cursor-not-allowed">
                <small class="text-gray-500 dark:text-gray-400">Exemplo: Switch 04 - T√©rreo</small>
            </div>

            <div class="space-y-2">
                <label for="marca" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Marca:</label>
                <select id="marca" name="marca" required onchange="atualizarModelos()" disabled class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white dark:border-gray-600 disabled:bg-gray-100 dark:disabled:bg-gray-700 disabled:cursor-not-allowed">
                    <option value="">Selecione a marca...</option>
                    <option value="Cisco">Cisco</option>
                    <option value="HP">HP</option>
                    <option value="Dell">Dell</option>
                    <option value="Juniper">Juniper</option>
                    <option value="Aruba">Aruba</option>
                    <option value="Netgear">Netgear</option>
                    <option value="TP-Link">TP-Link</option>
                    <option value="Ubiquiti">Ubiquiti</option>
                    <option value="Mikrotik">Mikrotik</option>
                    <option value="Outro">Outro</option>
                </select>
            </div>

            <div class="space-y-2">
                <label for="modelo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Modelo:</label>
                <select id="modelo" name="modelo" required disabled class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white dark:border-gray-600 disabled:bg-gray-100 dark:disabled:bg-gray-700 disabled:cursor-not-allowed">
                    <option value="">Selecione a marca primeiro</option>
                </select>
            </div>

            <div class="pt-4">
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-700 dark:hover:bg-indigo-800 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed" id="btnSalvar" disabled>
                    <i class="fas fa-save"></i> Salvar Altera√ß√µes
                </button>
            </div>
        </form>

        <div id="msg" class="mt-4 p-4 rounded-lg text-center font-medium"></div>
    </div>

    <script>
        let switchAtual = null;

        // Modelos por marca
        const modelosPorMarca = {
            Cisco: [
                "Catalyst 2960",
                "Catalyst 3560",
                "Catalyst 3750",
                "Catalyst 3850",
                "Catalyst 4500",
                "Catalyst 6500",
                "Nexus 3000",
                "Nexus 5000",
                "Nexus 7000",
                "Nexus 9000",
                "Outro"
            ],
            HP: [
                "ProCurve 1800",
                "ProCurve 2500",
                "ProCurve 2600",
                "ProCurve 2800",
                "ProCurve 2900",
                "ProCurve 3500",
                "ProCurve 5400",
                "Aruba 2530",
                "Aruba 2930",
                "Aruba 3810",
                "Outro"
            ],
            Dell: [
                "PowerConnect 2800",
                "PowerConnect 3500",
                "PowerConnect 5500",
                "PowerConnect 6200",
                "PowerConnect 7000",
                "N-Series",
                "S-Series",
                "Z-Series",
                "Outro"
            ],
            Juniper: [
                "EX2200",
                "EX2300",
                "EX3300",
                "EX3400",
                "EX4300",
                "EX4500",
                "EX4600",
                "EX9200",
                "QFX5100",
                "QFX5200",
                "Outro"
            ],
            Aruba: [
                "2530",
                "2930",
                "3810",
                "5400",
                "8320",
                "8400",
                "Outro"
            ],
            Netgear: [
                "GS108",
                "GS116",
                "GS724T",
                "GS748T",
                "GS752TP",
                "M4100",
                "M4300",
                "Outro"
            ],
            "TP-Link": [
                "TL-SG1008",
                "TL-SG1016",
                "TL-SG1024",
                "TL-SG108",
                "TL-SG116",
                "TL-SG2008",
                "TL-SG2016",
                "Outro"
            ],
            Ubiquiti: [
                "US-8",
                "US-16-150W",
                "US-24",
                "US-24-250W",
                "US-48",
                "US-48-500W",
                "USW-Enterprise-24-POE",
                "Outro"
            ],
            Mikrotik: [
                "CRS125-24G-1S",
                "CRS226-24G-2S",
                "CRS328-24P-4S",
                "CRS354-48G-4S",
                "CSS326-24G-2S",
                "CSS610-8G-2S",
                "Outro"
            ],
            Outro: ["Outro"]
        };

        // Atualizar modelos quando marca for selecionada
        function atualizarModelos() {
            const marca = document.getElementById('marca').value;
            const modeloSelect = document.getElementById('modelo');
            const modeloAtual = modeloSelect.value; // Preservar o valor atual
            
            modeloSelect.innerHTML = "";
            
            if (modelosPorMarca[marca]) {
                modeloSelect.innerHTML = '<option value="">Selecione o modelo...</option>';
                modelosPorMarca[marca].forEach(modelo => {
                    const opt = document.createElement('option');
                    opt.value = modelo;
                    opt.textContent = modelo;
                    modeloSelect.appendChild(opt);
                });
                
                // Se o modelo atual existe na nova lista de modelos, mant√™-lo selecionado
                if (modeloAtual && modelosPorMarca[marca].includes(modeloAtual)) {
                    modeloSelect.value = modeloAtual;
                }
            } else {
                modeloSelect.innerHTML = '<option value="">Selecione a marca primeiro</option>';
            }
        }

        // Carregar lista de switches
        async function carregarSwitches() {
            try {
                const resp = await fetch('/switches');
                const switches = await resp.json();
                const select = document.getElementById('switchSelect');
                
                select.innerHTML = '<option value="">Selecione um switch...</option>';
                switches.forEach(sw => {
                    const opt = document.createElement('option');
                    opt.value = sw.id;
                    opt.textContent = `${sw.nome} (${sw.marca} ${sw.modelo})`;
                    select.appendChild(opt);
                });
            } catch (error) {
                console.error('Erro ao carregar switches:', error);
                mostrarMensagem('Erro ao carregar switches', 'error');
            }
        }

        // Carregar dados do switch selecionado
        async function carregarSwitch() {
            const switchId = document.getElementById('switchSelect').value;
            const btnSalvar = document.getElementById('btnSalvar');
            const switchInfo = document.getElementById('switchInfo');
            const marcaSelect = document.getElementById('marca');
            const modeloSelect = document.getElementById('modelo');
            const nomeInput = document.getElementById('nome');
            
            if (!switchId) {
                switchAtual = null;
                btnSalvar.disabled = true;
                switchInfo.style.display = 'none';
                limparFormulario();
                
                // Desabilitar campos
                nomeInput.disabled = true;
                marcaSelect.disabled = true;
                modeloSelect.disabled = true;
                return;
            }

            try {
                const resp = await fetch(`/switches/${switchId}`);
                const switch_data = await resp.json();
                
                if (resp.ok) {
                    switchAtual = switch_data;
                    preencherFormulario(switch_data);
                    mostrarInfoSwitch(switch_data);
                    btnSalvar.disabled = false;
                    
                    // Habilitar campos
                    nomeInput.disabled = false;
                    marcaSelect.disabled = false;
                    modeloSelect.disabled = false;
                } else {
                    mostrarMensagem(switch_data.mensagem || 'Erro ao carregar switch', 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar switch:', error);
                mostrarMensagem('Erro ao carregar switch', 'error');
            }
        }

        // Preencher formul√°rio com dados do switch
        function preencherFormulario(switch_data) {
            document.getElementById('nome').value = switch_data.nome || '';
            
            // Selecionar a marca
            const marcaSelect = document.getElementById('marca');
            marcaSelect.value = switch_data.marca || '';
            
            // Atualizar os modelos baseado na marca selecionada
            atualizarModelos();
            
            // Selecionar o modelo imediatamente ap√≥s atualizar os modelos
            const modeloSelect = document.getElementById('modelo');
            modeloSelect.value = switch_data.modelo || '';
        }

        // Mostrar informa√ß√µes do switch
        function mostrarInfoSwitch(switch_data) {
            document.getElementById('switchId').textContent = switch_data.id;
            
            // Converter para fuso hor√°rio local
            const dataCriacao = new Date(switch_data.data_criacao);
            const dataLocal = dataCriacao.toLocaleString('pt-BR', {
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            document.getElementById('switchDataCriacao').textContent = dataLocal;
            document.getElementById('switchInfo').style.display = 'block';
        }

        // Limpar formul√°rio
        function limparFormulario() {
            const nomeInput = document.getElementById('nome');
            const marcaSelect = document.getElementById('marca');
            const modeloSelect = document.getElementById('modelo');
            
            nomeInput.value = '';
            marcaSelect.value = '';
            modeloSelect.innerHTML = '<option value="">Selecione a marca primeiro</option>';
            
            // Desabilitar campos
            nomeInput.disabled = true;
            marcaSelect.disabled = true;
            modeloSelect.disabled = true;
        }

        // Mostrar mensagem
        function mostrarMensagem(texto, tipo) {
            const msg = document.getElementById('msg');
            msg.innerText = texto;
            if (tipo === 'success') {
                msg.className = 'mt-4 p-4 rounded-lg text-center font-medium bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300';
            } else if (tipo === 'error') {
                msg.className = 'mt-4 p-4 rounded-lg text-center font-medium bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300';
            } else {
                msg.className = 'mt-4 p-4 rounded-lg text-center font-medium bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300';
            }
            setTimeout(() => {
                msg.innerText = '';
                msg.className = 'mt-4 p-4 rounded-lg text-center font-medium';
            }, 3000);
        }

        // Envio do formul√°rio de edi√ß√£o
        document.getElementById('formEditarSwitch').onsubmit = async function (e) {
            e.preventDefault();
            const form = e.target;
            const msgDiv = document.getElementById('msg');
            // Validar se todos os campos obrigat√≥rios est√£o preenchidos
            if (!form.nome.value.trim() || !form.marca.value || !form.modelo.value) {
                msgDiv.innerText = 'Por favor, preencha todos os campos obrigat√≥rios!';
                msgDiv.className = 'mt-4 p-4 rounded-lg text-center font-medium bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300';
                return;
            }
            // Valida√ß√£o do padr√£o do nome do switch
            const nome = form.nome.value.trim();
            if (!/^Switch\s*\d+\s*-\s*/i.test(nome)) {
                msgDiv.innerText = 'O nome deve seguir o padr√£o: Switch XX - Descri√ß√£o';
                msgDiv.className = 'mt-4 p-4 rounded-lg text-center font-medium bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300';
                return;
            }
            
            if (!switchAtual) {
                mostrarMensagem('Selecione um switch primeiro', 'error');
                return;
            }

            const dados = {
                nome: document.getElementById('nome').value,
                marca: document.getElementById('marca').value,
                modelo: document.getElementById('modelo').value
            };

            try {
                const resp = await fetch(`/switches/${switchAtual.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });

                const json = await resp.json();
                
                if (json.status === 'ok') {
                    mostrarMensagem('Switch atualizado com sucesso!', 'success');
                    // Aguardar um pouco para mostrar a mensagem e depois redirecionar
                    setTimeout(() => {
                        window.location.href = 'config-admin.html';
                    }, 1500);
                } else {
                    mostrarMensagem(json.mensagem || 'Erro ao atualizar switch', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem('Erro ao atualizar switch', 'error');
            }
        };

        function voltarPainelConfig() {
            fetch('/perfil').then(resp => resp.json()).then(perfil => {
                if (perfil.nivel === 'admin') {
                    window.location.href = 'config-admin.html';
                } else if (perfil.nivel === 'tecnico') {
                    window.location.href = 'config-tecnico.html';
                } else {
                    window.location.href = 'config-usuario.html';
                }
            });
        }

        // Carregar switches ao iniciar a p√°gina
        carregarSwitches();

        window.addEventListener('DOMContentLoaded', function() {
            fetch('/empresa_atual')
                .then(resp => resp.json())
                .then(data => {
                    LogoManager.loadEmpresaLogo(data);
                });
        });
    </script>
    <script src="static/js/logo-manager.js"></script>
    </body>

</html> 
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Gerenciar Portas Switch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="static/img/favicon-lista.png">
    <script>
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
        // Atualizar logo da empresa quando o tema mudar
        updateEmpresaLogo();
      }
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
</head>

<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
    <div class="relative w-full max-w-7xl mx-auto bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-8 mt-8">
        <button onclick="voltarPainelConfig()" class="absolute top-4 left-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-2 transition-colors" title="Voltar">
            <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="empresa-logada" class="absolute top-4 right-4 text-indigo-500 font-bold bg-gray-800 dark:bg-transparent rounded-lg p-2"></div>
        <button onclick="toggleDarkMode()" class="absolute top-4 left-16 bg-gray-200 dark:bg-gray-700 rounded-full p-2 transition-colors" title="Alternar modo escuro">
            <span class="dark:hidden">üåô</span><span class="hidden dark:inline">‚òÄÔ∏è</span>
        </button>
        <div class="text-center mt-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">Gerenciar Portas de Switch</h1>
        </div>
        
        <div class="mb-6">
            <label for="switchSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Selecione o Switch:</label>
            <div class="flex flex-col sm:flex-row gap-4">
                <select id="switchSelect" onchange="carregarPortas()" class="flex-1 px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white dark:border-gray-600">
                    <option value="">Selecione um switch...</option>
                </select>
                <button id="btnAdicionarPorta" onclick="abrirModalPorta()" class="bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-700 dark:hover:bg-indigo-800 text-white px-6 py-2 rounded-lg transition-colors flex items-center gap-2" style="display:none;">
                    <i class="fas fa-plus"></i> ADICIONAR PORTA
                </button>
                <button id="btnAdicionarTodasPortas" class="bg-green-600 hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-800 text-white px-6 py-2 rounded-lg transition-colors flex items-center gap-2" style="display:none;">
                    <i class="fas fa-layer-group"></i> ADICIONAR TODAS AS PORTAS
                </button>
            </div>
        </div>

        <div id="portasGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <!-- Portas ser√£o carregadas aqui -->
        </div>

        <div id="msg" class="mt-6 p-4 rounded-lg text-center font-medium"></div>
    </div>

    <!-- Modal para conectar equipamento -->
    <div id="modalConectar" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
            <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Conectar Equipamento</h2>
            <form id="formConectar" class="space-y-4">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Porta:</label>
                    <input type="text" id="portaNumero" readonly class="w-full px-4 py-2 rounded-lg border border-gray-300 bg-gray-100 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 cursor-not-allowed">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Equipamento:</label>
                    <select id="equipamentoSelect" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white dark:border-gray-600">
                        <option value="">Selecione um equipamento...</option>
                    </select>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="fecharModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-700 dark:hover:bg-indigo-800 text-white px-4 py-2 rounded-lg transition-colors">Conectar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para adicionar porta -->
    <div id="modalPorta" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
            <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Adicionar Porta</h2>
            <form id="formPorta" class="space-y-4">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">N√∫mero da Porta:</label>
                    <select id="numeroPorta" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white dark:border-gray-600">
                        <option value="">Selecione...</option>
                        <!-- op√ß√µes de 1 a 48 -->
                    </select>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Descri√ß√£o:</label>
                    <input type="text" id="descricaoPorta" placeholder="Ex: Porta para sala de reuni√£o" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white dark:border-gray-600">
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="fecharModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-800 text-white px-4 py-2 rounded-lg transition-colors">Adicionar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let switchAtual = null;
        let portaSelecionada = null;

        // Carregar switches
        async function carregarSwitches() {
            try {
                const resp = await fetch('/switches');
                const switches = await resp.json();
                const select = document.getElementById('switchSelect');
                select.innerHTML = '<option value="">Selecione um switch...</option>';
                switches.forEach(switch_ => {
                    const opt = document.createElement('option');
                    opt.value = switch_.id;
                    opt.textContent = `${switch_.nome} (${switch_.marca} ${switch_.modelo})`;
                    select.appendChild(opt);
                });
                // Sempre volta para a op√ß√£o vazia ao recarregar a lista
                select.value = "";
                carregarPortas(); // Para garantir que o bot√£o suma ao recarregar
            } catch (error) {
                console.error('Erro ao carregar switches:', error);
            }
        }

        // Carregar portas do switch selecionado
        async function carregarPortas() {
            const switchId = document.getElementById('switchSelect').value;
            const btnAdicionar = document.getElementById('btnAdicionarPorta');
            const btnAdicionarTodas = document.getElementById('btnAdicionarTodasPortas');
            if (switchId) {
                btnAdicionar.style.display = 'block';
                btnAdicionarTodas.style.display = 'block';
            } else {
                btnAdicionar.style.display = 'none';
                btnAdicionarTodas.style.display = 'none';
            }
            console.log('Switch selecionado:', switchId);
            
            if (!switchId) {
                console.log('Nenhum switch selecionado');
                document.getElementById('portasGrid').innerHTML = '<div class="col-span-full text-center text-gray-500 dark:text-gray-400 py-8">Selecione um switch para ver suas portas</div>';
                return;
            }

            try {
                console.log('Carregando portas para switch ID:', switchId);
                const resp = await fetch(`/switch-portas/${switchId}`);
                console.log('Resposta das portas:', resp);
                
                if (!resp.ok) {
                    console.error('Erro ao carregar portas:', resp.status, resp.statusText);
                    document.getElementById('portasGrid').innerHTML = '<div class="col-span-full text-center text-red-500 dark:text-red-400 py-8">Erro ao carregar portas</div>';
                    return;
                }
                
                const portas = await resp.json();
                console.log('Portas carregadas:', portas);
                switchAtual = switchId;
                
                const grid = document.getElementById('portasGrid');
                grid.innerHTML = '';
                
                if (portas.length === 0) {
                    console.log('Nenhuma porta encontrada');
                    grid.innerHTML = `
                        <div class="col-span-full text-center py-8 bg-gray-50 dark:bg-gray-800 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600">
                            <p class="text-gray-600 dark:text-gray-400 mb-4 text-lg">Nenhuma porta configurada para este switch.</p>
                            <p class="text-gray-500 dark:text-gray-500 text-sm">Use o bot√£o "ADICIONAR PORTA" acima para criar a primeira porta.</p>
                        </div>
                    `;
                    return;
                }

                portas.forEach(porta => {
                    const card = criarCardPorta(porta);
                    grid.appendChild(card);
                });

            } catch (error) {
                console.error('Erro ao carregar portas:', error);
                document.getElementById('portasGrid').innerHTML = '<div class="col-span-full text-center text-red-500 dark:text-red-400 py-8">Erro ao carregar portas</div>';
            }
        }

        // Criar card de porta
        function criarCardPorta(porta) {
            const card = document.createElement('div');
            card.className = `bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 p-4 ${porta.status === 'ocupada' ? 'ring-2 ring-red-200 dark:ring-red-800' : 'ring-2 ring-green-200 dark:ring-green-800'}`;
            
            const equipamentoInfo = porta.equipamento_conectado ? `
                <div class="mt-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <h4 class="font-semibold text-gray-800 dark:text-white mb-2">Equipamento Conectado:</h4>
                    <div class="text-sm text-gray-600 dark:text-gray-300 space-y-1">
                        <div><strong>${porta.equipamento_conectado.nome}</strong></div>
                        <div>Tipo: ${porta.equipamento_conectado.tipo}</div>
                        <div>Sala: ${porta.equipamento_conectado.sala_nome || 'Sem sala'}</div>
                        <div>IP 1: ${porta.equipamento_conectado.ip1 || '-'}</div>
                        <div>MAC 1: <span class="font-mono text-xs">${porta.equipamento_conectado.mac1 || '-'}</span></div>
                        <div>IP 2: ${porta.equipamento_conectado.ip2 || '-'}</div>
                        <div>MAC 2: <span class="font-mono text-xs">${porta.equipamento_conectado.mac2 || '-'}</span></div>
                    </div>
                </div>
            ` : '';

            const actions = porta.status === 'livre' ? `
                <button class="w-full bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-700 dark:hover:bg-indigo-800 text-white px-4 py-2 rounded-lg transition-colors flex items-center justify-center gap-2" onclick="conectarEquipamento(${porta.id}, ${porta.numero_porta})">
                    <i class="fas fa-plug"></i> Conectar
                </button>
            ` : `
                <button class="w-full bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 text-white px-4 py-2 rounded-lg transition-colors flex items-center justify-center gap-2" onclick="desconectarEquipamento(${porta.id})">
                    <i class="fas fa-unlink"></i> Desconectar
                </button>
            `;

            card.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <span class="font-semibold text-gray-800 dark:text-white">Porta ${porta.numero_porta}</span>
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${porta.status === 'livre' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' : 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200'}">
                        ${porta.status.toUpperCase()}
                    </span>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-300 mb-3">${porta.descricao || 'Sem descri√ß√£o'}</div>
                ${equipamentoInfo}
                <div class="mt-4">
                    ${actions}
                </div>
            `;
            
            // Adiciona evento de clique para portas ocupadas
            if (porta.status === 'ocupada') {
                card.style.cursor = 'pointer';
                card.title = 'Clique para desconectar o equipamento';
                card.addEventListener('click', function(e) {
                    // Evita disparar o clique se clicou em um bot√£o
                    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                        return;
                    }
                    desconectarEquipamento(porta.id);
                });
            }
            
            return card;
        }

        // Conectar equipamento
        async function conectarEquipamento(portaId, numeroPorta) {
            portaSelecionada = portaId;
            document.getElementById('portaNumero').value = `Porta ${numeroPorta}`;
            
            // Carregar equipamentos dispon√≠veis
            try {
                const resp = await fetch('/equipamentos?conectaveis=1');
                const equipamentos = await resp.json();
                const select = document.getElementById('equipamentoSelect');
                
                select.innerHTML = '<option value="">Selecione um equipamento...</option>';
                equipamentos.forEach(eq => {
                    const opt = document.createElement('option');
                    opt.value = eq.id;
                    opt.textContent = `${eq.nome} (${eq.tipo}) - Sala: ${eq.sala_nome}`;
                    select.appendChild(opt);
                });
            } catch (error) {
                console.error('Erro ao carregar equipamentos:', error);
            }
            
            document.getElementById('modalConectar').classList.remove('hidden');
        }

        // Desconectar equipamento
        async function desconectarEquipamento(portaId) {
            if (!confirm('Tem certeza que deseja desconectar este equipamento?')) {
                return;
            }

            try {
                // Primeiro, buscar a conex√£o
                const resp = await fetch('/conexoes');
                const conexoes = await resp.json();
                const conexao = conexoes.find(c => c.porta_id === portaId);
                
                if (conexao) {
                    const deleteResp = await fetch(`/conexoes/${conexao.id}`, {
                        method: 'DELETE'
                    });
                    
                    if (deleteResp.ok) {
                        mostrarMensagem('Equipamento desconectado com sucesso!', 'success');
                        carregarPortas();
                    } else {
                        mostrarMensagem('Erro ao desconectar equipamento', 'error');
                    }
                }
            } catch (error) {
                console.error('Erro ao desconectar:', error);
                mostrarMensagem('Erro ao desconectar equipamento', 'error');
            }
        }

        // Abrir modal para adicionar porta
        async function abrirModalPorta() {
            // Buscar portas j√° cadastradas para o switch atual
            const select = document.getElementById('numeroPorta');
            // Limpa o select
            select.innerHTML = '<option value="">Selecione...</option>';
            if (!switchAtual) {
                alert('Selecione um switch primeiro!');
                return;
            }
            try {
                const resp = await fetch(`/switch-portas/${switchAtual}`);
                const portas = await resp.json();
                const ocupadas = portas.map(p => Number(p.numero_porta));
                for (let i = 1; i <= 48; i++) {
                    if (!ocupadas.includes(i)) {
                        const opt = document.createElement('option');
                        opt.value = i;
                        opt.textContent = i;
                        select.appendChild(opt);
                    }
                }
            } catch (error) {
                console.error('Erro ao buscar portas existentes:', error);
            }
            document.getElementById('modalPorta').classList.remove('hidden');
        }

        // Fechar modais
        function fecharModal() {
            document.getElementById('modalConectar').classList.add('hidden');
            document.getElementById('modalPorta').classList.add('hidden');
        }

        // Mostrar mensagem
        function mostrarMensagem(texto, tipo) {
            const msg = document.getElementById('msg');
            msg.innerText = texto;
            if (tipo === 'success') {
                msg.className = 'mt-6 p-4 rounded-lg text-center font-medium bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300';
            } else if (tipo === 'error') {
                msg.className = 'mt-6 p-4 rounded-lg text-center font-medium bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300';
            } else {
                msg.className = 'mt-6 p-4 rounded-lg text-center font-medium bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300';
            }
            setTimeout(() => {
                msg.innerText = '';
                msg.className = 'mt-6 p-4 rounded-lg text-center font-medium';
            }, 3000);
        }

        // Event listeners
        document.getElementById('formConectar').onsubmit = async function(e) {
            e.preventDefault();
            
            const equipamentoId = document.getElementById('equipamentoSelect').value;
            if (!equipamentoId) {
                mostrarMensagem('Selecione um equipamento', 'error');
                return;
            }

            try {
                const resp = await fetch('/conexoes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        porta_id: portaSelecionada,
                        equipamento_id: equipamentoId
                    })
                });

                const json = await resp.json();
                
                if (json.status === 'ok') {
                    mostrarMensagem('Equipamento conectado com sucesso!', 'success');
                    fecharModal();
                    carregarPortas();
                } else {
                    mostrarMensagem(json.mensagem || 'Erro ao conectar equipamento', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem('Erro ao conectar equipamento', 'error');
            }
        };

        document.getElementById('formPorta').onsubmit = async function(e) {
            e.preventDefault();
            
            const numeroPorta = document.getElementById('numeroPorta').value;
            const descricao = document.getElementById('descricaoPorta').value;

            try {
                const resp = await fetch('/switch-portas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        switch_id: switchAtual,
                        numero_porta: parseInt(numeroPorta),
                        descricao: descricao
                    })
                });

                const json = await resp.json();
                
                if (json.status === 'ok') {
                    mostrarMensagem('Porta adicionada com sucesso!', 'success');
                    fecharModal();
                    carregarPortas();
                    document.getElementById('formPorta').reset();
                } else {
                    mostrarMensagem(json.mensagem || 'Erro ao adicionar porta', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem('Erro ao adicionar porta', 'error');
            }
        };

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modals = document.querySelectorAll('#modalConectar, #modalPorta');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        };

        // Inicializar
        carregarSwitches();

        document.addEventListener('DOMContentLoaded', function() {
            const btn = document.getElementById('btnAdicionarPorta');
            const select = document.getElementById('switchSelect');
            btn.style.display = 'none';
            select.addEventListener('change', function() {
                if (this.value) {
                    btn.style.display = 'block';
                } else {
                    btn.style.display = 'none';
                }
            });
        });

        function voltarPainelConfig() {
            fetch('/perfil').then(resp => resp.json()).then(perfil => {
                if (perfil.nivel === 'admin') {
                    window.location.href = 'config-admin.html';
                } else if (perfil.nivel === 'tecnico') {
                    window.location.href = 'config-tecnico.html';
                } else {
                    window.location.href = 'config-usuario.html';
                }
            });
        }

        // Mostrar/ocultar bot√µes ao selecionar switch
        async function atualizarBotoesAdicionar() {
            const switchId = document.getElementById('switchSelect').value;
            const btnAdicionar = document.getElementById('btnAdicionarPorta');
            const btnAdicionarTodas = document.getElementById('btnAdicionarTodasPortas');
            if (switchId) {
                btnAdicionar.style.display = 'block';
                btnAdicionarTodas.style.display = 'block';
                // Checar se todas as portas j√° foram adicionadas
                let numPortasPadrao = 48;
                try {
                    const resp = await fetch(`/switch-portas/${switchId}`);
                    const portas = await resp.json();
                    if (portas.length >= numPortasPadrao) {
                        btnAdicionarTodas.disabled = true;
                        btnAdicionarTodas.title = 'Todas as portas j√° foram adicionadas para este switch.';
                    } else {
                        btnAdicionarTodas.disabled = false;
                        btnAdicionarTodas.title = '';
                    }
                } catch (e) {
                    btnAdicionarTodas.disabled = false;
                    btnAdicionarTodas.title = '';
                }
            } else {
                btnAdicionar.style.display = 'none';
                btnAdicionarTodas.style.display = 'none';
            }
        }
        document.getElementById('switchSelect').addEventListener('change', atualizarBotoesAdicionar);
        // Chamar ao carregar tamb√©m
        atualizarBotoesAdicionar();

        // Adicionar todas as portas
        document.getElementById('btnAdicionarTodasPortas').onclick = async function() {
            if (this.disabled) return;
            if (!switchAtual) {
                alert('Selecione um switch primeiro!');
                return;
            }
            let numPortas = prompt('Quantas portas deseja criar para este switch? (Ex: 24 ou 48)', '48');
            numPortas = parseInt(numPortas);
            if (!numPortas || numPortas < 1 || numPortas > 96) {
                alert('N√∫mero de portas inv√°lido. Informe um valor entre 1 e 96.');
                return;
            }
            try {
                const resp = await fetch(`/switch-portas/${switchAtual}`);
                const portas = await resp.json();
                const ocupadas = portas.map(p => Number(p.numero_porta));
                if (portas.length >= numPortas) {
                    mostrarMensagem('Todas as portas j√° foram adicionadas para este switch.', 'error');
                    return;
                }
                let criadas = 0;
                for (let i = 1; i <= numPortas; i++) {
                    if (!ocupadas.includes(i)) {
                        const respAdd = await fetch('/switch-portas', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                switch_id: switchAtual,
                                numero_porta: i,
                                descricao: ''
                            })
                        });
                        const json = await respAdd.json();
                        if (json.status === 'ok') criadas++;
                    }
                }
                mostrarMensagem(`${criadas} porta(s) adicionada(s) com sucesso!`, 'success');
                carregarPortas();
                atualizarBotoesAdicionar();
            } catch (error) {
                console.error('Erro ao adicionar portas em massa:', error);
                mostrarMensagem('Erro ao adicionar portas em massa', 'error');
            }
        };

        window.addEventListener('DOMContentLoaded', function() {
            fetch('/empresa_atual')
                .then(resp => resp.json())
                .then(data => {
                    LogoManager.loadEmpresaLogo(data);
                });
        });
    </script>
    <script src="static/js/logo-manager.js"></script>
    </body>

</html> 
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Estat√≠sticas do Sistema</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' };</script>
  <link rel="stylesheet" href="css/estilo-base.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="static/js/chart.min.js"></script>
  <link rel="icon" type="image/png" href="static/img/favicon-dashboard.png">
  <style>
    .dashboard-card {
      background: linear-gradient(135deg, #6366f1 0%, #60a5fa 100%);
      color: #fff;
      border-radius: 1.2rem;
      box-shadow: 0 4px 24px #0002;
      padding: 1.3rem 1rem 1rem 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 110px;
      position: relative;
      overflow: hidden;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .dashboard-card:hover {
      transform: translateY(-4px) scale(1.03);
      box-shadow: 0 8px 32px #0003;
    }
    .dashboard-card .icon-bg {
      position: absolute;
      top: -24px;
      right: -24px;
      font-size: 5.5rem;
      color: #fff2;
      pointer-events: none;
      z-index: 0;
    }
    .dashboard-card .icon {
      font-size: 1.5rem;
      margin-bottom: 0.3rem;
      z-index: 1;
    }
    .dashboard-card .title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.1rem;
      z-index: 1;
      letter-spacing: 0.01em;
    }
    .dashboard-card .value {
      font-size: 1.6rem;
      font-weight: 800;
      z-index: 1;
      margin-bottom: 0.1rem;
    }
    .dashboard-card .desc {
      font-size: 0.85rem;
      color: #e0e7ff;
      z-index: 1;
    }
    @media (max-width: 640px) {
      .dashboard-card { min-height: 80px; padding: 0.7rem 0.4rem; }
      .dashboard-card .value { font-size: 1.1rem; }
      .dashboard-card .icon-bg { font-size: 2.2rem; }
    }
    .chart-container {
      background: #fff;
      border-radius: 1.2rem;
      box-shadow: 0 4px 24px #0001;
      padding: 1.5rem 1.2rem;
      margin-bottom: 2rem;
      min-height: 340px;
      transition: box-shadow 0.15s;
    }
    .dark .chart-container {
      background: #181e2a;
    }
    .chart-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #3730a3;
      margin-bottom: 1.2rem;
    }
    .dark .chart-title {
      color: #a5b4fc;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen flex flex-col items-center justify-center dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
  <button onclick="voltarPainelConfig()" class="fixed top-6 left-6 z-50 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-3 transition-colors shadow-lg" title="Voltar ao painel">
    <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
  </button>
  <div class="w-full max-w-7xl mx-auto mt-10 mb-10 px-2">
    <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
      <h1 class="text-3xl font-bold text-gray-800 dark:text-white">
        <i class="fas fa-chart-line text-indigo-600 dark:text-indigo-400 mr-3"></i>
        Dashboard do Sistema
      </h1>
      <div class="flex gap-2">
        <button onclick="toggleDarkMode()" class="bg-gray-200 dark:bg-gray-700 rounded-full p-3 transition-colors ml-1" title="Alternar modo escuro">
          <span class="dark:hidden">üåô</span><span class="hidden dark:inline">‚òÄÔ∏è</span>
        </button>
      </div>
    </div>
    <div class="mb-10">
      <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Equipamentos</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-8" id="cardsEquipamentos"></div>
      <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Salas</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6 mb-8" id="cardsSalas"></div>
      <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Switches</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="cardsSwitches"></div>
      <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Cabos</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" id="cardsCabos"></div>
    </div>
    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 mt-12">Gr√°ficos de Equipamentos e Switches</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8" id="dashboardCharts">
      <div class="chart-container">
        <div class="chart-title">Equipamentos por Tipo</div>
        <canvas id="chartTipos"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">Equipamentos Dependentes de Rede</div>
        <canvas id="chartRede"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">Ocupa√ß√£o de Portas de Switch</div>
        <canvas id="chartPortas"></canvas>
      </div>
      <div class="chart-container md:col-span-3">
        <div class="chart-title">Equipamentos por Marca</div>
        <canvas id="chartMarcas"></canvas>
      </div>
      <div class="chart-container md:col-span-3">
        <div class="chart-title">Equipamentos por Sala</div>
        <canvas id="chartSalas"></canvas>
      </div>
    </div>
  </div>
  <script>
    function toggleDarkMode() {
      if (document.documentElement.classList.contains('dark')) {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', 'light');
      } else {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme', 'dark');
      }
    }
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
    } else if (localStorage.getItem('theme') === 'light') {
      document.documentElement.classList.remove('dark');
    }

    let equipamentos = [];
    let salas = [];
    let switches = [];
    let portas = [];
    let cabos = [];
    let conexoesCabos = [];
    async function fetchData() {
      const [equipResp, salasResp, switchesResp, cabosResp, conexoesResp] = await Promise.all([
        fetch('/equipamentos'),
        fetch('/salas'),
        fetch('/switches'),
        fetch('/cabos'),
        fetch('/conexoes-cabos')
      ]);
      equipamentos = await equipResp.json();
      salas = await salasResp.json();
      switches = await switchesResp.json();
      cabos = await cabosResp.json();
      conexoesCabos = await conexoesResp.json();
      // Buscar todas as portas de todos os switches
      portas = [];
      await Promise.all(switches.map(async (sw) => {
        const resp = await fetch(`/switch-portas/${sw.id}`);
        if (resp.ok) {
          const portasSwitch = await resp.json();
          portas = portas.concat(portasSwitch);
        }
      }));
      renderCards();
      renderCharts();
    }
    function renderCards() {
      const tipos = {};
      let funcionando = 0, defeito = 0, rede = 0;
      equipamentos.forEach(eq => {
        if (!tipos[eq.tipo]) tipos[eq.tipo] = 0;
        tipos[eq.tipo]++;
        if (eq.defeito === 1 || eq.defeito === true || eq.defeito === '1') {
          defeito++;
        } else {
          funcionando++;
        }
        if (eq.dados && (eq.dados.ip1 || eq.dados.mac1 || eq.dados.ip2 || eq.dados.mac2)) {
          rede++;
        }
      });
      // Estat√≠sticas de marcas
      const marcasSet = new Set(equipamentos.map(eq => eq.marca).filter(Boolean));
      const totalMarcas = marcasSet.size;
      // Estat√≠sticas de portas
      const totalSwitches = switches.length;
      const totalPortas = portas.length;
      const portasOcupadas = portas.filter(p => p.status === 'ocupada').length;
      const portasLivres = portas.filter(p => p.status === 'livre').length;
      const cardsEquipamentos = [
        {
          icon: 'fa-boxes',
          iconBg: 'fa-cubes',
          title: 'Total de Equipamentos',
          value: equipamentos.length,
          desc: 'Todos os equipamentos cadastrados',
          bg: 'from-indigo-500 to-blue-500'
        },
        {
          icon: 'fa-check-circle',
          iconBg: 'fa-heart',
          title: 'Funcionando',
          value: funcionando,
          desc: 'Equipamentos sem defeito',
          bg: 'from-green-500 to-lime-500'
        },
        {
          icon: 'fa-times-circle',
          iconBg: 'fa-exclamation-triangle',
          title: 'Defeito',
          value: defeito,
          desc: 'Equipamentos com defeito',
          bg: 'from-red-500 to-pink-500'
        },
        {
          icon: 'fa-network-wired',
          iconBg: 'fa-wifi',
          title: 'Dependem de Rede',
          value: rede,
          desc: 'Equipamentos com IP ou MAC',
          bg: 'from-emerald-500 to-teal-500'
        },
        {
          icon: 'fa-tags',
          iconBg: 'fa-tag',
          title: 'Marcas de Equipamentos',
          value: totalMarcas,
          desc: 'Marcas distintas cadastradas',
          bg: 'from-pink-500 to-fuchsia-500'
        }
      ];
      const salasComAndar = salas.filter(s => s.andar_id !== null && s.andar_id !== undefined);
      const salasPorAndar = {};
      salasComAndar.forEach(s => {
        const andar = s.andar_id;
        if (!salasPorAndar[andar]) salasPorAndar[andar] = 0;
        salasPorAndar[andar]++;
      });
      const maxSalas = Object.values(salasPorAndar).length > 0 ? Math.max(...Object.values(salasPorAndar)) : 0;
      const andarMax = Object.entries(salasPorAndar).find(([_, qtd]) => qtd === maxSalas)?.[0] || '-';
      const tooltipAndares = Object.entries(salasPorAndar).map(([andar, qtd]) => `Andar ${andar}: ${qtd} sala${qtd>1?'s':''}`).join('\n');
      // Calcular equipamentos por sala (apenas salas com andar definido)
      const eqPorSalaCount = {};
      salasComAndar.forEach(sala => {
        eqPorSalaCount[sala.nome] = 0;
      });
      equipamentos.forEach(eq => {
        const sala = salasComAndar.find(s => s.id === eq.sala_id);
        if (sala) eqPorSalaCount[sala.nome]++;
      });
      const maxEq = Math.max(...Object.values(eqPorSalaCount));
      const minEq = Math.min(...Object.values(eqPorSalaCount));
      const salaMaxEq = Object.entries(eqPorSalaCount).find(([_, qtd]) => qtd === maxEq)?.[0] || '-';
      const salaMinEq = Object.entries(eqPorSalaCount).find(([_, qtd]) => qtd === minEq)?.[0] || '-';
      const cardsSalas = [
        {
          icon: 'fa-door-open',
          iconBg: 'fa-building',
          title: 'Total de Salas',
          value: salasComAndar.length,
          desc: 'Salas cadastradas no sistema',
          bg: 'from-blue-500 to-cyan-500'
        },
        {
          icon: 'fa-layer-group',
          iconBg: 'fa-layer-group',
          title: 'Salas no Andar com Mais Salas',
          value: maxSalas,
          desc: `No Andar ${andarMax}`,
          bg: 'from-indigo-500 to-purple-500',
          tooltip: tooltipAndares
        },
        {
          icon: 'fa-arrow-up',
          iconBg: 'fa-arrow-up',
          title: 'Sala com Mais Equipamentos',
          value: maxEq,
          desc: salaMaxEq,
          bg: 'from-green-500 to-lime-500'
        },
        {
          icon: 'fa-arrow-down',
          iconBg: 'fa-arrow-down',
          title: 'Sala com Menos Equipamentos',
          value: minEq,
          desc: salaMinEq,
          bg: 'from-red-500 to-pink-500'
        }
      ];
      const cardsSwitches = [
        {
          icon: 'fa-network-wired',
          iconBg: 'fa-server',
          title: 'Total de Switches',
          value: totalSwitches,
          desc: 'Switches cadastrados',
          bg: 'from-purple-500 to-indigo-500'
        },
        {
          icon: 'fa-ethernet',
          iconBg: 'fa-plug',
          title: 'Total de Portas',
          value: totalPortas,
          desc: 'Portas de todos os switches',
          bg: 'from-yellow-500 to-orange-500'
        },
        {
          icon: 'fa-plug',
          iconBg: 'fa-bolt',
          title: 'Portas Ocupadas',
          value: portasOcupadas,
          desc: `De ${totalPortas} portas`,
          bg: 'from-rose-500 to-pink-500'
        },
        {
          icon: 'fa-unlink',
          iconBg: 'fa-circle',
          title: 'Portas Livres',
          value: portasLivres,
          desc: `De ${totalPortas} portas`,
          bg: 'from-green-500 to-lime-500'
        }
      ];
      
      // Estat√≠sticas de cabos
      const totalCabos = cabos.length;
      const conexoesAtivas = conexoesCabos.filter(c => !c.data_desconexao).length;
      const conexoesInativas = conexoesCabos.filter(c => c.data_desconexao).length;
      const tiposCabos = new Set(cabos.map(c => c.tipo)).size;
      
      const cardsCabos = [
        {
          icon: 'fa-plug',
          iconBg: 'fa-plug',
          title: 'Total de Cabos',
          value: totalCabos,
          desc: 'Cabos cadastrados no sistema',
          bg: 'from-blue-500 to-cyan-500'
        },
        {
          icon: 'fa-link',
          iconBg: 'fa-check-circle',
          title: 'Conex√µes Ativas',
          value: conexoesAtivas,
          desc: 'Cabos conectados',
          bg: 'from-green-500 to-lime-500'
        },
        {
          icon: 'fa-unlink',
          iconBg: 'fa-times-circle',
          title: 'Conex√µes Inativas',
          value: conexoesInativas,
          desc: 'Cabos desconectados',
          bg: 'from-red-500 to-pink-500'
        },
        {
          icon: 'fa-tags',
          iconBg: 'fa-tag',
          title: 'Tipos de Cabos',
          value: tiposCabos,
          desc: 'Tipos diferentes cadastrados',
          bg: 'from-purple-500 to-indigo-500'
        }
      ];
      
      function renderCardArray(cards, containerId) {
        let html = '';
        cards.forEach(card => {
          html += `<div class="dashboard-card bg-gradient-to-br ${card.bg}"${card.tooltip ? ` title="${card.tooltip}"` : ''}>
            <i class="fas ${card.icon} icon"></i>
            <span class="icon-bg fas ${card.iconBg}"></span>
            <div class="title">${card.title}</div>
            <div class="value">${card.value}</div>
            <div class="desc">${card.desc}</div>
          </div>`;
        });
        document.getElementById(containerId).innerHTML = html;
      }
      renderCardArray(cardsEquipamentos, 'cardsEquipamentos');
      renderCardArray(cardsSalas, 'cardsSalas');
      renderCardArray(cardsSwitches, 'cardsSwitches');
      renderCardArray(cardsCabos, 'cardsCabos');
    }
    function renderCharts() {
      // Tipos de equipamentos (doughnut com agrupamento de 'Outros')
      const tipos = {};
      equipamentos.forEach(eq => {
        if (!tipos[eq.tipo]) tipos[eq.tipo] = 0;
        tipos[eq.tipo]++;
      });
      let tiposLabels = Object.keys(tipos);
      let tiposData = Object.values(tipos);
      const tiposColors = [
        '#6366f1','#22d3ee','#f59e42','#f43f5e','#10b981','#eab308','#a21caf','#f87171','#0ea5e9','#facc15','#14b8a6','#f472b6'
      ];
      // Agrupar tipos menores em 'Outros' se houver muitos
      if (tiposLabels.length > 7) {
        // Ordena do maior para o menor
        const zipped = tiposLabels.map((label, i) => [label, tiposData[i]]);
        zipped.sort((a, b) => b[1] - a[1]);
        const top = zipped.slice(0, 6);
        const outros = zipped.slice(6);
        const outrosCount = outros.reduce((sum, item) => sum + item[1], 0);
        tiposLabels = top.map(item => item[0]).concat('Outros');
        tiposData = top.map(item => item[1]).concat(outrosCount);
      }
      if (window.chartTipos && typeof window.chartTipos.destroy === 'function') window.chartTipos.destroy();
      window.chartTipos = new Chart(document.getElementById('chartTipos'), {
        type: 'doughnut',
        data: {
          labels: tiposLabels,
          datasets: [{
            data: tiposData,
            backgroundColor: tiposColors,
          }]
        },
        options: {
          plugins: {
            legend: { labels: { color: getComputedStyle(document.body).color } },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const value = context.parsed;
                  const percent = ((value / total) * 100).toFixed(1);
                  return `${context.label}: ${value} (${percent}%)`;
                }
              }
            }
          }
        }
      });
      // Equipamentos dependentes de rede (doughnut)
      let rede = 0, semRede = 0;
      equipamentos.forEach(eq => {
        if (eq.dados && (eq.dados.ip1 || eq.dados.mac1 || eq.dados.ip2 || eq.dados.mac2)) {
          rede++;
        } else {
          semRede++;
        }
      });
      if (window.chartRede && typeof window.chartRede.destroy === 'function') window.chartRede.destroy();
      window.chartRede = new Chart(document.getElementById('chartRede'), {
        type: 'doughnut',
        data: {
          labels: ['Dependem de Rede', 'N√£o Dependem'],
          datasets: [{
            data: [rede, semRede],
            backgroundColor: ['#10b981', '#f59e42'],
          }]
        },
        options: {
          plugins: {
            legend: { labels: { color: getComputedStyle(document.body).color } }
          }
        }
      });
      // Equipamentos por marca (barra)
      const marcas = {};
      equipamentos.forEach(eq => {
        if (!marcas[eq.marca]) marcas[eq.marca] = 0;
        marcas[eq.marca]++;
      });
      const marcasLabels = Object.keys(marcas);
      const marcasData = Object.values(marcas);
      if (window.chartMarcas && typeof window.chartMarcas.destroy === 'function') window.chartMarcas.destroy();
      window.chartMarcas = new Chart(document.getElementById('chartMarcas'), {
        type: 'bar',
        data: {
          labels: marcasLabels,
          datasets: [{
            label: 'Equipamentos',
            data: marcasData,
            backgroundColor: '#6366f1',
          }]
        },
        options: {
          plugins: {
            legend: { display: false },
          },
          scales: {
            x: { ticks: { color: getComputedStyle(document.body).color } },
            y: { ticks: { color: getComputedStyle(document.body).color } }
          }
        }
      });
      // Equipamentos por sala (barras)
      const salaMap = {};
      salas.forEach(s => salaMap[s.id] = s.nome);
      const eqPorSala = {};
      equipamentos.forEach(eq => {
        const salaNome = salaMap[eq.sala_id] || 'Estoque';
        if (!eqPorSala[salaNome]) eqPorSala[salaNome] = 0;
        eqPorSala[salaNome]++;
      });
      const salaLabels = Object.keys(eqPorSala);
      const salaData = Object.values(eqPorSala);
      if (window.chartSalas && typeof window.chartSalas.destroy === 'function') window.chartSalas.destroy();
      window.chartSalas = new Chart(document.getElementById('chartSalas'), {
        type: 'bar',
        data: {
          labels: salaLabels,
          datasets: [{
            label: 'Equipamentos',
            data: salaData,
            backgroundColor: '#a21caf',
          }]
        },
        options: {
          plugins: {
            legend: { display: false },
          },
          scales: {
            x: { ticks: { color: getComputedStyle(document.body).color } },
            y: { ticks: { color: getComputedStyle(document.body).color } }
          }
        }
      });
      // Gr√°fico de ocupa√ß√£o de portas
      if (document.getElementById('chartPortas')) {
        if (window.chartPortas && typeof window.chartPortas.destroy === 'function') window.chartPortas.destroy();
        const portasOcupadas = portas.filter(p => p.status === 'ocupada').length;
        const portasLivres = portas.filter(p => p.status === 'livre').length;
        window.chartPortas = new Chart(document.getElementById('chartPortas'), {
          type: 'doughnut',
          data: {
            labels: ['Ocupadas', 'Livres'],
            datasets: [{
              data: [portasOcupadas, portasLivres],
              backgroundColor: ['#ef4444', '#22c55e'], // vermelho para ocupadas, verde para livres
            }]
          },
          options: {
            plugins: {
              legend: { labels: { color: getComputedStyle(document.body).color } }
            }
          }
        });
      }
    }
    fetchData();
    // Atualizar gr√°ficos ao alternar dark mode
    document.querySelector('button[onclick="toggleDarkMode()"]')?.addEventListener('click', () => {
      setTimeout(renderCharts, 300);
    });

    function voltarPainelConfig() {
      fetch('/perfil').then(resp => resp.json()).then(perfil => {
        if (perfil.nivel === 'admin') {
          window.location.href = 'config-admin.html';
        } else if (perfil.nivel === 'tecnico') {
          window.location.href = 'config-tecnico.html';
        } else {
          window.location.href = 'config-usuario.html';
        }
      });
    }
  </script>
</body>
</html> 
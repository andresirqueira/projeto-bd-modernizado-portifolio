<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ver Switch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">`n    <script src="static/js/demo-banner.js"></script>
    <script>
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
        // Atualizar logo da empresa quando o tema mudar
        updateEmpresaLogo();
      }
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
    <script src="static/js/logo-manager.js"></script>
    <link rel="icon" type="image/png" href="static/img/favicon-olho.png">
</head>
<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
    <div class="relative w-full max-w-7xl mx-auto bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-8 mt-8">
        <button onclick="voltarPainelConfig()" class="absolute top-4 left-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-2 transition-colors" title="Voltar">
            <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="empresa-logada" class="absolute top-4 right-4 text-indigo-500 font-bold bg-gray-800 dark:bg-transparent rounded-lg p-2"></div>
        <button onclick="toggleDarkMode()" class="absolute top-4 left-16 bg-gray-200 dark:bg-gray-700 rounded-full p-2 transition-colors" title="Alternar modo escuro">
            <span class="dark:hidden">🌙</span><span class="hidden dark:inline">☀️</span>
        </button>
        <div class="text-center mt-8 mb-8">
            <div class="text-center mt-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">
                <i class="fas fa-eye text-indigo-600 dark:text-indigo-400 mr-3"></i>
                Visualizar Switches
            </h1>
            <p class="text-gray-600 dark:text-gray-300">Visualize todos os switches cadastrados no sistema</p>
        </div>
        </div>
        <div id="msg" class="mb-6 p-4 rounded-lg text-center font-medium" style="display:none;"></div>
        <div id="switchList" class="space-y-6"></div>
    </div>

    <!-- Modal para vincular switch -->
    <div id="modalVincular" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white">Vincular Switch</h3>
                    <button onclick="fecharModalVincular()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <p class="text-gray-600 dark:text-gray-300">Switch: <span id="switchNomeModal" class="font-semibold"></span></p>
                </div>
                <form id="formVincular">
                    <div class="space-y-4">
                        <div>
                            <label for="andarModal" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Andar:</label>
                            <select id="andarModal" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white">
                                <option value="">Selecione o andar</option>
                            </select>
                        </div>
                        <div>
                            <label for="idfModal" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">IDF Responsável:</label>
                            <select id="idfModal" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white">
                                <option value="">Selecione o IDF (opcional)</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="fecharModalVincular()" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-700 dark:hover:bg-indigo-800 text-white rounded-lg transition-colors">
                            Vincular
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        async function carregarSwitches() {
            try {
                const resp = await fetch('/switches');
                const switches = await resp.json();
                const container = document.getElementById('switchList');
                container.innerHTML = '';
                
                if (switches.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-8">Nenhum switch cadastrado.</div>';
                    return;
                }
                
                for (const sw of switches) {
                    // Buscar portas do switch
                    const respPortas = await fetch(`/switch-portas/${sw.id}`);
                    const portas = await respPortas.json();
                    
                                         const portasLivres = portas.filter(p => !p.equipamento_info && !p.patch_panel_info).length;
                     const portasOcupadas = portas.filter(p => p.equipamento_info || (p.patch_panel_info && p.patch_panel_info.equipamento)).length;
                     const portasMapeadas = portas.filter(p => p.patch_panel_info && !p.patch_panel_info.equipamento).length;
                    const totalPortas = portas.length;
                    
                    container.innerHTML += `
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
                            <div class="p-6">
                                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-4">
                                    <div class="flex-grow">
                                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">${sw.nome}</h3>
                                        <div class="text-sm text-gray-600 dark:text-gray-300 space-y-1">
                                            <div><strong>Marca:</strong> ${sw.marca}</div>
                                            <div><strong>Modelo:</strong> ${sw.modelo}</div>
                                            <div><strong>ID:</strong> ${sw.id}</div>
                                            <div><strong>Andar:</strong> ${sw.andar_titulo || 'Não vinculado'}</div>
                                            <div><strong>IDF Responsável:</strong> ${sw.idf_nome || 'Não vinculado'}</div>
                                        </div>
                                    </div>
                                    <div class="flex flex-wrap gap-3">
                                        <div class="flex items-center gap-2 bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 px-3 py-2 rounded-lg">
                                            <i class="fas fa-network-wired"></i>
                                            <span class="font-semibold">Total: ${totalPortas}</span>
                                        </div>
                                        <div class="flex items-center gap-2 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-3 py-2 rounded-lg">
                                            <i class="fas fa-check-circle"></i>
                                            <span class="font-semibold">Livres: ${portasLivres}</span>
                                        </div>
                                                                                 <div class="flex items-center gap-2 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 px-3 py-2 rounded-lg">
                                             <i class="fas fa-times-circle"></i>
                                             <span class="font-semibold">Ocupadas: ${portasOcupadas}</span>
                                         </div>
                                         <div class="flex items-center gap-2 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-3 py-2 rounded-lg">
                                             <i class="fas fa-plug"></i>
                                             <span class="font-semibold">Mapeadas: ${portasMapeadas}</span>
                                         </div>
                                    </div>
                                </div>
                                <div class="flex flex-wrap gap-3">
                                    <button class="btn-ver-portas bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-700 dark:hover:bg-indigo-800 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2" onclick="togglePortas(${sw.id})">
                                        <i class="fas fa-eye"></i> Ver Portas
                                    </button>
                                    <button class="btn-vincular bg-green-600 hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-800 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2" onclick="abrirModalVincular(${sw.id}, '${sw.nome}', ${sw.andar_id || 'null'}, ${sw.idf_responsavel_id || 'null'})">
                                        <i class="fas fa-link"></i> Vincular Andar/IDF
                                    </button>
                                    ${sw.andar_id ? `
                                        <button class="btn-desvincular bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2" onclick="desvincularSwitch(${sw.id}, ${sw.andar_id})">
                                            <i class="fas fa-unlink"></i> Desvincular
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="portas-container border-t border-gray-200 dark:border-gray-700">
                                <div id="portas-${sw.id}" class="portas-toggle hidden p-6 bg-gray-50 dark:bg-gray-700/50">
                                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Portas do Switch</h4>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                        ${portas.map(porta => `
                                                                                         <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-600 p-4 ${getStatusClass(porta)}">
                                                                                                 <div class="flex items-center justify-between mb-3">
                                                     <span class="font-semibold text-gray-800 dark:text-white">Porta ${porta.numero_porta}</span>
                                                     <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusTextClass(porta)}">
                                                         ${getStatusText(porta)}
                                                     </span>
                                                 </div>
                                                                                                 ${porta.equipamento_info ? `
                                                     <div class="mt-3 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                                         <h4 class="font-semibold text-green-800 dark:text-green-200 mb-2">Equipamento Conectado:</h4>
                                                         <div class="text-sm text-green-600 dark:text-green-300 space-y-1">
                                                             <div><strong>${porta.equipamento_info.nome}</strong></div>
                                                             <div>Tipo: ${porta.equipamento_info.tipo}</div>
                                                             <div>Sala: ${porta.equipamento_info.sala_nome || 'Não atribuído'}</div>
                                                             <div>IP 1: ${porta.equipamento_info.ip1 || '-'}</div>
                                                             <div>MAC 1: <span class='font-mono text-xs'>${porta.equipamento_info.mac1 || '-'}</span></div>
                                                             ${porta.equipamento_info.ip2 ? `<div>IP 2: ${porta.equipamento_info.ip2}</div>` : ''}
                                                             ${porta.equipamento_info.mac2 ? `<div>MAC 2: <span class='font-mono text-xs'>${porta.equipamento_info.mac2}</span></div>` : ''}
                                                         </div>
                                                     </div>
                                                 ` : ''}
                                                 ${porta.patch_panel_info ? `
                                                     <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                                         <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Patch Panel Mapeado:</h4>
                                                         <div class="text-sm text-blue-600 dark:text-blue-300 space-y-1">
                                                             <div><strong>${porta.patch_panel_info.nome}</strong></div>
                                                             <div>Porta: ${porta.patch_panel_info.porta_patch_panel}</div>
                                                             <div>Keystone: ${porta.patch_panel_info.keystone}</div>
                                                             ${porta.patch_panel_info.equipamento ? `
                                                                 <div class="mt-2 pt-2 border-t border-blue-200 dark:border-blue-700">
                                                                     <div class="font-medium text-blue-700 dark:text-blue-300">Equipamento Conectado:</div>
                                                                     <div class="text-blue-600 dark:text-blue-400 space-y-1">
                                                                         <div>${porta.patch_panel_info.equipamento.nome}</div>
                                                                         <div class="text-xs">Tipo: ${porta.patch_panel_info.equipamento.tipo}</div>
                                                                         <div class="text-xs">Sala: ${porta.patch_panel_info.equipamento.sala || 'Não atribuído'}</div>
                                                                         <div class="text-xs">IP 1: ${porta.patch_panel_info.equipamento.ip1 || '-'}</div>
                                                                         <div class="text-xs">MAC 1: <span class='font-mono text-xs'>${porta.patch_panel_info.equipamento.mac1 || '-'}</span></div>
                                                                         ${porta.patch_panel_info.equipamento.ip2 ? `<div class="text-xs">IP 2: ${porta.patch_panel_info.equipamento.ip2}</div>` : ''}
                                                                         ${porta.patch_panel_info.equipamento.mac2 ? `<div class="text-xs">MAC 2: <span class='font-mono text-xs'>${porta.patch_panel_info.equipamento.mac2}</span></div>` : ''}
                                                                     </div>
                                                                 </div>
                                                             ` : ''}
                                                         </div>
                                                     </div>
                                                 ` : ''}
                                                 ${!porta.equipamento_info && !porta.patch_panel_info ? `
                                                     <div class="text-sm text-gray-500 dark:text-gray-400 italic">
                                                         Porta disponível para conexão
                                                     </div>
                                                 ` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar switches:', error);
                mostrarMensagem('Erro ao carregar switches', 'error');
            }
        }
        
        function togglePortas(switchId) {
            const portasDiv = document.getElementById(`portas-${switchId}`);
            const btn = event.target.closest('.btn-ver-portas');
            
            if (portasDiv.classList.contains('hidden')) {
                portasDiv.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> Ocultar Portas';
            } else {
                portasDiv.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-eye"></i> Ver Portas';
            }
        }
        
        function mostrarMensagem(msg, tipo) {
            const div = document.getElementById('msg');
            div.textContent = msg;
            if (tipo === 'success') {
                div.className = 'mb-6 p-4 rounded-lg text-center font-medium bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300';
            } else if (tipo === 'error') {
                div.className = 'mb-6 p-4 rounded-lg text-center font-medium bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300';
            } else {
                div.className = 'mb-6 p-4 rounded-lg text-center font-medium bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300';
            }
            div.style.display = 'block';
            setTimeout(() => { div.style.display = 'none'; }, 3000);
        }
        
        function voltarPainelConfig() {
            fetch('/perfil').then(resp => resp.json()).then(perfil => {
                if (perfil.nivel === 'admin') {
                    window.location.href = 'config-admin.html';
                } else if (perfil.nivel === 'tecnico') {
                    window.location.href = 'config-tecnico.html';
                } else {
                    window.location.href = 'config-usuario.html';
                }
            });
        }

                 // Obter classe CSS para status
         function getStatusClass(porta) {
             if (porta.equipamento_info || (porta.patch_panel_info && porta.patch_panel_info.equipamento)) {
                 return 'ring-2 ring-red-200 dark:ring-red-800';
             } else if (porta.patch_panel_info) {
                 return 'ring-2 ring-blue-200 dark:ring-blue-800';
             } else {
                 return 'ring-2 ring-green-200 dark:ring-green-800';
             }
         }

                 // Obter classe CSS para texto do status
         function getStatusTextClass(porta) {
             if (porta.equipamento_info || (porta.patch_panel_info && porta.patch_panel_info.equipamento)) {
                 return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
             } else if (porta.patch_panel_info) {
                 return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
             } else {
                 return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
             }
         }

                 // Obter texto para status
         function getStatusText(porta) {
             if (porta.equipamento_info || (porta.patch_panel_info && porta.patch_panel_info.equipamento)) {
                 return 'OCUPADA';
             } else if (porta.patch_panel_info) {
                 return 'MAPEADA';
             } else {
                 return 'LIVRE';
             }
         }
        
        // Variáveis globais para o modal
        let switchAtual = null;

        // Funções do modal
        async function abrirModalVincular(switchId, switchNome, andarAtual, idfAtual) {
            switchAtual = { id: switchId, nome: switchNome, andar: andarAtual, idf: idfAtual };
            document.getElementById('switchNomeModal').textContent = switchNome;
            
            // Carregar andares
            try {
                const respAndares = await fetch('/andares');
                const andares = await respAndares.json();
                const andarSelect = document.getElementById('andarModal');
                andarSelect.innerHTML = '<option value="">Selecione o andar</option>';
                
                andares.forEach(andar => {
                    const option = document.createElement('option');
                    option.value = andar.id;
                    option.textContent = andar.titulo;
                    if (andar.id == andarAtual) option.selected = true;
                    andarSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar andares:', error);
            }

            // Carregar IDFs
            try {
                const respIDFs = await fetch('/idfs');
                const idfs = await respIDFs.json();
                const idfSelect = document.getElementById('idfModal');
                idfSelect.innerHTML = '<option value="">Selecione o IDF (opcional)</option>';
                
                idfs.forEach(idf => {
                    const option = document.createElement('option');
                    option.value = idf.id;
                    option.textContent = `${idf.nome} (${idf.andar_titulo})`;
                    if (idf.id == idfAtual) option.selected = true;
                    idfSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar IDFs:', error);
            }

            document.getElementById('modalVincular').classList.remove('hidden');
        }

        function fecharModalVincular() {
            document.getElementById('modalVincular').classList.add('hidden');
            switchAtual = null;
        }

        // Formulário de vincular
        document.getElementById('formVincular').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const andarId = document.getElementById('andarModal').value;
            const idfId = document.getElementById('idfModal').value;
            
            if (!andarId) {
                mostrarMensagem('Selecione um andar', 'error');
                return;
            }

            try {
                const response = await fetch(`/andares/${andarId}/switches`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        switch_id: switchAtual.id,
                        idf_responsavel_id: idfId || null
                    })
                });

                const result = await response.json();
                
                if (result.status === 'ok') {
                    mostrarMensagem('Switch vinculado com sucesso!', 'success');
                    fecharModalVincular();
                    carregarSwitches(); // Recarregar lista
                } else {
                    mostrarMensagem('Erro ao vincular: ' + result.mensagem, 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem('Erro de conexão', 'error');
            }
        });

        // Desvincular switch
        async function desvincularSwitch(switchId, andarId) {
            if (!confirm('Tem certeza que deseja desvincular este switch do andar?')) {
                return;
            }

            try {
                const response = await fetch(`/andares/${andarId}/switches/${switchId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.status === 'ok') {
                    mostrarMensagem('Switch desvinculado com sucesso!', 'success');
                    carregarSwitches(); // Recarregar lista
                } else {
                    mostrarMensagem('Erro ao desvincular: ' + result.mensagem, 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem('Erro de conexão', 'error');
            }
        }

        // Carregar switches quando a página carregar
        carregarSwitches();

        window.addEventListener('DOMContentLoaded', function() {
            fetch('/empresa_atual')
                .then(resp => resp.json())
                .then(data => {
                    LogoManager.loadEmpresaLogo(data);
                });
        });
    </script>
</body>
</html>


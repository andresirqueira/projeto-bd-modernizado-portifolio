<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Visualizar Layout Sala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
    <link rel="icon" type="image/png" href="static/img/favicon-olho.png">
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0; 
        }
        .dark body {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        }
        #mainCanvas {
            position: absolute;
            left: 240px; 
            top: 0; 
            right: 0; 
            bottom: 0;
            width: calc(100vw - 240px);
            height: 100vh;
            background: url('static/img/blue-print.png') center/cover, #183c6b;
            overflow: hidden;
        }
        .dark #mainCanvas {
            background: url('static/img/blue-print.png') center/cover, #1a202c;
        }
        .equip-instance {
            position: absolute;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        .equip-instance:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.6);
        }
        .equip-instance img {
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .text-instance span {
            font-weight: bold;
            font-family: inherit;
            pointer-events: none;
        }
        
        /* Estilos para as conex√µes SVG */
        #svg-connections path {
            pointer-events: auto;
            cursor: pointer;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
        }
        
        #svg-connections text {
            pointer-events: auto;
            cursor: pointer;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
            font-weight: bold;
        }
        
        #svg-connections rect {
            filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.3));
        }
        #sidebar {
            position: fixed;
            left: 0; top: 0; bottom: 0;
            width: 180px;
            background: #222a33;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
            box-shadow: 2px 0 8px #0002;
        }
        #sidebar h2 {
            margin-top: 32px;
            font-size: 1.3em;
            color: #f1c40f;
        }
        #salaTitulo {
            margin-top: 32px;
            font-size: 1.2em;
            color: #fff;
            text-align: center;
        }
    </style>
</head>
<body>
    <button onclick="window.history.back()" class="fixed top-6 left-64 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-3 transition-colors z-50" title="Voltar">
        <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
    </button>
    <div id="sidebar" class="fixed left-0 top-0 bottom-0 w-60 bg-white dark:bg-gray-800 text-gray-800 dark:text-white flex flex-col items-center z-10 shadow-2xl">
        <div class="w-full p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-bold text-indigo-600 dark:text-indigo-400 text-center">Layout da Sala</h2>
        </div>
        <div class="flex-1 flex flex-col items-center justify-center space-y-4">
            <div id="salaTitulo" class="text-lg font-semibold text-gray-700 dark:text-gray-300 text-center">Sala</div>
            
            <!-- Bot√µes de modo de visualiza√ß√£o -->
            <div class="w-full px-4 space-y-3">
                <button id="btnManual" onclick="carregarLayoutManual()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                    <i class="fas fa-pencil-alt mr-2"></i>Layout Manual
                </button>
                
                <button id="btnReal" onclick="carregarConexoesReais()" class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                    <i class="fas fa-plug mr-2"></i>Conex√µes Reais
                </button>
                
                <button id="btnHibrido" onclick="carregarLayoutHibrido()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                    <i class="fas fa-layer-group mr-2"></i>H√≠brido
                </button>
            </div>
            
            <!-- Status atual -->
            <div id="statusAtual" class="text-sm text-gray-500 dark:text-gray-400 text-center px-4">
                Carregando...
            </div>
            
            <!-- Legenda de tipos de cabos -->
            <div id="legendaCabos" class="w-full px-4 mt-4 hidden">
                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Tipos de Cabos:</h4>
                <div class="space-y-1 text-xs">
                    <!-- Legenda ser√° preenchida dinamicamente -->
                </div>
            </div>
        </div>
    </div>
    <div id="mainCanvas" style="position:relative; min-height:600px; min-width:800px;">
        <svg id="svg-connections" style="position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:0;"></svg>
    </div>
    <script>
    let sala_id_atual = null;
    let modo_atual = 'manual';
    
    function getSalaIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('sala_id');
    }
    
    async function carregarSalaInfo(sala_id) {
        const resp = await fetch(`/salas/${sala_id}`);
        if (!resp.ok) return;
        const sala = await resp.json();
        document.getElementById('salaTitulo').innerText = sala.nome || 'Sala';
    }
    
    function limparCanvas() {
        const mainCanvas = document.getElementById('mainCanvas');
        const svgEl = document.getElementById('svg-connections');
        
        // Verifica se os elementos existem antes de tentar acess√°-los
        if (mainCanvas) {
            // Remove todos os elementos .equip-instance
            Array.from(mainCanvas.querySelectorAll('.equip-instance')).forEach(e => e.remove());
        }
        
        if (svgEl) {
            // Limpa SVG de forma segura
            while (svgEl.firstChild) {
                svgEl.removeChild(svgEl.firstChild);
            }
        }
    }
    
    function atualizarStatus(mensagem) {
        document.getElementById('statusAtual').innerText = mensagem;
    }
    
    function atualizarBotaoAtivo(modo) {
        // Remove classe ativa de todos os bot√µes
        document.getElementById('btnManual').classList.remove('ring-2', 'ring-blue-300');
        document.getElementById('btnReal').classList.remove('ring-2', 'ring-green-300');
        document.getElementById('btnHibrido').classList.remove('ring-2', 'ring-purple-300');
        
        // Adiciona classe ativa ao bot√£o selecionado
        if (modo === 'manual') {
            document.getElementById('btnManual').classList.add('ring-2', 'ring-blue-300');
        } else if (modo === 'real') {
            document.getElementById('btnReal').classList.add('ring-2', 'ring-green-300');
        } else if (modo === 'hibrido') {
            document.getElementById('btnHibrido').classList.add('ring-2', 'ring-purple-300');
        }
    }
    
    // Fun√ß√£o para definir cor baseada no tipo de cabo
    function getCorPorTipoCabo(tipoCabo) {
        console.log('getCorPorTipoCabo chamada com:', tipoCabo);
        
        const cores = {
            // Cores mais vibrantes e distintas
            'HDMI': '#FF0000',      // üî¥ Vermelho vibrante
            'HDMI STANDARD': '#FF0000', // üî¥ Vermelho vibrante
            'USB': '#FF6600',       // üü† Laranja vibrante
            'USB-A PARA USB-C': '#FF6600', // üü† Laranja vibrante
            'USB-C': '#FF6600',     // üü† Laranja vibrante
            'USB-A': '#FF6600',     // üü† Laranja vibrante
            'RJ45': '#00CC00',      // üü¢ Verde vibrante
            'ETH': '#00CC00',       // üü¢ Verde vibrante
            'CAT5E': '#00CC00',     // üü¢ Verde vibrante
            'CAT6': '#00CC00',      // üü¢ Verde vibrante
            'Power': '#000000',     // ‚ö´ Preto
            'Audio': '#9933FF',     // üü£ Roxo vibrante
            'Dante': '#0066FF',     // üîµ Azul vibrante
            'VGA': '#FF9900',       // üü† Laranja escuro
            'Serial': '#666666',    // ‚ö´ Cinza escuro
            'Fiber': '#FFCC00',     // üü° Amarelo vibrante
            'Coaxial': '#CC6600'    // üü§ Marrom
        };
        
        if (!tipoCabo) {
            console.warn('Tipo de cabo √© null/undefined');
            return '#FF0000';  // Vermelho como padr√£o
        }
        
        const tipoUpper = tipoCabo.toUpperCase();
        const cor = cores[tipoUpper];
        
        if (cor) {
            console.log(`Cor encontrada para ${tipoCabo}: ${cor}`);
            return cor;
        } else {
            console.warn(`Cor n√£o encontrada para tipo: ${tipoCabo}, usando padr√£o`);
            return '#FF0000';  // Vermelho como padr√£o
        }
    }
    
    // Fun√ß√£o para atualizar a legenda com apenas os tipos de cabos utilizados
    function atualizarLegendaCabos(conexoes) {
        const legendaDiv = document.getElementById('legendaCabos');
        if (!legendaDiv) return;
        
        const legendaContent = legendaDiv.querySelector('.space-y-1');
        if (!legendaContent) return;
        
        // Limpa a legenda atual
        legendaContent.innerHTML = '';
        
        // Obt√©m tipos √∫nicos de cabos
        const tiposCabos = [...new Set(conexoes.map(conn => conn.tipo_cabo))];
        
        // Cores para os tipos de cabos (usando as mesmas cores da fun√ß√£o getCorPorTipoCabo)
        const cores = {
            'HDMI': '#FF0000',      // üî¥ Vermelho vibrante
            'HDMI STANDARD': '#FF0000', // üî¥ Vermelho vibrante
            'USB': '#FF6600',       // üü† Laranja vibrante
            'USB-A PARA USB-C': '#FF6600', // üü† Laranja vibrante
            'USB-C': '#FF6600',     // üü† Laranja vibrante
            'USB-A': '#FF6600',     // üü† Laranja vibrante
            'RJ45': '#00CC00',      // üü¢ Verde vibrante
            'ETH': '#00CC00',       // üü¢ Verde vibrante
            'CAT5E': '#00CC00',     // üü¢ Verde vibrante
            'CAT6': '#00CC00',      // üü¢ Verde vibrante
            'Power': '#000000',     // ‚ö´ Preto
            'Audio': '#9933FF',     // üü£ Roxo vibrante
            'Dante': '#0066FF',     // üîµ Azul vibrante
            'VGA': '#FF9900',       // üü† Laranja escuro
            'Serial': '#666666',    // ‚ö´ Cinza escuro
            'Fiber': '#FFCC00',     // üü° Amarelo vibrante
            'Coaxial': '#CC6600'    // üü§ Marrom
        };
        
        // Cria itens da legenda apenas para os tipos utilizados
        tiposCabos.forEach(tipo => {
            if (tipo) {
                const cor = cores[tipo.toUpperCase()] || '#FF0000';
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center justify-between p-2 bg-white dark:bg-gray-700 rounded-lg shadow-sm border border-gray-200 dark:border-gray-600';
                itemDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded-full mr-3 shadow-sm" style="background-color: ${cor}"></div>
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">${tipo}</span>
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                        <i class="fas fa-plug mr-1"></i>Cabo
                    </div>
                `;
                legendaContent.appendChild(itemDiv);
            }
        });
        
        // Se n√£o h√° tipos de cabos, mostra mensagem
        if (tiposCabos.length === 0 || tiposCabos.every(tipo => !tipo)) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600';
            itemDiv.innerHTML = `
                <i class="fas fa-info-circle text-gray-400 mb-2"></i>
                <div class="text-sm text-gray-500 dark:text-gray-400">Nenhum cabo conectado</div>
            `;
            legendaContent.appendChild(itemDiv);
        }
    }
    
    async function carregarLayoutManual() {
        if (!sala_id_atual) return;
        
        modo_atual = 'manual';
        atualizarBotaoAtivo('manual');
        limparCanvas();
        atualizarStatus('Carregando layout manual...');
        
        // Oculta legenda no modo manual
        document.getElementById('legendaCabos').classList.add('hidden');
        
        try {
            const resp = await fetch(`/api/salas/${sala_id_atual}/layout`);
            if (!resp.ok) throw new Error('Nenhum layout salvo para esta sala.');
            const layout = await resp.json();
            await renderizarLayout(layout);
            atualizarStatus('Layout manual carregado');
        } catch (e) {
            document.getElementById('mainCanvas').innerHTML = `<div style='color:#e74c3c;font-size:1.3em;text-align:center;margin-top:80px;'>${e.message || 'Erro ao carregar layout manual.'}</div>`;
            atualizarStatus('Erro ao carregar layout manual');
        }
    }
    
        async function carregarConexoesReais() {
        if (!sala_id_atual) return;
        
        modo_atual = 'real';
        atualizarBotaoAtivo('real');
        limparCanvas();
        atualizarStatus('Carregando conex√µes reais...');
        
        // Mostra legenda no modo real
        document.getElementById('legendaCabos').classList.remove('hidden');
        
        try {
            console.log('Iniciando carregamento de conex√µes reais para sala:', sala_id_atual);
            
            // Primeiro carrega o layout manual para ter os equipamentos posicionados
            const respLayout = await fetch(`/api/salas/${sala_id_atual}/layout`);
            let layout = { items: [], conns: [] };
            
            if (respLayout.ok) {
                layout = await respLayout.json();
                console.log('Layout manual carregado:', layout);
            } else {
                console.log('Nenhum layout manual encontrado, criando autom√°tico');
            }
            
            // Busca conex√µes reais
            const respConexoes = await fetch(`/api/salas/${sala_id_atual}/conexoes-reais`);
            if (!respConexoes.ok) {
                console.error('Erro na resposta da API:', respConexoes.status, respConexoes.statusText);
                throw new Error('Erro ao buscar conex√µes reais.');
            }
            
            const conexoes = await respConexoes.json();
            console.log('Conex√µes reais carregadas:', conexoes);
            
            if (!conexoes || conexoes.length === 0) {
                throw new Error('Nenhuma conex√£o real encontrada para esta sala.');
            }
            
            // Se n√£o h√° layout manual, cria equipamentos automaticamente baseado nas conex√µes
            if (layout.items.length === 0) {
                console.log('Criando layout autom√°tico...');
                layout = await criarLayoutAutomatico(conexoes);
                console.log('Layout autom√°tico criado:', layout);
            }
            
            // Converte conex√µes reais para formato do layout
            const conexoesFormatadas = conexoes.map(conn => {
                const cor = getCorPorTipoCabo(conn.tipo_cabo);
                console.log(`Conex√£o ${conn.codigo_cabo}: tipo=${conn.tipo_cabo}, cor=${cor}`);
                
                return {
                    id: `real_${conn.id}`,
                    fromId: `equip_${conn.equipamento_origem_id}`,
                    toId: `equip_${conn.equipamento_destino_id}`,
                    name: `${conn.codigo_cabo} (${conn.tipo_cabo})`,
                    label: `${conn.codigo_cabo} (${conn.tipo_cabo})`,
                    color: cor,
                    fontSize: 12,
                    is_real: true,
                    tipo_cabo: conn.tipo_cabo,
                    codigo_cabo: conn.codigo_cabo,
                    equipamento_origem: conn.equipamento_origem,
                    equipamento_destino: conn.equipamento_destino,
                    porta_origem: conn.porta_origem,
                    porta_destino: conn.porta_destino
                };
            });
            
            layout.conns = conexoesFormatadas;
            await renderizarLayout(layout);
            
            // Atualiza a legenda com apenas os tipos de cabos utilizados
            atualizarLegendaCabos(conexoes);
            
            atualizarStatus(`Conex√µes reais carregadas (${conexoes.length} conex√µes) - Layout autom√°tico criado`);
            
        } catch (e) {
            document.getElementById('mainCanvas').innerHTML = `<div style='color:#e74c3c;font-size:1.3em;text-align:center;margin-top:80px;'>${e.message || 'Erro ao carregar conex√µes reais.'}</div>`;
            atualizarStatus('Erro ao carregar conex√µes reais');
        }
    }
    
    // Fun√ß√£o para criar layout autom√°tico baseado nas conex√µes
    async function criarLayoutAutomatico(conexoes) {
        console.log('Criando layout autom√°tico com', conexoes.length, 'conex√µes');
        
        // Coleta todos os equipamentos √∫nicos das conex√µes
        const equipamentos = new Map();
        
        conexoes.forEach((conn, index) => {
            console.log(`Conex√£o ${index + 1}:`, {
                origem_id: conn.equipamento_origem_id,
                origem_nome: conn.equipamento_origem,
                destino_id: conn.equipamento_destino_id,
                destino_nome: conn.equipamento_destino
            });
            
            if (conn.equipamento_origem_id && conn.equipamento_origem) {
                if (!equipamentos.has(conn.equipamento_origem_id)) {
                    equipamentos.set(conn.equipamento_origem_id, {
                        id: conn.equipamento_origem_id,
                        nome: conn.equipamento_origem,
                        tipo: 'equip'
                    });
                }
            }
            
            if (conn.equipamento_destino_id && conn.equipamento_destino) {
                if (!equipamentos.has(conn.equipamento_destino_id)) {
                    equipamentos.set(conn.equipamento_destino_id, {
                        id: conn.equipamento_destino_id,
                        nome: conn.equipamento_destino,
                        tipo: 'equip'
                    });
                }
            }
        });
        
        console.log('Equipamentos √∫nicos encontrados:', Array.from(equipamentos.values()));
        
        // Fun√ß√£o para determinar imagem baseada no nome do equipamento
        function getImagemEquipamento(nome) {
            // Verifica se o nome existe e n√£o √© null/undefined
            if (!nome || typeof nome !== 'string') {
                console.warn('Nome do equipamento inv√°lido:', nome);
                return 'static/img/equipamentos/pc-ctl.png'; // Imagem padr√£o
            }
            
            const nomeLower = nome.toLowerCase();
            console.log('Mapeando imagem para equipamento:', nome, '->', nomeLower);
            
            if (nomeLower.includes('switch') || nomeLower.includes('sw')) {
                return 'static/img/equipamentos/switch-cisco.png';
            } else if (nomeLower.includes('tv') || nomeLower.includes('televis√£o')) {
                return 'static/img/equipamentos/tv-lg.png';
            } else if (nomeLower.includes('c√¢mera') || nomeLower.includes('camera')) {
                return 'static/img/equipamentos/camera-logitech.png';
            } else if (nomeLower.includes('microfone') || nomeLower.includes('mic')) {
                return 'static/img/equipamentos/microfone-logitech.png';
            } else if (nomeLower.includes('speaker') || nomeLower.includes('alto-falante')) {
                return 'static/img/equipamentos/speaker-logitech.png';
            } else if (nomeLower.includes('hub')) {
                return 'static/img/equipamentos/hub-logitech.png';
            } else if (nomeLower.includes('painel') || nomeLower.includes('panel')) {
                return 'static/img/equipamentos/painel-crestron.png';
            } else if (nomeLower.includes('tap')) {
                return 'static/img/equipamentos/tap-logitech.png';
            } else if (nomeLower.includes('patch') || nomeLower.includes('pt') || nomeLower.includes('keystone')) {
                return 'static/img/equipamentos/patch-panel.png';
            } else if (nomeLower.includes('chromebox') || nomeLower.includes('pc')) {
                return 'static/img/equipamentos/pc-ctl.png';
            } else if (nomeLower.includes('poe')) {
                return 'static/img/poe-logitech-kit-cat5e.png';
            } else if (nomeLower.includes('dongle')) {
                return 'static/img/dongle-logitech-logitech.png';
            } else if (nomeLower.includes('sensor') || nomeLower.includes('presen√ßa')) {
                return 'static/img/sensor-crestron-cen-odt-c-poe.png';
            } else if (nomeLower.includes('meetup')) {
                return 'static/img/meetup-logitech-meetup.png';
            } else {
                console.log('Usando imagem padr√£o para:', nome);
                return 'static/img/equipamentos/pc-ctl.png'; // Imagem padr√£o
            }
        }
        
        // Fun√ß√£o para ordenar equipamentos na ordem espec√≠fica
        function ordenarEquipamentos(equipamentos) {
            const ordemPrioritaria = [
                'sensor', 'presen√ßa', 'presenca',
                'tv', 'televis√£o', 'televisao',
                'chromebox', 'pc',
                'meetup',
                'tap',
                'painel', 'panel',
                'agenda',
                'poe',
                'dongle'
            ];
            
            return equipamentos.sort((a, b) => {
                const nomeA = a.nome.toLowerCase();
                const nomeB = b.nome.toLowerCase();
                
                // Encontra a posi√ß√£o de cada equipamento na ordem priorit√°ria
                const posA = ordemPrioritaria.findIndex(tipo => nomeA.includes(tipo));
                const posB = ordemPrioritaria.findIndex(tipo => nomeB.includes(tipo));
                
                // Se ambos est√£o na ordem priorit√°ria, ordena pela posi√ß√£o
                if (posA !== -1 && posB !== -1) {
                    return posA - posB;
                }
                
                // Se apenas A est√° na ordem priorit√°ria, A vem primeiro
                if (posA !== -1 && posB === -1) {
                    return -1;
                }
                
                // Se apenas B est√° na ordem priorit√°ria, B vem primeiro
                if (posA === -1 && posB !== -1) {
                    return 1;
                }
                
                // Se nenhum est√° na ordem priorit√°ria, mant√©m ordem alfab√©tica
                return nomeA.localeCompare(nomeB);
            });
        }
        
        // Posiciona equipamentos em uma grade com melhor distribui√ß√£o
        const equipamentosArray = ordenarEquipamentos(Array.from(equipamentos.values()));
        console.log('Equipamentos ordenados:', equipamentosArray.map(e => e.nome));
        const items = [];
        
        // Calcula melhor distribui√ß√£o baseada no n√∫mero de equipamentos
        let colunas, larguraEquip, alturaEquip, espacamento;
        
        if (equipamentosArray.length <= 4) {
            colunas = 2;
            larguraEquip = 140;
            alturaEquip = 100;
            espacamento = 200;
        } else if (equipamentosArray.length <= 9) {
            colunas = 3;
            larguraEquip = 130;
            alturaEquip = 90;
            espacamento = 180;
        } else {
            colunas = 4;
            larguraEquip = 120;
            alturaEquip = 80;
            espacamento = 160;
        }
        
        equipamentosArray.forEach((equip, index) => {
            const col = index % colunas;
            const linha = Math.floor(index / colunas);
            
            // Centraliza melhor no espa√ßo dispon√≠vel
            const totalWidth = colunas * larguraEquip + (colunas - 1) * espacamento;
            const startX = Math.max(100, (window.innerWidth - 300 - totalWidth) / 2);
            const startY = 100;
            
            const x = startX + col * (larguraEquip + espacamento);
            const y = startY + linha * (alturaEquip + espacamento);
            
            // Adiciona o equipamento
            items.push({
                type: 'equip',
                id: `equip_${equip.id}`,
                x: x,
                y: y,
                w: larguraEquip,
                h: alturaEquip,
                img: getImagemEquipamento(equip.nome),
                nome: equip.nome
            });
            
            // Adiciona texto com o nome do equipamento
            items.push({
                type: 'text',
                id: `text_${equip.id}`,
                x: x,
                y: y + alturaEquip + 5,
                w: larguraEquip,
                h: 20,
                text: equip.nome,
                color: '#ffffff',
                fontSize: '12px'
            });
        });
        
        return { items, conns: [] };
    }
    
    async function carregarLayoutHibrido() {
        if (!sala_id_atual) return;
        
        modo_atual = 'hibrido';
        atualizarBotaoAtivo('hibrido');
        limparCanvas();
        atualizarStatus('Carregando layout h√≠brido...');
        
        // Mostra legenda no modo h√≠brido
        document.getElementById('legendaCabos').classList.remove('hidden');
        
        try {
            // Busca conex√µes reais primeiro
            const respConexoes = await fetch(`/api/salas/${sala_id_atual}/conexoes-reais`);
            if (!respConexoes.ok) throw new Error('Erro ao buscar conex√µes reais.');
            const conexoes = await respConexoes.json();
            
            // Busca layout manual
            const respLayout = await fetch(`/api/salas/${sala_id_atual}/layout`);
            let layout = { items: [], conns: [] };
            
            if (respLayout.ok) {
                layout = await respLayout.json();
            }
            
            // Se n√£o h√° layout manual, cria automaticamente
            if (layout.items.length === 0) {
                layout = await criarLayoutAutomatico(conexoes);
            }
            
            // Converte conex√µes reais para formato do layout
            const conexoesFormatadas = conexoes.map(conn => {
                const cor = getCorPorTipoCabo(conn.tipo_cabo);
                console.log(`Conex√£o ${conn.codigo_cabo}: tipo=${conn.tipo_cabo}, cor=${cor}`);
                
                return {
                    id: `real_${conn.id}`,
                    fromId: `equip_${conn.equipamento_origem_id}`,
                    toId: `equip_${conn.equipamento_destino_id}`,
                    name: `${conn.codigo_cabo} (${conn.tipo_cabo})`,
                    label: `${conn.codigo_cabo} (${conn.tipo_cabo})`,
                    color: cor,
                    fontSize: 12,
                    is_real: true,
                    tipo_cabo: conn.tipo_cabo,
                    codigo_cabo: conn.codigo_cabo,
                    equipamento_origem: conn.equipamento_origem,
                    equipamento_destino: conn.equipamento_destino,
                    porta_origem: conn.porta_origem,
                    porta_destino: conn.porta_destino
                };
            });
            
            layout.conns = conexoesFormatadas;
            await renderizarLayout(layout);
            
            // Atualiza a legenda com apenas os tipos de cabos utilizados
            atualizarLegendaCabos(conexoes);
            
            atualizarStatus(`Layout h√≠brido carregado (${layout.conns.length} conex√µes reais) - Layout autom√°tico criado`);
            
        } catch (e) {
            document.getElementById('mainCanvas').innerHTML = `<div style='color:#e74c3c;font-size:1.3em;text-align:center;margin-top:80px;'>${e.message || 'Erro ao carregar layout h√≠brido.'}</div>`;
            atualizarStatus('Erro ao carregar layout h√≠brido');
        }
    }
    
    async function renderizarLayout(layout) {
        const mainCanvas = document.getElementById('mainCanvas');
        const svgEl = document.getElementById('svg-connections');
        
        if (!mainCanvas || !svgEl) {
            console.error('Elementos do canvas n√£o encontrados');
            return;
        }
        
        // Renderiza equipamentos/textos e cria mapa de id
        const idToDiv = {};
        
        if (layout.items && layout.items.length > 0) {
            layout.items.forEach(item => {
                let div;
                if (item.type === 'equip') {
                    div = document.createElement('div');
                    div.className = 'equip-instance';
                    div.style.position = 'absolute';
                    div.style.left = item.x + 'px';
                    div.style.top = item.y + 'px';
                    div.style.width = item.w + 'px';
                    div.style.height = item.h + 'px';
                    div.dataset.id = item.id;
                    
                    // Cria a imagem
                    const img = document.createElement('img');
                    img.src = item.img || 'static/img/equipamentos/pc-ctl.png';
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'contain';
                    img.style.borderRadius = '8px';
                    img.onerror = function() {
                        console.warn('Erro ao carregar imagem:', item.img);
                        this.style.display = 'none';
                    };
                    
                    div.appendChild(img);
                    mainCanvas.appendChild(div);
                    
                } else if (item.type === 'text') {
                    div = document.createElement('div');
                    div.className = 'equip-instance text-instance';
                    div.style.position = 'absolute';
                    div.style.left = item.x + 'px';
                    div.style.top = item.y + 'px';
                    div.style.width = item.w + 'px';
                    div.style.height = item.h + 'px';
                    div.dataset.id = item.id;
                    
                    const span = document.createElement('span');
                    span.textContent = item.text;
                    span.style.color = item.color;
                    span.style.fontSize = item.fontSize;
                    div.appendChild(span);
                    mainCanvas.appendChild(div);
                }
                
                if (div) {
                    idToDiv[item.id] = div;
                }
            });
        }
        
        // Fun√ß√£o para renderizar conex√µes ap√≥s um pequeno delay
        function renderizarConexoes() {
            console.log('Iniciando renderiza√ß√£o de conex√µes...');
            console.log('Layout.conns:', layout.conns);
            console.log('idToDiv keys:', Object.keys(idToDiv));
            
            if (layout.conns && layout.conns.length > 0) {
                console.log('Renderizando', layout.conns.length, 'conex√µes...');
                
                layout.conns.forEach((conn, index) => {
                    console.log(`Processando conex√£o ${index + 1}:`, conn);
                    const from = idToDiv[conn.fromId];
                    const to = idToDiv[conn.toId];
                    
                    console.log(`  fromId: ${conn.fromId}, from:`, from);
                    console.log(`  toId: ${conn.toId}, to:`, to);
                    
                    if (from && to) {
                        try {
                            // Calcula posi√ß√µes dos centros dos equipamentos
                            const x1 = from.offsetLeft + from.offsetWidth/2;
                            const y1 = from.offsetTop + from.offsetHeight/2;
                            const x2 = to.offsetLeft + to.offsetWidth/2;
                            const y2 = to.offsetTop + to.offsetHeight/2;
                            
                            // Cria o caminho SVG com arco mais suave
                            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                            const dx = Math.abs(x2 - x1) * 0.3;
                            const dy = Math.abs(y2 - y1) * 0.3;
                            
                            // Cria um arco mais suave e vis√≠vel
                            path.setAttribute('d', `M${x1},${y1} C${x1+dx},${y1-dy} ${x2-dx},${y2+dy} ${x2},${y2}`);
                            path.setAttribute('stroke', conn.color || '#FF0000');
                            path.setAttribute('stroke-width', conn.is_real ? '6' : '4');
                            path.setAttribute('fill', 'none');
                            path.setAttribute('opacity', '0.9');
                            
                            // Adiciona estilo tracejado para conex√µes reais
                            if (conn.is_real) {
                                path.setAttribute('stroke-dasharray', '8,6');
                                path.setAttribute('title', `Cabo: ${conn.codigo_cabo}\nTipo: ${conn.tipo_cabo}\nDe: ${conn.equipamento_origem || 'N/A'}\nPara: ${conn.equipamento_destino || 'N/A'}\nPorta Origem: ${conn.porta_origem || 'N/A'}\nPorta Destino: ${conn.porta_destino || 'N/A'}`);
                            }
                            
                            svgEl.appendChild(path);
                            
                            // Adiciona texto da conex√£o com melhor legibilidade
                            if (conn.name || conn.label) {
                                const labelText = conn.name || conn.label;
                                const textWidth = labelText.length * 7; // Aproxima√ß√£o da largura do texto
                                const textX = (x1+x2)/2 - textWidth/2;
                                const textY = (y1+y2)/2 - 25; // Posiciona acima da linha
                                
                                // Cria um fundo mais vis√≠vel para o texto
                                const textBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                                textBg.setAttribute('x', textX - 6);
                                textBg.setAttribute('y', textY - 4);
                                textBg.setAttribute('width', textWidth + 12);
                                textBg.setAttribute('height', 20);
                                textBg.setAttribute('fill', 'rgba(255,255,255,0.95)');
                                textBg.setAttribute('rx', '4');
                                textBg.setAttribute('stroke', conn.color || '#FF0000');
                                textBg.setAttribute('stroke-width', '1');
                                svgEl.appendChild(textBg);
                                
                                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                text.setAttribute('x', (x1+x2)/2);
                                text.setAttribute('y', textY + 8);
                                text.setAttribute('fill', conn.color || '#FF0000');
                                text.setAttribute('font-size', '11');
                                text.setAttribute('font-family', 'Arial, sans-serif');
                                text.setAttribute('text-anchor', 'middle');
                                text.setAttribute('font-weight', 'bold');
                                text.textContent = labelText;
                                
                                if (conn.is_real) {
                                    text.setAttribute('title', `Cabo: ${conn.codigo_cabo}\nTipo: ${conn.tipo_cabo}\nDe: ${conn.equipamento_origem || 'N/A'}\nPara: ${conn.equipamento_destino || 'N/A'}\nPorta Origem: ${conn.porta_origem || 'N/A'}\nPorta Destino: ${conn.porta_destino || 'N/A'}`);
                                    textBg.setAttribute('title', `Cabo: ${conn.codigo_cabo}\nTipo: ${conn.tipo_cabo}\nDe: ${conn.equipamento_origem || 'N/A'}\nPara: ${conn.equipamento_destino || 'N/A'}\nPorta Origem: ${conn.porta_origem || 'N/A'}\nPorta Destino: ${conn.porta_destino || 'N/A'}`);
                                }
                                
                                svgEl.appendChild(text);
                            }
                            
                            console.log(`Conex√£o ${index + 1} renderizada: ${conn.fromId} -> ${conn.toId}`);
                            
                        } catch (error) {
                            console.error('Erro ao renderizar conex√£o:', error, conn);
                        }
                    } else {
                        console.warn(`Conex√£o ${index + 1} n√£o pode ser renderizada:`, {
                            fromId: conn.fromId,
                            toId: conn.toId,
                            fromExists: !!from,
                            toExists: !!to
                        });
                    }
                });
            }
        }
        
        // Aguarda um pouco para garantir que os elementos foram renderizados
        setTimeout(renderizarConexoes, 200);
        
        console.log('Layout renderizado:', {
            equipamentos: layout.items?.length || 0,
            conexoes: layout.conns?.length || 0,
            idToDiv: Object.keys(idToDiv)
        });
    }
    
    // Inicializa√ß√£o
    (function(){
        sala_id_atual = getSalaIdFromUrl();
        if (sala_id_atual) {
            carregarSalaInfo(sala_id_atual);
            carregarLayoutManual(); // Carrega layout manual por padr√£o
        } else {
            document.getElementById('mainCanvas').innerHTML = '<div style="color:#e74c3c;font-size:1.3em;text-align:center;margin-top:80px;">Sala n√£o informada na URL.</div>';
            atualizarStatus('Sala n√£o informada');
        }
    })();
    </script>
    <script src="static/js/logo-manager.js"></script>
    </body>
</html> 
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Visualizar Layout Sala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
    <link rel="icon" type="image/png" href="static/img/favicon-olho.png">
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0; 
        }
        .dark body {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        }
        #mainCanvas {
            position: absolute;
            left: 240px; 
            top: 0; 
            right: 0; 
            bottom: 0;
            width: calc(100vw - 240px);
            height: 100vh;
            background: url('static/img/blue-print.png') center/cover, #183c6b;
             overflow: auto;
             transform-origin: top left;
             transition: transform 0.3s ease;
         }
         
         #mainCanvas.zoomed {
             cursor: grab;
         }
         
         #mainCanvas.zoomed:active {
             cursor: grabbing;
        }
        .dark #mainCanvas {
            background: url('static/img/blue-print.png') center/cover, #1a202c;
        }
        .equip-instance {
            position: absolute;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            border-radius: 8px;
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            width: 120px !important;
            height: 90px !important;
        }
        
        .text-instance {
            width: 100px !important;
            height: 25px !important;
            background: rgba(0,0,0,0.7) !important;
            border: 1px solid rgba(255,255,255,0.3) !important;
        }
        .equip-instance:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 16px rgba(0,0,0,0.5);
            border-color: rgba(255,255,255,0.7);
            background: rgba(255,255,255,0.2);
        }
        .equip-instance img {
            border-radius: 8px;
            transition: all 0.3s ease;
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-width: 100%;
            max-height: 100%;
        }
        .text-instance span {
            font-weight: bold;
            font-family: inherit;
            pointer-events: none;
        }
        
        /* Estilos para as conexões SVG */
        #svg-connections path {
            pointer-events: auto;
            cursor: pointer;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
        }
        
        #svg-connections text {
            pointer-events: auto;
            cursor: pointer;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
            font-weight: bold;
        }
        
        #svg-connections rect {
            filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.3));
        }
        #sidebar {
            position: fixed;
            left: 0; top: 0; bottom: 0;
            width: 180px;
            background: #222a33;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
            box-shadow: 2px 0 8px #0002;
        }
        #sidebar h2 {
            margin-top: 32px;
            font-size: 1.3em;
            color: #f1c40f;
        }
        #salaTitulo {
            margin-top: 32px;
            font-size: 1.2em;
            color: #fff;
            text-align: center;
        }
    </style>
</head>
<body>
    <button onclick="window.history.back()" class="fixed top-6 left-64 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-3 transition-colors z-50" title="Voltar">
        <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
    </button>
    <div id="sidebar" class="fixed left-0 top-0 bottom-0 w-60 bg-white dark:bg-gray-800 text-gray-800 dark:text-white flex flex-col items-center z-10 shadow-2xl">
        <div class="w-full p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-bold text-indigo-600 dark:text-indigo-400 text-center">Layout da Sala</h2>
        </div>
        <div class="flex-1 flex flex-col items-center justify-center space-y-4">
            <div id="salaTitulo" class="text-lg font-semibold text-gray-700 dark:text-gray-300 text-center">Sala</div>
            
            <!-- Status atual -->
            <div id="statusAtual" class="text-sm text-gray-500 dark:text-gray-400 text-center px-4">
                Carregando...
            </div>
            
             <!-- Controles de zoom -->
             <div class="w-full px-4 space-y-3">
                 <div class="text-sm font-semibold text-gray-700 dark:text-gray-300 text-center">Zoom</div>
                 <div class="flex items-center justify-center space-x-2">
                     <button id="btnZoomOut" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-3 rounded-lg transition-colors">
                         <i class="fas fa-search-minus"></i>
                     </button>
                     <span id="zoomLevel" class="text-sm font-medium text-gray-700 dark:text-gray-300">100%</span>
                     <button id="btnZoomIn" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-3 rounded-lg transition-colors">
                         <i class="fas fa-search-plus"></i>
                     </button>
                </div>
                 <button id="btnResetZoom" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                     <i class="fas fa-expand-arrows-alt mr-2"></i>Resetar Zoom
                 </button>
            </div>
        </div>
    </div>
    <div id="mainCanvas" style="position:relative; min-height:600px; min-width:800px;">
        <svg id="svg-connections" style="position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:0;"></svg>
    </div>
    <script>
    let sala_id_atual = null;
    
    function getSalaIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('sala_id');
    }
    
    async function carregarSalaInfo(sala_id) {
        const resp = await fetch(`/salas/${sala_id}`);
        if (!resp.ok) return;
        const sala = await resp.json();
        document.getElementById('salaTitulo').innerText = sala.nome || 'Sala';
    }
    
    function limparCanvas() {
        const mainCanvas = document.getElementById('mainCanvas');
        const svgEl = document.getElementById('svg-connections');
        
        // Verifica se os elementos existem antes de tentar acessá-los
        if (mainCanvas) {
            // Remove todos os elementos .equip-instance
            Array.from(mainCanvas.querySelectorAll('.equip-instance')).forEach(e => e.remove());
        }
        
        if (svgEl) {
            // Limpa SVG de forma segura
            while (svgEl.firstChild) {
                svgEl.removeChild(svgEl.firstChild);
            }
        }
    }
    
    function atualizarStatus(mensagem) {
        document.getElementById('statusAtual').innerText = mensagem;
    }
    
    
    
    // Função para converter layout da grade para formato de visualização
    function converterLayoutParaVisualizacao(layoutGrade) {
        console.log('Convertendo layout da grade:', layoutGrade);
        
        const items = [];
        const conns = [];
        
        // Configurações de visualização
        const cellSize = 120; // Tamanho de cada "célula" na visualização
        const spacing = 140; // Espaçamento entre equipamentos (reduzido para o novo tamanho)
        const startX = 300;
        const startY = -100; // Movido para cima
        
        // Converte equipamentos da grade para posições absolutas
        if (layoutGrade.equipment && layoutGrade.equipment.length > 0) {
            layoutGrade.equipment.forEach((equip, index) => {
                // Calcula posição baseada na grade
                const x = startX + equip.col * spacing;
                const y = startY + equip.row * spacing;
                
                // Tamanho padronizado para todos os equipamentos
                const largura = 120;
                const altura = 90;
                
                                                 // Determina imagem baseada no tipo de equipamento
                let imgSrc = equip.src;
                const nome = equip.name.toLowerCase();
                const isAdaptador = nome.includes('adaptador') || nome.includes('adapter');
                let isKeystone = (equip.isKeystone || nome.includes('keystone') || nome.includes('pt')) && !isAdaptador;
                
                if (!imgSrc) {
                    if (isKeystone) {
                        imgSrc = null; // Keystones usarão ícone
                    } else if (nome.includes('switch') || nome.includes('sw')) {
                        imgSrc = 'static/img/equipamentos/switch-cisco.png';
                    } else if (nome.includes('tv') || nome.includes('tela')) {
                        imgSrc = 'static/img/equipamentos/tv-lg.png';
                    } else if (nome.includes('camera') || nome.includes('câmera')) {
                        imgSrc = 'static/img/equipamentos/camera-logitech.png';
                    } else if (nome.includes('microfone') || nome.includes('mic')) {
                        imgSrc = 'static/img/equipamentos/microfone-logitech.png';
                    } else if (nome.includes('speaker') || nome.includes('alto-falante')) {
                        imgSrc = 'static/img/equipamentos/speaker-logitech.png';
                    } else if (nome.includes('hub')) {
                        imgSrc = 'static/img/equipamentos/hub-logitech.png';
                    } else if (nome.includes('painel') || nome.includes('panel')) {
                        imgSrc = 'static/img/equipamentos/painel-crestron.png';
                    } else if (nome.includes('tap')) {
                        imgSrc = 'static/img/equipamentos/tap-logitech.png';
                    } else if (nome.includes('chromebox') || nome.includes('pc')) {
                        imgSrc = 'static/img/equipamentos/pc-ctl.png';
                    } else if (nome.includes('poe')) {
                        imgSrc = 'static/img/poe-logitech-kit-cat5e.png';
                    } else if (nome.includes('dongle')) {
                        imgSrc = 'static/img/dongle-logitech-logitech.png';
                    } else if (nome.includes('sensor') || nome.includes('presença')) {
                        imgSrc = 'static/img/sensor-crestron-cen-odt-c-poe.png';
                    } else if (nome.includes('meetup')) {
                        imgSrc = 'static/img/meetup-logitech-meetup.png';
                    } else if (nome.includes('adaptador') || nome.includes('adapter')) {
                        // Usar imagem específica do adaptador se disponível, senão usar uma genérica
                        if (nome.includes('hdmi') && nome.includes('mesa')) {
                            imgSrc = 'static/img/adaptador-kramer-hdmi-f-to-hdmi-f.png';
                        } else if (nome.includes('kramer') && nome.includes('hdmi')) {
                            imgSrc = 'static/img/adaptador-kramer-hdmi-f-to-hdmi-f.png';
                        } else if (nome.includes('dante') && nome.includes('analog') && nome.includes('input')) {
                            imgSrc = 'static/img/avio-dante-1ch-analog-input-adapter.png';
                        } else if (nome.includes('dante') && nome.includes('analog') && nome.includes('output')) {
                            imgSrc = 'static/img/avio-dante-1ch-analog-output-adapter.png';
                        } else if (nome.includes('dante') && nome.includes('2ch') && nome.includes('analog') && nome.includes('output')) {
                            imgSrc = 'static/img/avio-dante-2ch-analog-output-adapter.png';
                        } else if (nome.includes('dante') && nome.includes('2ch') && nome.includes('usb')) {
                            imgSrc = 'static/img/avio-dante-2ch-usb-io-adapter.png';
                        } else {
                            // Adaptador genérico - usar o primeiro disponível
                            imgSrc = 'static/img/adaptador-kramer-hdmi-f-to-hdmi-f.png';
                        }
                    } else {
                        imgSrc = 'static/img/equipamentos/pc-ctl.png';
                    }
                }
                 
                                 // Adiciona equipamento
                items.push({
                    type: 'equip',
                    id: `equip_${index}`,
                    x: x,
                    y: y,
                    w: largura,
                    h: altura,
                    img: imgSrc,
                    nome: equip.name,
                    isKeystone: isKeystone
                });
                
                // Adiciona texto do nome
                items.push({
                    type: 'text',
                    id: `text_${index}`,
                    x: x + (largura - 100) / 2, // Centraliza o texto em relação ao equipamento
                    y: y + altura + 5,
                    w: 100,
                    h: 25,
                    text: equip.name,
                    color: '#ffffff',
                    fontSize: '11px'
                });
            });
        }
        
        // Converte conexões
        if (layoutGrade.connections && layoutGrade.connections.length > 0) {
            layoutGrade.connections.forEach((conn, index) => {
                // Encontra os índices dos equipamentos conectados
                const fromIndex = layoutGrade.equipment.findIndex(e => 
                    e.row === conn.from.row && e.col === conn.from.col
                );
                const toIndex = layoutGrade.equipment.findIndex(e => 
                    e.row === conn.to.row && e.col === conn.to.col
                );
                
                if (fromIndex !== -1 && toIndex !== -1) {
                    conns.push({
                        id: `conn_${index}`,
                        fromId: `equip_${fromIndex}`,
                        toId: `equip_${toIndex}`,
                        name: conn.cableInfo,
                        label: conn.cableInfo,
                        color: getCorPorTipoCabo(conn.cableInfo),
                        fontSize: 11,
                        is_real: false
                    });
                }
            });
        }
        
        console.log('Layout convertido:', { items, conns });
        return { items, conns };
    }
    
    // Função para definir cor baseada no tipo de cabo
    function getCorPorTipoCabo(tipoCabo) {
        console.log('getCorPorTipoCabo chamada com:', tipoCabo);
        
        if (!tipoCabo) {
            console.warn('Tipo de cabo é null/undefined');
            return '#9E9E9E';  // Cinza como padrão
        }
        
        const tipoLower = tipoCabo.toLowerCase();
        
        // Ethernet / RJ45 / CAT
        if (tipoLower.includes('ethernet') || tipoLower.includes('rj45') || tipoLower.includes('cat') || 
            tipoLower.includes('eth') || tipoLower.includes('lan') || tipoLower.includes('network')) {
            return '#4CAF50'; // Verde
        }
        
        // HDMI
        if (tipoLower.includes('hdmi')) {
            return '#2196F3'; // Azul
        }
        
        // USB
        if (tipoLower.includes('usb')) {
            return '#FF9800'; // Laranja
        }
        
        // VGA
        if (tipoLower.includes('vga')) {
            return '#9C27B0'; // Roxo
        }
        
        // DisplayPort
        if (tipoLower.includes('displayport') || tipoLower.includes('dp')) {
            return '#00BCD4'; // Ciano
        }
        
        // DVI
        if (tipoLower.includes('dvi')) {
            return '#795548'; // Marrom
        }
        
        // Audio / XLR / TRS
        if (tipoLower.includes('audio') || tipoLower.includes('xlr') || tipoLower.includes('trs') || 
            tipoLower.includes('jack') || tipoLower.includes('mic') || tipoLower.includes('speaker')) {
            return '#E91E63'; // Rosa
        }
        
        // Power / Alimentação
        if (tipoLower.includes('power') || tipoLower.includes('alimentacao') || tipoLower.includes('energia') ||
            tipoLower.includes('poe') || tipoLower.includes('ac') || tipoLower.includes('dc')) {
            return '#FF5722'; // Vermelho escuro
        }
        
        // Serial / RS232 / RS485
        if (tipoLower.includes('serial') || tipoLower.includes('rs232') || tipoLower.includes('rs485') ||
            tipoLower.includes('com') || tipoLower.includes('modbus')) {
            return '#607D8B'; // Azul acinzentado
        }
        
        // Padrão - cinza
        return '#9E9E9E';
    }
    

    
         async function carregarLayoutManual() {
        if (!sala_id_atual) return;
        
        limparCanvas();
         atualizarStatus('Carregando layout...');
         
         try {
             const resp = await fetch(`/api/salas/${sala_id_atual}/layout`);
             if (!resp.ok) throw new Error('Nenhum layout salvo para esta sala.');
             const layout = await resp.json();
             
             // Converte o layout da grade para formato de visualização
             const layoutVisualizacao = converterLayoutParaVisualizacao(layout);
             await renderizarLayout(layoutVisualizacao);
             atualizarStatus('Layout carregado com sucesso');
        } catch (e) {
             document.getElementById('mainCanvas').innerHTML = `<div style='color:#e74c3c;font-size:1.3em;text-align:center;margin-top:80px;'>${e.message || 'Erro ao carregar layout.'}</div>`;
             atualizarStatus('Erro ao carregar layout');
        }
    }
    
        
    
    async function renderizarLayout(layout) {
        const mainCanvas = document.getElementById('mainCanvas');
        const svgEl = document.getElementById('svg-connections');
        
        if (!mainCanvas || !svgEl) {
            console.error('Elementos do canvas não encontrados');
            return;
        }
        
        // Renderiza equipamentos/textos e cria mapa de id
        const idToDiv = {};
        
        if (layout.items && layout.items.length > 0) {
            layout.items.forEach(item => {
                let div;
                if (item.type === 'equip') {
                    div = document.createElement('div');
                    div.className = 'equip-instance';
                    div.style.position = 'absolute';
                    div.style.left = item.x + 'px';
                    div.style.top = item.y + 'px';
                    div.style.width = item.w + 'px';
                    div.style.height = item.h + 'px';
                    div.dataset.id = item.id;
                    
                    // Verifica se é um adaptador (deve usar imagem mesmo se marcado como keystone)
                    const isAdaptador = item.nome && (item.nome.toLowerCase().includes('adaptador') || item.nome.toLowerCase().includes('adapter'));
                    
                    if (item.isKeystone && !isAdaptador) {
                        // Para keystones (exceto adaptadores), cria um ícone
                        const icon = document.createElement('div');
                        icon.innerHTML = '<i class="fas fa-network-wired" style="font-size: 2em; color: #ffffff;"></i>';
                        icon.style.display = 'flex';
                        icon.style.alignItems = 'center';
                        icon.style.justifyContent = 'center';
                        icon.style.width = '100%';
                        icon.style.height = '100%';
                        icon.style.fontSize = '24px';
                        icon.style.color = '#ffffff';
                        
                        div.appendChild(icon);
                    } else {
                        // Para outros equipamentos, cria a imagem
                        const img = document.createElement('img');
                        img.src = item.img || 'static/img/equipamentos/pc-ctl.png';
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'contain';
                        img.style.borderRadius = '8px';
                        img.onerror = function() {
                            console.warn('Erro ao carregar imagem:', item.img);
                            this.style.display = 'none';
                        };
                        
                        div.appendChild(img);
                    }
                    
                    mainCanvas.appendChild(div);
                    
                } else if (item.type === 'text') {
                    div = document.createElement('div');
                    div.className = 'equip-instance text-instance';
                    div.style.position = 'absolute';
                    div.style.left = item.x + 'px';
                    div.style.top = item.y + 'px';
                    div.style.width = item.w + 'px';
                    div.style.height = item.h + 'px';
                    div.dataset.id = item.id;
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.justifyContent = 'center';
                    div.style.textAlign = 'center';
                    div.style.padding = '2px';
                    
                    const span = document.createElement('span');
                    span.textContent = item.text;
                    span.style.color = item.color;
                    span.style.fontSize = item.fontSize;
                    span.style.fontWeight = 'bold';
                    span.style.lineHeight = '1.2';
                    span.style.wordWrap = 'break-word';
                    span.style.overflowWrap = 'break-word';
                    span.style.maxWidth = '100%';
                    div.appendChild(span);
                    mainCanvas.appendChild(div);
                }
                
                if (div) {
                    idToDiv[item.id] = div;
                }
            });
        }
        
        // Função para renderizar conexões após um pequeno delay
        function renderizarConexoes() {
            console.log('Iniciando renderização de conexões...');
            console.log('Layout.conns:', layout.conns);
            console.log('idToDiv keys:', Object.keys(idToDiv));
            
            if (layout.conns && layout.conns.length > 0) {
                console.log('Renderizando', layout.conns.length, 'conexões...');
                
                layout.conns.forEach((conn, index) => {
                    console.log(`Processando conexão ${index + 1}:`, conn);
                    const from = idToDiv[conn.fromId];
                    const to = idToDiv[conn.toId];
                    
                    console.log(`  fromId: ${conn.fromId}, from:`, from);
                    console.log(`  toId: ${conn.toId}, to:`, to);
                    
                    if (from && to) {
                        try {
                            // Calcula posições dos centros dos equipamentos
                            const x1 = from.offsetLeft + from.offsetWidth/2;
                            const y1 = from.offsetTop + from.offsetHeight/2;
                            const x2 = to.offsetLeft + to.offsetWidth/2;
                            const y2 = to.offsetTop + to.offsetHeight/2;
                            
                            // Cria o caminho SVG com arco mais suave
                            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                            const dx = Math.abs(x2 - x1) * 0.2;
                            const dy = Math.abs(y2 - y1) * 0.2;
                            
                            // Cria um arco mais suave e visível
                            path.setAttribute('d', `M${x1},${y1} C${x1+dx},${y1-dy} ${x2-dx},${y2+dy} ${x2},${y2}`);
                            path.setAttribute('stroke', conn.color || '#9E9E9E');
                            path.setAttribute('stroke-width', conn.is_real ? '5' : '3');
                            path.setAttribute('fill', 'none');
                            path.setAttribute('opacity', '0.85');
                            
                            // Adiciona estilo tracejado para todas as conexões (visual de desenho técnico)
                            path.setAttribute('stroke-dasharray', '6,4');
                            
                            if (conn.is_real) {
                                path.setAttribute('title', `Cabo: ${conn.codigo_cabo}\nTipo: ${conn.tipo_cabo}\nDe: ${conn.equipamento_origem || 'N/A'}\nPara: ${conn.equipamento_destino || 'N/A'}\nPorta Origem: ${conn.porta_origem || 'N/A'}\nPorta Destino: ${conn.porta_destino || 'N/A'}`);
                            } else {
                                path.setAttribute('title', `Cabo: ${conn.name || 'N/A'}`);
                            }
                            
                            svgEl.appendChild(path);
                            
                            // Adiciona texto da conexão com melhor legibilidade
                            if (conn.name || conn.label) {
                                const labelText = conn.name || conn.label;
                                 const textX = (x1+x2)/2;
                                 const textY = (y1+y2)/2 - 15; // Posiciona acima da linha
                                
                                 // Cria um fundo escuro para melhor contraste
                                const textBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                                 textBg.setAttribute('x', textX - 40);
                                 textBg.setAttribute('y', textY - 8);
                                 textBg.setAttribute('width', 80);
                                 textBg.setAttribute('height', 16);
                                 textBg.setAttribute('fill', 'rgba(0,0,0,0.8)');
                                textBg.setAttribute('rx', '4');
                                 textBg.setAttribute('opacity', '0.9');
                                svgEl.appendChild(textBg);
                                
                                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                 text.setAttribute('x', textX);
                                 text.setAttribute('y', textY + 4);
                                 text.setAttribute('fill', '#FFFFFF');
                                text.setAttribute('font-size', '11');
                                text.setAttribute('font-family', 'Arial, sans-serif');
                                text.setAttribute('text-anchor', 'middle');
                                text.setAttribute('font-weight', 'bold');
                                 text.setAttribute('letter-spacing', '0.3');
                                text.textContent = labelText;
                                
                                if (conn.is_real) {
                                    text.setAttribute('title', `Cabo: ${conn.codigo_cabo}\nTipo: ${conn.tipo_cabo}\nDe: ${conn.equipamento_origem || 'N/A'}\nPara: ${conn.equipamento_destino || 'N/A'}\nPorta Origem: ${conn.porta_origem || 'N/A'}\nPorta Destino: ${conn.porta_destino || 'N/A'}`);
                                    textBg.setAttribute('title', `Cabo: ${conn.codigo_cabo}\nTipo: ${conn.tipo_cabo}\nDe: ${conn.equipamento_origem || 'N/A'}\nPara: ${conn.equipamento_destino || 'N/A'}\nPorta Origem: ${conn.porta_origem || 'N/A'}\nPorta Destino: ${conn.porta_destino || 'N/A'}`);
                                }
                                
                                svgEl.appendChild(text);
                            }
                            
                            console.log(`Conexão ${index + 1} renderizada: ${conn.fromId} -> ${conn.toId}`);
                            
                        } catch (error) {
                            console.error('Erro ao renderizar conexão:', error, conn);
                        }
                    } else {
                        console.warn(`Conexão ${index + 1} não pode ser renderizada:`, {
                            fromId: conn.fromId,
                            toId: conn.toId,
                            fromExists: !!from,
                            toExists: !!to
                        });
                    }
                });
            }
        }
        
        // Aguarda um pouco para garantir que os elementos foram renderizados
        setTimeout(renderizarConexoes, 200);
        
        console.log('Layout renderizado:', {
            equipamentos: layout.items?.length || 0,
            conexoes: layout.conns?.length || 0,
            idToDiv: Object.keys(idToDiv)
        });
    }
    
         // Variáveis de zoom
     let currentZoom = 1;
     let isDragging = false;
     let lastMouseX = 0;
     let lastMouseY = 0;
     let translateX = 0;
     let translateY = 0;
     
     // Funções de controle de zoom
     function updateZoom() {
         const mainCanvas = document.getElementById('mainCanvas');
         const zoomLevel = document.getElementById('zoomLevel');
         
         mainCanvas.style.transform = `scale(${currentZoom}) translate(${translateX}px, ${translateY}px)`;
         zoomLevel.textContent = Math.round(currentZoom * 100) + '%';
         
         if (currentZoom > 1) {
             mainCanvas.classList.add('zoomed');
         } else {
             mainCanvas.classList.remove('zoomed');
         }
     }
     
     function zoomIn() {
         if (currentZoom < 3) {
             currentZoom *= 1.2;
             updateZoom();
         }
     }
     
     function zoomOut() {
         if (currentZoom > 0.3) {
             currentZoom /= 1.2;
             updateZoom();
         }
     }
     
     function resetZoom() {
         currentZoom = 1;
         translateX = 0;
         translateY = 0;
         updateZoom();
     }
     
     // Event listeners para zoom
     document.addEventListener('DOMContentLoaded', function() {
         const btnZoomIn = document.getElementById('btnZoomIn');
         const btnZoomOut = document.getElementById('btnZoomOut');
         const btnResetZoom = document.getElementById('btnResetZoom');
         const mainCanvas = document.getElementById('mainCanvas');
         
         btnZoomIn.addEventListener('click', zoomIn);
         btnZoomOut.addEventListener('click', zoomOut);
         btnResetZoom.addEventListener('click', resetZoom);
         
         // Pan com mouse quando zoomado
         mainCanvas.addEventListener('mousedown', function(e) {
             if (currentZoom > 1) {
                 isDragging = true;
                 lastMouseX = e.clientX;
                 lastMouseY = e.clientY;
                 mainCanvas.style.cursor = 'grabbing';
             }
         });
         
         mainCanvas.addEventListener('mousemove', function(e) {
             if (isDragging && currentZoom > 1) {
                 const deltaX = e.clientX - lastMouseX;
                 const deltaY = e.clientY - lastMouseY;
                 
                 translateX += deltaX / currentZoom;
                 translateY += deltaY / currentZoom;
                 
                 lastMouseX = e.clientX;
                 lastMouseY = e.clientY;
                 
                 updateZoom();
             }
         });
         
         mainCanvas.addEventListener('mouseup', function() {
             isDragging = false;
             if (currentZoom > 1) {
                 mainCanvas.style.cursor = 'grab';
             }
         });
         
         mainCanvas.addEventListener('mouseleave', function() {
             isDragging = false;
             if (currentZoom > 1) {
                 mainCanvas.style.cursor = 'grab';
             }
         });
         
         // Zoom com scroll
         mainCanvas.addEventListener('wheel', function(e) {
             if (e.ctrlKey || e.metaKey) {
                 e.preventDefault();
                 if (e.deltaY < 0) {
                     zoomIn();
                 } else {
                     zoomOut();
                 }
             }
         });
     });
    
    // Inicialização
    (function(){
        sala_id_atual = getSalaIdFromUrl();
        if (sala_id_atual) {
            carregarSalaInfo(sala_id_atual);
            carregarLayoutManual(); // Carrega layout manual por padrão
        } else {
            document.getElementById('mainCanvas').innerHTML = '<div style="color:#e74c3c;font-size:1.3em;text-align:center;margin-top:80px;">Sala não informada na URL.</div>';
            atualizarStatus('Sala não informada');
        }
    })();
    </script>
    <script src="static/js/logo-manager.js"></script>
    </body>
</html> 
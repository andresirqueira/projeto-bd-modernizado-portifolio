<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Editar Equipamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">`n    <script src="static/js/demo-banner.js"></script>
    <link rel="icon" type="image/png" href="static/img/favicon-lapis.png">
    <script>
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
        // Atualizar logo da empresa quando o tema mudar
        updateEmpresaLogo();
      }
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
</head>

<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
    <div class="relative w-full max-w-7xl mx-auto bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-8 mt-8">
        <button onclick="voltarPainelConfig()" class="absolute top-4 left-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-2 transition-colors" title="Voltar">
            <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="empresa-logada" class="absolute top-4 right-4 text-indigo-500 font-bold bg-gray-800 dark:bg-transparent rounded-lg p-2"></div>
        <button onclick="toggleDarkMode()" class="absolute top-4 left-16 bg-gray-200 dark:bg-gray-700 rounded-full p-2 transition-colors" title="Alternar modo escuro">
            <span class="dark:hidden">🌙</span><span class="hidden dark:inline">☀️</span>
        </button>
        <div class="text-center mt-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">
                <i class="fas fa-edit text-indigo-600 dark:text-indigo-400 mr-3"></i>
                Editar Equipamento
            </h1>
            <p class="text-gray-600 dark:text-gray-300">Modifique os dados do equipamento selecionado</p>
        </div>
        <!-- Filtros de Busca -->
        <div class="mb-6 flex flex-wrap gap-4 justify-center">
            <div class="flex gap-2">
                <div class="relative">
                    <input id="filtroEquipamento" type="text" class="px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white dark:border-gray-600" placeholder="Buscar equipamento...">
                    <div class="absolute right-3 top-2.5 text-gray-400 dark:text-gray-500 text-sm">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                <button onclick="limparBusca()" class="px-3 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded transition-colors text-sm" title="Limpar busca">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex gap-2">
                <button onclick="aplicarFiltroStatus('todos')" id="btn-todos" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded transition-colors text-sm">
                    <i class="fas fa-list"></i> Todos
                </button>
                <button onclick="aplicarFiltroStatus('funcionando')" id="btn-funcionando" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded transition-colors text-sm">
                    <i class="fas fa-check"></i> Funcionando
                </button>
                <button onclick="aplicarFiltroStatus('defeito')" id="btn-defeito" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded transition-colors text-sm">
                    <i class="fas fa-times"></i> Com Defeito
                </button>
            </div>
        </div>

        <div id="resultadosInfo" class="text-xs text-indigo-600 dark:text-indigo-400 text-center font-medium mb-4"></div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
            <div class="flex flex-col">
                <div id="equipamentos-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8"></div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-6" style="display: none;">
                <form id="formEquipamento" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 dark:text-white font-semibold mb-2">Nome:</label>
                        <input type="text" name="nome" id="nome" required class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-white font-semibold mb-2">Tipo:</label>
                        <select name="tipo" id="tipo" required class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:text-white dark:border-gray-600"></select>
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-white font-semibold mb-2">Marca:</label>
                        <select name="marca" id="marca" required class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:text-white dark:border-gray-600"></select>
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-white font-semibold mb-2">Modelo:</label>
                        <select name="modelo" id="modelo" class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:text-white dark:border-gray-600"></select>
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-white font-semibold mb-2">Part Number:</label>
                        <input type="text" name="partnumber" id="partnumber" class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-white font-semibold mb-2">Tamanho:</label>
                        <input type="text" name="tamanho" id="tamanho" class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 dark:text-white font-semibold mb-2">Descrição:</label>
                        <input type="text" name="descricao" id="descricao" class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-white font-semibold mb-2">Firmware:</label>
                        <input type="text" name="firmware" id="firmware" class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-white font-semibold mb-2">Número de Série:</label>
                        <input type="text" name="serie" id="serie" required class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-white font-semibold mb-2">IP 1:</label>
                        <input type="text" name="ip1" id="ip1" class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-white font-semibold mb-2">MAC 1:</label>
                        <input type="text" name="mac1" id="mac1" class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-white font-semibold mb-2">IP 2:</label>
                        <input type="text" name="ip2" id="ip2" class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-white font-semibold mb-2">MAC 2:</label>
                        <input type="text" name="mac2" id="mac2" class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    </div>
                    <div class="md:col-span-2 flex justify-center gap-4 mt-6">
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg shadow flex items-center gap-2 transition-colors text-lg">
                            <i class="fas fa-save"></i> Salvar Alterações
                        </button>
                        <button type="button" onclick="cancelarEdicao()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-8 rounded-lg shadow flex items-center gap-2 transition-colors text-lg">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="msg text-center mt-6 text-lg font-semibold" id="msg"></div>
    </div>
    <script>
        let equipamentos = [];
        let salasMap = {};
        let idSelecionado = null;
        let filtroStatusAtivo = 'todos';
        let termoBusca = '';
        const params = new URLSearchParams(window.location.search);
        const equipamentoIdParam = params.get('id');
        // --- Marcas e modelos dependentes ---
        const marcasPorTipo = {
            Projetor: ["Epson", "Outro"],
            TV: ["LG", "Sony", "Outro"],
            Tap: ["Logitech", "Outro"],
            Microfone: ["Shure", "Logitech", "Jabra", "Outro"],
            Speaker: ["JBL", "Shure", "Philips", "Outro"],
            Camera: ["Logitech", "Huddly", "Yealink", "Jabra", "Outro"],
            Painel: ["Crestron", "Outro"],
            Sensor: ["Crestron", "Outro"],
            PC: ["CTL", "Asus", "BlueTech", "Outro"],
            Hub: ["Logitech", "Outro"],
            Clickshare: ["Barco", "Outro"],
            AVIO: ["Dante", "Outro"],
            Extensores: ["Extron", "Kramer", "Outro"],
            Dongle: ["Logitech", "Outro"],
            "Tela Led": ["LG", "Leyard", "Outro"],
            Switcher: ["Kramer", "Outro"],
            Serial: ["Controlart", "Outro"],
            Antena: ["Shure", "Outro"],
            Mixer: ["Shure", "Outro"],
            Amplificador: ["QSC", "Outro"],
            Receptor: ["Shure", "Outro"],
            Poe: ["Logitech", "Outro"],
            Adaptador: ["Kramer", "Generico","Outro"],
            Fonte: ["Logitech", "Universal", "Outro"],
            Controladora: ["LG", "Leyard", "Nova Star", "Outro"],
            Outro: ["Outro"]
        };
        const modelosPorTipoMarca = {
            Projetor: {
                Epson: ["PowerLite X41+", "Outro"],
                Outro: ["Outro"]
            },
            TV: {
                LG: ["32LM621CBSB", "50UP751C0SF", "55UN731C0SC", "75UN801C0SB", "75UP801C0SB", "82UN8000PSB", "50UL3G-BJ", "43UN731C0SC", "50UN731C0SC","32SM5KE-BJ","Outro"],
                Sony: ["Bravia", "Outro"],
                Outro: ["Outro"]
            },
            "Tela Led": {
                LG: ["LG", "Outro"],
                Leyard: ["MGS Series", "Outro"],
                Outro: ["Outro"]
            },
            Tap: {
                Logitech: ["Tap Poe", "Tap USB", "Outro"],
                Outro: ["Outro"]
            },
            Microfone: {
                Shure: ["MXA710", "MXA910", "MXA920", "SM58", "BLX1","Outro"],
                Logitech: ["Rally Mic Pod", "Outro"],
                Jabra: ["Jabra Speak", "Outro"],
                Outro: ["Outro"]
            },
            Speaker: {
                JBL: ["JBL CBT 1000E", "Outro"],
                Logitech: ["Rally", "Outro"],
                Shure: ["MXN5W-C", "Outro"],
                Outro: ["Outro"]
            },
            Camera: {
                Logitech: ["Rally", "Meetup", "Outro"],
                Huddly: ["Huddly Go", "Outro"],
                Yealink: ["Yealink W52P", "Outro"],
                Jabra: ["Panacast", "Outro"],
                Outro: ["Outro"]
            },
            Painel: {
                Crestron: ["TSW-770-B-S", "TSW-770-W-S", "Outro"],
                Outro: ["Outro"]
            },
            Sensor: {
                Crestron: ["CEN-ODT-C-POE", "Outro"],
                Outro: ["Outro"]
            },
            PC: {
                CTL: ["CTL-1000", "Outro"],
                Asus: ["Asus", "Outro"],
                BlueTech: ["BlueTech", "Outro"],
                Outro: ["Outro"]
            },
            Hub: {
                Logitech: ["Display", "Table", "Mic Pod","Outro"],
                Outro: ["Outro"]
            },
            Clickshare: {
                Barco: ["C5", "C10", "CSE-200", "Outro"],
                Outro: ["Outro"]
            },
            AVIO: {
                Dante: ["2CH USB IO Adapter", "2CH Analog Output Adapter", "1CH Analog Input Adapter", "1CH Analog Output Adapter", "2CH Analog Input Adapter", "Outro"],
                Outro: ["Outro"]
            },
            Extensores: {
                Extron: ["DTP HDMI 230 Tx", "USB EXTENDER Plus T", "USB EXTENDER Plus R", "Outro"],
                Kramer: ["PT571", "Outro"],
                Outro: ["Outro"]
            },
            Dongle: {
                Logitech: ["Logitech", "Outro"],
                Outro: ["Outro"]
            },
            Switcher: {
                Kramer: ["VP-440X", "Outro"],
                RGBlink: ["X1PRO-E", "Outro"],
                Outro: ["Outro"]
            },
            Serial: {
                Controlart: ["rs-232"]
            },
            Antena: {
                Shure: ["UA864", "Outro"],
                Outro: ["Outro"]
            },
            Mixer: {
                Shure: ["ANI22", "Outro"],
                Outro: ["Outro"]
            },
            Amplificador: {
                QSC: ["DPA4.2Q", "Outro"],
                Outro: ["Outro"]
            },
            Receptor: {
                Shure: ["ULXD4Q", "Outro"],
                Outro: ["Outro"]
            },
            "Fonte": {
                Logitech: ["TAP","Table Hub","Display Hub", "Meetup","Rally Camera", "Outro"],
                Universal: ["Chromebox", "Outro"],
                Outro: ["Outro"]
            },
            Poe: {
                Logitech: ["KIT CAT5E", "Outro"],
                Outro: ["Outro"]
            },
            Adaptador: {
                Kramer: ["HDMI F to HDMI F", "Outro"],
                Generico: ["USBA to HDMI", "Outro"],
                Outro: ["USBA F to USBA F","Outro"]
            },
            Controladora: {
                LG: ["xxxxx", "Outro"],
                Leyard: ["MGS Series", "Outro"],
                "Nova Star": ["MCTRL700", "Outro"],
                Outro: ["Outro"]
            },
            Outro: {
                Outro: ["Outro"]
            }
        };
        // --- Fim dependências ---
        // Preencher Tipo
        async function preencherTipos(valor) {
            const resp = await fetch('/tipos-equipamento');
            const tipos = await resp.json();
            const tipoSelect = document.getElementById('tipo');
            tipoSelect.innerHTML = '<option value="">Selecione...</option>';
            if (tipos && tipos.length > 0) {
                tipos.filter(tipo => tipo && tipo.trim() !== "").forEach(tipo => {
                    const opt = document.createElement('option');
                    opt.value = tipo;
                    opt.textContent = tipo;
                    tipoSelect.appendChild(opt);
                });
            }
            if (valor) tipoSelect.value = valor;
        }
        // Preencher Marca
        async function preencherMarcas(tipo, valor) {
            const resp = await fetch(`/marcas-equipamento?tipo=${encodeURIComponent(tipo)}`);
            const marcas = await resp.json();
            const marcaSelect = document.getElementById('marca');
            marcaSelect.innerHTML = '<option value="">Selecione...</option>';
            let opcoes = [];
            if (marcas && marcas.length > 0) {
                opcoes = marcas.filter(marca => marca && marca.trim() !== "");
            } else if (marcasPorTipo[tipo]) {
                opcoes = marcasPorTipo[tipo];
            }
            opcoes.forEach(marca => {
                const opt = document.createElement('option');
                opt.value = marca;
                opt.textContent = marca;
                marcaSelect.appendChild(opt);
            });
            if (valor) marcaSelect.value = valor;
        }
        // Preencher Modelo
        async function preencherModelos(tipo, marca, valor) {
            const resp = await fetch(`/modelos-equipamento?tipo=${encodeURIComponent(tipo)}&marca=${encodeURIComponent(marca)}`);
            const modelos = await resp.json();
            const modeloSelect = document.getElementById('modelo');
            modeloSelect.innerHTML = '<option value="">Selecione...</option>';
            let opcoes = [];
            // Priorizar modelos locais se disponíveis
            if (modelosPorTipoMarca[tipo] && modelosPorTipoMarca[tipo][marca]) {
                opcoes = modelosPorTipoMarca[tipo][marca];
            } else if (modelos && modelos.length > 0) {
                opcoes = modelos.filter(modelo => modelo && modelo.trim() !== "");
            }
            opcoes.forEach(modelo => {
                const opt = document.createElement('option');
                opt.value = modelo;
                opt.textContent = modelo;
                modeloSelect.appendChild(opt);
            });
            if (valor) modeloSelect.value = valor;
        }
        // Preencher todas as opções de tipo ao focar/clicar
        document.getElementById('tipo').addEventListener('focus', async function () {
            await preencherTipos();
        });
        // Ao mudar o tipo, limpa marca e modelo
        document.getElementById('tipo').addEventListener('change', function () {
            preencherMarcas(this.value);
            document.getElementById('marca').value = '';
            document.getElementById('modelo').innerHTML = '<option value="">Selecione a marca primeiro</option>';
            document.getElementById('modelo').value = '';
        });
        // Ao mudar a marca, atualiza os modelos
        document.getElementById('marca').addEventListener('change', function () {
            const tipo = document.getElementById('tipo').value;
            preencherModelos(tipo, this.value);
        });
        // Buscar salas para mapear id -> nome
        fetch('/salas')
            .then(resp => resp.json())
            .then(salas => {
                salas.forEach(sala => {
                    salasMap[sala.id] = sala.nome;
                });
                carregarEquipamentos();
            });
        // Renderizar cards de equipamentos
        function renderizarCardsEquipamentos(lista) {
            const container = document.getElementById('equipamentos-cards-container');
            
            let html = '';
            lista.forEach(eq => {
                const salaIdStr = eq.sala_id !== undefined && eq.sala_id !== null ? String(eq.sala_id) : null;
                const nomeSala = salaIdStr && salasMap[salaIdStr] ? salasMap[salaIdStr] : (eq.sala_id ? eq.sala_id : 'Sem sala');
                const isDefeito = eq.defeito === 1 || eq.defeito === "1" || eq.defeito === true;
                
                html += `<div class='bg-white dark:bg-gray-800 rounded-xl shadow-lg flex flex-col h-full p-4 relative cursor-pointer border-2 ${isDefeito ? 'border-red-300 dark:border-red-600' : 'border-green-300 dark:border-green-600'} equipamento-card' data-id='${eq.id}'>`;
                
                // Badge de status
                html += `<div class='absolute top-2 right-2 w-8 h-8 rounded-full flex items-center justify-center ${isDefeito ? 'bg-red-500' : 'bg-green-500'} text-white' title='${isDefeito ? 'Defeito' : 'Funcionando'}'>`;
                html += `<i class='fas ${isDefeito ? 'fa-times' : 'fa-check'}'></i>`;
                html += `</div>`;
                
                // Logo da marca
                if (eq.marca) {
                    html += LogoManager.renderMarcaLogo(eq.marca);
                }
                
                // Imagem do equipamento
                if (eq.foto) {
                    html += `<div class='w-full h-20 flex items-center justify-center mb-3 mt-4'><img src='${eq.foto.startsWith("img/") ? "static/" + eq.foto : eq.foto}' alt='${eq.nome || ''}' class='object-contain max-h-20 max-w-20 rounded-md'/></div>`;
                } else {
                    html += `<div class='w-full h-20 flex items-center justify-center mb-3 mt-4 bg-gray-100 dark:bg-gray-700 rounded-md'><i class='fas fa-image text-2xl text-gray-300 dark:text-gray-600'></i></div>`;
                }
                
                // Nome do equipamento
                html += `<div class='font-semibold text-lg text-indigo-700 dark:text-indigo-300 mb-1 text-center'>${eq.nome || ''}</div>`;
                
                // Informações do equipamento
                html += `<div class='text-sm text-gray-700 dark:text-gray-200 space-y-1 flex-grow'>`;
                html += `<div><strong class='text-gray-800 dark:text-gray-200'>Sala:</strong> <span class='text-gray-700 dark:text-gray-300'>${nomeSala}</span></div>`;
                html += `<div><strong class='text-gray-800 dark:text-gray-200'>Status:</strong> <span class='font-normal ${isDefeito ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}'>${isDefeito ? 'Defeito' : 'Funcionando'}</span></div>`;
                html += `<div><strong class='text-gray-800 dark:text-gray-200'>Tipo:</strong> <span class='text-gray-700 dark:text-gray-300'>${eq.tipo || ''}</span></div>`;
                html += `<div><strong class='text-gray-800 dark:text-gray-200'>Marca:</strong> <span class='text-gray-700 dark:text-gray-300'>${eq.marca || ''}</span></div>`;
                html += `</div>`;
                
                // Ícone do equipamento
                if (eq.icone) {
                    html += `<div class='w-full h-8 flex items-center justify-center mb-2'><img src='${eq.icone.startsWith("img/") ? "static/" + eq.icone : eq.icone}' alt='ícone' class='max-h-8 object-contain'></div>`;
                }
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
            
            // Evento de clique para seleção
            container.querySelectorAll('div[data-id]').forEach(card => {
                card.onclick = function() {
                    const id = card.getAttribute('data-id');
                    const eq = lista.find(e => String(e.id) === id);
                    selecionarEquipamentoCard(eq);
                    
                    // Destacar card selecionado
                    container.querySelectorAll('div[data-id]').forEach(c => {
                        c.classList.remove('ring-4', 'ring-blue-500');
                    });
                    card.classList.add('ring-4', 'ring-blue-500');
                    
                    // Scroll automático para o formulário
                    const form = document.getElementById('formEquipamento');
                    if (form) {
                        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                };
            });
        }
        // Selecionar equipamento pelo card
        function selecionarEquipamentoCard(eq) {
            idSelecionado = eq.id;
            const form = document.getElementById('formEquipamento');
            const formContainer = form.parentElement;
            
            // Preencher o formulário
            form.nome.value = eq.nome || '';
            preencherTipos(eq.tipo);
            preencherMarcas(eq.tipo, eq.marca);
            preencherModelos(eq.tipo, eq.marca, eq.modelo);
            form.tipo.value = eq.tipo || '';
            form.marca.value = eq.marca || '';
            form.modelo.value = eq.modelo || '';
            form.partnumber.value = eq.dados?.partnumber || '';
            form.tamanho.value = eq.dados?.tamanho || '';
            form.descricao.value = eq.descricao || '';
            form.firmware.value = eq.dados?.firmware || '';
            form.serie.value = eq.dados?.serie || '';
            form.ip1.value = eq.dados?.ip1 || '';
            form.mac1.value = eq.dados?.mac1 || '';
            form.ip2.value = eq.dados?.ip2 || '';
            form.mac2.value = eq.dados?.mac2 || '';
            
            // Esconder todos os cards exceto o selecionado
            const container = document.getElementById('equipamentos-cards-container');
            const cards = container.querySelectorAll('.equipamento-card');
            cards.forEach(card => {
                if (card.getAttribute('data-id') == eq.id) {
                    card.style.display = 'block';
                    card.style.gridColumn = '1 / -1';
                    card.style.justifySelf = 'center';
                    card.style.maxWidth = '400px';
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Mostrar o formulário
            formContainer.style.display = 'block';
        }
        // Função para cancelar edição e voltar à visualização normal
        function cancelarEdicao() {
            // Limpar formulário
            document.getElementById('formEquipamento').reset();
            idSelecionado = null;
            
            // Esconder formulário
            const form = document.getElementById('formEquipamento');
            const formContainer = form.parentElement;
            formContainer.style.display = 'none';
            
            // Restaurar visualização normal dos cards
            const container = document.getElementById('equipamentos-cards-container');
            const cards = container.querySelectorAll('.equipamento-card');
            cards.forEach(card => {
                card.style.display = 'block';
                card.style.gridColumn = '';
                card.style.justifySelf = '';
                card.style.maxWidth = '';
            });
            
            // Limpar filtros e mostrar todos os equipamentos
            limparBusca();
        }
        
        // Carregar equipamentos e renderizar cards
        function carregarEquipamentos() {
            fetch('/equipamentos')
                .then(resp => resp.json())
                .then(data => {
                    equipamentos = data;
                    renderizarCardsEquipamentos(equipamentos);
                    if (equipamentoIdParam) {
                        const eq = equipamentos.find(e => String(e.id) === String(equipamentoIdParam));
                        if (eq) {
                            selecionarEquipamentoCard(eq);
                        }
                    }
                });
        }

        // Aplicar filtro por status
        function aplicarFiltroStatus(status) {
            filtroStatusAtivo = status;
            
            // Atualizar estilos dos botões
            document.getElementById('btn-todos').className = 'px-4 py-2 rounded transition-colors text-sm ' + (status === 'todos' ? 'bg-indigo-600 text-white' : 'bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300');
            document.getElementById('btn-funcionando').className = 'px-4 py-2 rounded transition-colors text-sm ' + (status === 'funcionando' ? 'bg-green-600 text-white' : 'bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300');
            document.getElementById('btn-defeito').className = 'px-4 py-2 rounded transition-colors text-sm ' + (status === 'defeito' ? 'bg-red-600 text-white' : 'bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300');
            
            aplicarFiltros();
        }

        // Aplicar filtros combinados
        function aplicarFiltros() {
            let filtrados = equipamentos;
            
            // Filtro por status
            if (filtroStatusAtivo === 'funcionando') {
                filtrados = filtrados.filter(eq => !(eq.defeito === 1 || eq.defeito === "1" || eq.defeito === true));
            } else if (filtroStatusAtivo === 'defeito') {
                filtrados = filtrados.filter(eq => eq.defeito === 1 || eq.defeito === "1" || eq.defeito === true);
            }
            
            // Filtro por texto
            if (termoBusca) {
                filtrados = filtrados.filter(eq => {
                    const nomeMatch = (eq.nome || '').toLowerCase().includes(termoBusca);
                    const tipoMatch = (eq.tipo || '').toLowerCase().includes(termoBusca);
                    const marcaMatch = (eq.marca || '').toLowerCase().includes(termoBusca);
                    const modeloMatch = (eq.modelo || '').toLowerCase().includes(termoBusca);
                    const serieMatch = (eq.dados?.serie || '').toLowerCase().includes(termoBusca);
                    const salaIdStr = eq.sala_id !== undefined && eq.sala_id !== null ? String(eq.sala_id) : null;
                    const nomeSala = salaIdStr && salasMap[salaIdStr] ? salasMap[salaIdStr] : '';
                    const salaMatch = nomeSala.toLowerCase().includes(termoBusca);
                    const descricaoMatch = (eq.descricao || '').toLowerCase().includes(termoBusca);
                    const partNumberMatch = (eq.dados?.partnumber || '').toLowerCase().includes(termoBusca);
                    const ipMatch = (eq.dados?.ip1 || '').toLowerCase().includes(termoBusca) || 
                                   (eq.dados?.ip2 || '').toLowerCase().includes(termoBusca);
                    const macMatch = (eq.dados?.mac1 || '').toLowerCase().includes(termoBusca) || 
                                    (eq.dados?.mac2 || '').toLowerCase().includes(termoBusca);
                    
                    return nomeMatch || tipoMatch || marcaMatch || modeloMatch || serieMatch || 
                           salaMatch || descricaoMatch || partNumberMatch || ipMatch || macMatch;
                });
            }
            
            renderizarCardsEquipamentos(filtrados);
            atualizarIndicadorResultados(filtrados);
        }

        // Função para limpar busca
        function limparBusca() {
            // Se há um equipamento selecionado para edição, cancelar a edição primeiro
            if (document.getElementById('formEquipamento').parentElement.style.display !== 'none') {
                cancelarEdicao();
                return;
            }
            
            document.getElementById('filtroEquipamento').value = '';
            termoBusca = '';
            filtroStatusAtivo = 'todos';
            
            // Resetar botões
            document.getElementById('btn-todos').className = 'px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded transition-colors text-sm';
            document.getElementById('btn-funcionando').className = 'px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded transition-colors text-sm';
            document.getElementById('btn-defeito').className = 'px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded transition-colors text-sm';
            
            renderizarCardsEquipamentos(equipamentos);
            atualizarIndicadorResultados(equipamentos);
        }
        
        // Função para atualizar indicador de resultados
        function atualizarIndicadorResultados(filtrados) {
            const infoDiv = document.getElementById('resultadosInfo');
            if (termoBusca || filtroStatusAtivo !== 'todos') {
                const filtros = [];
                if (termoBusca) filtros.push(`busca: "${termoBusca}"`);
                if (filtroStatusAtivo !== 'todos') filtros.push(`status: ${filtroStatusAtivo === 'funcionando' ? 'funcionando' : 'defeito'}`);
                
                infoDiv.innerHTML = `<i class="fas fa-filter"></i> Filtros: ${filtros.join(', ')} (${filtrados.length} resultado${filtrados.length !== 1 ? 's' : ''})`;
            } else {
                infoDiv.innerHTML = '';
            }
        }
        
        // Filtro de equipamentos por texto
        document.getElementById('filtroEquipamento').addEventListener('input', function() {
            termoBusca = this.value.trim().toLowerCase();
            aplicarFiltros();
        });
        // Submete as alterações
        document.getElementById('formEquipamento').onsubmit = async function (e) {
            e.preventDefault();
            if (!idSelecionado) {
                document.getElementById('msg').innerText = 'Selecione um equipamento!';
                return;
            }
            const form = e.target;
            const dados = {
                nome: form.nome.value,
                tipo: form.tipo.value,
                marca: form.marca.value,
                modelo: form.modelo.value,
                descricao: form.descricao.value,
                dados: {
                    partnumber: form.partnumber.value,
                    tamanho: form.tamanho.value,
                    firmware: form.firmware.value,
                    serie: form.serie.value,
                    ip1: form.ip1.value,
                    mac1: form.mac1.value,
                    ip2: form.ip2.value,
                    mac2: form.mac2.value
                }
            };
            const resp = await fetch(`/equipamentos/${idSelecionado}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            });
            let json = null;
            let bodyText = '';
            try {
                bodyText = await resp.text();
                json = JSON.parse(bodyText);
            } catch (err) {
                json = null;
            }
            if (resp.ok && json && json.status === 'ok') {
                document.getElementById('msg').innerText = 'Equipamento atualizado com sucesso!';
                form.reset();
                document.getElementById('equipamentos-cards-container').innerHTML = '';
                // Recarrega a lista de equipamentos para refletir possíveis mudanças
                carregarEquipamentos();
            } else {
                const erro = json && json.mensagem ? json.mensagem : `Erro ao atualizar equipamento (status ${resp.status}).`;
                document.getElementById('msg').innerText = erro;
            }
        };
        function voltarPainelConfig() {
            fetch('/perfil').then(resp => resp.json()).then(perfil => {
                if (perfil.nivel === 'admin') {
                    window.location.href = 'config-admin.html';
                } else if (perfil.nivel === 'tecnico') {
                    window.location.href = 'config-tecnico.html';
                } else {
                    window.location.href = 'config-usuario.html';
                }
            });
        }
        window.addEventListener('DOMContentLoaded', function() {
            fetch('/empresa_atual')
                .then(resp => resp.json())
                .then(data => {
                    LogoManager.loadEmpresaLogo(data);
                });
        });
    </script>
    <script src="static/js/logo-manager.js"></script>
    </body>

</html>

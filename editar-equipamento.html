<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Editar Equipamento</title>
    <link rel="stylesheet" href="css/estilo-base.css">
    <link rel="stylesheet" href="css/estilo-editar-equipamento.css">
    <link rel="stylesheet" href="css/estilo-excluir-equipamento.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body style="background: rgb(18, 33, 55);">
    <div class="admin-container">
        <div class="voltar-container">
            <button class="card-btn voltar" onclick="voltarPainelConfig()" title="Voltar">
                <i class="fas fa-arrow-left"></i>
            </button>
        </div>
        <h1>Editar Equipamento</h1>
        <div id="empresa-logada"></div>
        <div class="equip-layout-2col">
            <div class="equip-col-cards">
                <div style="width:100%;margin-bottom:18px;">
                    <input id="filtroEquipamento" type="text" class="input-filtro-equipamento input-estilizado" placeholder="Filtrar por nome do equipamento...">
                </div>
                <div style="overflow-x:auto;"><div id="equipamentos-cards-container"></div></div>
            </div>
            <div class="equip-col-form">
                <div class="card-form">
                    <form id="formEquipamento" class="form-equipamento">
                        <label for="nome">Nome:
                            <input type="text" name="nome" id="nome" required class="input-estilizado">
                        </label>
                        <label for="tipo">Tipo:
                            <select name="tipo" id="tipo" required class="input-estilizado"></select>
                        </label>
                        <label for="marca">Marca:
                            <select name="marca" id="marca" required class="input-estilizado"></select>
                        </label>
                        <label for="modelo">Modelo:
                            <select name="modelo" id="modelo" class="input-estilizado"></select>
                        </label>
                        <label for="partnumber">Part Number:
                            <input type="text" name="partnumber" id="partnumber" class="input-estilizado">
                        </label>
                        <label for="tamanho">Tamanho:
                            <input type="text" name="tamanho" id="tamanho" class="input-estilizado">
                        </label>
                        <label for="descricao">Descrição:
                            <input type="text" name="descricao" id="descricao" class="input-estilizado">
                        </label>
                        <label for="firmware">Firmware:
                            <input type="text" name="firmware" id="firmware" class="input-estilizado">
                        </label>
                        <label for="serie">Número de Série:
                            <input type="text" name="serie" id="serie" required class="input-estilizado">
                        </label>
                        <label for="ip1">IP 1:
                            <input type="text" name="ip1" id="ip1" class="input-estilizado">
                        </label>
                        <label for="mac1">MAC 1:
                            <input type="text" name="mac1" id="mac1" class="input-estilizado">
                        </label>
                        <label for="ip2">IP 2:
                            <input type="text" name="ip2" id="ip2" class="input-estilizado">
                        </label>
                        <label for="mac2">MAC 2:
                            <input type="text" name="mac2" id="mac2" class="input-estilizado">
                        </label>
                        <div style="display: flex; justify-content: center;">
                            <button type="submit" class="card-btn cadastrar" style="width:auto;height:auto;padding:8px 16px;font-size:1em;display:inline-flex;align-items:center;gap:6px;">
                                <i class="fas fa-save"></i> Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="msg" id="msg"></div>
    </div>
    <script>
        let equipamentos = [];
        let salasMap = {};
        let idSelecionado = null;
        // --- Marcas e modelos dependentes ---
        const marcasPorTipo = {
            Projetor: ["Epson", "Outro"],
            TV: ["LG", "Sony", "Outro"],
            Tap: ["Logitech", "Outro"],
            Microfone: ["Shure", "Logitech", "Jabra", "Outro"],
            Speaker: ["JBL", "Shure", "Philips", "Outro"],
            Camera: ["Logitech", "Huddly", "Yealink", "Jabra", "Outro"],
            Painel: ["Crestron", "Outro"],
            Sensor: ["Crestron", "Outro"],
            PC: ["CTL", "Asus", "BlueTech", "Outro"],
            Hub: ["Logitech", "Outro"],
            Clickshare: ["Barco", "Outro"],
            AVIO: ["Dante", "Outro"],
            Extensores: ["Extron", "Outro"],
            Dongle: ["Logitech", "Outro"],
            "Tela Led": ["LG", "Leyard", "Outro"],
            Switcher: ["Kramer", "Outro"],
            Outro: ["Outro"]
        };
        const modelosPorTipoMarca = {
            Projetor: {
                Epson: ["PowerLite X41+", "Outro"],
                Outro: ["Outro"]
            },
            TV: {
                LG: ["32LM621CBSB", "50UP751C0SF", "55UN731C0SC", "75UN801C0SB", "75UP801C0SB", "82UN8000PSB", "Outro"],
                Sony: ["Bravia", "Outro"],
                Outro: ["Outro"]
            },
            "Tela Led": {
                LG: ["LG", "Outro"],
                Leyard: ["Leyard", "Outro"],
                Outro: ["Outro"]
            },
            Tap: {
                Logitech: ["Tap Poe", "Tap USB", "Outro"],
                Outro: ["Outro"]
            },
            Microfone: {
                Shure: ["MXA710", "MXA910", "MXA920", "Bastão SM58", "Outro"],
                Logitech: ["Rally Mic Pod", "Outro"],
                Jabra: ["Jabra Speak", "Outro"],
                Outro: ["Outro"]
            },
            Speaker: {
                JBL: ["JBL CBT 1000E", "Outro"],
                Logitech: ["Rally", "Outro"],
                Shure: ["MXN5W-C", "Outro"],
                Outro: ["Outro"]
            },
            Camera: {
                Logitech: ["Rally", "Meetup", "Outro"],
                Huddly: ["Huddly Go", "Outro"],
                Yealink: ["Yealink W52P", "Outro"],
                Jabra: ["Panacast", "Outro"],
                Outro: ["Outro"]
            },
            Painel: {
                Crestron: ["TSW-770-B-S", "TSW-770-W-S", "Outro"],
                Outro: ["Outro"]
            },
            Sensor: {
                Crestron: ["CEN-ODT-C-POE", "Outro"],
                Outro: ["Outro"]
            },
            PC: {
                CTL: ["CTL-1000", "Outro"],
                Asus: ["Asus", "Outro"],
                BlueTech: ["BlueTech", "Outro"],
                Outro: ["Outro"]
            },
            Hub: {
                Logitech: ["Display", "Table", "Outro"],
                Outro: ["Outro"]
            },
            Clickshare: {
                Barco: ["C5", "C10", "CSE-200", "Outro"],
                Outro: ["Outro"]
            },
            AVIO: {
                Dante: ["2CH USB I/O Adapter", "2CH Analog Output Adapter", "1CH Analog Input Adapter", "Outro"],
                Outro: ["Outro"]
            },
            Extensores: {
                Extron: ["DTP HDMI 230 Tx", "USB EXTENDER Plus T", "Outro"],
                Outro: ["Outro"]
            },
            Dongle: {
                Logitech: ["Logitech", "Outro"],
                Outro: ["Outro"]
            },
            Switcher: {
                Kramer: ["VP-440X", "Outro"],
                Outro: ["Outro"]
            },
            Outro: {
                Outro: ["Outro"]
            }
        };
        // --- Fim dependências ---
        // Preencher Tipo
        async function preencherTipos(valor) {
            const resp = await fetch('/tipos-equipamento');
            const tipos = await resp.json();
            const tipoSelect = document.getElementById('tipo');
            tipoSelect.innerHTML = '<option value="">Selecione...</option>';
            if (tipos && tipos.length > 0) {
                tipos.filter(tipo => tipo && tipo.trim() !== "").forEach(tipo => {
                    const opt = document.createElement('option');
                    opt.value = tipo;
                    opt.textContent = tipo;
                    tipoSelect.appendChild(opt);
                });
            }
            if (valor) tipoSelect.value = valor;
        }
        // Preencher Marca
        async function preencherMarcas(tipo, valor) {
            const resp = await fetch(`/marcas-equipamento?tipo=${encodeURIComponent(tipo)}`);
            const marcas = await resp.json();
            const marcaSelect = document.getElementById('marca');
            marcaSelect.innerHTML = '<option value="">Selecione...</option>';
            let opcoes = [];
            if (marcas && marcas.length > 0) {
                opcoes = marcas.filter(marca => marca && marca.trim() !== "");
            } else if (marcasPorTipo[tipo]) {
                opcoes = marcasPorTipo[tipo];
            }
            opcoes.forEach(marca => {
                const opt = document.createElement('option');
                opt.value = marca;
                opt.textContent = marca;
                marcaSelect.appendChild(opt);
            });
            if (valor) marcaSelect.value = valor;
        }
        // Preencher Modelo
        async function preencherModelos(tipo, marca, valor) {
            const resp = await fetch(`/modelos-equipamento?tipo=${encodeURIComponent(tipo)}&marca=${encodeURIComponent(marca)}`);
            const modelos = await resp.json();
            const modeloSelect = document.getElementById('modelo');
            modeloSelect.innerHTML = '<option value="">Selecione...</option>';
            let opcoes = [];
            if (modelos && modelos.length > 0) {
                opcoes = modelos.filter(modelo => modelo && modelo.trim() !== "");
            } else if (modelosPorTipoMarca[tipo] && modelosPorTipoMarca[tipo][marca]) {
                opcoes = modelosPorTipoMarca[tipo][marca];
            }
            opcoes.forEach(modelo => {
                const opt = document.createElement('option');
                opt.value = modelo;
                opt.textContent = modelo;
                modeloSelect.appendChild(opt);
            });
            if (valor) modeloSelect.value = valor;
        }
        // Preencher todas as opções de tipo ao focar/clicar
        document.getElementById('tipo').addEventListener('focus', async function () {
            await preencherTipos();
        });
        // Ao mudar o tipo, limpa marca e modelo
        document.getElementById('tipo').addEventListener('change', function () {
            preencherMarcas(this.value);
            document.getElementById('marca').value = '';
            document.getElementById('modelo').innerHTML = '<option value="">Selecione a marca primeiro</option>';
            document.getElementById('modelo').value = '';
        });
        // Buscar salas para mapear id -> nome
        fetch('/salas')
            .then(resp => resp.json())
            .then(salas => {
                salas.forEach(sala => {
                    salasMap[sala.id] = sala.nome;
                });
                carregarEquipamentos();
            });
        // Renderizar cards igual excluir-equipamento
        function renderizarCardsEquipamentos(lista) {
            const container = document.getElementById('equipamentos-cards-container');
            let html = '';
            lista.forEach(eq => {
                const salaIdStr = eq.sala_id !== undefined && eq.sala_id !== null ? String(eq.sala_id) : null;
                html += `<div class='card-equipamento' data-id='${eq.id}'>`;
                if (eq.foto) {
                    html += `<div class='equip-foto'><img src='${eq.foto.startsWith("img/") ? "static/" + eq.foto : eq.foto}' alt='${eq.nome || ''}'></div>`;
                }
                html += `<div class='equip-nome'>${eq.nome || ''}</div>`;
                html += `<div class='equip-info'>`;
                html += `<div class='equip-info-linha'><b>Sala:</b> ${salaIdStr && salasMap[salaIdStr] ? salasMap[salaIdStr] : (eq.sala_id ? eq.sala_id : 'Sem sala')}</div>`;
                html += `<div class='equip-info-linha'><b>Status:</b> ${eq.defeito === 1 || eq.defeito === true || eq.status === 'defeito' ? 'Defeito' : 'Funcionando'}</div>`;
                html += `<div class='equip-info-linha'><b>Tipo:</b> ${eq.tipo || ''}</div>`;
                html += `<div class='equip-info-linha'><b>Marca:</b> ${eq.marca || ''}</div>`;
                html += `<div class='equip-info-linha'><b>Série:</b> ${eq.dados?.serie || ''}</div>`;
                html += `<div class='equip-info-linha'><b>Descrição:</b> ${eq.descricao || ''}</div>`;
                html += `</div>`;
                if (eq.icone) {
                    html += `<div class='equip-icone'><img src='${eq.icone.startsWith("img/") ? "static/" + eq.icone : eq.icone}' alt='ícone'></div>`;
                }
                html += `</div>`;
            });
            container.innerHTML = html;
            // Evento de clique para seleção
            document.querySelectorAll('.card-equipamento').forEach(card => {
                card.onclick = function() {
                    const id = card.getAttribute('data-id');
                    const eq = lista.find(e => String(e.id) === id);
                    selecionarEquipamentoCard(eq);
                    // Destacar card selecionado
                    document.querySelectorAll('.card-equipamento').forEach(c => c.style.border = '2px solid #444');
                    card.style.border = '2px solid #4a90e2';
                    // Scroll automático para o formulário
                    const form = document.getElementById('formEquipamento');
                    if (form) {
                        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                };
            });
        }
        // Selecionar equipamento pelo card
        function selecionarEquipamentoCard(eq) {
            idSelecionado = eq.id;
            const form = document.getElementById('formEquipamento');
            form.nome.value = eq.nome || '';
            preencherTipos(eq.tipo);
            preencherMarcas(eq.tipo, eq.marca);
            preencherModelos(eq.tipo, eq.marca, eq.modelo);
            form.tipo.value = eq.tipo || '';
            form.marca.value = eq.marca || '';
            form.modelo.value = eq.modelo || '';
            form.partnumber.value = eq.dados?.partnumber || '';
            form.tamanho.value = eq.dados?.tamanho || '';
            form.descricao.value = eq.descricao || '';
            form.firmware.value = eq.dados?.firmware || '';
            form.serie.value = eq.dados?.serie || '';
            form.ip1.value = eq.dados?.ip1 || '';
            form.mac1.value = eq.dados?.mac1 || '';
            form.ip2.value = eq.dados?.ip2 || '';
            form.mac2.value = eq.dados?.mac2 || '';
        }
        // Carregar equipamentos e renderizar cards
        function carregarEquipamentos() {
            fetch('/equipamentos')
                .then(resp => resp.json())
                .then(data => {
                    equipamentos = data;
                    renderizarCardsEquipamentos(equipamentos);
                });
        }
        // Filtro de equipamentos
        document.getElementById('filtroEquipamento').addEventListener('input', function() {
            const termo = this.value.trim().toLowerCase();
            const filtrados = termo ? equipamentos.filter(eq =>
                (eq.nome||'').toLowerCase().includes(termo) ||
                (eq.tipo||'').toLowerCase().includes(termo) ||
                (eq.marca||'').toLowerCase().includes(termo) ||
                (eq.modelo||'').toLowerCase().includes(termo)
            ) : equipamentos;
            renderizarCardsEquipamentos(filtrados);
        });
        // Submete as alterações
        document.getElementById('formEquipamento').onsubmit = async function (e) {
            e.preventDefault();
            if (!idSelecionado) {
                document.getElementById('msg').innerText = 'Selecione um equipamento!';
                return;
            }
            const form = e.target;
            const dados = {
                nome: form.nome.value,
                tipo: form.tipo.value,
                marca: form.marca.value,
                modelo: form.modelo.value,
                descricao: form.descricao.value,
                dados: {
                    partnumber: form.partnumber.value,
                    tamanho: form.tamanho.value,
                    firmware: form.firmware.value,
                    serie: form.serie.value,
                    ip1: form.ip1.value,
                    mac1: form.mac1.value,
                    ip2: form.ip2.value,
                    mac2: form.mac2.value
                }
            };
            const resp = await fetch(`/equipamentos/${idSelecionado}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            });
            const json = await resp.json();
            if (json.status === 'ok') {
                document.getElementById('msg').innerText = 'Equipamento atualizado com sucesso!';
                form.reset();
                document.getElementById('equipamentos-cards-container').innerHTML = '';
                // Recarrega a lista de equipamentos para refletir possíveis mudanças
                carregarEquipamentos();
            } else {
                document.getElementById('msg').innerText = 'Erro ao atualizar equipamento!';
            }
        };
        function voltarPainelConfig() {
            fetch('/perfil').then(resp => resp.json()).then(perfil => {
                if (perfil.nivel === 'admin') {
                    window.location.href = 'config-admin.html';
                } else if (perfil.nivel === 'tecnico') {
                    window.location.href = 'config-tecnico.html';
                } else {
                    window.location.href = 'config-usuario.html';
                }
            });
        }
        window.addEventListener('DOMContentLoaded', function() {
            fetch('/empresa_atual')
                .then(resp => resp.json())
                .then(data => {
                    if (data.logo) {
                        document.getElementById('empresa-logada').innerHTML = `<img src="${data.logo}" alt="Logo da empresa" style="max-height:40px;max-width:120px;object-fit:contain;">`;
                    } else if (data.nome) {
                        document.getElementById('empresa-logada').innerText = 'Empresa: ' + data.nome;
                    }
                });
        });
    </script>
</body>

</html>
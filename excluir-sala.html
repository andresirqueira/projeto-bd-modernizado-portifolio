<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Excluir Sala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="static/img/favicon-lixeira.png">
    <script>
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
        // Atualizar logo da empresa quando o tema mudar
        updateEmpresaLogo();
      }
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
</head>
<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
    <div class="relative w-full max-w-5xl mx-auto bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-8 mt-8">
        <button onclick="window.location.href='config-admin.html'" class="absolute top-4 left-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-2 transition-colors" title="Voltar">
            <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="empresa-logada" class="absolute top-4 right-4 text-indigo-500 font-bold bg-gray-800 dark:bg-transparent rounded-lg p-2"></div>
        <button onclick="toggleDarkMode()" class="absolute top-4 left-16 bg-gray-200 dark:bg-gray-700 rounded-full p-2 transition-colors" title="Alternar modo escuro">
            <span class="dark:hidden">üåô</span><span class="hidden dark:inline">‚òÄÔ∏è</span>
        </button>
        <div class="text-center mt-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">
                <i class="fas fa-trash text-indigo-600 dark:text-indigo-400 mr-3"></i>
                Excluir Sala
            </h1>
            <p class="text-gray-600 dark:text-gray-300">Remova salas do sistema de forma segura</p>
        </div>
        <div class="mb-6 flex flex-wrap gap-4 justify-center" id="resumoSalas"></div>
        <div class="flex flex-col gap-4 mb-6">
            <div class="flex gap-2">
                <div class="relative flex-1 max-w-md mx-auto">
                    <input id="filtroSala" type="text" class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white dark:border-gray-600" placeholder="Buscar por nome, tipo, descri√ß√£o...">
                    <div class="absolute right-3 top-2.5 text-gray-400 dark:text-gray-500 text-sm">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                <button onclick="limparBusca()" class="px-3 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded transition-colors text-sm" title="Limpar busca">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-400 text-center">
                <i class="fas fa-info-circle"></i> Dica: Voc√™ pode buscar por nome, tipo, descri√ß√£o ou andar
            </div>
            <div id="resultadosInfo" class="text-xs text-indigo-600 dark:text-indigo-400 text-center font-medium"></div>
            <div id="cardsSalasContainer" class="flex flex-wrap gap-6 justify-center"></div>
        </div>
        <div class="msg text-center mt-4 text-lg font-semibold" id="msg"></div>
    </div>
    <script>
    let todasSalas = [];
    let filtroAtivo = null; // Para controlar qual filtro est√° ativo
    
    async function carregarSalas() {
        const resp = await fetch('/salas');
        const salas = await resp.json();
        todasSalas = salas;
        renderizarCards(salas);
        renderizarResumo(salas);
    }
    
    // Fun√ß√£o para aplicar filtro por tipo
    function aplicarFiltro(tipo) {
        filtroAtivo = tipo;
        const filtrados = tipo === 'total' ? todasSalas : todasSalas.filter(sala => sala.tipo === tipo);
        renderizarCards(filtrados);
        // Limpar o campo de busca quando aplicar filtro por tipo
        document.getElementById('filtroSala').value = '';
        atualizarIndicadorResultados(filtrados, '');
    }
    
    // Fun√ß√£o para limpar busca
    function limparBusca() {
        document.getElementById('filtroSala').value = '';
        filtroAtivo = null;
        renderizarCards(todasSalas);
        atualizarIndicadorResultados(todasSalas, '');
    }
    
    // Fun√ß√£o para renderizar resumo das salas
    function renderizarResumo(salas) {
        const resumoDiv = document.getElementById('resumoSalas');
        if (!salas.length) {
            resumoDiv.innerHTML = "<span class='text-gray-400 dark:text-gray-500'>Nenhuma sala encontrada.</span>";
            return;
        }
        // Conta por tipo
        const tipos = {};
        salas.forEach(sala => {
            if (!tipos[sala.tipo]) tipos[sala.tipo] = 0;
            tipos[sala.tipo]++;
        });
        
        // Card Total - sempre clic√°vel
        const totalAtivo = filtroAtivo === 'total' ? 'ring-4 ring-yellow-400' : '';
        let html = `
            <div onclick="aplicarFiltro('total')" class="flex items-center gap-2 bg-indigo-600 dark:bg-indigo-800 text-white px-5 py-2 rounded-lg shadow cursor-pointer hover:bg-indigo-700 dark:hover:bg-indigo-700 transition-colors ${totalAtivo}" title="Mostrar todas as salas">
                <i class="fas fa-building"></i> Total: <b class='ml-1'>${salas.length}</b>
            </div>
        `;
        
        // Se h√° filtro ativo, mostrar apenas o card do tipo selecionado
        if (filtroAtivo && filtroAtivo !== 'total' && tipos[filtroAtivo]) {
            const tipoAtivo = 'ring-4 ring-yellow-400';
            html += `
                <div onclick="aplicarFiltro('${filtroAtivo}')" class="flex items-center gap-2 bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 px-5 py-2 rounded-lg shadow cursor-pointer hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors ${tipoAtivo}" title="Filtrar por ${filtroAtivo}">
                    <i class="fas fa-tag"></i> ${filtroAtivo || 'Sem tipo'}: <b class='ml-1'>${tipos[filtroAtivo]}</b>
                </div>
            `;
        } else {
            // Cards por tipo - clic√°veis (apenas quando n√£o h√° filtro ativo)
            Object.entries(tipos).forEach(([tipo, qtd]) => {
                const tipoAtivo = filtroAtivo === tipo ? 'ring-4 ring-yellow-400' : '';
                html += `
                    <div onclick="aplicarFiltro('${tipo}')" class="flex items-center gap-2 bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 px-5 py-2 rounded-lg shadow cursor-pointer hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors ${tipoAtivo}" title="Filtrar por ${tipo}">
                        <i class="fas fa-tag"></i> ${tipo || 'Sem tipo'}: <b class='ml-1'>${qtd}</b>
                    </div>
                `;
            });
        }
        resumoDiv.innerHTML = html;
    }
    
    // Fun√ß√£o para atualizar indicador de resultados
    function atualizarIndicadorResultados(filtrados, termo) {
        const infoDiv = document.getElementById('resultadosInfo');
        if (termo || (filtroAtivo && filtroAtivo !== 'total')) {
            const filtros = [];
            if (termo) filtros.push(`busca: "${termo}"`);
            if (filtroAtivo && filtroAtivo !== 'total') filtros.push(`tipo: ${filtroAtivo}`);
            
            infoDiv.innerHTML = `<i class="fas fa-filter"></i> Filtros: ${filtros.join(', ')} (${filtrados.length} resultado${filtrados.length !== 1 ? 's' : ''})`;
        } else {
            infoDiv.innerHTML = '';
        }
    }
    function renderizarCards(salas) {
        const container = document.getElementById('cardsSalasContainer');
        const termoBusca = document.getElementById('filtroSala').value.trim().toLowerCase();
        
        let html = '';
        for (const sala of salas) {
            // Destacar termo de busca no nome
            const nomeDestacado = termoBusca && sala.nome ? 
                sala.nome.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                (sala.nome || '');
            
            // Destacar termo de busca no tipo
            const tipoDestacado = termoBusca && sala.tipo ? 
                sala.tipo.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                (sala.tipo || '');
            
            // Destacar termo de busca na descri√ß√£o
            const descricaoDestacada = termoBusca && sala.descricao ? 
                sala.descricao.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                (sala.descricao || '');
            
            html += `<div class='bg-gray-100 dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center w-64 min-h-[220px]'>`;
            if (sala.foto) {
                html += `<div class='mb-3'><img src='${sala.foto.startsWith('img/') ? 'static/' + sala.foto : sala.foto}' alt='${sala.nome || ''}' class='rounded-md object-cover max-w-[180px] max-h-[90px]'></div>`;
            }
            html += `<div class='font-bold text-lg text-gray-800 dark:text-white mb-2 text-center'>${nomeDestacado}</div>`;
            if (sala.tipo) {
                html += `<div class='text-sm text-gray-600 dark:text-gray-300 mb-1'>Tipo: ${tipoDestacado}</div>`;
            }
            if (sala.descricao) {
                html += `<div class='text-sm text-gray-600 dark:text-gray-300 mb-2 text-center'>${descricaoDestacada}</div>`;
            }
            html += `<div class='flex-1'></div>`;
            html += `<button class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-lg shadow flex items-center justify-center gap-2 transition-colors text-base mt-2" onclick="excluirSala(${sala.id}, this)"><i class="fas fa-trash-alt"></i> Excluir</button>`;
            html += `</div>`;
        }
        container.innerHTML = html;
        renderizarResumo(todasSalas);
    }
    document.addEventListener('DOMContentLoaded', function() {
        // Filtro de salas avan√ßado
        const filtro = document.getElementById('filtroSala');
        filtro.addEventListener('input', function() {
            const termo = this.value.trim().toLowerCase();
            // Aplicar filtro de texto sobre o filtro de tipo ativo
            let salasParaFiltrar = todasSalas;
            if (filtroAtivo && filtroAtivo !== 'total') {
                salasParaFiltrar = todasSalas.filter(sala => sala.tipo === filtroAtivo);
            }
            
            const filtrados = termo ? salasParaFiltrar.filter(sala => {
                // Busca por nome da sala
                const nomeMatch = (sala.nome || '').toLowerCase().includes(termo);
                
                // Busca por tipo
                const tipoMatch = (sala.tipo || '').toLowerCase().includes(termo);
                
                // Busca por descri√ß√£o
                const descricaoMatch = (sala.descricao || '').toLowerCase().includes(termo);
                
                // Busca por andar
                const andarMatch = (sala.andar_id !== null && sala.andar_id !== undefined) ? 
                    String(sala.andar_id).toLowerCase().includes(termo) : false;
                
                return nomeMatch || tipoMatch || descricaoMatch || andarMatch;
            }) : salasParaFiltrar;
            
            renderizarCards(filtrados);
            atualizarIndicadorResultados(filtrados, termo);
        });
        
        fetch('/empresa_atual')
            .then(resp => resp.json())
            .then(data => {
                LogoManager.loadEmpresaLogo(data);
            });
    });

    async function excluirSala(id, btn) {
        // Buscar equipamentos vinculados
        const respEq = await fetch(`/equipamentos?sala_id=${id}`);
        const equipamentos = await respEq.json();
        let msg = '';
        if (equipamentos.length > 0) {
            msg = `Aten√ß√£o! Os seguintes equipamentos est√£o vinculados a esta sala e ser√£o desvinculados:\n\n`;
            msg += equipamentos.map(eq => `- ${eq.nome}${eq.modelo ? ' (' + eq.modelo + ')' : ''}`).join('\n');
            msg += `\n\nEles ficar√£o dispon√≠veis para vincular a outras salas.`;
        } else {
            msg = 'Tem certeza que deseja excluir esta sala?';
        }
        if (!confirm(msg)) return;
        const resp = await fetch(`/salas/${id}`, { method: 'DELETE' });
        const json = await resp.json();
        if (json.status === 'ok') {
            btn.closest('.bg-gray-100, .dark\:bg-gray-800').remove();
            document.getElementById('msg').innerText = 'Sala exclu√≠da com sucesso!';
        } else {
            document.getElementById('msg').innerText = 'Erro ao excluir sala!';
        }
    }

    carregarSalas();
    </script>
    <script src="static/js/logo-manager.js"></script>
    </body>
</html> 
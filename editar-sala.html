<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Editar Sala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="static/img/favicon-lapis.png">
    <script>
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
        // Atualizar logo da empresa quando o tema mudar
        updateEmpresaLogo();
      }
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
</head>

<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
    <div class="relative w-full max-w-7xl mx-auto bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-8 mt-8">
        <button onclick="voltarPainelConfig()" class="absolute top-4 left-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-2 transition-colors" title="Voltar">
            <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="empresa-logada" class="absolute top-4 right-4 text-indigo-500 font-bold bg-gray-800 dark:bg-transparent rounded-lg p-2"></div>
        <button onclick="toggleDarkMode()" class="absolute top-4 left-16 bg-gray-200 dark:bg-gray-700 rounded-full p-2 transition-colors" title="Alternar modo escuro">
            <span class="dark:hidden">üåô</span><span class="hidden dark:inline">‚òÄÔ∏è</span>
        </button>
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white text-center mb-8">Editar Sala</h1>
        <div class="mb-6 flex flex-wrap gap-4 justify-center" id="resumoSalas"></div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
            <div class="flex flex-col">
                <div class="space-y-2 mb-4">
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <input id="filtroSala" type="text" class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white dark:border-gray-600" placeholder="Buscar por nome, tipo, descri√ß√£o...">
                            <div class="absolute right-3 top-2.5 text-gray-400 dark:text-gray-500 text-sm">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                        <button onclick="limparBusca()" class="px-3 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded transition-colors text-sm" title="Limpar busca">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 text-center">
                        <i class="fas fa-info-circle"></i> Dica: Voc√™ pode buscar por nome, tipo, descri√ß√£o ou andar
                    </div>
                    <div id="resultadosInfo" class="text-xs text-indigo-600 dark:text-indigo-400 text-center font-medium"></div>
                </div>
                <div id="salas-cards-container" class="flex flex-wrap gap-4 justify-center max-h-[600px] overflow-y-auto"></div>
            </div>
            <div class="flex flex-col">
                <form id="formEditarSala" class="flex flex-col gap-4">
            <input type="hidden" id="salaIdSelecionada" name="salaIdSelecionada">
            <label for="nomeSala" class="text-gray-700 dark:text-gray-200">Nome:</label>
            <input type="text" id="nomeSala" name="nomeSala" class="px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white" required>
            <label for="tipo" class="text-gray-700 dark:text-gray-200">Tipo:</label>
            <input type="text" id="tipo" name="tipo" class="px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white">
            <label for="descricao" class="text-gray-700 dark:text-gray-200">Descri√ß√£o:</label>
            <textarea id="descricao" name="descricao" class="px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white"></textarea>
            <div id="foto-preview-container" class="mb-2"></div>
            <label for="fotoExistente" class="text-gray-700 dark:text-gray-200">Escolher imagem j√° enviada:</label>
            <select id="fotoExistente" class="px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white mb-2"></select>
            <label for="andar_id" class="text-gray-700 dark:text-gray-200">Andar ID:</label>
            <select id="andar_id" name="andar_id" required class="px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white">
                <option value="">Selecione...</option>
                <script>for (let i = 0; i < 200; i++) { document.write(`<option value='${i}'>${i}</option>`); }</script>
            </select>
            <label for="equipamentos" class="text-gray-700 dark:text-gray-200">Equipamentos vinculados:</label>
            <div class="mb-2">
                <button type="button" id="btnVincularEquip" class="bg-gray-400 cursor-not-allowed text-white font-semibold py-2 px-4 rounded-lg shadow flex items-center gap-2 transition-colors text-base" disabled>
                    <i class="fas fa-plus"></i> Vincular novo equipamento
                </button>
            </div>
            <div class="overflow-x-auto"><div id="equipamentos-lista" class="mb-4"></div></div>
            <div id="modalEquipamentos" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center;">
                <div class="bg-gray-800 text-white p-8 rounded-xl min-w-[800px] max-w-[95vw] max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-yellow-400">Equipamentos dispon√≠veis</h3>
                        <button id="btnFecharModal" type="button" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors text-sm">
                            <i class='fas fa-times'></i> Fechar
                        </button>
                    </div>
                    <div id="equipamentos-disponiveis-lista" class="flex-1 overflow-y-auto"></div>
                    <div class="mt-6 flex items-center justify-center gap-4 pt-4 border-t border-gray-600">
                        <button id="btnConfirmarVinculo" type="button" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-8 rounded-lg flex items-center gap-2 transition-colors text-base">
                            <i class="fas fa-link"></i> Vincular selecionados
                        </button>
                    </div>
                </div>
            </div>
            <div class="flex justify-center mt-8">
                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg shadow flex items-center gap-2 transition-colors text-lg">
                    <i class="fas fa-save"></i> <span>Salvar Altera√ß√µes</span>
                </button>
            </div>
        </form>
            </div>
        </div>
        <div class="msg text-center mt-4 text-lg font-semibold" id="msg"></div>
    </div>
    <script>
        // Pega o ID da sala da URL
        const params = new URLSearchParams(window.location.search);
        const salaId = params.get('id');
        console.log('salaId:', salaId);

        // Vari√°veis para controle de filtros
        let todasSalas = [];
        let filtroAtivo = null; // Para controlar qual filtro est√° ativo
        async function carregarSalasCombo() {
            const resp = await fetch('/salas');
            todasSalas = await resp.json();
            renderizarCardsSalas(todasSalas);
            renderizarResumo(todasSalas);
        }
        
        // Fun√ß√£o para aplicar filtro por tipo
        function aplicarFiltro(tipo) {
            filtroAtivo = tipo;
            const filtrados = tipo === 'total' ? todasSalas : todasSalas.filter(sala => sala.tipo === tipo);
            renderizarCardsSalas(filtrados);
            // Limpar o campo de busca quando aplicar filtro por tipo
            document.getElementById('filtroSala').value = '';
            atualizarIndicadorResultados(filtrados, '');
        }
        
        // Fun√ß√£o para limpar busca
        function limparBusca() {
            document.getElementById('filtroSala').value = '';
            filtroAtivo = null;
            renderizarCardsSalas(todasSalas);
            atualizarIndicadorResultados(todasSalas, '');
        }
        
        // Fun√ß√£o para renderizar resumo das salas
        function renderizarResumo(salas) {
            const resumoDiv = document.getElementById('resumoSalas');
            if (!salas.length) {
                resumoDiv.innerHTML = "<span class='text-gray-400 dark:text-gray-500'>Nenhuma sala encontrada.</span>";
                return;
            }
            // Conta por tipo
            const tipos = {};
            salas.forEach(sala => {
                if (!tipos[sala.tipo]) tipos[sala.tipo] = 0;
                tipos[sala.tipo]++;
            });
            
            // Card Total - sempre clic√°vel
            const totalAtivo = filtroAtivo === 'total' ? 'ring-4 ring-yellow-400' : '';
            let html = `
                <div onclick="aplicarFiltro('total')" class="flex items-center gap-2 bg-indigo-600 dark:bg-indigo-800 text-white px-5 py-2 rounded-lg shadow cursor-pointer hover:bg-indigo-700 dark:hover:bg-indigo-700 transition-colors ${totalAtivo}" title="Mostrar todas as salas">
                    <i class="fas fa-building"></i> Total: <b class='ml-1'>${salas.length}</b>
                </div>
            `;
            
            // Se h√° filtro ativo, mostrar apenas o card do tipo selecionado
            if (filtroAtivo && filtroAtivo !== 'total' && tipos[filtroAtivo]) {
                const tipoAtivo = 'ring-4 ring-yellow-400';
                html += `
                    <div onclick="aplicarFiltro('${filtroAtivo}')" class="flex items-center gap-2 bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 px-5 py-2 rounded-lg shadow cursor-pointer hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors ${tipoAtivo}" title="Filtrar por ${filtroAtivo}">
                        <i class="fas fa-tag"></i> ${filtroAtivo || 'Sem tipo'}: <b class='ml-1'>${tipos[filtroAtivo]}</b>
                    </div>
                `;
            } else {
                // Cards por tipo - clic√°veis (apenas quando n√£o h√° filtro ativo)
                Object.entries(tipos).forEach(([tipo, qtd]) => {
                    const tipoAtivo = filtroAtivo === tipo ? 'ring-4 ring-yellow-400' : '';
                    html += `
                        <div onclick="aplicarFiltro('${tipo}')" class="flex items-center gap-2 bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 px-5 py-2 rounded-lg shadow cursor-pointer hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors ${tipoAtivo}" title="Filtrar por ${tipo}">
                            <i class="fas fa-tag"></i> ${tipo || 'Sem tipo'}: <b class='ml-1'>${qtd}</b>
                        </div>
                    `;
                });
            }
            resumoDiv.innerHTML = html;
        }
        
        // Fun√ß√£o para atualizar indicador de resultados
        function atualizarIndicadorResultados(filtrados, termo) {
            const infoDiv = document.getElementById('resultadosInfo');
            if (termo) {
                infoDiv.innerHTML = `<i class="fas fa-search"></i> Busca: "${termo}" (${filtrados.length} resultado${filtrados.length !== 1 ? 's' : ''})`;
            } else {
                infoDiv.innerHTML = '';
            }
        }
        
        // Fun√ß√£o para atualizar estado do bot√£o de vincular equipamento
        function atualizarBotaoVincular() {
            const btnVincular = document.getElementById('btnVincularEquip');
            const salaSelecionada = document.getElementById('salaIdSelecionada').value;
            
            if (salaSelecionada) {
                btnVincular.disabled = false;
                btnVincular.className = 'bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow flex items-center gap-2 transition-colors text-base';
            } else {
                btnVincular.disabled = true;
                btnVincular.className = 'bg-gray-400 cursor-not-allowed text-white font-semibold py-2 px-4 rounded-lg shadow flex items-center gap-2 transition-colors text-base';
            }
        }
        // Lista local de IDs dos equipamentos vinculados (atualizada dinamicamente)
        let equipamentosVinculadosIds = [];
        // Busca e exibe apenas os equipamentos j√° vinculados √† sala
        async function carregarEquipamentosVinculados(salaIdAtual) {
            const resp = await fetch('/equipamentos');
            const equipamentos = await resp.json();
            // Atualiza lista local de vinculados se ainda n√£o estiver preenchida
            if (equipamentosVinculadosIds.length === 0) {
                equipamentosVinculadosIds = equipamentos.filter(eq => eq.sala_id == salaIdAtual).map(eq => String(eq.id));
            }
            const listaDiv = document.getElementById('equipamentos-lista');
            listaDiv.innerHTML = '';
            const filtrados = equipamentos.filter(eq => equipamentosVinculadosIds.includes(String(eq.id)));
            if (filtrados.length === 0) {
                listaDiv.innerHTML = '<div class="text-center py-8 text-gray-500 dark:text-gray-400"><i class="fas fa-info-circle text-2xl mb-2"></i><p>Nenhum equipamento vinculado a esta sala.</p></div>';
                return;
            }
            
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
            filtrados.forEach(eq => {
                const isDefeito = eq.defeito === 1 || eq.defeito === "1" || eq.defeito === true;
                const serie = (eq.dados && eq.dados.serie) ? eq.dados.serie : '';
                const partnumber = (eq.dados && eq.dados.partnumber) ? eq.dados.partnumber : '';
                const ip1 = (eq.dados && eq.dados.ip1) ? eq.dados.ip1 : '';
                const mac1 = (eq.dados && eq.dados.mac1) ? eq.dados.mac1 : '';
                
                                 html += `
                     <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg flex flex-col h-full p-4 relative">
                        <!-- Status Indicator -->
                        <div class="absolute top-2 right-2 w-8 h-8 rounded-full flex items-center justify-center ${isDefeito ? 'bg-red-500' : 'bg-green-500'} text-white" title="${isDefeito ? 'Defeito' : 'Funcionando'}">
                            <i class="fas ${isDefeito ? 'fa-times' : 'fa-check'}"></i>
                        </div>
                        
                        <!-- Checkbox -->
                        <div class="absolute top-2 left-2">
                            <input type="checkbox" value="${eq.id}" id="eq_${eq.id}" checked class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                        </div>
                        
                        <!-- Brand Logo -->
                        ${eq.marca ? `<div class="absolute top-2 left-8">${LogoManager.renderMarcaLogo(eq.marca)}</div>` : ''}
                        
                        <!-- Equipment Image -->
                        <div class="w-full h-20 flex items-center justify-center mb-3 mt-4">
                            ${eq.foto ? 
                                `<img src="${eq.foto.startsWith('img/') ? 'static/' + eq.foto : eq.foto}" alt="${eq.nome}" class="object-contain max-h-20 max-w-20">` : 
                                `<div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-cog text-gray-400 text-2xl"></i>
                                </div>`
                            }
                        </div>
                        
                        <!-- Equipment Name -->
                        <h3 class="font-semibold text-lg text-indigo-700 dark:text-indigo-300 mb-2 text-center">${eq.nome}</h3>
                        
                        <!-- Equipment Details -->
                        <div class="text-sm text-gray-700 dark:text-gray-200 space-y-1 flex-grow">
                            <div><b>Tipo:</b> ${eq.tipo || '-'}</div>
                            <div><b>Marca:</b> ${eq.marca || '-'}</div>
                            <div><b>Modelo:</b> ${eq.modelo || '-'}</div>
                            ${serie ? `<div><b>S√©rie:</b> ${serie}</div>` : ''}
                            ${partnumber ? `<div><b>Part Number:</b> ${partnumber}</div>` : ''}
                            ${ip1 ? `<div><b>IP:</b> ${ip1}</div>` : ''}
                            ${mac1 ? `<div><b>MAC:</b> ${mac1}</div>` : ''}
                            <div><b>Status:</b> <span class="font-normal ${isDefeito ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}">${isDefeito ? 'Defeito' : 'Funcionando'}</span></div>
                            ${eq.descricao ? `<div><b>Descri√ß√£o:</b> ${eq.descricao}</div>` : ''}
                        </div>
                        
                        <!-- Equipment Icon -->
                        ${eq.icone ? `
                            <div class="w-full h-8 flex items-center justify-center mb-2">
                                <img src="${eq.icone.startsWith('img/') ? 'static/' + eq.icone : eq.icone}" alt="√≠cone" class="max-h-8 object-contain">
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            html += '</div>';
            listaDiv.innerHTML = html;
        }
        // Atualiza campos e equipamentos ao selecionar sala
        function preencherCamposSala(sala) {
            console.log('Sala selecionada:', sala);
            document.getElementById('tipo').value = sala.tipo || '';
            document.getElementById('descricao').value = sala.descricao || '';
            document.getElementById('foto').value = sala.foto || '';
            document.getElementById('fotos').value = sala.fotos || '';
            document.getElementById('andar_id').value = sala.andar_id !== null && sala.andar_id !== undefined ? String(sala.andar_id) : '';
            equipamentosVinculadosIds = [];
            carregarEquipamentosVinculados(sala.id);
        }
        // Modal de vincula√ß√£o de novos equipamentos
        document.getElementById('btnVincularEquip').onclick = async function() {
            const resp = await fetch('/equipamentos');
            const equipamentos = await resp.json();
            const salaIdAtual = document.getElementById('salaIdSelecionada').value;
            const disponiveis = equipamentos.filter(eq => eq.sala_id == null && !equipamentosVinculadosIds.includes(String(eq.id)) && eq.defeito !== 1 && eq.defeito !== '1' && eq.defeito !== true);
            const listaDiv = document.getElementById('equipamentos-disponiveis-lista');
            if (disponiveis.length === 0) {
                listaDiv.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-info-circle text-2xl mb-2"></i><p>Nenhum equipamento dispon√≠vel para vincular.</p></div>';
            } else {
                let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto">';
                disponiveis.forEach(eq => {
                    const isDefeito = eq.defeito === 1 || eq.defeito === "1" || eq.defeito === true;
                    const serie = (eq.dados && eq.dados.serie) ? eq.dados.serie : '';
                    const partnumber = (eq.dados && eq.dados.partnumber) ? eq.dados.partnumber : '';
                    const ip1 = (eq.dados && eq.dados.ip1) ? eq.dados.ip1 : '';
                    const mac1 = (eq.dados && eq.dados.mac1) ? eq.dados.mac1 : '';
                    
                                         html += `
                         <div class="bg-gray-700 rounded-xl shadow-lg flex flex-col h-full p-4 relative border border-gray-600">
                            <!-- Status Indicator -->
                            <div class="absolute top-2 right-2 w-8 h-8 rounded-full flex items-center justify-center ${isDefeito ? 'bg-red-500' : 'bg-green-500'} text-white" title="${isDefeito ? 'Defeito' : 'Funcionando'}">
                                <i class="fas ${isDefeito ? 'fa-times' : 'fa-check'}"></i>
                            </div>
                            
                            <!-- Checkbox -->
                            <div class="absolute top-2 left-2">
                                <input type="checkbox" value="${eq.id}" id="modal_eq_${eq.id}" class="w-4 h-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2">
                            </div>
                            
                            <!-- Brand Logo -->
                            ${eq.marca ? `<div class="absolute top-2 left-8">${LogoManager.renderMarcaLogo(eq.marca)}</div>` : ''}
                            
                            <!-- Equipment Image -->
                            <div class="w-full h-20 flex items-center justify-center mb-3 mt-4">
                                ${eq.foto ? 
                                    `<img src="${eq.foto.startsWith('img/') ? 'static/' + eq.foto : eq.foto}" alt="${eq.nome}" class="object-contain max-h-20 max-w-20">` : 
                                    `<div class="w-16 h-16 bg-gray-600 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-cog text-gray-400 text-2xl"></i>
                                    </div>`
                                }
                            </div>
                            
                            <!-- Equipment Name -->
                            <h3 class="font-semibold text-lg text-yellow-400 mb-2 text-center">${eq.nome}</h3>
                            
                            <!-- Equipment Details -->
                            <div class="text-sm text-gray-300 space-y-1 flex-grow">
                                <div><b>Tipo:</b> ${eq.tipo || '-'}</div>
                                <div><b>Marca:</b> ${eq.marca || '-'}</div>
                                <div><b>Modelo:</b> ${eq.modelo || '-'}</div>
                                ${serie ? `<div><b>S√©rie:</b> ${serie}</div>` : ''}
                                ${partnumber ? `<div><b>Part Number:</b> ${partnumber}</div>` : ''}
                                ${ip1 ? `<div><b>IP:</b> ${ip1}</div>` : ''}
                                ${mac1 ? `<div><b>MAC:</b> ${mac1}</div>` : ''}
                                <div><b>Status:</b> <span class="font-normal ${isDefeito ? 'text-red-400' : 'text-green-400'}">${isDefeito ? 'Defeito' : 'Funcionando'}</span></div>
                                ${eq.descricao ? `<div><b>Descri√ß√£o:</b> ${eq.descricao}</div>` : ''}
                            </div>
                            
                            <!-- Equipment Icon -->
                            ${eq.icone ? `
                                <div class="w-full h-8 flex items-center justify-center mb-2">
                                    <img src="${eq.icone.startsWith('img/') ? 'static/' + eq.icone : eq.icone}" alt="√≠cone" class="max-h-8 object-contain">
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                html += '</div>';
                listaDiv.innerHTML = html;
            }
            document.getElementById('modalEquipamentos').style.display = 'flex';
        };
        document.getElementById('btnFecharModal').onclick = function() {
            document.getElementById('modalEquipamentos').style.display = 'none';
        };
        document.getElementById('btnConfirmarVinculo').onclick = function() {
            // Adiciona os equipamentos selecionados √† lista local e recarrega a tabela principal
            const selecionados = Array.from(document.querySelectorAll('#equipamentos-disponiveis-lista input[type=checkbox]:checked')).map(cb => cb.value);
            if (selecionados.length === 0) {
                document.getElementById('modalEquipamentos').style.display = 'none';
                return;
            }
            // Adiciona √† lista local
            equipamentosVinculadosIds = equipamentosVinculadosIds.concat(selecionados.filter(id => !equipamentosVinculadosIds.includes(id)));
            document.getElementById('modalEquipamentos').style.display = 'none';
            carregarEquipamentosVinculados(document.getElementById('salaIdSelecionada').value);
        };
        // Carregar imagens j√° enviadas para o select
        async function carregarFotosExistentes() {
            const resp = await fetch('/fotos-salas');
            const data = await resp.json();
            const select = document.getElementById('fotoExistente');
            select.innerHTML = '<option value="">Nenhuma</option>';
            data.imagens.forEach(url => {
                const nome = url.split('/').pop();
                select.innerHTML += `<option value="${url}">${nome}</option>`;
            });
        }
        carregarFotosExistentes();
        // Atualizar preview ao escolher imagem existente
        document.getElementById('fotoExistente').addEventListener('change', function() {
            const url = this.value;
            const preview = document.getElementById('foto-preview-container');
            if (url) {
                preview.innerHTML = `<img src='${url}' alt='Foto da sala' style='max-width:180px;max-height:90px;object-fit:cover;border-radius:6px;'>`;
            } else {
                preview.innerHTML = "<span style='color:#aaa;'>Sem foto cadastrada</span>";
            }
        });
        // Ao selecionar sala, marcar a imagem existente se for de fotos-salas
        function selecionarSalaCard(sala) {
            document.getElementById('salaIdSelecionada').value = sala.id;
            document.getElementById('nomeSala').value = sala.nome || '';
            document.getElementById('tipo').value = sala.tipo || '';
            document.getElementById('descricao').value = sala.descricao || '';
            // Preview e select
            const preview = document.getElementById('foto-preview-container');
            const select = document.getElementById('fotoExistente');
            let fotoBanco = sala.foto || '';
            let fotoSelectValue = '';
            // Normaliza o valor para comparar com as op√ß√µes do select
            if (fotoBanco.startsWith('static/')) {
                fotoSelectValue = '/' + fotoBanco;
            } else if (fotoBanco.startsWith('/static/')) {
                fotoSelectValue = fotoBanco;
            } else if (fotoBanco.startsWith('/img/fotos-salas/')) {
                fotoSelectValue = fotoBanco;
            } else if (fotoBanco.startsWith('img/fotos-salas/')) {
                fotoSelectValue = '/static/' + fotoBanco;
            } else {
                fotoSelectValue = fotoBanco;
            }
            // Tenta marcar a op√ß√£o correta no select
            let found = false;
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === fotoSelectValue) {
                    select.selectedIndex = i;
                    found = true;
                    break;
                }
            }
            if (found && fotoSelectValue) {
                preview.innerHTML = `<img src='${fotoSelectValue}' alt='Foto da sala' style='max-width:180px;max-height:90px;object-fit:cover;border-radius:6px;'>`;
            } else if (sala.foto) {
                preview.innerHTML = `<img src='${sala.foto.startsWith('img/') ? 'static/' + sala.foto : sala.foto}' alt='Foto da sala' style='max-width:180px;max-height:90px;object-fit:cover;border-radius:6px;'>`;
                select.value = '';
            } else {
                preview.innerHTML = "<span style='color:#aaa;'>Sem foto cadastrada</span>";
                select.value = '';
            }
            document.getElementById('andar_id').value = sala.andar_id !== null && sala.andar_id !== undefined ? String(sala.andar_id) : '';
            equipamentosVinculadosIds = [];
            carregarEquipamentosVinculados(sala.id);
            // Destacar card selecionado
            document.querySelectorAll('.card-sala-editar').forEach(card => {
                card.style.boxShadow = '0 2px 8px #0002';
                card.style.border = 'none';
            });
            const cardAtivo = document.querySelector(`.card-sala-editar[data-id='${sala.id}']`);
            if (cardAtivo) {
                cardAtivo.style.boxShadow = '0 0 0 3px #4a90e2';
                cardAtivo.style.border = '2px solid #4a90e2';
            }
        }
        // No envio do formul√°rio, priorizar upload se houver, sen√£o usar o valor do select
        document.getElementById('formEditarSala').onsubmit = async function (e) {
            e.preventDefault();
            equipamentosVinculadosIds = Array.from(document.querySelectorAll('#equipamentos-lista input[type=checkbox]:checked')).map(cb => cb.value);
            let fotoFinal = document.getElementById('fotoExistente').value;
            const dados = {
                nome: document.getElementById('nomeSala').value,
                tipo: document.getElementById('tipo').value,
                descricao: document.getElementById('descricao').value,
                foto: fotoFinal,
                andar_id: document.getElementById('andar_id').value,
                equipamentos_ids: equipamentosVinculadosIds
            };
            const id = document.getElementById('salaIdSelecionada').value;
            const msgDiv = document.getElementById('msg');
            if (!id) {
                msgDiv.innerText = 'Selecione uma sala para editar!';
                msgDiv.className = 'msg text-center mt-4 text-lg font-semibold text-red-600';
                return;
            }
            const resp = await fetch(`/salas/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            });
            const json = await resp.json();
            if (json.status === 'ok') {
                msgDiv.innerText = 'Sala atualizada com sucesso!';
                msgDiv.className = 'msg text-center mt-4 text-lg font-semibold text-green-600';
                setTimeout(() => { window.history.back(); }, 1000);
            } else {
                msgDiv.innerText = json.mensagem || 'Erro ao atualizar sala!';
                msgDiv.className = 'msg text-center mt-4 text-lg font-semibold text-red-600';
            }
        };
        // --- NOVO: Renderizar cards de salas ---
        function renderizarCardsSalas(salas) {
            const container = document.getElementById('salas-cards-container');
            const termoBusca = document.getElementById('filtroSala').value.trim().toLowerCase();
            const salaSelecionadaId = document.getElementById('salaIdSelecionada').value;
            
            container.innerHTML = '';
            salas.forEach(sala => {
                const card = document.createElement('div');
                const isSelecionada = sala.id == salaSelecionadaId;
                card.className = `bg-gray-100 dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center w-64 min-h-[220px] card-sala-editar mb-2 cursor-pointer transition-all hover:scale-105 hover:shadow-2xl ${isSelecionada ? 'ring-4 ring-blue-500' : ''}`;
                
                // Destacar termo de busca no nome
                const nomeDestacado = termoBusca && sala.nome ? 
                    sala.nome.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                    (sala.nome || '');
                
                // Destacar termo de busca no tipo
                const tipoDestacado = termoBusca && sala.tipo ? 
                    sala.tipo.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                    (sala.tipo || '-');
                
                // Destacar termo de busca na descri√ß√£o
                const descricaoDestacada = termoBusca && sala.descricao ? 
                    sala.descricao.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                    (sala.descricao || '');
                
                card.innerHTML = `
                    ${sala.foto ? `<div class='mb-3'><img src='${sala.foto.startsWith('img/') ? 'static/' + sala.foto : sala.foto}' alt='${sala.nome}' class='rounded-md object-cover max-w-[180px] max-h-[90px]'></div>` : ''}
                    <div class='font-bold text-lg text-gray-800 dark:text-white mb-2 text-center'>${nomeDestacado}</div>
                    <span class='text-gray-700 dark:text-gray-300 text-base mb-1'>Tipo: ${tipoDestacado}</span>
                    <span class='text-gray-700 dark:text-gray-300 text-base mb-1'>Andar: ${sala.andar_id ?? '-'}</span>
                    ${sala.descricao ? `<span class='text-gray-700 dark:text-gray-300 text-sm text-center'>${descricaoDestacada}</span>` : ''}
                `;
                card.onclick = function() {
                    selecionarSalaCard(sala);
                };
                card.setAttribute('data-id', sala.id);
                container.appendChild(card);
            });
            renderizarResumo(todasSalas);
        }
        // --- NOVO: Selecionar sala pelo card ---
        function selecionarSalaCard(sala) {
            document.getElementById('salaIdSelecionada').value = sala.id;
            document.getElementById('nomeSala').value = sala.nome || '';
            document.getElementById('tipo').value = sala.tipo || '';
            document.getElementById('descricao').value = sala.descricao || '';
            // Preview e select
            const preview = document.getElementById('foto-preview-container');
            const select = document.getElementById('fotoExistente');
            let fotoBanco = sala.foto || '';
            let fotoSelectValue = '';
            // Normaliza o valor para comparar com as op√ß√µes do select
            if (fotoBanco.startsWith('static/')) {
                fotoSelectValue = '/' + fotoBanco;
            } else if (fotoBanco.startsWith('/static/')) {
                fotoSelectValue = fotoBanco;
            } else if (fotoBanco.startsWith('/img/fotos-salas/')) {
                fotoSelectValue = fotoBanco;
            } else if (fotoBanco.startsWith('img/fotos-salas/')) {
                fotoSelectValue = '/static/' + fotoBanco;
            } else {
                fotoSelectValue = fotoBanco;
            }
            // Tenta marcar a op√ß√£o correta no select
            let found = false;
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === fotoSelectValue) {
                    select.selectedIndex = i;
                    found = true;
                    break;
                }
            }
            if (found && fotoSelectValue) {
                preview.innerHTML = `<img src='${fotoSelectValue}' alt='Foto da sala' style='max-width:180px;max-height:90px;object-fit:cover;border-radius:6px;'>`;
            } else if (sala.foto) {
                preview.innerHTML = `<img src='${sala.foto.startsWith('img/') ? 'static/' + sala.foto : sala.foto}' alt='Foto da sala' style='max-width:180px;max-height:90px;object-fit:cover;border-radius:6px;'>`;
                select.value = '';
            } else {
                preview.innerHTML = "<span style='color:#aaa;'>Sem foto cadastrada</span>";
                select.value = '';
            }
            document.getElementById('andar_id').value = sala.andar_id !== null && sala.andar_id !== undefined ? String(sala.andar_id) : '';
            equipamentosVinculadosIds = [];
            carregarEquipamentosVinculados(sala.id);
            
            // Atualizar estado do bot√£o de vincular
            atualizarBotaoVincular();
            
            // Atualizar visualiza√ß√£o dos cards para mostrar sele√ß√£o
            renderizarCardsSalas(todasSalas);
        }
        // --- Substituir chamada inicial ---
        carregarSalasCombo();
        atualizarBotaoVincular(); // Inicializar estado do bot√£o
        
        // Filtro de salas avan√ßado
        document.getElementById('filtroSala').addEventListener('input', function() {
            const termo = this.value.trim().toLowerCase();
            // Aplicar filtro de texto sobre o filtro de tipo ativo
            let salasParaFiltrar = todasSalas;
            if (filtroAtivo && filtroAtivo !== 'total') {
                salasParaFiltrar = todasSalas.filter(sala => sala.tipo === filtroAtivo);
            }
            
            const filtrados = termo ? salasParaFiltrar.filter(sala => {
                // Busca por nome da sala
                const nomeMatch = (sala.nome || '').toLowerCase().includes(termo);
                
                // Busca por tipo
                const tipoMatch = (sala.tipo || '').toLowerCase().includes(termo);
                
                // Busca por descri√ß√£o
                const descricaoMatch = (sala.descricao || '').toLowerCase().includes(termo);
                
                // Busca por andar
                const andarMatch = (sala.andar_id !== null && sala.andar_id !== undefined) ? 
                    String(sala.andar_id).toLowerCase().includes(termo) : false;
                
                return nomeMatch || tipoMatch || descricaoMatch || andarMatch;
            }) : salasParaFiltrar;
            
            renderizarCardsSalas(filtrados);
            atualizarIndicadorResultados(filtrados, termo);
        });
        
        function voltarPainelConfig() {
            fetch('/perfil').then(resp => resp.json()).then(perfil => {
                if (perfil.nivel === 'admin') {
                    window.location.href = 'config-admin.html';
                } else if (perfil.nivel === 'tecnico') {
                    window.location.href = 'config-tecnico.html';
                } else {
                    window.location.href = 'config-usuario.html';
                }
            });
        }
        window.addEventListener('DOMContentLoaded', function() {
            fetch('/empresa_atual')
                .then(resp => resp.json())
                .then(data => {
                    LogoManager.loadEmpresaLogo(data);
                });
        });
    </script>
    <script src="static/js/logo-manager.js"></script>
    <script>
        // LogoManager para renderizar logos das marcas
        const LogoManager = {
            renderMarcaLogo: function(marca) {
                const logos = {
                    'LG': '<img src="static/img/logos/lg.png" alt="LG" class="w-6 h-6 object-contain">',
                    'Crestron': '<img src="static/img/logos/crestron.png" alt="Crestron" class="w-6 h-6 object-contain">',
                    'CTL': '<img src="static/img/logos/ctl.png" alt="CTL" class="w-6 h-6 object-contain">',
                    'Logitech': '<img src="static/img/logos/logitech.png" alt="Logitech" class="w-6 h-6 object-contain">',
                    'Shure': '<img src="static/img/logos/shure.png" alt="Shure" class="w-6 h-6 object-contain">',
                    'Barco': '<img src="static/img/logos/barco.png" alt="Barco" class="w-6 h-6 object-contain">',
                    'Dante': '<img src="static/img/logos/dante.png" alt="Dante" class="w-6 h-6 object-contain">'
                };
                return logos[marca] || `<span class="text-xs font-semibold text-gray-600 dark:text-gray-400">${marca}</span>`;
            }
        };
    </script>
    </body>

</html>
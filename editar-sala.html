<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Editar Sala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">`n    <script src="static/js/demo-banner.js"></script>
    <link rel="stylesheet" href="static/css/tour.css">
    <script src="static/js/tour.js"></script>
    <link rel="icon" type="image/png" href="static/img/favicon-lapis.png">
    <script>
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
        // Atualizar logo da empresa quando o tema mudar
        updateEmpresaLogo();
      }
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
</head>

<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
    <div class="relative w-full max-w-7xl mx-auto bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-8 mt-8">
        <button onclick="voltarPainelConfig()" class="absolute top-4 left-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-2 transition-colors" title="Voltar">
            <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="empresa-logada" class="absolute top-4 right-4 text-indigo-500 font-bold bg-gray-800 dark:bg-transparent rounded-lg p-2"></div>
        <button onclick="toggleDarkMode()" class="absolute top-4 left-16 bg-gray-200 dark:bg-gray-700 rounded-full p-2 transition-colors" title="Alternar modo escuro">
            <span class="dark:hidden">🌙</span><span class="hidden dark:inline">☀️</span>
        </button>
        
        <!-- Botão Tour -->
        <button onclick="iniciarTour()" class="absolute top-4 left-28 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 rounded-full p-2 transition-colors" title="Ajuda - Iniciar tour da página">
            <i class="fas fa-question text-sm"></i>
        </button>
        <div class="text-center mt-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">
                <i class="fas fa-edit text-indigo-600 dark:text-indigo-400 mr-3"></i>
                Editar Sala
            </h1>
            <p class="text-gray-600 dark:text-gray-300">Modifique os dados da sala selecionada</p>
        </div>
        <!-- Filtros de Busca -->
        <div class="mb-6 flex flex-wrap gap-4 justify-center">
            <div class="flex gap-2">
                <div class="relative">
                    <input id="filtroSala" type="text" class="px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white dark:border-gray-600" placeholder="Buscar sala...">
                    <div class="absolute right-3 top-2.5 text-gray-400 dark:text-gray-500 text-sm">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                <button onclick="limparBusca()" class="px-3 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded transition-colors text-sm" title="Limpar busca">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex gap-2">
                <button onclick="aplicarFiltroStatus('todos')" id="btn-todos" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded transition-colors text-sm">
                    <i class="fas fa-list"></i> Todas
                </button>
                <button onclick="aplicarFiltroStatus('reuniao')" id="btn-reuniao" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors text-sm">
                    <i class="fas fa-users"></i> Reunião
                </button>
                <button onclick="aplicarFiltroStatus('escritorio')" id="btn-escritorio" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded transition-colors text-sm">
                    <i class="fas fa-briefcase"></i> Escritório
                </button>
                <button onclick="aplicarFiltroStatus('outro')" id="btn-outro" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded transition-colors text-sm">
                    <i class="fas fa-ellipsis-h"></i> Outro
                </button>
            </div>
        </div>

        <div id="resultadosInfo" class="text-xs text-indigo-600 dark:text-indigo-400 text-center font-medium mb-4"></div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
            <div>
                <div id="salas-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8"></div>
            </div>
            <div class="flex flex-col bg-gray-50 dark:bg-gray-800 rounded-xl p-6" style="display: none;">
                <form id="formEditarSala" class="flex flex-col gap-4">
            <input type="hidden" id="salaIdSelecionada" name="salaIdSelecionada">
            <label for="nomeSala" class="text-gray-700 dark:text-gray-200">Nome:</label>
            <input type="text" id="nomeSala" name="nomeSala" class="px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white" required>
            <label for="tipo" class="text-gray-700 dark:text-gray-200">Tipo:</label>
            <input type="text" id="tipo" name="tipo" class="px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white">
            <label for="descricao" class="text-gray-700 dark:text-gray-200">Descrição:</label>
            <textarea id="descricao" name="descricao" class="px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white"></textarea>
            <div id="foto-preview-container" class="mb-2"></div>
            <label for="fotoExistente" class="text-gray-700 dark:text-gray-200">Escolher imagem já enviada:</label>
            <select id="fotoExistente" class="px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white mb-2"></select>
            <label for="andar_id" class="text-gray-700 dark:text-gray-200">Andar ID:</label>
            <select id="andar_id" name="andar_id" required class="px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white">
                <option value="">Selecione...</option>
                <script>for (let i = 0; i < 200; i++) { document.write(`<option value='${i}'>${i}</option>`); }</script>
            </select>
            <label for="equipamentos" class="text-gray-700 dark:text-gray-200">Equipamentos vinculados:</label>
            <div class="mb-2">
                <button type="button" id="btnVincularEquip" class="bg-gray-400 cursor-not-allowed text-white font-semibold py-2 px-4 rounded-lg shadow flex items-center gap-2 transition-colors text-base" disabled>
                    <i class="fas fa-plus"></i> Vincular novo equipamento
                </button>
            </div>
            <div class="overflow-x-auto"><div id="equipamentos-lista" class="mb-4"></div></div>
            <div id="modalEquipamentos" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center;">
                <div class="bg-gray-800 text-white p-8 rounded-xl min-w-[800px] max-w-[95vw] max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-yellow-400">Equipamentos disponíveis</h3>
                        <button id="btnFecharModal" type="button" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors text-sm">
                            <i class='fas fa-times'></i> Fechar
                        </button>
                    </div>
                    <div id="equipamentos-disponiveis-lista" class="flex-1 overflow-y-auto"></div>
                    <div class="mt-6 flex items-center justify-center gap-4 pt-4 border-t border-gray-600">
                        <button id="btnConfirmarVinculo" type="button" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-8 rounded-lg flex items-center gap-2 transition-colors text-base">
                            <i class="fas fa-link"></i> Vincular selecionados
                        </button>
                    </div>
                </div>
            </div>
            <div class="flex justify-center gap-4 mt-8">
                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg shadow flex items-center gap-2 transition-colors text-lg">
                    <i class="fas fa-save"></i> <span>Salvar Alterações</span>
                </button>
                <button type="button" onclick="cancelarEdicao()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-8 rounded-lg shadow flex items-center gap-2 transition-colors text-lg">
                    <i class="fas fa-times"></i> <span>Cancelar</span>
                </button>
            </div>
        </form>
            </div>
        </div>
        <div class="msg text-center mt-4 text-lg font-semibold" id="msg"></div>
    </div>
    <script>
        // Função para iniciar o tour do sistema
        function iniciarTour() {
            if (window.sistemaTour) {
                window.sistemaTour.iniciarTour('editar-sala');
            } else {
                alert('Sistema de tour não carregado. Recarregue a página.');
            }
        }

        // Pega o ID da sala da URL
        const params = new URLSearchParams(window.location.search);
        const salaId = params.get('id');
        console.log('salaId:', salaId);

        // Variáveis para controle de filtros
        let todasSalas = [];
        let filtroStatusAtivo = 'todos';
        let termoBusca = '';
        async function carregarSalasCombo() {
            const resp = await fetch('/salas');
            todasSalas = await resp.json();
            renderizarCardsSalas(todasSalas);
            // Se veio um id na URL, selecionar automaticamente a sala para edição
            if (salaId) {
                const salaAuto = todasSalas.find(s => String(s.id) === String(salaId));
                if (salaAuto) {
                    selecionarSalaCard(salaAuto);
                }
            }
        }

        // Aplicar filtro por status
        function aplicarFiltroStatus(status) {
            filtroStatusAtivo = status;
            
            // Atualizar estilos dos botões
            document.getElementById('btn-todos').className = 'px-4 py-2 rounded transition-colors text-sm ' + (status === 'todos' ? 'bg-indigo-600 text-white' : 'bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300');
            document.getElementById('btn-reuniao').className = 'px-4 py-2 rounded transition-colors text-sm ' + (status === 'reuniao' ? 'bg-blue-600 text-white' : 'bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300');
            document.getElementById('btn-escritorio').className = 'px-4 py-2 rounded transition-colors text-sm ' + (status === 'escritorio' ? 'bg-green-600 text-white' : 'bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300');
            document.getElementById('btn-outro').className = 'px-4 py-2 rounded transition-colors text-sm ' + (status === 'outro' ? 'bg-purple-600 text-white' : 'bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300');
            
            aplicarFiltros();
        }

        // Aplicar filtros combinados
        function aplicarFiltros() {
            let filtrados = todasSalas;
            
            // Filtro por status
            if (filtroStatusAtivo !== 'todos') {
                filtrados = filtrados.filter(sala => sala.tipo === filtroStatusAtivo);
            }
            
            // Filtro por texto
            if (termoBusca) {
                filtrados = filtrados.filter(sala => {
                    const nomeMatch = (sala.nome || '').toLowerCase().includes(termoBusca);
                    const tipoMatch = (sala.tipo || '').toLowerCase().includes(termoBusca);
                    const descricaoMatch = (sala.descricao || '').toLowerCase().includes(termoBusca);
                    const andarMatch = String(sala.andar_id || '').includes(termoBusca);
                    
                    return nomeMatch || tipoMatch || descricaoMatch || andarMatch;
                });
            }
            
            renderizarCardsSalas(filtrados);
            atualizarIndicadorResultados(filtrados);
        }

        // Função para limpar busca
        function limparBusca() {
            // Se há uma sala selecionada para edição, cancelar a edição primeiro
            if (document.getElementById('formEditarSala').parentElement.style.display !== 'none') {
                cancelarEdicao();
                return;
            }
            
            document.getElementById('filtroSala').value = '';
            termoBusca = '';
            filtroStatusAtivo = 'todos';
            
            // Resetar botões
            document.getElementById('btn-todos').className = 'px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded transition-colors text-sm';
            document.getElementById('btn-reuniao').className = 'px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors text-sm';
            document.getElementById('btn-escritorio').className = 'px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded transition-colors text-sm';
            document.getElementById('btn-outro').className = 'px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded transition-colors text-sm';
            
            renderizarCardsSalas(todasSalas);
            atualizarIndicadorResultados(todasSalas);
        }
        
        // Função para atualizar indicador de resultados
        function atualizarIndicadorResultados(filtrados) {
            const infoDiv = document.getElementById('resultadosInfo');
            if (termoBusca || filtroStatusAtivo !== 'todos') {
                const filtros = [];
                if (termoBusca) filtros.push(`busca: "${termoBusca}"`);
                if (filtroStatusAtivo !== 'todos') filtros.push(`tipo: ${filtroStatusAtivo}`);
                
                infoDiv.innerHTML = `<i class="fas fa-filter"></i> Filtros: ${filtros.join(', ')} (${filtrados.length} resultado${filtrados.length !== 1 ? 's' : ''})`;
            } else {
                infoDiv.innerHTML = '';
            }
        }
        
        // Função para atualizar estado do botão de vincular equipamento
        function atualizarBotaoVincular() {
            const btnVincular = document.getElementById('btnVincularEquip');
            const salaSelecionada = document.getElementById('salaIdSelecionada').value;
            
            if (salaSelecionada) {
                btnVincular.disabled = false;
                btnVincular.className = 'bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow flex items-center gap-2 transition-colors text-base';
            } else {
                btnVincular.disabled = true;
                btnVincular.className = 'bg-gray-400 cursor-not-allowed text-white font-semibold py-2 px-4 rounded-lg shadow flex items-center gap-2 transition-colors text-base';
            }
        }
        // Lista local de IDs dos equipamentos vinculados (atualizada dinamicamente)
        let equipamentosVinculadosIds = [];
        // Busca e exibe apenas os equipamentos já vinculados à sala
        async function carregarEquipamentosVinculados(salaIdAtual) {
            const resp = await fetch('/equipamentos');
            const equipamentos = await resp.json();
            // Atualiza lista local de vinculados se ainda não estiver preenchida
            if (equipamentosVinculadosIds.length === 0) {
                equipamentosVinculadosIds = equipamentos.filter(eq => eq.sala_id == salaIdAtual).map(eq => String(eq.id));
            }
            const listaDiv = document.getElementById('equipamentos-lista');
            listaDiv.innerHTML = '';
            const filtrados = equipamentos.filter(eq => equipamentosVinculadosIds.includes(String(eq.id)));
            if (filtrados.length === 0) {
                listaDiv.innerHTML = '<div class="text-center py-8 text-gray-500 dark:text-gray-400"><i class="fas fa-info-circle text-2xl mb-2"></i><p>Nenhum equipamento vinculado a esta sala.</p></div>';
                return;
            }
            
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
            filtrados.forEach(eq => {
                const isDefeito = eq.defeito === 1 || eq.defeito === "1" || eq.defeito === true;
                const serie = (eq.dados && eq.dados.serie) ? eq.dados.serie : '';
                const partnumber = (eq.dados && eq.dados.partnumber) ? eq.dados.partnumber : '';
                const ip1 = (eq.dados && eq.dados.ip1) ? eq.dados.ip1 : '';
                const mac1 = (eq.dados && eq.dados.mac1) ? eq.dados.mac1 : '';
                
                                 html += `
                     <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg flex flex-col h-full p-4 relative">
                        <!-- Status Indicator -->
                        <div class="absolute top-2 right-2 w-8 h-8 rounded-full flex items-center justify-center ${isDefeito ? 'bg-red-500' : 'bg-green-500'} text-white" title="${isDefeito ? 'Defeito' : 'Funcionando'}">
                            <i class="fas ${isDefeito ? 'fa-times' : 'fa-check'}"></i>
                        </div>
                        
                        <!-- Checkbox -->
                        <div class="absolute top-2 left-2">
                            <input type="checkbox" value="${eq.id}" id="eq_${eq.id}" checked class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                        </div>
                        
                        <!-- Brand Logo -->
                        ${eq.marca ? `<div class="absolute top-2 left-8">${LogoManager.renderMarcaLogo(eq.marca)}</div>` : ''}
                        
                        <!-- Equipment Image -->
                        <div class="w-full h-20 flex items-center justify-center mb-3 mt-4">
                            ${eq.foto ? 
                                `<img src="${eq.foto.startsWith('img/') ? 'static/' + eq.foto : eq.foto}" alt="${eq.nome}" class="object-contain max-h-20 max-w-20">` : 
                                `<div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-cog text-gray-400 text-2xl"></i>
                                </div>`
                            }
                        </div>
                        
                        <!-- Equipment Name -->
                        <h3 class="font-semibold text-lg text-indigo-700 dark:text-indigo-300 mb-2 text-center">${eq.nome}</h3>
                        
                        <!-- Equipment Details -->
                        <div class="text-sm text-gray-700 dark:text-gray-200 space-y-1 flex-grow">
                            <div><b>Tipo:</b> ${eq.tipo || '-'}</div>
                            <div><b>Marca:</b> ${eq.marca || '-'}</div>
                            <div><b>Modelo:</b> ${eq.modelo || '-'}</div>
                            ${serie ? `<div><b>Série:</b> ${serie}</div>` : ''}
                            ${partnumber ? `<div><b>Part Number:</b> ${partnumber}</div>` : ''}
                            ${ip1 ? `<div><b>IP:</b> ${ip1}</div>` : ''}
                            ${mac1 ? `<div><b>MAC:</b> ${mac1}</div>` : ''}
                            <div><b>Status:</b> <span class="font-normal ${isDefeito ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}">${isDefeito ? 'Defeito' : 'Funcionando'}</span></div>
                            ${eq.descricao ? `<div><b>Descrição:</b> ${eq.descricao}</div>` : ''}
                        </div>
                        
                        <!-- Equipment Icon -->
                        ${eq.icone ? `
                            <div class="w-full h-8 flex items-center justify-center mb-2">
                                <img src="${eq.icone.startsWith('img/') ? 'static/' + eq.icone : eq.icone}" alt="ícone" class="max-h-8 object-contain">
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            html += '</div>';
            listaDiv.innerHTML = html;
        }

        // Modal de vinculação de novos equipamentos
        document.getElementById('btnVincularEquip').onclick = async function() {
            const resp = await fetch('/equipamentos');
            const equipamentos = await resp.json();
            const salaIdAtual = document.getElementById('salaIdSelecionada').value;
            const disponiveis = equipamentos.filter(eq => eq.sala_id == null && !equipamentosVinculadosIds.includes(String(eq.id)) && eq.defeito !== 1 && eq.defeito !== '1' && eq.defeito !== true);
            const listaDiv = document.getElementById('equipamentos-disponiveis-lista');
            if (disponiveis.length === 0) {
                listaDiv.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-info-circle text-2xl mb-2"></i><p>Nenhum equipamento disponível para vincular.</p></div>';
            } else {
                let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto">';
                disponiveis.forEach(eq => {
                    const isDefeito = eq.defeito === 1 || eq.defeito === "1" || eq.defeito === true;
                    const serie = (eq.dados && eq.dados.serie) ? eq.dados.serie : '';
                    const partnumber = (eq.dados && eq.dados.partnumber) ? eq.dados.partnumber : '';
                    const ip1 = (eq.dados && eq.dados.ip1) ? eq.dados.ip1 : '';
                    const mac1 = (eq.dados && eq.dados.mac1) ? eq.dados.mac1 : '';
                    
                                         html += `
                         <div class="bg-gray-700 rounded-xl shadow-lg flex flex-col h-full p-4 relative border border-gray-600">
                            <!-- Status Indicator -->
                            <div class="absolute top-2 right-2 w-8 h-8 rounded-full flex items-center justify-center ${isDefeito ? 'bg-red-500' : 'bg-green-500'} text-white" title="${isDefeito ? 'Defeito' : 'Funcionando'}">
                                <i class="fas ${isDefeito ? 'fa-times' : 'fa-check'}"></i>
                            </div>
                            
                            <!-- Checkbox -->
                            <div class="absolute top-2 left-2">
                                <input type="checkbox" value="${eq.id}" id="modal_eq_${eq.id}" class="w-4 h-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2">
                            </div>
                            
                            <!-- Brand Logo -->
                            ${eq.marca ? `<div class="absolute top-2 left-8">${LogoManager.renderMarcaLogo(eq.marca)}</div>` : ''}
                            
                            <!-- Equipment Image -->
                            <div class="w-full h-20 flex items-center justify-center mb-3 mt-4">
                                ${eq.foto ? 
                                    `<img src="${eq.foto.startsWith('img/') ? 'static/' + eq.foto : eq.foto}" alt="${eq.nome}" class="object-contain max-h-20 max-w-20">` : 
                                    `<div class="w-16 h-16 bg-gray-600 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-cog text-gray-400 text-2xl"></i>
                                    </div>`
                                }
                            </div>
                            
                            <!-- Equipment Name -->
                            <h3 class="font-semibold text-lg text-yellow-400 mb-2 text-center">${eq.nome}</h3>
                            
                            <!-- Equipment Details -->
                            <div class="text-sm text-gray-300 space-y-1 flex-grow">
                                <div><b>Tipo:</b> ${eq.tipo || '-'}</div>
                                <div><b>Marca:</b> ${eq.marca || '-'}</div>
                                <div><b>Modelo:</b> ${eq.modelo || '-'}</div>
                                ${serie ? `<div><b>Série:</b> ${serie}</div>` : ''}
                                ${partnumber ? `<div><b>Part Number:</b> ${partnumber}</div>` : ''}
                                ${ip1 ? `<div><b>IP:</b> ${ip1}</div>` : ''}
                                ${mac1 ? `<div><b>MAC:</b> ${mac1}</div>` : ''}
                                <div><b>Status:</b> <span class="font-normal ${isDefeito ? 'text-red-400' : 'text-green-400'}">${isDefeito ? 'Defeito' : 'Funcionando'}</span></div>
                                ${eq.descricao ? `<div><b>Descrição:</b> ${eq.descricao}</div>` : ''}
                            </div>
                            
                            <!-- Equipment Icon -->
                            ${eq.icone ? `
                                <div class="w-full h-8 flex items-center justify-center mb-2">
                                    <img src="${eq.icone.startsWith('img/') ? 'static/' + eq.icone : eq.icone}" alt="ícone" class="max-h-8 object-contain">
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                html += '</div>';
                listaDiv.innerHTML = html;
            }
            document.getElementById('modalEquipamentos').style.display = 'flex';
        };
        document.getElementById('btnFecharModal').onclick = function() {
            document.getElementById('modalEquipamentos').style.display = 'none';
        };
        document.getElementById('btnConfirmarVinculo').onclick = function() {
            // Adiciona os equipamentos selecionados à lista local e recarrega a tabela principal
            const selecionados = Array.from(document.querySelectorAll('#equipamentos-disponiveis-lista input[type=checkbox]:checked')).map(cb => cb.value);
            if (selecionados.length === 0) {
                document.getElementById('modalEquipamentos').style.display = 'none';
                return;
            }
            // Adiciona à lista local
            equipamentosVinculadosIds = equipamentosVinculadosIds.concat(selecionados.filter(id => !equipamentosVinculadosIds.includes(id)));
            document.getElementById('modalEquipamentos').style.display = 'none';
            carregarEquipamentosVinculados(document.getElementById('salaIdSelecionada').value);
        };
        // Carregar imagens já enviadas para o select
        async function carregarFotosExistentes() {
            const resp = await fetch('/fotos-salas');
            const data = await resp.json();
            const select = document.getElementById('fotoExistente');
            select.innerHTML = '<option value="">Nenhuma</option>';
            data.imagens.forEach(url => {
                const nome = url.split('/').pop();
                select.innerHTML += `<option value="${url}">${nome}</option>`;
            });
        }
        carregarFotosExistentes();
        // Atualizar preview ao escolher imagem existente
        document.getElementById('fotoExistente').addEventListener('change', function() {
            const url = this.value;
            const preview = document.getElementById('foto-preview-container');
            if (url) {
                preview.innerHTML = `<img src='${url}' alt='Foto da sala' style='max-width:180px;max-height:90px;object-fit:cover;border-radius:6px;'>`;
            } else {
                preview.innerHTML = "<span style='color:#aaa;'>Sem foto cadastrada</span>";
            }
        });

        // No envio do formulário, priorizar upload se houver, senão usar o valor do select
        document.getElementById('formEditarSala').onsubmit = async function (e) {
            e.preventDefault();
            equipamentosVinculadosIds = Array.from(document.querySelectorAll('#equipamentos-lista input[type=checkbox]:checked')).map(cb => cb.value);
            let fotoFinal = document.getElementById('fotoExistente').value;
            const dados = {
                nome: document.getElementById('nomeSala').value,
                tipo: document.getElementById('tipo').value,
                descricao: document.getElementById('descricao').value,
                foto: fotoFinal,
                andar_id: document.getElementById('andar_id').value,
                equipamentos_ids: equipamentosVinculadosIds
            };
            const id = document.getElementById('salaIdSelecionada').value;
            const msgDiv = document.getElementById('msg');
            if (!id) {
                msgDiv.innerText = 'Selecione uma sala para editar!';
                msgDiv.className = 'msg text-center mt-4 text-lg font-semibold text-red-600';
                return;
            }
            const resp = await fetch(`/salas/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            });
            const json = await resp.json();
            if (json.status === 'ok') {
                msgDiv.innerText = 'Sala atualizada com sucesso!';
                msgDiv.className = 'msg text-center mt-4 text-lg font-semibold text-green-600';
                setTimeout(() => { window.history.back(); }, 1000);
            } else {
                msgDiv.innerText = json.mensagem || 'Erro ao atualizar sala!';
                msgDiv.className = 'msg text-center mt-4 text-lg font-semibold text-red-600';
            }
        };
        // --- NOVO: Renderizar cards de salas ---
        function renderizarCardsSalas(salas) {
            const container = document.getElementById('salas-cards-container');
            const termoBusca = document.getElementById('filtroSala').value.trim().toLowerCase();
            const salaSelecionadaId = document.getElementById('salaIdSelecionada').value;
            
            container.innerHTML = '';
            salas.forEach(sala => {
                const card = document.createElement('div');
                const isSelecionada = sala.id == salaSelecionadaId;
                card.className = `bg-gray-100 dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center w-full min-h-[220px] card-sala-editar cursor-pointer ${isSelecionada ? 'ring-4 ring-blue-500' : ''}`;
                
                // Destacar termo de busca no nome
                const nomeDestacado = termoBusca && sala.nome ? 
                    sala.nome.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                    (sala.nome || '');
                
                // Destacar termo de busca no tipo
                const tipoDestacado = termoBusca && sala.tipo ? 
                    sala.tipo.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                    (sala.tipo || '-');
                
                // Destacar termo de busca na descrição
                const descricaoDestacada = termoBusca && sala.descricao ? 
                    sala.descricao.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                    (sala.descricao || '');
                
                card.innerHTML = `
                    ${sala.foto ? `<div class='mb-3'><img src='${sala.foto.startsWith('img/') ? 'static/' + sala.foto : sala.foto}' alt='${sala.nome}' class='rounded-md object-cover max-w-[180px] max-h-[90px]'></div>` : ''}
                    <div class='font-bold text-lg text-gray-800 dark:text-white mb-2 text-center'>${nomeDestacado}</div>
                    <span class='text-gray-700 dark:text-gray-300 text-base mb-1'>Tipo: ${tipoDestacado}</span>
                    <span class='text-gray-700 dark:text-gray-300 text-base mb-1'>Andar: ${sala.andar_id ?? '-'}</span>
                    ${sala.descricao ? `<span class='text-gray-700 dark:text-gray-300 text-sm text-center'>${descricaoDestacada}</span>` : ''}
                `;
                card.onclick = function() {
                    selecionarSalaCard(sala);
                };
                card.setAttribute('data-id', sala.id);
                container.appendChild(card);
            });
        }
        // --- NOVO: Selecionar sala pelo card ---
        function selecionarSalaCard(sala) {
            console.log('selecionarSalaCard chamada com:', sala);
            const formContainer = document.getElementById('formEditarSala').parentElement;
            
            document.getElementById('salaIdSelecionada').value = sala.id;
            document.getElementById('nomeSala').value = sala.nome || '';
            document.getElementById('tipo').value = sala.tipo || '';
            document.getElementById('descricao').value = sala.descricao || '';
            // Preview e select
            const preview = document.getElementById('foto-preview-container');
            const select = document.getElementById('fotoExistente');
            let fotoBanco = sala.foto || '';
            let fotoSelectValue = '';
            // Normaliza o valor para comparar com as opções do select
            if (fotoBanco.startsWith('static/')) {
                fotoSelectValue = '/' + fotoBanco;
            } else if (fotoBanco.startsWith('/static/')) {
                fotoSelectValue = fotoBanco;
            } else if (fotoBanco.startsWith('/img/fotos-salas/')) {
                fotoSelectValue = fotoBanco;
            } else if (fotoBanco.startsWith('img/fotos-salas/')) {
                fotoSelectValue = '/static/' + fotoBanco;
            } else {
                fotoSelectValue = fotoBanco;
            }
            // Tenta marcar a opção correta no select
            let found = false;
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === fotoSelectValue) {
                    select.selectedIndex = i;
                    found = true;
                    break;
                }
            }
            if (found && fotoSelectValue) {
                preview.innerHTML = `<img src='${fotoSelectValue}' alt='Foto da sala' style='max-width:180px;max-height:90px;object-fit:cover;border-radius:6px;'>`;
            } else if (sala.foto) {
                preview.innerHTML = `<img src='${sala.foto.startsWith('img/') ? 'static/' + sala.foto : sala.foto}' alt='Foto da sala' style='max-width:180px;max-height:90px;object-fit:cover;border-radius:6px;'>`;
                select.value = '';
            } else {
                preview.innerHTML = "<span style='color:#aaa;'>Sem foto cadastrada</span>";
                select.value = '';
            }
            document.getElementById('andar_id').value = sala.andar_id !== null && sala.andar_id !== undefined ? String(sala.andar_id) : '';
            equipamentosVinculadosIds = [];
            carregarEquipamentosVinculados(sala.id);
            
            // Atualizar estado do botão de vincular
            atualizarBotaoVincular();
            
            // Esconder todos os cards exceto o selecionado
            const container = document.getElementById('salas-cards-container');
            const cards = container.querySelectorAll('.card-sala-editar');
            cards.forEach(card => {
                if (card.getAttribute('data-id') == sala.id) {
                    card.style.display = 'block';
                    card.style.gridColumn = '1 / -1';
                    card.style.justifySelf = 'center';
                    card.style.maxWidth = '400px';
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Mostrar o formulário
            console.log('formContainer:', formContainer);
            console.log('formContainer.style.display antes:', formContainer.style.display);
            formContainer.style.display = 'flex';
            console.log('formContainer.style.display depois:', formContainer.style.display);
        }
        // Função para cancelar edição e voltar à visualização normal
        function cancelarEdicao() {
            // Limpar formulário
            document.getElementById('formEditarSala').reset();
            document.getElementById('salaIdSelecionada').value = '';
            document.getElementById('foto-preview-container').innerHTML = "<span style='color:#aaa;'>Sem foto cadastrada</span>";
            document.getElementById('equipamentos-lista').innerHTML = '';
            
            // Esconder formulário
            const formContainer = document.getElementById('formEditarSala').parentElement;
            formContainer.style.display = 'none';
            
            // Restaurar visualização normal dos cards
            const container = document.getElementById('salas-cards-container');
            const cards = container.querySelectorAll('.card-sala-editar');
            cards.forEach(card => {
                card.style.display = 'block';
                card.style.gridColumn = '';
                card.style.justifySelf = '';
                card.style.maxWidth = '';
            });
            
            // Atualizar estado do botão de vincular
            atualizarBotaoVincular();
            
            // Limpar filtros e mostrar todas as salas
            limparBusca();
        }
        
        // --- Substituir chamada inicial ---
        carregarSalasCombo();
        atualizarBotaoVincular(); // Inicializar estado do botão
        
        // Filtro de salas por texto
        document.getElementById('filtroSala').addEventListener('input', function() {
            termoBusca = this.value.trim().toLowerCase();
            aplicarFiltros();
        });
        
        function voltarPainelConfig() {
            fetch('/perfil').then(resp => resp.json()).then(perfil => {
                if (perfil.nivel === 'admin') {
                    window.location.href = 'config-admin.html';
                } else if (perfil.nivel === 'tecnico') {
                    window.location.href = 'config-tecnico.html';
                } else {
                    window.location.href = 'config-usuario.html';
                }
            });
        }
        window.addEventListener('DOMContentLoaded', function() {
            fetch('/empresa_atual')
                .then(resp => resp.json())
                .then(data => {
                    LogoManager.loadEmpresaLogo(data);
                });
        });
    </script>
    <script src="static/js/logo-manager.js"></script>
    <script>
        // LogoManager para renderizar logos das marcas
        const LogoManager = {
            renderMarcaLogo: function(marca) {
                const logos = {
                    'LG': '<img src="static/img/logos/lg.png" alt="LG" class="w-6 h-6 object-contain">',
                    'Crestron': '<img src="static/img/logos/crestron.png" alt="Crestron" class="w-6 h-6 object-contain">',
                    'CTL': '<img src="static/img/logos/ctl.png" alt="CTL" class="w-6 h-6 object-contain">',
                    'Logitech': '<img src="static/img/logos/logitech.png" alt="Logitech" class="w-6 h-6 object-contain">',
                    'Shure': '<img src="static/img/logos/shure.png" alt="Shure" class="w-6 h-6 object-contain">',
                    'Barco': '<img src="static/img/logos/barco.png" alt="Barco" class="w-6 h-6 object-contain">',
                    'Dante': '<img src="static/img/logos/dante.png" alt="Dante" class="w-6 h-6 object-contain">'
                };
                return logos[marca] || `<span class="text-xs font-semibold text-gray-600 dark:text-gray-400">${marca}</span>`;
            }
        };
    </script>
    </body>

</html>

<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Adicionar Cabo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="static/img/favicon-lapis.png">
    <script>
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
        updateEmpresaLogo();
      }
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
</head>

<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
    <div class="relative w-full max-w-4xl mx-auto bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-8 mt-8">
        <button onclick="voltarPainelConfig()" class="absolute top-4 left-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-2 transition-colors" title="Voltar">
            <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="empresa-logada" class="absolute top-4 right-4 text-indigo-500 font-bold bg-gray-800 dark:bg-transparent rounded-lg p-2"></div>
        <button onclick="toggleDarkMode()" class="absolute top-4 left-16 bg-gray-200 dark:bg-gray-700 rounded-full p-2 transition-colors" title="Alternar modo escuro">
            <span class="dark:hidden">üåô</span><span class="hidden dark:inline">‚òÄÔ∏è</span>
        </button>
        
        <div class="text-center mt-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">
                <i class="fas fa-plug text-indigo-600 dark:text-indigo-400 mr-3"></i>
                <span id="tituloPagina">Adicionar Cabo</span>
            </h1>
            <p class="text-gray-600 dark:text-gray-300" id="subtituloPagina">Cadastre um novo cabo no sistema</p>
            <div id="infoSubstituicao" class="hidden mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-exchange-alt text-yellow-600 dark:text-yellow-400 mr-3"></i>
                    <div class="text-left">
                        <h3 class="font-semibold text-yellow-800 dark:text-yellow-200">Substitui√ß√£o de Cabo</h3>
                        <p class="text-sm text-yellow-700 dark:text-yellow-300">Ap√≥s adicionar o novo cabo, ele ser√° automaticamente conectado na mesma posi√ß√£o do cabo anterior.</p>
                    </div>
                </div>
            </div>
        </div>

        <form id="formCabo" class="space-y-6">
            <!-- Tipo de Conex√£o -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-project-diagram mr-2"></i>Tipo de Conex√£o *
                </label>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Escolha como o cabo ser√° conectado no sistema</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Conex√£o Direta -->
                    <label class="relative cursor-pointer">
                        <input type="radio" name="tipo_conexao" value="direta" checked onchange="toggleTipoConexao()" class="sr-only">
                        <div class="border-2 border-gray-200 dark:border-gray-600 rounded-lg p-4 transition-all duration-200 hover:border-indigo-300 dark:hover:border-indigo-500 bg-white dark:bg-gray-800">
                            <div class="flex items-center mb-3">
                                <div class="w-5 h-5 border-2 border-gray-300 dark:border-gray-500 rounded-full mr-3 flex items-center justify-center">
                                    <div class="w-3 h-3 bg-gray-300 dark:bg-gray-500 rounded-full"></div>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-exchange-alt text-indigo-600 dark:text-indigo-400 mr-2"></i>
                                    <span class="font-medium text-gray-900 dark:text-white">Conex√£o Direta</span>
                                </div>
                            </div>
                            <div class="ml-8">
                                <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">Equipamento ‚Üî Equipamento</p>
                                <div class="flex items-center justify-center space-x-2 text-xs text-gray-500 dark:text-gray-400">
                                    <span class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">Equip. A</span>
                                    <i class="fas fa-arrow-right"></i>
                                    <span class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">Equip. B</span>
                                </div>
                            </div>
                        </div>
                    </label>

                    <!-- Conex√£o via Patch Panel -->
                    <label class="relative cursor-pointer">
                        <input type="radio" name="tipo_conexao" value="patch_panel" onchange="toggleTipoConexao()" class="sr-only">
                        <div class="border-2 border-gray-200 dark:border-gray-600 rounded-lg p-4 transition-all duration-200 hover:border-indigo-300 dark:hover:border-indigo-500 bg-white dark:bg-gray-800">
                            <div class="flex items-center mb-3">
                                <div class="w-5 h-5 border-2 border-gray-300 dark:border-gray-500 rounded-full mr-3 flex items-center justify-center">
                                    <div class="w-3 h-3 bg-gray-300 dark:bg-gray-500 rounded-full"></div>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-th text-indigo-600 dark:text-indigo-400 mr-2"></i>
                                    <span class="font-medium text-gray-900 dark:text-white">Via Patch Panel</span>
                                </div>
                            </div>
                                                         <div class="ml-8">
                                 <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">Equipamento ‚Üí Patch Panel (conectado ao switch)</p>
                                 <div class="flex items-center justify-center space-x-1 text-xs text-gray-500 dark:text-gray-400">
                                     <span class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">Equip.</span>
                                     <i class="fas fa-arrow-right"></i>
                                     <span class="bg-blue-100 dark:bg-blue-900 px-2 py-1 rounded">Patch Panel</span>
                                 </div>
                             </div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- C√≥digo √önico -->
            <div>
                <label for="codigo_unico" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-barcode mr-2"></i>C√≥digo √önico *
                </label>
                <div class="flex gap-2">
                    <input type="text" id="codigo_unico" name="codigo_unico" required readonly
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white dark:border-gray-600"
                           placeholder="Ser√° gerado automaticamente">
                    <button type="button" onclick="gerarNovoCodigo()" class="px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors" title="Gerar novo c√≥digo">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">C√≥digo gerado automaticamente baseado no tipo de cabo</p>
            </div>

            <!-- Tipo de Cabo -->
            <div>
                <label for="tipo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-tag mr-2"></i>Tipo de Cabo *
                </label>
                <select id="tipo" name="tipo" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600">
                    <option value="">Selecione o tipo...</option>
                </select>
            </div>

            <!-- Se√ß√£o de Conex√£o Direta -->
            <div id="secaoConexaoDireta">
                <!-- Equipamento Origem -->
                <div>
                    <label for="equipamento_origem" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-plug mr-2"></i>Equipamento Origem *
                    </label>
                                         <select id="equipamento_origem" name="equipamento_origem"
                             class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600">
                        <option value="">Selecione o equipamento...</option>
                    </select>
                </div>

                <!-- Equipamento Destino -->
                <div>
                    <label for="equipamento_destino" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-plug mr-2"></i>Equipamento Destino *
                    </label>
                                         <select id="equipamento_destino" name="equipamento_destino"
                             class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600">
                        <option value="">Selecione o equipamento...</option>
                    </select>
                </div>
            </div>

                         <!-- Se√ß√£o de Conex√£o via Patch Panel -->
             <div id="secaoPatchPanel" class="hidden space-y-4">
                 <div class="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                     <div class="flex items-center">
                         <i class="fas fa-info-circle text-blue-600 dark:text-blue-400 mr-2"></i>
                         <p class="text-sm text-blue-700 dark:text-blue-300">
                             <strong>Dica:</strong> Selecione o equipamento primeiro para carregar automaticamente todas as informa√ß√µes do patch panel. Se o equipamento n√£o estiver conectado a nenhum patch panel, voc√™ ver√° uma mensagem informativa.
                         </p>
                     </div>
                 </div>
                                 <!-- Equipamento -->
                 <div>
                     <label for="equipamento_rede" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                         <i class="fas fa-network-wired mr-2"></i>Equipamento de Rede *
                     </label>
                     <select id="equipamento_rede" name="equipamento_rede" onchange="carregarInfoPatchPanel()"
                             class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600">
                         <option value="">Selecione o equipamento (sensor, painel, etc.)...</option>
                     </select>
                 </div>

                <!-- Andar -->
                <div>
                    <label for="andar_patch_panel" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-building mr-2"></i>Andar *
                    </label>
                                         <select id="andar_patch_panel" name="andar_patch_panel" onchange="carregarPatchPanelAndar()"
                             class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600">
                         <option value="">Selecione o andar...</option>
                         <option value="0">T√©rreo</option>
                         <option value="1">1¬∫ Andar</option>
                         <option value="2">2¬∫ Andar</option>
                         <option value="3">3¬∫ Andar</option>
                     </select>
                     <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Ser√° preenchido automaticamente ao selecionar o equipamento</p>
                </div>

                <!-- Patch Panel do Andar -->
                <div>
                    <label for="patch_panel" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-th mr-2"></i>Patch Panel do Andar *
                    </label>
                    <select id="patch_panel" name="patch_panel" onchange="carregarPortasPatchPanel()"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600">
                        <option value="">Selecione o patch panel...</option>
                    </select>
                                         <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Ser√° preenchido automaticamente ao selecionar o equipamento</p>
                </div>

                <!-- Porta do Patch Panel (Keystone) -->
                <div>
                                         <label for="porta_patch_panel" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                         <i class="fas fa-hashtag mr-2"></i>Porta Ocupada do Patch Panel *
                     </label>
                    <select id="porta_patch_panel" name="porta_patch_panel"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600">
                        <option value="">Selecione a porta...</option>
                    </select>
                                         <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Ser√° preenchido automaticamente ao selecionar o equipamento</p>
                </div>

                

                
            </div>

            <!-- Comprimento -->
            <div>
                <label for="comprimento" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-ruler mr-2"></i>Comprimento (metros)
                </label>
                <input type="number" id="comprimento" name="comprimento" min="0.1" step="0.1"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600"
                       placeholder="Ex: 2.5">
            </div>

            <!-- Marca -->
            <div>
                <label for="marca" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-industry mr-2"></i>Marca
                </label>
                <input type="text" id="marca" name="marca"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600"
                       placeholder="Ex: Belkin, AmazonBasics, etc.">
            </div>

            <!-- Modelo -->
            <div>
                <label for="modelo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-cube mr-2"></i>Modelo
                </label>
                <input type="text" id="modelo" name="modelo"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600"
                       placeholder="Ex: Ultra HD, Premium, etc.">
            </div>

            <!-- Status -->
            <div>
                <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-check-circle mr-2"></i>Status
                </label>
                <select id="status" name="status"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600">
                    <option value="funcionando">Funcionando</option>
                    <option value="defeito">Com Defeito</option>
                </select>
            </div>

            <!-- Descri√ß√£o -->
            <div>
                <label for="descricao" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-align-left mr-2"></i>Descri√ß√£o
                </label>
                <textarea id="descricao" name="descricao" rows="3"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600"
                          placeholder="Descri√ß√£o adicional do cabo..."></textarea>
            </div>

            <!-- Foto -->
            <div>
                <label for="foto" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-camera mr-2"></i>Foto do Cabo
                </label>
                <input type="file" id="foto" name="foto" accept="image/*"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600">
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Opcional: foto do cabo para identifica√ß√£o visual</p>
            </div>

            <!-- Bot√µes -->
            <div class="flex gap-4 pt-6">
                <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                    <i class="fas fa-save mr-2"></i>Salvar Cabo
                </button>
                <button type="button" onclick="limparFormulario()" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg transition-colors">
                    <i class="fas fa-eraser mr-2"></i>Limpar
                </button>

            </div>
        </form>

        <!-- Modal de Sucesso -->
        <div id="modalSucesso" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4">
                <div class="text-center">
                    <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Cabo Adicionado!</h3>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">O cabo foi cadastrado com sucesso no sistema.</p>
                    <div class="flex gap-3">
                        <button onclick="fecharModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            OK
                        </button>
                        <button onclick="adicionarOutro()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            Adicionar Outro
                        </button>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <script>
                 let tiposCabos = [];
         let cabosExistentes = [];
         let equipamentos = [];
         let salas = [];
         let patchPanels = [];

        // Carregar tipos de cabos
        async function carregarTiposCabos() {
            try {
                const response = await fetch('/tipos-cabos');
                tiposCabos = await response.json();
                
                const selectTipo = document.getElementById('tipo');
                selectTipo.innerHTML = '<option value="">Selecione o tipo...</option>';
                
                tiposCabos.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.nome;
                    option.textContent = `${tipo.nome} - ${tipo.descricao}`;
                    selectTipo.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar tipos de cabos:', error);
            }
        }

        // Carregar cabos existentes para verificar c√≥digos
        async function carregarCabosExistentes() {
            try {
                const response = await fetch('/cabos');
                cabosExistentes = await response.json();
            } catch (error) {
                console.error('Erro ao carregar cabos existentes:', error);
            }
        }

        // Carregar equipamentos
        async function carregarEquipamentos() {
            try {
                const response = await fetch('/equipamentos');
                equipamentos = await response.json();
                
                // Preencher selects de equipamentos
                const equipOrigem = document.getElementById('equipamento_origem');
                const equipDestino = document.getElementById('equipamento_destino');
                const equipRede = document.getElementById('equipamento_rede');
                
                equipOrigem.innerHTML = '<option value="">Selecione o equipamento...</option>';
                equipDestino.innerHTML = '<option value="">Selecione o equipamento...</option>';
                equipRede.innerHTML = '<option value="">Selecione o equipamento (sensor, painel, etc.)...</option>';
                
                equipamentos.forEach(eq => {
                    const option = document.createElement('option');
                    option.value = eq.id;
                    option.textContent = `${eq.nome} (${eq.tipo}) - Sala: ${eq.sala_nome || 'Sem sala'}`;
                    
                    equipOrigem.appendChild(option.cloneNode(true));
                    equipDestino.appendChild(option.cloneNode(true));
                    equipRede.appendChild(option.cloneNode(true));
                });
            } catch (error) {
                console.error('Erro ao carregar equipamentos:', error);
            }
        }

        // Carregar salas (removido pois n√£o √© mais necess√°rio)
        async function carregarSalas() {
            // Esta fun√ß√£o foi removida pois o campo sala_patch_panel n√£o existe mais
            // As salas s√£o carregadas automaticamente atrav√©s dos equipamentos
            console.log('Fun√ß√£o carregarSalas() n√£o √© mais necess√°ria');
        }

        

        // Carregar patch panels por andar
        async function carregarPatchPanelAndar() {
            const andar = document.getElementById('andar_patch_panel').value;
            if (!andar) {
                document.getElementById('patch_panel').innerHTML = '<option value="">Selecione o patch panel...</option>';
                return;
            }
            
            try {
                const response = await fetch(`/patch-panels/andar/${andar}`);
                const patchPanelsAndar = await response.json();
                
                const patchPanelSelect = document.getElementById('patch_panel');
                patchPanelSelect.innerHTML = '<option value="">Selecione o patch panel...</option>';
                
                patchPanelsAndar.forEach(pp => {
                    const option = document.createElement('option');
                    option.value = pp.id;
                    option.textContent = `${pp.nome} (${pp.num_portas} portas)`;
                    patchPanelSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar patch panels do andar:', error);
            }
        }

                 // Carregar informa√ß√µes do patch panel baseado no equipamento selecionado
         async function carregarInfoPatchPanel() {
             const equipamentoId = document.getElementById('equipamento_rede').value;
             if (!equipamentoId) {
                 // Limpar campos se nenhum equipamento estiver selecionado
                 document.getElementById('andar_patch_panel').value = '';
                 document.getElementById('patch_panel').innerHTML = '<option value="">Selecione o patch panel...</option>';
                 document.getElementById('porta_patch_panel').innerHTML = '<option value="">Selecione a porta...</option>';
                 return;
             }
             
             try {
                 // Buscar informa√ß√µes do equipamento e sua conex√£o com patch panel
                 const response = await fetch(`/equipamentos/${equipamentoId}/patch-panel-info`);
                 const info = await response.json();
                 
                 if (info.patch_panel_info) {
                     // Preencher andar
                     document.getElementById('andar_patch_panel').value = info.patch_panel_info.andar;
                     
                     // Carregar patch panels do andar
                     await carregarPatchPanelAndar();
                     
                     // Selecionar o patch panel correto
                     document.getElementById('patch_panel').value = info.patch_panel_info.patch_panel_id;
                     
                     // Carregar e selecionar a porta correta
                     await carregarPortasPatchPanel();
                     document.getElementById('porta_patch_panel').value = info.patch_panel_info.porta_numero;
                     
                     // Mostrar mensagem de sucesso
                     mostrarMensagemInfo('Informa√ß√µes do patch panel carregadas automaticamente!', 'success');
                 } else {
                     mostrarMensagemInfo('Este equipamento n√£o est√° conectado a nenhum patch panel.', 'warning');
                 }
             } catch (error) {
                 console.error('Erro ao carregar informa√ß√µes do patch panel:', error);
                 mostrarMensagemInfo('Erro ao carregar informa√ß√µes do patch panel.', 'error');
             }
         }

         // Carregar portas do patch panel (apenas ocupadas)
         async function carregarPortasPatchPanel() {
             const patchPanelId = document.getElementById('patch_panel').value;
             if (!patchPanelId) {
                 document.getElementById('porta_patch_panel').innerHTML = '<option value="">Selecione a porta...</option>';
                 return;
             }
             
             try {
                 const response = await fetch(`/patch-panels/${patchPanelId}/portas`);
                 const portas = await response.json();
                 
                 const portaSelect = document.getElementById('porta_patch_panel');
                 portaSelect.innerHTML = '<option value="">Selecione a porta...</option>';
                 
                 // Filtrar apenas portas ocupadas
                 const portasOcupadas = portas.filter(porta => porta.status === 'ocupada');
                 
                 if (portasOcupadas.length === 0) {
                     portaSelect.innerHTML = '<option value="">Nenhuma porta ocupada encontrada</option>';
                     return;
                 }
                 
                 portasOcupadas.forEach(porta => {
                     const option = document.createElement('option');
                     option.value = porta.numero_porta;
                     
                     option.textContent = `Porta ${porta.numero_porta} - ${porta.equipamento_nome} (${porta.sala_nome || 'Sem sala'})`;
                     portaSelect.appendChild(option);
                 });
             } catch (error) {
                 console.error('Erro ao carregar portas do patch panel:', error);
             }
         }

        

        

        // Gerar c√≥digo √∫nico baseado no tipo de cabo
        // Exemplos: HDMI -> HDM-001, USB -> USB-001, VGA -> VGA-001
        async function gerarCodigoUnico(tipoCabo) {
            if (!tipoCabo) return '';
            
            // Obter prefixo do tipo de cabo (primeiras 3 letras mai√∫sculas)
            const prefixo = tipoCabo.toUpperCase().replace(/[^A-Z]/g, '').substring(0, 3);
            
            // Buscar o pr√≥ximo n√∫mero dispon√≠vel para este tipo
            const codigosDoTipo = cabosExistentes
                .filter(cabo => cabo.codigo_unico && cabo.codigo_unico.startsWith(prefixo))
                .map(cabo => {
                    const match = cabo.codigo_unico.match(new RegExp(`^${prefixo}-(\\d+)$`));
                    return match ? parseInt(match[1]) : 0;
                })
                .sort((a, b) => b - a);
            
            const proximoNumero = codigosDoTipo.length > 0 ? codigosDoTipo[0] + 1 : 1;
            
            return `${prefixo}-${proximoNumero.toString().padStart(3, '0')}`;
        }

        // Gerar novo c√≥digo manualmente
        async function gerarNovoCodigo() {
            const tipoCabo = document.getElementById('tipo').value;
            if (!tipoCabo) {
                alert('Selecione primeiro o tipo de cabo');
                return;
            }
            
            const novoCodigo = await gerarCodigoUnico(tipoCabo);
            document.getElementById('codigo_unico').value = novoCodigo;
        }

        // Atualizar c√≥digo quando tipo de cabo mudar
        function atualizarCodigoUnico() {
            const tipoCabo = document.getElementById('tipo').value;
            if (tipoCabo) {
                gerarCodigoUnico(tipoCabo).then(codigo => {
                    document.getElementById('codigo_unico').value = codigo;
                });
            } else {
                document.getElementById('codigo_unico').value = '';
            }
        }

        // Fun√ß√£o para alternar entre conex√£o direta e via Patch Panel
        function toggleTipoConexao() {
            const secaoConexaoDireta = document.getElementById('secaoConexaoDireta');
            const secaoPatchPanel = document.getElementById('secaoPatchPanel');
            const selectedValue = document.querySelector('input[name="tipo_conexao"]:checked').value;

            // Atualizar visual dos cards
            updateRadioCards(selectedValue);

            if (selectedValue === 'patch_panel') {
                secaoConexaoDireta.classList.add('hidden');
                secaoPatchPanel.classList.remove('hidden');
            } else {
                secaoConexaoDireta.classList.remove('hidden');
                secaoPatchPanel.classList.add('hidden');
            }
        }

        // Fun√ß√£o para atualizar o visual dos cards de radio
        function updateRadioCards(selectedValue) {
            const cards = document.querySelectorAll('input[name="tipo_conexao"]');
            cards.forEach(card => {
                const cardDiv = card.closest('label').querySelector('div');
                const radioDot = cardDiv.querySelector('.w-3.h-3');
                
                if (card.value === selectedValue) {
                    cardDiv.classList.add('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/20');
                    cardDiv.classList.remove('border-gray-200', 'dark:border-gray-600');
                    radioDot.classList.add('bg-indigo-600');
                    radioDot.classList.remove('bg-gray-300', 'dark:bg-gray-500');
                } else {
                    cardDiv.classList.remove('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/20');
                    cardDiv.classList.add('border-gray-200', 'dark:border-gray-600');
                    radioDot.classList.remove('bg-indigo-600');
                    radioDot.classList.add('bg-gray-300', 'dark:bg-gray-500');
                }
            });
        }



        // Submeter formul√°rio
        document.getElementById('formCabo').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('Formul√°rio submetido! Verificando dados...');
            console.log('Formul√°rio submetido - iniciando processamento...');
            
            const formData = new FormData(this);
            const codigoUnico = formData.get('codigo_unico');
            const tipo = formData.get('tipo');
            const tipoConexao = formData.get('tipo_conexao');
            
            console.log('Dados b√°sicos:', { codigoUnico, tipo, tipoConexao });
            
            // Verificar se o c√≥digo √∫nico foi gerado
            if (!codigoUnico) {
                console.log('Erro: C√≥digo √∫nico n√£o gerado');
                alert('Selecione o tipo de cabo para gerar o c√≥digo √∫nico automaticamente');
                document.getElementById('tipo').focus();
                return;
            }
             
             // Validar campos obrigat√≥rios baseado no tipo de conex√£o
             if (tipoConexao === 'direta') {
                 const equipOrigem = formData.get('equipamento_origem');
                 const equipDestino = formData.get('equipamento_destino');
                 
                 if (!equipOrigem) {
                     alert('Selecione o equipamento origem para conex√£o direta');
                     document.getElementById('equipamento_origem').focus();
                     return;
                 }
                 
                 if (!equipDestino) {
                     alert('Selecione o equipamento destino para conex√£o direta');
                     document.getElementById('equipamento_destino').focus();
                     return;
                 }
                 
                 if (equipOrigem === equipDestino) {
                     alert('O equipamento origem e destino n√£o podem ser o mesmo');
                     return;
                 }
             } else if (tipoConexao === 'patch_panel') {
                 const equipRede = formData.get('equipamento_rede');
                 const patchPanel = formData.get('patch_panel');
                 const portaPatchPanel = formData.get('porta_patch_panel');
                 
                 if (!equipRede) {
                     alert('Selecione o equipamento de rede para conex√£o via patch panel');
                     document.getElementById('equipamento_rede').focus();
                     return;
                 }
                 
                 if (!patchPanel) {
                     alert('Selecione o patch panel para conex√£o via patch panel');
                     document.getElementById('patch_panel').focus();
                     return;
                 }
                 
                 if (!portaPatchPanel) {
                     alert('Selecione a porta do patch panel para conex√£o via patch panel');
                     document.getElementById('porta_patch_panel').focus();
                     return;
                 }
             }
            
            const dados = {
                codigo_unico: codigoUnico,
                tipo: tipo,
                tipo_conexao: tipoConexao,
                comprimento: formData.get('comprimento') ? parseFloat(formData.get('comprimento')) : null,
                marca: formData.get('marca'),
                modelo: formData.get('modelo'),
                descricao: formData.get('descricao'),
                status: formData.get('status')
            };

            // Adicionar dados espec√≠ficos baseado no tipo de conex√£o
            if (tipoConexao === 'direta') {
                dados.equipamento_origem_id = parseInt(formData.get('equipamento_origem'));
                dados.equipamento_destino_id = parseInt(formData.get('equipamento_destino'));
                console.log('Conex√£o direta - equipamentos:', { origem: dados.equipamento_origem_id, destino: dados.equipamento_destino_id });
            } else if (tipoConexao === 'patch_panel') {
                dados.equipamento_rede_id = parseInt(formData.get('equipamento_rede'));
                dados.patch_panel_id = parseInt(formData.get('patch_panel'));
                dados.porta_patch_panel = parseInt(formData.get('porta_patch_panel'));
                console.log('Conex√£o via patch panel:', { equipamento_rede: dados.equipamento_rede_id, patch_panel: dados.patch_panel_id, porta: dados.porta_patch_panel });
            }

            // Processar foto se fornecida
            const fotoFile = formData.get('foto');
            if (fotoFile && fotoFile.size > 0) {
                // Aqui voc√™ pode implementar upload de foto
                // Por enquanto, vamos apenas salvar o nome do arquivo
                dados.foto = fotoFile.name;
            }

            console.log('Dados completos a serem enviados:', dados);

            try {
                // Usar a nova fun√ß√£o que inclui conex√£o autom√°tica se for substitui√ß√£o
                await adicionarCaboComConexao(dados);
            } catch (error) {
                console.error('Erro durante o processamento:', error);
                alert('Erro ao processar o formul√°rio: ' + error.message);
            }
        });

        // Limpar formul√°rio
        function limparFormulario() {
            document.getElementById('formCabo').reset();
            // Resetar a op√ß√£o de tipo de conex√£o para direta ao limpar
            document.querySelector('input[name="tipo_conexao"]:checked').checked = true;
            toggleTipoConexao(); // Aplicar a mudan√ßa de visibilidade
        }

        // Mostrar modal de sucesso
        function mostrarModalSucesso() {
            document.getElementById('modalSucesso').classList.remove('hidden');
        }

        // Fechar modal
        function fecharModal() {
            document.getElementById('modalSucesso').classList.add('hidden');
        }

        // Adicionar outro cabo
        function adicionarOutro() {
            fecharModal();
            limparFormulario();
            document.getElementById('codigo_unico').focus();
        }



                 // Mostrar mensagem informativa
         function mostrarMensagemInfo(mensagem, tipo) {
             // Remover mensagem anterior se existir
             const mensagemAnterior = document.getElementById('mensagemInfo');
             if (mensagemAnterior) {
                 mensagemAnterior.remove();
             }
             
             // Criar nova mensagem
             const mensagemDiv = document.createElement('div');
             mensagemDiv.id = 'mensagemInfo';
             
             let classes = 'fixed top-20 right-4 p-4 rounded-lg shadow-lg z-50 max-w-sm';
             let icone = '';
             
             switch (tipo) {
                 case 'success':
                     classes += ' bg-green-100 border border-green-400 text-green-700 dark:bg-green-900/20 dark:border-green-800 dark:text-green-300';
                     icone = 'fas fa-check-circle';
                     break;
                 case 'warning':
                     classes += ' bg-yellow-100 border border-yellow-400 text-yellow-700 dark:bg-yellow-900/20 dark:border-yellow-800 dark:text-yellow-300';
                     icone = 'fas fa-exclamation-triangle';
                     break;
                 case 'error':
                     classes += ' bg-red-100 border border-red-400 text-red-700 dark:bg-red-900/20 dark:border-red-800 dark:text-red-300';
                     icone = 'fas fa-times-circle';
                     break;
             }
             
             mensagemDiv.className = classes;
             mensagemDiv.innerHTML = `
                 <div class="flex items-center">
                     <i class="${icone} mr-2"></i>
                     <span>${mensagem}</span>
                     <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                         <i class="fas fa-times"></i>
                     </button>
                 </div>
             `;
             
             document.body.appendChild(mensagemDiv);
             
             // Remover automaticamente ap√≥s 5 segundos
             setTimeout(() => {
                 if (mensagemDiv.parentElement) {
                     mensagemDiv.remove();
                 }
             }, 5000);
         }

         // Voltar ao painel de configura√ß√£o
         function voltarPainelConfig() {
             fetch('/perfil').then(resp => resp.json()).then(perfil => {
                 if (perfil.nivel === 'admin') {
                     window.location.href = 'config-admin.html';
                 } else if (perfil.nivel === 'tecnico') {
                     window.location.href = 'config-tecnico.html';
                 } else {
                     window.location.href = 'config-usuario.html';
                 }
             });
         }

        // Verificar se √© uma substitui√ß√£o de cabo
        function verificarSubstituicao() {
            const urlParams = new URLSearchParams(window.location.search);
            const isSubstituicao = urlParams.get('substituicao') === 'true';
            
            if (isSubstituicao) {
                const infoSubstituicao = localStorage.getItem('substituicao_cabo');
                if (infoSubstituicao) {
                    const dados = JSON.parse(infoSubstituicao);
                    
                    // Atualizar t√≠tulo e subt√≠tulo
                    document.getElementById('tituloPagina').textContent = 'Substituir Cabo';
                    document.getElementById('subtituloPagina').textContent = 'Adicione o novo cabo para substituir o anterior';
                    document.getElementById('infoSubstituicao').classList.remove('hidden');
                    
                    // Preencher tipo de cabo automaticamente e gerar c√≥digo
                    setTimeout(() => {
                        const tipoSelect = document.getElementById('tipo');
                        if (tipoSelect) {
                            tipoSelect.value = dados.tipo_cabo;
                            // Gerar c√≥digo √∫nico automaticamente
                            atualizarCodigoUnico();
                        }
                    }, 500);
                }
            }
        }

        // Modificar fun√ß√£o de sucesso para incluir conex√£o autom√°tica
        async function adicionarCaboComConexao(dadosCabo) {
            try {
                console.log('Fun√ß√£o adicionarCaboComConexao chamada!');
                console.log('Iniciando adicionarCaboComConexao com dados:', dadosCabo);
                
                // Primeiro, adicionar o cabo
                console.log('Enviando requisi√ß√£o para /cabos...');
                console.log('Dados sendo enviados:', JSON.stringify(dadosCabo, null, 2));
                
                const responseCabo = await fetch('/cabos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dadosCabo)
                });

                console.log('Resposta recebida:', responseCabo.status, responseCabo.statusText);
                
                if (!responseCabo.ok) {
                    console.error('Erro HTTP:', responseCabo.status, responseCabo.statusText);
                    alert('Erro HTTP: ' + responseCabo.status + ' - ' + responseCabo.statusText);
                    return;
                }
                
                const resultCabo = await responseCabo.json();
                console.log('Resultado da cria√ß√£o do cabo:', resultCabo);
                console.log('Resposta do servidor:', resultCabo);
                
                                 if (resultCabo.status === 'ok') {
                     // Verificar se √© uma substitui√ß√£o
                     const infoSubstituicao = localStorage.getItem('substituicao_cabo');
                     if (infoSubstituicao) {
                         const dadosSubstituicao = JSON.parse(infoSubstituicao);
                         
                         // Buscar equipamentos pelo nome
                         const equipamentos = await fetch('/equipamentos').then(r => r.json());
                         const equipOrigem = equipamentos.find(e => e.nome === dadosSubstituicao.equipamento_origem);
                         const equipDestino = equipamentos.find(e => e.nome === dadosSubstituicao.equipamento_destino);
                         
                         if (equipOrigem && equipDestino) {
                             // Conectar automaticamente o novo cabo
                             const dadosConexao = {
                                 cabo_id: resultCabo.cabo_id,
                                 equipamento_origem_id: equipOrigem.id,
                                 equipamento_destino_id: equipDestino.id,
                                 porta_origem: dadosSubstituicao.porta_origem,
                                 porta_destino: dadosSubstituicao.porta_destino,
                                 sala_id: dadosSubstituicao.sala_id,
                                 observacao: `Substitui√ß√£o autom√°tica - ${new Date().toLocaleString('pt-BR')}`
                             };
                             
                             const responseConexao = await fetch('/conexoes-cabos', {
                                 method: 'POST',
                                 headers: {
                                     'Content-Type': 'application/json'
                                 },
                                 body: JSON.stringify(dadosConexao)
                             });
                             
                             if (responseConexao.ok) {
                                 // Limpar dados de substitui√ß√£o
                                 localStorage.removeItem('substituicao_cabo');
                                 
                                 // Mostrar sucesso com redirecionamento
                                 alert('Cabo adicionado e conectado automaticamente!');
                                 window.location.href = `detalhes-cabos-sala.html?id=${dadosSubstituicao.sala_id}`;
                                 return;
                             }
                         }
                     }
                     
                                           // Se for conex√£o via patch panel, conectar automaticamente
                      if (dadosCabo.tipo_conexao === 'patch_panel') {
                          console.log('Criando conex√£o autom√°tica para cabo via patch panel...');
                          
                          // Buscar informa√ß√µes do equipamento para obter a sala
                          const equipamentoResponse = await fetch(`/equipamentos/${dadosCabo.equipamento_rede_id}`);
                          const equipamentoInfo = await equipamentoResponse.json();
                          
                          if (equipamentoInfo.sala_id) {
                              const dadosConexao = {
                                  cabo_id: resultCabo.cabo_id,
                                  equipamento_origem_id: dadosCabo.equipamento_rede_id, // Equipamento (ex: Painel Agenda)
                                  equipamento_destino_id: dadosCabo.patch_panel_id, // Patch Panel
                                  porta_origem: null, // Porta do equipamento (se aplic√°vel)
                                  porta_destino: dadosCabo.porta_patch_panel, // Porta do patch panel
                                  sala_id: equipamentoInfo.sala_id,
                                  observacao: `Conex√£o via Patch Panel - Porta ${dadosCabo.porta_patch_panel} - ${new Date().toLocaleString('pt-BR')}`
                              };
                             
                             const responseConexao = await fetch('/conexoes-cabos', {
                                 method: 'POST',
                                 headers: {
                                     'Content-Type': 'application/json'
                                 },
                                 body: JSON.stringify(dadosConexao)
                             });
                             
                             if (responseConexao.ok) {
                                 console.log('Conex√£o via patch panel criada com sucesso!');
                                 alert('Cabo adicionado e conectado via patch panel!');
                                 window.location.href = `detalhes-cabos-sala.html?id=${equipamentoInfo.sala_id}`;
                                 return;
                             } else {
                                 console.error('Erro ao criar conex√£o via patch panel:', responseConexao.statusText);
                             }
                         }
                     }
                     
                     // Se n√£o for substitui√ß√£o ou erro na conex√£o, mostrar modal normal
                     mostrarModalSucesso();
                } else {
                    console.error('Erro na resposta do servidor:', resultCabo);
                    alert(`Erro: ${resultCabo.mensagem}`);
                }
            } catch (error) {
                console.error('Erro ao adicionar cabo:', error);
                alert('Erro ao adicionar cabo. Tente novamente.');
            }
        }

                 // Inicializa√ß√£o
         window.addEventListener('DOMContentLoaded', function() {
             carregarTiposCabos();
             carregarCabosExistentes();
             carregarEquipamentos();
             carregarSalas();
             verificarSubstituicao();
            
            // Inicializar visual dos cards de radio
            updateRadioCards('direta');
            
            // Adicionar evento de mudan√ßa no tipo de cabo
            document.getElementById('tipo').addEventListener('change', atualizarCodigoUnico);
            
            
            
            // Carregar logo da empresa
            fetch('/empresa_atual')
                .then(resp => resp.json())
                .then(data => {
                    LogoManager.loadEmpresaLogo(data);
                });
        });
    </script>
    <script src="static/js/logo-manager.js"></script>
</body>

</html> 
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Adicionar Cabo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="static/img/favicon-lapis.png">
    <script>
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
        updateEmpresaLogo();
      }
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
</head>

<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
    <div class="relative w-full max-w-4xl mx-auto bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-8 mt-8">
        <button onclick="voltarPainelConfig()" class="absolute top-4 left-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-2 transition-colors" title="Voltar">
            <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="empresa-logada" class="absolute top-4 right-4 text-indigo-500 font-bold bg-gray-800 dark:bg-transparent rounded-lg p-2"></div>
        <button onclick="toggleDarkMode()" class="absolute top-4 left-16 bg-gray-200 dark:bg-gray-700 rounded-full p-2 transition-colors" title="Alternar modo escuro">
            <span class="dark:hidden">üåô</span><span class="hidden dark:inline">‚òÄÔ∏è</span>
        </button>
        
        <div class="text-center mt-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">
                <i class="fas fa-plug text-indigo-600 dark:text-indigo-400 mr-3"></i>
                <span id="tituloPagina">Adicionar Cabo</span>
            </h1>
            <p class="text-gray-600 dark:text-gray-300" id="subtituloPagina">Cadastre um novo cabo no sistema</p>
            <div id="infoSubstituicao" class="hidden mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-exchange-alt text-yellow-600 dark:text-yellow-400 mr-3"></i>
                    <div class="text-left">
                        <h3 class="font-semibold text-yellow-800 dark:text-yellow-200">Substitui√ß√£o de Cabo</h3>
                        <p class="text-sm text-yellow-700 dark:text-yellow-300">Ap√≥s adicionar o novo cabo, ele ser√° automaticamente conectado na mesma posi√ß√£o do cabo anterior.</p>
                    </div>
                </div>
            </div>
        </div>

        <form id="formCabo" class="space-y-6">
            <!-- C√≥digo √önico -->
            <div>
                <label for="codigo_unico" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-barcode mr-2"></i>C√≥digo √önico *
                </label>
                <input type="text" id="codigo_unico" name="codigo_unico" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600"
                       placeholder="Ex: HDMI-001, USB-002, etc.">
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">C√≥digo √∫nico para identificar o cabo f√≠sico</p>
            </div>

            <!-- Tipo de Cabo -->
            <div>
                <label for="tipo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-tag mr-2"></i>Tipo de Cabo *
                </label>
                <select id="tipo" name="tipo" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600">
                    <option value="">Selecione o tipo...</option>
                </select>
            </div>

            <!-- Comprimento -->
            <div>
                <label for="comprimento" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-ruler mr-2"></i>Comprimento (metros)
                </label>
                <input type="number" id="comprimento" name="comprimento" min="0.1" step="0.1"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600"
                       placeholder="Ex: 2.5">
            </div>

            <!-- Marca -->
            <div>
                <label for="marca" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-industry mr-2"></i>Marca
                </label>
                <input type="text" id="marca" name="marca"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600"
                       placeholder="Ex: Belkin, AmazonBasics, etc.">
            </div>

            <!-- Modelo -->
            <div>
                <label for="modelo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-cube mr-2"></i>Modelo
                </label>
                <input type="text" id="modelo" name="modelo"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600"
                       placeholder="Ex: Ultra HD, Premium, etc.">
            </div>

            <!-- Status -->
            <div>
                <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-check-circle mr-2"></i>Status
                </label>
                <select id="status" name="status"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600">
                    <option value="funcionando">Funcionando</option>
                    <option value="defeito">Com Defeito</option>
                </select>
            </div>

            <!-- Descri√ß√£o -->
            <div>
                <label for="descricao" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-align-left mr-2"></i>Descri√ß√£o
                </label>
                <textarea id="descricao" name="descricao" rows="3"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600"
                          placeholder="Descri√ß√£o adicional do cabo..."></textarea>
            </div>

            <!-- Foto -->
            <div>
                <label for="foto" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-camera mr-2"></i>Foto do Cabo
                </label>
                <input type="file" id="foto" name="foto" accept="image/*"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600">
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Opcional: foto do cabo para identifica√ß√£o visual</p>
            </div>

            <!-- Bot√µes -->
            <div class="flex gap-4 pt-6">
                <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                    <i class="fas fa-save mr-2"></i>Salvar Cabo
                </button>
                <button type="button" onclick="limparFormulario()" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg transition-colors">
                    <i class="fas fa-eraser mr-2"></i>Limpar
                </button>
            </div>
        </form>

        <!-- Modal de Sucesso -->
        <div id="modalSucesso" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4">
                <div class="text-center">
                    <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Cabo Adicionado!</h3>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">O cabo foi cadastrado com sucesso no sistema.</p>
                    <div class="flex gap-3">
                        <button onclick="fecharModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            OK
                        </button>
                        <button onclick="adicionarOutro()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            Adicionar Outro
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tiposCabos = [];

        // Carregar tipos de cabos
        async function carregarTiposCabos() {
            try {
                const response = await fetch('/tipos-cabos');
                tiposCabos = await response.json();
                
                const selectTipo = document.getElementById('tipo');
                selectTipo.innerHTML = '<option value="">Selecione o tipo...</option>';
                
                tiposCabos.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.nome;
                    option.textContent = `${tipo.nome} - ${tipo.descricao}`;
                    selectTipo.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar tipos de cabos:', error);
            }
        }

        // Submeter formul√°rio
        document.getElementById('formCabo').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const dados = {
                codigo_unico: formData.get('codigo_unico'),
                tipo: formData.get('tipo'),
                comprimento: formData.get('comprimento') ? parseFloat(formData.get('comprimento')) : null,
                marca: formData.get('marca'),
                modelo: formData.get('modelo'),
                descricao: formData.get('descricao'),
                status: formData.get('status')
            };

            // Processar foto se fornecida
            const fotoFile = formData.get('foto');
            if (fotoFile && fotoFile.size > 0) {
                // Aqui voc√™ pode implementar upload de foto
                // Por enquanto, vamos apenas salvar o nome do arquivo
                dados.foto = fotoFile.name;
            }

            // Usar a nova fun√ß√£o que inclui conex√£o autom√°tica se for substitui√ß√£o
            await adicionarCaboComConexao(dados);
        });

        // Limpar formul√°rio
        function limparFormulario() {
            document.getElementById('formCabo').reset();
        }

        // Mostrar modal de sucesso
        function mostrarModalSucesso() {
            document.getElementById('modalSucesso').classList.remove('hidden');
        }

        // Fechar modal
        function fecharModal() {
            document.getElementById('modalSucesso').classList.add('hidden');
        }

        // Adicionar outro cabo
        function adicionarOutro() {
            fecharModal();
            limparFormulario();
            document.getElementById('codigo_unico').focus();
        }

        // Voltar ao painel de configura√ß√£o
        function voltarPainelConfig() {
            fetch('/perfil').then(resp => resp.json()).then(perfil => {
                if (perfil.nivel === 'admin') {
                    window.location.href = 'config-admin.html';
                } else if (perfil.nivel === 'tecnico') {
                    window.location.href = 'config-tecnico.html';
                } else {
                    window.location.href = 'config-usuario.html';
                }
            });
        }

        // Verificar se √© uma substitui√ß√£o de cabo
        function verificarSubstituicao() {
            const urlParams = new URLSearchParams(window.location.search);
            const isSubstituicao = urlParams.get('substituicao') === 'true';
            
            if (isSubstituicao) {
                const infoSubstituicao = localStorage.getItem('substituicao_cabo');
                if (infoSubstituicao) {
                    const dados = JSON.parse(infoSubstituicao);
                    
                    // Atualizar t√≠tulo e subt√≠tulo
                    document.getElementById('tituloPagina').textContent = 'Substituir Cabo';
                    document.getElementById('subtituloPagina').textContent = 'Adicione o novo cabo para substituir o anterior';
                    document.getElementById('infoSubstituicao').classList.remove('hidden');
                    
                    // Preencher tipo de cabo automaticamente
                    setTimeout(() => {
                        const tipoSelect = document.getElementById('tipo');
                        if (tipoSelect) {
                            tipoSelect.value = dados.tipo_cabo;
                        }
                    }, 500);
                }
            }
        }

        // Modificar fun√ß√£o de sucesso para incluir conex√£o autom√°tica
        async function adicionarCaboComConexao(dadosCabo) {
            try {
                // Primeiro, adicionar o cabo
                const responseCabo = await fetch('/cabos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dadosCabo)
                });

                const resultCabo = await responseCabo.json();
                
                if (resultCabo.status === 'ok') {
                    // Verificar se √© uma substitui√ß√£o
                    const infoSubstituicao = localStorage.getItem('substituicao_cabo');
                    if (infoSubstituicao) {
                        const dadosSubstituicao = JSON.parse(infoSubstituicao);
                        
                        // Buscar equipamentos pelo nome
                        const equipamentos = await fetch('/equipamentos').then(r => r.json());
                        const equipOrigem = equipamentos.find(e => e.nome === dadosSubstituicao.equipamento_origem);
                        const equipDestino = equipamentos.find(e => e.nome === dadosSubstituicao.equipamento_destino);
                        
                        if (equipOrigem && equipDestino) {
                            // Conectar automaticamente o novo cabo
                            const dadosConexao = {
                                cabo_id: resultCabo.cabo_id,
                                equipamento_origem_id: equipOrigem.id,
                                equipamento_destino_id: equipDestino.id,
                                porta_origem: dadosSubstituicao.porta_origem,
                                porta_destino: dadosSubstituicao.porta_destino,
                                sala_id: dadosSubstituicao.sala_id,
                                observacao: `Substitui√ß√£o autom√°tica - ${new Date().toLocaleString('pt-BR')}`
                            };
                            
                            const responseConexao = await fetch('/conexoes-cabos', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(dadosConexao)
                            });
                            
                            if (responseConexao.ok) {
                                // Limpar dados de substitui√ß√£o
                                localStorage.removeItem('substituicao_cabo');
                                
                                // Mostrar sucesso com redirecionamento
                                alert('Cabo adicionado e conectado automaticamente!');
                                window.location.href = `detalhes-cabos-sala.html?id=${dadosSubstituicao.sala_id}`;
                                return;
                            }
                        }
                    }
                    
                    // Se n√£o for substitui√ß√£o ou erro na conex√£o, mostrar modal normal
                    mostrarModalSucesso();
                } else {
                    alert(`Erro: ${resultCabo.mensagem}`);
                }
            } catch (error) {
                console.error('Erro ao adicionar cabo:', error);
                alert('Erro ao adicionar cabo. Tente novamente.');
            }
        }

        // Inicializa√ß√£o
        window.addEventListener('DOMContentLoaded', function() {
            carregarTiposCabos();
            verificarSubstituicao();
            
            // Carregar logo da empresa
            fetch('/empresa_atual')
                .then(resp => resp.json())
                .then(data => {
                    LogoManager.loadEmpresaLogo(data);
                });
        });
    </script>
    <script src="static/js/logo-manager.js"></script>
</body>

</html> 
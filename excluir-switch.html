<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Excluir Switch</title>
    <link rel="stylesheet" href="css/estilo-base.css">
    <link rel="stylesheet" href="css/estilo-excluir-switch.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <div class="voltar-container">
            <button class="card-btn voltar" onclick="window.location.href='config-admin.html'" title="Voltar">
                <i class="fas fa-arrow-left"></i>
            </button>
        </div>
        <h1>Excluir Switch</h1>
        <div id="msg" class="msg" style="display:none;"></div>
        <div id="empresa-logada"></div>
        <div class="switch-list" id="switchList"></div>
    </div>
    <script>
        async function carregarSwitches() {
            const resp = await fetch('/switches');
            const switches = await resp.json();
            const container = document.getElementById('switchList');
            container.innerHTML = '';
            if (switches.length === 0) {
                container.innerHTML = '<div class="aviso">Nenhum switch cadastrado.</div>';
                return;
            }
            for (const sw of switches) {
                // Buscar portas e conexões
                const respPortas = await fetch(`/switch-portas/${sw.id}`);
                const portas = await respPortas.json();
                const ocupadas = portas.filter(p => p.status === 'ocupada');
                let aviso = '';
                if (ocupadas.length > 0) {
                    aviso = `<div class='aviso'>Atenção: Este switch possui ${ocupadas.length} porta(s) conectada(s) a equipamentos. Ao excluir, todas as conexões serão desfeitas e as portas liberadas.</div>`;
                }
                container.innerHTML += `
                    <div class="switch-item">
                        <div class="switch-info">
                            <strong>${sw.nome}</strong> <br>
                            Marca: ${sw.marca} | Modelo: ${sw.modelo} <br>
                            ID: ${sw.id}
                            ${aviso}
                        </div>
                        <button class="btn-excluir" onclick="confirmarExclusao(${sw.id}, '${sw.nome}')">
                            <i class="fas fa-trash-alt"></i> Excluir
                        </button>
                    </div>
                `;
            }
        }
        async function confirmarExclusao(id, nome) {
            if (!confirm(`Tem certeza que deseja excluir o switch '${nome}'?\n\nTodas as conexões das portas deste switch serão desfeitas e os equipamentos ficarão disponíveis para outros switches.`)) {
                return;
            }
            try {
                const resp = await fetch(`/switches/${id}`, { method: 'DELETE' });
                const json = await resp.json();
                if (json.status === 'ok') {
                    mostrarMensagem('Switch excluído com sucesso!', 'success');
                    carregarSwitches();
                } else {
                    mostrarMensagem(json.mensagem || 'Erro ao excluir switch', 'error');
                }
            } catch (error) {
                mostrarMensagem('Erro ao excluir switch', 'error');
            }
        }
        function mostrarMensagem(msg, tipo) {
            const div = document.getElementById('msg');
            div.textContent = msg;
            div.className = 'msg ' + tipo;
            div.style.display = 'block';
            setTimeout(() => { div.style.display = 'none'; }, 3000);
        }
        window.addEventListener('DOMContentLoaded', function() {
            fetch('/empresa_atual')
                .then(resp => resp.json())
                .then(data => {
                    if (data.logo) {
                        document.getElementById('empresa-logada').innerHTML = `<img src="${data.logo}" alt="Logo da empresa" style="max-height:40px;max-width:120px;object-fit:contain;">`;
                    } else if (data.nome) {
                        document.getElementById('empresa-logada').innerText = 'Empresa: ' + data.nome;
                    }
                });
        });
        carregarSwitches();
    </script>
</body>
</html> 
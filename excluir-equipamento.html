<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Excluir Equipamento</title>
    <link rel="stylesheet" href="css/estilo-base.css">
    <link rel="stylesheet" href="css/estilo-excluir-equipamento.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body style="background: rgb(18, 33, 55);">
    <div class="admin-container">
        <div class="voltar-container" style="justify-content:flex-start;">
            <button class="card-btn voltar" onclick="window.history.back()" title="Voltar">
                <i class="fas fa-arrow-left"></i>
            </button>
        </div>
        <h1 style="text-align:left;">Excluir Equipamentos</h1>
        <div style="width:100%;margin-bottom:18px;">
            <input id="filtroEquipamento" type="text" class="input-filtro-equipamento input-estilizado" placeholder="Filtrar por nome do equipamento...">
        </div>
        <div style="overflow-x:auto;"><div id="cardsEquipamentosContainer"></div></div>
        <div class="msg" id="msg"></div>
        <div id="empresa-logada"></div>
    </div>
    <script>
    let equipamentos = [];
    let salasMap = {};
    // Carrega todas as salas para mapear id -> nome
    fetch('/salas')
        .then(resp => resp.json())
        .then(salas => {
            salas.forEach(sala => {
                salasMap[sala.id] = sala.nome;
            });
            carregarEquipamentos();
        });
    function carregarEquipamentos() {
        fetch('/equipamentos')
            .then(resp => resp.json())
            .then(data => {
                equipamentos = data;
                renderizarEquipamentos(data);
            });
    }
    function renderizarEquipamentos(equipamentosFiltrados) {
        const container = document.getElementById('cardsEquipamentosContainer');
        let html = '';
        equipamentosFiltrados.forEach(eq => {
            const salaIdStr = eq.sala_id !== undefined && eq.sala_id !== null ? String(eq.sala_id) : null;
            html += `<div class='card-equipamento'>`;
            if (eq.foto) {
                html += `<div class='equip-foto'><img src='${eq.foto.startsWith("img/") ? "static/" + eq.foto : eq.foto}' alt='${eq.nome || ''}'></div>`;
            }
            html += `<div class='equip-nome'>${eq.nome || ''}</div>`;
            html += `<div class='equip-info'>`;
            html += `<div class='equip-info-linha'><b>Sala:</b> ${salaIdStr && salasMap[salaIdStr] ? salasMap[salaIdStr] : (eq.sala_id ? eq.sala_id : 'Sem sala')}</div>`;
            html += `<div class='equip-info-linha'><b>Status:</b> ${eq.defeito === 1 || eq.defeito === true || eq.status === 'defeito' ? 'Defeito' : 'Funcionando'}</div>`;
            html += `<div class='equip-info-linha'><b>Tipo:</b> ${eq.tipo || ''}</div>`;
            html += `<div class='equip-info-linha'><b>Marca:</b> ${eq.marca || ''}</div>`;
            html += `<div class='equip-info-linha'><b>Série:</b> ${eq.dados?.serie || ''}</div>`;
            html += `<div class='equip-info-linha'><b>Descrição:</b> ${eq.descricao || ''}</div>`;
            html += `</div>`;
            if (eq.icone) {
                html += `<div class='equip-icone'><img src='${eq.icone.startsWith("img/") ? "static/" + eq.icone : eq.icone}' alt='ícone'></div>`;
            }
            html += `<button class='excluir-btn' onclick='excluirEquipamento(${eq.id}, this)'><i class='fas fa-trash-alt'></i> Excluir</button>`;
            html += `</div>`;
        });
        container.innerHTML = html;
    }
    document.addEventListener('DOMContentLoaded', function() {
        const filtro = document.getElementById('filtroEquipamento');
        filtro.addEventListener('input', function() {
            const termo = filtro.value.trim().toLowerCase();
            const filtrados = termo ? equipamentos.filter(eq => (eq.nome||'').toLowerCase().includes(termo)) : equipamentos;
            renderizarEquipamentos(filtrados);
        });
        fetch('/empresa_atual')
            .then(resp => resp.json())
            .then(data => {
                if (data.logo) {
                    document.getElementById('empresa-logada').innerHTML = `<img src="${data.logo}" alt="Logo da empresa" style="max-height:40px;max-width:120px;object-fit:contain;">`;
                } else if (data.nome) {
                    document.getElementById('empresa-logada').innerText = 'Empresa: ' + data.nome;
                }
            });
    });
    async function excluirEquipamento(id, btn) {
        const eq = equipamentos.find(e => e.id == id);
        let statusMsg = '';
        if (eq && eq.sala_id && salasMap[eq.sala_id]) {
            statusMsg = `Este equipamento está vinculado à sala ${salasMap[eq.sala_id]}.`;
        } else {
            statusMsg = 'Este equipamento não está vinculado a nenhuma sala.';
        }
        if (!confirm(`${statusMsg}\n\nTem certeza que deseja excluir este equipamento?`)) return;
        const resp = await fetch(`/equipamentos/${id}`, {
            method: 'DELETE'
        });
        const json = await resp.json();
        if (json.status === 'ok') {
            btn.closest('.card-equipamento').remove();
            document.getElementById('msg').innerText = 'Equipamento excluído com sucesso!';
        } else {
            document.getElementById('msg').innerText = 'Erro ao excluir!';
        }
    }
    </script>
</body>
</html>
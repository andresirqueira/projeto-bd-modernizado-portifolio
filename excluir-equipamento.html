<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Excluir Equipamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
        // Atualizar logo da empresa quando o tema mudar
        updateEmpresaLogo();
      }
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
</head>
<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
    <div class="relative w-full max-w-6xl mx-auto bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-8 mt-8">
        <button onclick="window.history.back()" class="absolute top-4 left-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-2 transition-colors" title="Voltar">
            <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="empresa-logada" class="absolute top-4 right-4 text-indigo-500 font-bold bg-gray-800 dark:bg-transparent rounded-lg p-2"></div>
        <button onclick="toggleDarkMode()" class="absolute top-4 left-16 bg-gray-200 dark:bg-gray-700 rounded-full p-2 transition-colors" title="Alternar modo escuro">
            <span class="dark:hidden">üåô</span><span class="hidden dark:inline">‚òÄÔ∏è</span>
        </button>
        <div class="text-center mt-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">Excluir Equipamentos</h1>
        </div>
        <div class="mb-6">
            <input id="filtroEquipamento" type="text" class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white dark:border-gray-600" placeholder="Filtrar por nome do equipamento...">
        </div>
        <div id="cardsEquipamentosContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-[600px] overflow-y-auto w-full"></div>
        <div class="msg text-center mt-6 text-lg font-semibold" id="msg"></div>
    </div>
    <script>
    let equipamentos = [];
    let salasMap = {};
    // Carrega todas as salas para mapear id -> nome
    fetch('/salas')
        .then(resp => resp.json())
        .then(salas => {
            salas.forEach(sala => {
                salasMap[sala.id] = sala.nome;
            });
            carregarEquipamentos();
        });
    function carregarEquipamentos() {
        fetch('/equipamentos')
            .then(resp => resp.json())
            .then(data => {
                equipamentos = data;
                renderizarEquipamentos(data);
            });
    }
    function renderizarEquipamentos(equipamentosFiltrados) {
        const container = document.getElementById('cardsEquipamentosContainer');
        let html = '';
        equipamentosFiltrados.forEach(eq => {
            const salaIdStr = eq.sala_id !== undefined && eq.sala_id !== null ? String(eq.sala_id) : null;
            html += `<div class='bg-gray-100 dark:bg-gray-800 rounded-xl shadow-lg p-4 flex flex-col items-center justify-start break-words overflow-hidden border-2 border-gray-300 dark:border-gray-600 hover:shadow-xl transition-colors'>`;
            if (eq.foto) {
                html += `<div class='mb-2 flex justify-center w-full'><img src='${eq.foto.startsWith("img/") ? "static/" + eq.foto : eq.foto}' alt='${eq.nome || ''}' class='w-20 h-14 object-contain rounded'></div>`;
            }
            html += `<div class='font-bold text-base text-gray-800 dark:text-white text-center mb-1'>${eq.nome || ''}</div>`;
            html += `<div class='text-xs text-gray-600 dark:text-gray-400 text-center space-y-0.5 mb-2 flex flex-col items-center'>`;
            html += `<div><span class='font-semibold'>Sala:</span> ${salaIdStr && salasMap[salaIdStr] ? salasMap[salaIdStr] : (eq.sala_id ? eq.sala_id : 'Sem sala')}</div>`;
            html += `<div><span class='font-semibold'>Status:</span> ${eq.defeito === 1 || eq.defeito === true || eq.status === 'defeito' ? 'Defeito' : 'Funcionando'}</div>`;
            html += `<div><span class='font-semibold'>Tipo:</span> ${eq.tipo || ''}</div>`;
            html += `<div><span class='font-semibold'>Marca:</span> ${eq.marca || ''}</div>`;
            html += `<div><span class='font-semibold'>S√©rie:</span> ${eq.dados?.serie || ''}</div>`;
            html += `<div><span class='font-semibold'>Descri√ß√£o:</span> ${eq.descricao || ''}</div>`;
            html += `</div>`;
            if (eq.icone) {
                html += `<div class='mt-1 flex justify-center w-full'><img src='${eq.icone.startsWith("img/") ? "static/" + eq.icone : eq.icone}' alt='√≠cone' class='w-6 h-6 object-contain'></div>`;
            }
            html += `<button class='mt-3 bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-4 rounded shadow flex items-center gap-2 transition-colors text-sm excluir-btn' onclick='excluirEquipamento(${eq.id}, this)'><i class='fas fa-trash-alt'></i> Excluir</button>`;
            html += `</div>`;
        });
        container.innerHTML = html;
    }
    document.addEventListener('DOMContentLoaded', function() {
        const filtro = document.getElementById('filtroEquipamento');
        filtro.addEventListener('input', function() {
            const termo = filtro.value.trim().toLowerCase();
            const filtrados = termo ? equipamentos.filter(eq => (eq.nome||'').toLowerCase().includes(termo)) : equipamentos;
            renderizarEquipamentos(filtrados);
        });
        fetch('/empresa_atual')
            .then(resp => resp.json())
            .then(data => {
                LogoManager.loadEmpresaLogo(data);
            });
    });
    async function excluirEquipamento(id, btn) {
        const eq = equipamentos.find(e => e.id == id);
        let statusMsg = '';
        if (eq && eq.sala_id && salasMap[eq.sala_id]) {
            statusMsg = `Este equipamento est√° vinculado √† sala ${salasMap[eq.sala_id]}.`;
        } else {
            statusMsg = 'Este equipamento n√£o est√° vinculado a nenhuma sala.';
        }
        if (!confirm(`${statusMsg}\n\nTem certeza que deseja excluir este equipamento?`)) return;
        const resp = await fetch(`/equipamentos/${id}`, {
            method: 'DELETE'
        });
        const json = await resp.json();
        if (json.status === 'ok') {
            btn.closest('.card-equipamento').remove();
            document.getElementById('msg').innerText = 'Equipamento exclu√≠do com sucesso!';
        } else {
            document.getElementById('msg').innerText = 'Erro ao excluir!';
        }
    }
    </script>
    <script src="static/js/logo-manager.js"></script>
    </body>
</html>
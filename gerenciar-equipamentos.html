<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gerenciar Equipamentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="static/img/favicon-lista.png">
    <script>
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
        // Atualizar logo da empresa quando o tema mudar
        updateEmpresaLogo();
      }
      
      function updateEmpresaLogo() {
        const empresaDiv = document.getElementById('empresa-logada');
        if (empresaDiv && empresaDiv.querySelector('img')) {
          const isDark = document.documentElement.classList.contains('dark');
          const bgClass = isDark ? 'dark:bg-transparent' : 'bg-gray-800';
          empresaDiv.className = `absolute top-4 right-4 text-indigo-500 font-bold ${bgClass} rounded-lg p-2`;
        }
      }
      
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
</head>
<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
    <div class="relative w-full max-w-7xl mx-auto bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-8 mt-8">
        <button onclick="voltarPainelConfig()" class="absolute top-4 left-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-2 transition-colors" title="Voltar">
            <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="empresa-logada" class="absolute top-4 right-4 text-indigo-500 font-bold bg-gray-800 dark:bg-transparent rounded-lg p-2"></div>
        <button onclick="toggleDarkMode()" class="absolute top-4 left-16 bg-gray-200 dark:bg-gray-700 rounded-full p-2 transition-colors" title="Alternar modo escuro">
            <span class="dark:hidden">üåô</span><span class="hidden dark:inline">‚òÄÔ∏è</span>
        </button>
        <div class="text-center mt-8 mb-8">
            <div class="text-center mt-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">
                <i class="fas fa-cogs text-indigo-600 dark:text-indigo-400 mr-3"></i>
                Gerenciar Equipamentos
            </h1>
            <p class="text-gray-600 dark:text-gray-300">Gerencie todos os equipamentos do sistema</p>
        </div>
            <div id="filtroAtivoIndicador" class="text-sm text-indigo-600 dark:text-indigo-400 font-medium"></div>
        </div>
        <div class="mb-6 flex flex-wrap gap-4 justify-center" id="resumoEquipamentos"></div>
        <div class="mb-6 flex gap-2">
            <div class="flex-1 relative">
                <input id="filtroEquipamento" type="text" class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white dark:border-gray-600" placeholder="Buscar por nome, s√©rie, marca, sala...">
                <div class="absolute right-3 top-2.5 text-gray-400 dark:text-gray-500 text-sm">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            <button onclick="limparFiltros()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded transition-colors" title="Limpar todos os filtros">
                <i class="fas fa-times"></i> Limpar
            </button>
        </div>
        <div class="mb-4 text-xs text-gray-500 dark:text-gray-400 text-center">
            <i class="fas fa-info-circle"></i> Dica: Voc√™ pode buscar por nome do equipamento, n√∫mero de s√©rie, marca, nome da sala ou descri√ß√£o
        </div>
        <div id="resultadosInfo" class="mb-4 text-xs text-indigo-600 dark:text-indigo-400 text-center font-medium"></div>
        <div id="tabelaEquipamentosContainer"></div>
    </div>
    <script>
    let equipamentos = [];
    let salasMap = {};
    let filtroAtivo = null; // Para controlar qual filtro est√° ativo
    fetch('/salas')
        .then(resp => resp.json())
        .then(salas => {
            salas.forEach(sala => {
                salasMap[sala.id] = sala.nome;
            });
            carregarEquipamentos();
        });
    function carregarEquipamentos() {
        fetch('/equipamentos')
            .then(resp => resp.json())
            .then(data => {
                equipamentos = data;
                renderizarEquipamentos(data);
            });
    }
    
    function aplicarFiltro(tipo) {
        filtroAtivo = tipo;
        const filtrados = tipo === 'total' ? equipamentos : equipamentos.filter(eq => eq.tipo === tipo);
        renderizarEquipamentos(filtrados);
        // Limpar o campo de busca quando aplicar filtro por tipo
        document.getElementById('filtroEquipamento').value = '';
        atualizarIndicadorFiltro();
        atualizarIndicadorResultados(filtrados, '');
    }
    
    function limparFiltros() {
        filtroAtivo = null;
        document.getElementById('filtroEquipamento').value = '';
        renderizarEquipamentos(equipamentos);
        atualizarIndicadorFiltro();
        atualizarIndicadorResultados(equipamentos, '');
    }
    
    function atualizarIndicadorFiltro() {
        const indicador = document.getElementById('filtroAtivoIndicador');
        const termoBusca = document.getElementById('filtroEquipamento').value.trim();
        const container = document.getElementById('tabelaEquipamentosContainer');
        const cardsContainer = container.querySelector('#cardsEquipamentosContainer');
        const numResultados = cardsContainer ? cardsContainer.children.length : 0;
        
        let indicadorTexto = '';
        
        if (filtroAtivo && filtroAtivo !== 'total') {
            indicadorTexto += `<i class="fas fa-filter"></i> Filtro por tipo: ${filtroAtivo}`;
        }
        
        if (termoBusca) {
            if (indicadorTexto) indicadorTexto += ' | ';
            indicadorTexto += `<i class="fas fa-search"></i> Busca: "${termoBusca}" (${numResultados} resultado${numResultados !== 1 ? 's' : ''})`;
        }
        
        indicador.innerHTML = indicadorTexto;
    }
    
    function atualizarIndicadorResultados(filtrados, termo) {
        const infoDiv = document.getElementById('resultadosInfo');
        if (termo || (filtroAtivo && filtroAtivo !== 'total')) {
            const filtros = [];
            if (termo) filtros.push(`busca: "${termo}"`);
            if (filtroAtivo && filtroAtivo !== 'total') filtros.push(`tipo: ${filtroAtivo}`);
            
            infoDiv.innerHTML = `<i class="fas fa-filter"></i> Filtros: ${filtros.join(', ')} (${filtrados.length} resultado${filtrados.length !== 1 ? 's' : ''})`;
        } else {
            infoDiv.innerHTML = '';
        }
    }
    function renderizarResumo(equipamentos) {
        const resumoDiv = document.getElementById('resumoEquipamentos');
        if (!equipamentos.length) {
            resumoDiv.innerHTML = "<span class='text-gray-400 dark:text-gray-500'>Nenhum equipamento encontrado.</span>";
            return;
        }
        // Conta por tipo e status
        const tipos = {};
        let funcionando = 0;
        let defeito = 0;
        equipamentos.forEach(eq => {
            if (!tipos[eq.tipo]) tipos[eq.tipo] = 0;
            tipos[eq.tipo]++;
            if (eq.defeito === 1 || eq.defeito === true || eq.defeito === '1') {
                defeito++;
            } else {
                funcionando++;
            }
        });
        
        // Card Total - sempre clic√°vel
        const totalAtivo = filtroAtivo === 'total' ? 'ring-4 ring-yellow-400' : '';
        let html = `
            <div onclick="aplicarFiltro('total')" class="flex items-center gap-2 bg-indigo-600 dark:bg-indigo-800 text-white px-5 py-2 rounded-lg shadow cursor-pointer hover:bg-indigo-700 dark:hover:bg-indigo-700 transition-colors ${totalAtivo}" title="Mostrar todos os equipamentos">
                <i class="fas fa-boxes"></i> Total: <b class='ml-1'>${equipamentos.length}</b>
            </div>
            <div class="flex items-center gap-2 bg-green-600 dark:bg-green-800 text-white px-5 py-2 rounded-lg shadow">
                <i class="fas fa-check-circle"></i> Funcionando: <b class='ml-1'>${funcionando}</b>
            </div>
            <div class="flex items-center gap-2 bg-red-600 dark:bg-red-800 text-white px-5 py-2 rounded-lg shadow">
                <i class="fas fa-times-circle"></i> Defeito: <b class='ml-1'>${defeito}</b>
            </div>
        `;
        
        // Se h√° filtro ativo, mostrar apenas o card do tipo selecionado
        if (filtroAtivo && filtroAtivo !== 'total' && tipos[filtroAtivo]) {
            const tipoAtivo = 'ring-4 ring-yellow-400';
            html += `
                <div onclick="aplicarFiltro('${filtroAtivo}')" class="flex items-center gap-2 bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 px-5 py-2 rounded-lg shadow cursor-pointer hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors ${tipoAtivo}" title="Filtrar por ${filtroAtivo}">
                    <i class="fas fa-tag"></i> ${filtroAtivo || 'Sem tipo'}: <b class='ml-1'>${tipos[filtroAtivo]}</b>
                </div>
            `;
        } else {
            // Cards por tipo - clic√°veis (apenas quando n√£o h√° filtro ativo)
            Object.entries(tipos).forEach(([tipo, qtd]) => {
                const tipoAtivo = filtroAtivo === tipo ? 'ring-4 ring-yellow-400' : '';
                html += `
                    <div onclick="aplicarFiltro('${tipo}')" class="flex items-center gap-2 bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 px-5 py-2 rounded-lg shadow cursor-pointer hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors ${tipoAtivo}" title="Filtrar por ${tipo}">
                        <i class="fas fa-tag"></i> ${tipo || 'Sem tipo'}: <b class='ml-1'>${qtd}</b>
                    </div>
                `;
            });
        }
        resumoDiv.innerHTML = html;
    }
    function renderizarEquipamentos(equipamentosFiltrados) {
        const container = document.getElementById('tabelaEquipamentosContainer');
        const termoBusca = document.getElementById('filtroEquipamento').value.trim().toLowerCase();
        
        let html = '<div id="cardsEquipamentosContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">';
        equipamentosFiltrados.forEach(eq => {
            const salaIdStr = eq.sala_id !== undefined && eq.sala_id !== null ? String(eq.sala_id) : null;
            const isDefeito = eq.defeito === 1 || eq.defeito === "1" || eq.defeito === true;
            html += `<div class='bg-white dark:bg-gray-800 rounded-xl shadow-lg flex flex-col h-full p-4 transition hover:scale-105 hover:shadow-2xl relative'>`;
            html += `<div class='absolute top-2 right-2 w-8 h-8 rounded-full flex items-center justify-center ${isDefeito ? 'bg-red-500' : 'bg-green-500'} text-white' title='${isDefeito ? 'Defeito' : 'Funcionando'}'>`;
            html += `<i class='fas ${isDefeito ? 'fa-times' : 'fa-check'}'></i>`;
            html += `</div>`;
            if (eq.marca) {
                html += LogoManager.renderMarcaLogo(eq.marca);
            }
            if (eq.foto) {
                html += `<div class='w-full h-20 flex items-center justify-center mb-3 mt-4'><img src='${eq.foto.startsWith("img/") ? "static/" + eq.foto : eq.foto}' alt='${eq.nome || ''}' class='object-contain max-h-20 max-w-20 rounded-md shadow'/></div>`;
            } else {
                html += `<div class='w-full h-20 flex items-center justify-center mb-3 mt-4 bg-gray-100 dark:bg-gray-700 rounded-md'><i class='fas fa-image text-2xl text-gray-300 dark:text-gray-600'></i></div>`;
            }
            // Destacar termo de busca no nome
            const nomeDestacado = termoBusca && eq.nome ? 
                eq.nome.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                (eq.nome || '');
            
            html += `<div class='font-semibold text-lg text-indigo-700 dark:text-indigo-300 mb-1 text-center'>${nomeDestacado}</div>`;
            html += `<div class='text-sm text-gray-700 dark:text-gray-200 space-y-1 flex-grow'>`;
            
            // Destacar termo de busca na sala
            const nomeSala = salaIdStr && salasMap[salaIdStr] ? salasMap[salaIdStr] : (eq.sala_id ? eq.sala_id : 'Sem sala');
            const salaDestacada = termoBusca && nomeSala ? 
                nomeSala.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                nomeSala;
            html += `<div><b>Sala:</b> <span class='font-normal'>${salaDestacada}</span></div>`;
            html += `<div><b>Status:</b> <span class='font-normal ${isDefeito ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}'>${isDefeito ? 'Defeito' : 'Funcionando'}</span></div>`;
            
            // Destacar termo de busca no tipo
            const tipoDestacado = termoBusca && eq.tipo ? 
                eq.tipo.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                (eq.tipo || '');
            html += `<div><b>Tipo:</b> <span class='font-normal'>${tipoDestacado}</span></div>`;
            
            // Destacar termo de busca na marca
            const marcaDestacada = termoBusca && eq.marca ? 
                eq.marca.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                (eq.marca || '');
            html += `<div><b>Marca:</b> <span class='font-normal'>${marcaDestacada}</span></div>`;
            
            // Destacar termo de busca na s√©rie
            const serieDestacada = termoBusca && eq.dados?.serie ? 
                eq.dados.serie.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                (eq.dados?.serie || '');
            html += `<div><b>S√©rie:</b> <span class='font-normal'>${serieDestacada}</span></div>`;
            
            // Destacar termo de busca na descri√ß√£o
            const descricaoDestacada = termoBusca && eq.descricao ? 
                eq.descricao.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                (eq.descricao || '');
            html += `<div><b>Descri√ß√£o:</b> <span class='font-normal'>${descricaoDestacada}</span></div>`;
            html += `</div>`;
            if (eq.icone) {
                html += `<div class='w-full h-8 flex items-center justify-center mb-2'><img src='${eq.icone.startsWith("img/") ? "static/" + eq.icone : eq.icone}' alt='√≠cone' class='max-h-8 object-contain'></div>`;
            }
            html += `<button class='defeito-btn mt-3 bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-700 dark:hover:bg-indigo-800 text-white px-4 py-2 rounded-lg transition-colors flex items-center justify-center gap-2' data-id='${eq.id}' data-defeito='${isDefeito ? 1 : 0}'><i class='fas fa-exchange-alt'></i> Mudar status</button>`;
            html += `</div>`;
        });
        html += `</div>`;
        container.innerHTML = html;
        renderizarResumo(equipamentos);
        document.querySelectorAll('.defeito-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const defeitoAtual = this.getAttribute('data-defeito') === '1';
                const novoStatus = !defeitoAtual;
                const pergunta = defeitoAtual
                    ? 'Deseja marcar este equipamento como FUNCIONANDO?'
                    : 'Deseja marcar este equipamento como DEFEITO?';
                if (confirm(pergunta)) {
                    fetch(`/equipamento-defeito/${id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ defeito: novoStatus })
                    }).then(() => carregarEquipamentos());
                }
            });
        });
    }
    document.addEventListener('DOMContentLoaded', function() {
        const filtro = document.getElementById('filtroEquipamento');
        filtro.addEventListener('input', function() {
            const termo = filtro.value.trim().toLowerCase();
            // Aplicar filtro de texto sobre o filtro de tipo ativo
            let equipamentosParaFiltrar = equipamentos;
            if (filtroAtivo && filtroAtivo !== 'total') {
                equipamentosParaFiltrar = equipamentos.filter(eq => eq.tipo === filtroAtivo);
            }
            
            const filtrados = termo ? equipamentosParaFiltrar.filter(eq => {
                // Busca por nome do equipamento
                const nomeMatch = (eq.nome || '').toLowerCase().includes(termo);
                
                // Busca por tipo
                const tipoMatch = (eq.tipo || '').toLowerCase().includes(termo);
                
                // Busca por marca
                const marcaMatch = (eq.marca || '').toLowerCase().includes(termo);
                
                // Busca por n√∫mero de s√©rie
                const serieMatch = (eq.dados?.serie || '').toLowerCase().includes(termo);
                
                // Busca por nome da sala
                const salaIdStr = eq.sala_id !== undefined && eq.sala_id !== null ? String(eq.sala_id) : null;
                const nomeSala = salaIdStr && salasMap[salaIdStr] ? salasMap[salaIdStr] : '';
                const salaMatch = nomeSala.toLowerCase().includes(termo);
                
                // Busca por descri√ß√£o
                const descricaoMatch = (eq.descricao || '').toLowerCase().includes(termo);
                
                return nomeMatch || tipoMatch || marcaMatch || serieMatch || salaMatch || descricaoMatch;
            }) : equipamentosParaFiltrar;
            
            renderizarEquipamentos(filtrados);
            atualizarIndicadorFiltro();
            atualizarIndicadorResultados(filtrados, termo);
        });
        fetch('/empresa_atual')
            .then(resp => resp.json())
            .then(data => {
                LogoManager.loadEmpresaLogo(data);
            });
    });
    function voltarPainelConfig() {
        fetch('/perfil').then(resp => resp.json()).then(perfil => {
            if (perfil.nivel === 'admin') {
                window.location.href = 'config-admin.html';
            } else if (perfil.nivel === 'tecnico') {
                window.location.href = 'config-tecnico.html';
            } else {
                window.location.href = 'config-usuario.html';
            }
        });
    }
    </script>
    <script src="static/js/logo-manager.js"></script>
    </body>
</html>
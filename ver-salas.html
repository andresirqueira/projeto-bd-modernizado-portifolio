<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Visualizar Salas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
        // Atualizar logo da empresa quando o tema mudar
        updateEmpresaLogo();
      }
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
</head>
<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
    <div class="relative w-full max-w-6xl mx-auto bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-8 mt-8">
        <button onclick="voltarPainelConfig()" class="absolute top-4 left-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-2 transition-colors" title="Voltar">
            <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="empresa-logada" class="absolute top-4 right-4 text-indigo-500 font-bold bg-gray-800 dark:bg-transparent rounded-lg p-2"></div>
        <button onclick="toggleDarkMode()" class="absolute top-4 left-16 bg-gray-200 dark:bg-gray-700 rounded-full p-2 transition-colors" title="Alternar modo escuro">
            <span class="dark:hidden">üåô</span><span class="hidden dark:inline">‚òÄÔ∏è</span>
        </button>
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white text-center mb-8">Visualizar Salas</h1>
        <div class="flex flex-col gap-4 mb-6">
            <input id="filtroSala" type="text" class="px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white w-full max-w-md mx-auto" placeholder="Filtrar por nome da sala...">
            <div id="cardsSalasContainer" class="flex flex-wrap gap-6 justify-center"></div>
        </div>
    </div>
    <script>
    // Fun√ß√£o para buscar equipamentos de uma sala
    async function buscarEquipamentosSala(salaId) {
        const resp = await fetch(`/equipamentos?sala_id=${salaId}`);
        if (!resp.ok) return [];
        return await resp.json();
    }

    // Renderiza a lista de equipamentos dentro do card
    function renderEquipamentos(equipamentos) {
        if (!equipamentos.length) {
            return `<div class='bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-300 rounded-md p-3 mt-2 text-center'>Nenhum equipamento vinculado.</div>`;
        }
        let html = `<div class='flex flex-col gap-2 mt-2'>`;
        equipamentos.forEach(eq => {
            html += `<div class='flex items-center gap-3 bg-gray-100 dark:bg-gray-800 rounded-lg p-3 shadow'>`;
            if (eq.icone) html += `<img src='${eq.icone.startsWith('img/') ? 'static/' + eq.icone : eq.icone}' class='rounded object-cover w-8 h-8'>`;
            html += `<div class='flex-1'>`;
            html += `<b class='text-gray-800 dark:text-white'>${eq.nome || 'Equipamento'}</b> <span class='text-teal-400'>${eq.tipo || ''}</span>`;
            html += `<div class='text-sm text-gray-500 dark:text-gray-300'>${eq.marca || ''} ${eq.modelo || ''}</div>`;
            html += `</div>`;
            html += `<span class='text-xs px-3 py-1 rounded-full ${eq.defeito === 1 || eq.defeito === true ? 'bg-red-500 text-white' : 'bg-green-400 text-gray-800'}'>${eq.defeito === 1 || eq.defeito === true ? 'Defeito' : 'Funcionando'}</span>`;
            html += `</div>`;
        });
        html += `</div>`;
        return html;
    }

    // Renderiza todos os cards de sala
    function renderCardsSalas(salas) {
        const container = document.getElementById('cardsSalasContainer');
        let html = '';
        salas.forEach(sala => {
            const cardId = `equipamentos_sala_${sala.id}`;
            html += `<div class='bg-gray-100 dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center w-72 min-h-[220px] mb-4'>`;
            if (sala.foto) {
                html += `<div class='mb-3'><img src='${sala.foto.startsWith('img/') ? 'static/' + sala.foto : sala.foto}' alt='${sala.nome || ''}' class='rounded-md object-cover max-w-[180px] max-h-[90px]'></div>`;
            }
            html += `<div class='font-bold text-lg text-gray-800 dark:text-white mb-2 text-center'>${sala.nome || ''}</div>`;
            html += `<div class='flex gap-2 mb-2'>`;
            html += `<button onclick='window.location.href="detalhes-sala.html?id=${sala.id}"' class='bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-2 rounded-lg shadow flex items-center gap-2 transition-colors text-sm'><i class='fas fa-eye'></i> Ver Detalhes</button>`;
            html += `<button class='btn-equipamentos bg-teal-500 hover:bg-teal-600 text-white font-semibold py-1 px-2 rounded-lg shadow flex items-center gap-2 transition-colors text-sm' data-sala='${sala.id}' type='button'><i class='fas fa-plug'></i> <span id='labelBtn${sala.id}'>Mostrar Equipamentos</span></button>`;
            html += `</div>`;
            html += `<div id='equipamentos_sala_${sala.id}' style='display:none;'></div>`;
            html += `</div>`;
        });
        container.innerHTML = html;

        // Adiciona eventos aos bot√µes de mostrar/ocultar equipamentos
        document.querySelectorAll('.btn-equipamentos').forEach(btn => {
            btn.addEventListener('click', async function(e) {
                e.stopPropagation();
                const salaId = this.getAttribute('data-sala');
                const cardId = `equipamentos_sala_${salaId}`;
                const divEquip = document.getElementById(cardId);
                const labelBtn = document.getElementById('labelBtn'+salaId);
                if (divEquip.style.display === 'none') {
                    divEquip.innerHTML = `<div class='text-gray-400 dark:text-gray-500 py-2'>Carregando...</div>`;
                    divEquip.style.display = 'block';
                    const equipamentos = await buscarEquipamentosSala(salaId);
                    divEquip.innerHTML = renderEquipamentos(equipamentos);
                    labelBtn.innerText = 'Ocultar Equipamentos';
                } else {
                    divEquip.style.display = 'none';
                    labelBtn.innerText = 'Mostrar Equipamentos';
                }
            });
        });
    }

    let todasSalas = [];
    // Carrega as salas e renderiza os cards
    function carregarSalas() {
        fetch('/salas')
            .then(resp => resp.json())
            .then(salas => {
                todasSalas = salas;
                renderCardsSalas(salas);
            });
    }
    // Filtro em tempo real
    document.addEventListener('DOMContentLoaded', function() {
        const filtro = document.getElementById('filtroSala');
        filtro.addEventListener('input', function() {
            const termo = filtro.value.trim().toLowerCase();
            const filtradas = termo ? todasSalas.filter(s => (s.nome||'').toLowerCase().includes(termo)) : todasSalas;
            renderCardsSalas(filtradas);
        });
    });
    carregarSalas();

    function voltarPainelConfig() {
        fetch('/perfil').then(resp => resp.json()).then(perfil => {
            if (perfil.nivel === 'admin') {
                window.location.href = 'config-admin.html';
            } else if (perfil.nivel === 'tecnico') {
                window.location.href = 'config-tecnico.html';
            } else {
                window.location.href = 'config-usuario.html';
            }
        });
    }

    window.addEventListener('DOMContentLoaded', function() {
        fetch('/empresa_atual')
            .then(resp => resp.json())
            .then(data => {
                LogoManager.loadEmpresaLogo(data);
            });
    });
    </script>
    <script src="static/js/logo-manager.js"></script>
    </body>
</html> 
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Ver Salas</title>
    <link rel="icon" type="image/png" href="static/img/favicon-olho.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="static/css/tour.css">
    <script src="static/js/demo-banner.js"></script>
    <script src="static/js/tour.js"></script>
    <script>
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
        // Atualizar logo da empresa quando o tema mudar
        updateEmpresaLogo();
      }
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
</head>
<body class="bg-gradient-to-br from-indigo-400 to-purple-600 min-h-screen dark:bg-gradient-to-br dark:from-gray-900 dark:to-gray-800">
    <div class="relative w-full max-w-6xl mx-auto bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-8 mt-8">
        <button onclick="voltarPainelConfig()" class="absolute top-4 left-4 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full p-2 transition-colors" title="Voltar">
            <i class="fas fa-arrow-left text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="empresa-logada" class="absolute top-4 right-4 text-indigo-500 font-bold bg-gray-800 dark:bg-transparent rounded-lg p-2"></div>
        <button onclick="toggleDarkMode()" class="absolute top-4 left-16 bg-gray-200 dark:bg-gray-700 rounded-full p-2 transition-colors" title="Alternar modo escuro">
            <span class="dark:hidden">üåô</span><span class="hidden dark:inline">‚òÄÔ∏è</span>
        </button>
        <button onclick="iniciarTour()" class="absolute top-4 left-28 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 rounded-full p-2 transition-colors" title="Ajuda - Iniciar tour da p√°gina">
            <i class="fas fa-question text-sm"></i>
        </button>
        <div class="text-center mt-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">
                <i class="fas fa-eye text-indigo-600 dark:text-indigo-400 mr-3"></i>
                Visualizar Salas
            </h1>
            <p class="text-gray-600 dark:text-gray-300">Visualize todas as salas cadastradas no sistema</p>
        </div>
        <div class="mb-6 flex flex-wrap gap-4 justify-center" id="resumoSalas"></div>
        <div class="flex flex-col gap-4 mb-6">
            <div class="flex gap-2">
                <div class="relative flex-1 max-w-md mx-auto">
                    <input id="filtroSala" type="text" class="w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white dark:border-gray-600" placeholder="Buscar por nome, tipo, descri√ß√£o...">
                    <div class="absolute right-3 top-2.5 text-gray-400 dark:text-gray-500 text-sm">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                <button onclick="limparBusca()" class="px-3 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded transition-colors text-sm" title="Limpar busca">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-400 text-center">
                <i class="fas fa-info-circle"></i> Dica: Voc√™ pode buscar por nome, tipo, descri√ß√£o ou andar
            </div>
            <div id="resultadosInfo" class="text-xs text-indigo-600 dark:text-indigo-400 text-center font-medium"></div>
            <div id="cardsSalasContainer" class="flex flex-wrap gap-6 justify-center"></div>
        </div>
    </div>
    <!-- Modal Adicionar Sala -->
    <div id="modalAddSala" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;" class="flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-900 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-auto">
            <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">Adicionar Sala</h3>
                <button id="addSala-fechar" class="px-3 py-1.5 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600">Fechar</button>
            </div>
            <form id="formAddSala" enctype="multipart/form-data" class="p-4 grid grid-cols-1 gap-3">
                <label class="text-gray-700 dark:text-white">Nome da Sala:</label>
                <input type="text" name="nome" required class="px-3 py-2 rounded border dark:bg-gray-800 dark:text-white dark:border-gray-600">
                <label class="text-gray-700 dark:text-white">Tipo:</label>
                <input type="text" name="tipo" class="px-3 py-2 rounded border dark:bg-gray-800 dark:text-white dark:border-gray-600">
                <label class="text-gray-700 dark:text-white">Descri√ß√£o:</label>
                <textarea name="descricao" class="px-3 py-2 rounded border dark:bg-gray-800 dark:text-white dark:border-gray-600"></textarea>
                <div id="addSala-fotoPreview" class="mb-2"></div>
                <label class="text-gray-700 dark:text-white">Escolher imagem j√° enviada:</label>
                <select id="addSala-fotoExistente" name="foto" class="px-3 py-2 rounded border dark:bg-gray-800 dark:text-white dark:border-gray-600 mb-2"></select>
                <div class="mb-2 text-yellow-500 text-sm">
                    Se a foto desejada n√£o estiver aqui, <a href="upload-fotos-salas.html" class="text-blue-400 underline">fa√ßa o upload na tela Upload Fotos</a>.
                </div>
                <label class="text-gray-700 dark:text-white">Andar ID:</label>
                <select name="andar_id" class="px-3 py-2 rounded border dark:bg-gray-800 dark:text-white dark:border-gray-600">
                    <option value="">Selecione...</option>
                    <script>for (let i = 0; i < 200; i++) { document.write(`<option value='${i}'>${i}</option>`); }</script>
                </select>
                <label class="text-gray-700 dark:text-white">Equipamentos em estoque:</label>
                <div class="overflow-x-auto"><div id="addSala-equipTabela" class="mb-2"></div></div>
                <div class="flex justify-end gap-2 mt-2">
                    <span id="addSala-msg" class="mr-auto text-sm"></span>
                    <button type="button" id="addSala-cancelar" class="px-4 py-2 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-white">Cadastrar</button>
                </div>
            </form>
        </div>
    </div>
    <script>
    // Vari√°veis para controle de filtros
    let todasSalas = [];
    let filtroAtivo = null; // Para controlar qual filtro est√° ativo
    
    // Fun√ß√£o para buscar equipamentos de uma sala
    async function buscarEquipamentosSala(salaId) {
        const resp = await fetch(`/equipamentos?sala_id=${salaId}`);
        if (!resp.ok) return [];
        return await resp.json();
    }
    
    // Fun√ß√£o para aplicar filtro por tipo
    function aplicarFiltro(tipo) {
        filtroAtivo = tipo;
        const filtrados = tipo === 'total' ? todasSalas : todasSalas.filter(sala => sala.tipo === tipo);
        renderCardsSalas(filtrados);
        // Limpar o campo de busca quando aplicar filtro por tipo
        document.getElementById('filtroSala').value = '';
        atualizarIndicadorResultados(filtrados, '');
    }
    
    // Fun√ß√£o para limpar busca
    function limparBusca() {
        document.getElementById('filtroSala').value = '';
        filtroAtivo = null;
        renderCardsSalas(todasSalas);
        atualizarIndicadorResultados(todasSalas, '');
    }
    
    // Fun√ß√£o para renderizar resumo das salas
    function renderizarResumo(salas) {
        const resumoDiv = document.getElementById('resumoSalas');
        if (!salas.length) {
            resumoDiv.innerHTML = "<span class='text-gray-400 dark:text-gray-500'>Nenhuma sala encontrada.</span>";
            return;
        }
        // Conta por tipo
        const tipos = {};
        salas.forEach(sala => {
            if (!tipos[sala.tipo]) tipos[sala.tipo] = 0;
            tipos[sala.tipo]++;
        });
        
        // Card Total - sempre clic√°vel
        const totalAtivo = filtroAtivo === 'total' ? 'ring-4 ring-yellow-400' : '';
        let html = `
            <div onclick="aplicarFiltro('total')" class="flex items-center gap-2 bg-indigo-600 dark:bg-indigo-800 text-white px-5 py-2 rounded-lg shadow cursor-pointer hover:bg-indigo-700 dark:hover:bg-indigo-700 transition-colors ${totalAtivo}" title="Mostrar todas as salas">
                <i class="fas fa-building"></i> Total: <b class='ml-1'>${salas.length}</b>
            </div>
        `;
        
        // Se h√° filtro ativo, mostrar apenas o card do tipo selecionado
        if (filtroAtivo && filtroAtivo !== 'total' && tipos[filtroAtivo]) {
            const tipoAtivo = 'ring-4 ring-yellow-400';
            html += `
                <div onclick="aplicarFiltro('${filtroAtivo}')" class="flex items-center gap-2 bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 px-5 py-2 rounded-lg shadow cursor-pointer hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors ${tipoAtivo}" title="Filtrar por ${filtroAtivo}">
                    <i class="fas fa-tag"></i> ${filtroAtivo || 'Sem tipo'}: <b class='ml-1'>${tipos[filtroAtivo]}</b>
                </div>
            `;
        } else {
            // Cards por tipo - clic√°veis (apenas quando n√£o h√° filtro ativo)
            Object.entries(tipos).forEach(([tipo, qtd]) => {
                const tipoAtivo = filtroAtivo === tipo ? 'ring-4 ring-yellow-400' : '';
                html += `
                    <div onclick="aplicarFiltro('${tipo}')" class="flex items-center gap-2 bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 px-5 py-2 rounded-lg shadow cursor-pointer hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors ${tipoAtivo}" title="Filtrar por ${tipo}">
                        <i class="fas fa-tag"></i> ${tipo || 'Sem tipo'}: <b class='ml-1'>${qtd}</b>
                    </div>
                `;
            });
        }
        resumoDiv.innerHTML = html;
    }
    
    // Fun√ß√£o para atualizar indicador de resultados
    function atualizarIndicadorResultados(filtrados, termo) {
        const infoDiv = document.getElementById('resultadosInfo');
        if (termo || (filtroAtivo && filtroAtivo !== 'total')) {
            const filtros = [];
            if (termo) filtros.push(`busca: "${termo}"`);
            if (filtroAtivo && filtroAtivo !== 'total') filtros.push(`tipo: ${filtroAtivo}`);
            
            infoDiv.innerHTML = `<i class="fas fa-filter"></i> Filtros: ${filtros.join(', ')} (${filtrados.length} resultado${filtrados.length !== 1 ? 's' : ''})`;
        } else {
            infoDiv.innerHTML = '';
        }
    }

    // Renderiza a lista de equipamentos dentro do card
    function renderEquipamentos(equipamentos) {
        if (!equipamentos.length) {
            return `<div class='bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-300 rounded-md p-3 mt-2 text-center'>Nenhum equipamento vinculado.</div>`;
        }
        let html = `<div class='flex flex-col gap-2 mt-2'>`;
        equipamentos.forEach(eq => {
            html += `<div class='flex items-center gap-3 bg-gray-100 dark:bg-gray-800 rounded-lg p-3 shadow'>`;
            if (eq.icone) html += `<img src='${eq.icone.startsWith('img/') ? 'static/' + eq.icone : eq.icone}' class='rounded object-cover w-8 h-8'>`;
            html += `<div class='flex-1'>`;
            html += `<b class='text-gray-800 dark:text-white'>${eq.nome || 'Equipamento'}</b> <span class='text-teal-400'>${eq.tipo || ''}</span>`;
            html += `<div class='text-sm text-gray-500 dark:text-gray-300'>${eq.marca || ''} ${eq.modelo || ''}</div>`;
            html += `</div>`;
            html += `<span class='text-xs px-3 py-1 rounded-full ${eq.defeito === 1 || eq.defeito === true ? 'bg-red-500 text-white' : 'bg-green-400 text-gray-800'}'>${eq.defeito === 1 || eq.defeito === true ? 'Defeito' : 'Funcionando'}</span>`;
            html += `</div>`;
        });
        html += `</div>`;
        return html;
    }

    // Renderiza todos os cards de sala
    function renderCardsSalas(salas) {
        const container = document.getElementById('cardsSalasContainer');
        const termoBusca = document.getElementById('filtroSala').value.trim().toLowerCase();
        
        let html = '';
        
        // Adicionar card "Adicionar Sala" se o usu√°rio for admin
        const perfil = JSON.parse(localStorage.getItem('perfil') || '{}');
        if (perfil.nivel === 'admin') {
            html += `<div class='bg-gradient-to-br from-green-400 to-green-600 dark:from-green-600 dark:to-green-800 rounded-xl shadow-lg p-6 flex flex-col items-center justify-center w-72 min-h-[220px] mb-4 cursor-pointer hover:from-green-500 hover:to-green-700 dark:hover:from-green-700 dark:hover:to-green-900 transition-all duration-300 transform hover:scale-105' onclick='abrirModalAddSala()' title='Adicionar Nova Sala'>`;
            html += `<div class='text-white text-center'>`;
            html += `<i class='fas fa-plus-circle text-6xl mb-4'></i>`;
            html += `<div class='font-bold text-xl mb-2'>Adicionar Sala</div>`;
            html += `<div class='text-sm opacity-90'>Clique para criar uma nova sala</div>`;
            html += `</div>`;
            html += `</div>`;
        }
        
        salas.forEach(sala => {
            const cardId = `equipamentos_sala_${sala.id}`;
            
            // Destacar termo de busca no nome
            const nomeDestacado = termoBusca && sala.nome ? 
                sala.nome.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                (sala.nome || '');
            
            // Destacar termo de busca no tipo
            const tipoDestacado = termoBusca && sala.tipo ? 
                sala.tipo.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                (sala.tipo || '');
            
            // Destacar termo de busca na descri√ß√£o
            const descricaoDestacada = termoBusca && sala.descricao ? 
                sala.descricao.replace(new RegExp(`(${termoBusca})`, 'gi'), '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>') : 
                (sala.descricao || '');
            
            html += `<div class='bg-gray-100 dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center w-72 min-h-[220px] mb-4'>`;
            if (sala.foto) {
                html += `<div class='mb-3'><img src='${sala.foto.startsWith('img/') ? 'static/' + sala.foto : sala.foto}' alt='${sala.nome || ''}' class='rounded-md object-cover max-w-[180px] max-h-[90px]'></div>`;
            }
            html += `<div class='font-bold text-lg text-gray-800 dark:text-white mb-2 text-center'>${nomeDestacado}</div>`;
            if (sala.tipo) {
                html += `<div class='text-sm text-gray-600 dark:text-gray-300 mb-1'>Tipo: ${tipoDestacado}</div>`;
            }
            if (sala.descricao) {
                html += `<div class='text-sm text-gray-600 dark:text-gray-300 mb-2 text-center'>${descricaoDestacada}</div>`;
            }
            html += `<div class='flex gap-2 mb-2'>`;
            html += `<button onclick='window.location.href="detalhes-sala.html?id=${sala.id}"' class='bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-2 rounded-lg shadow flex items-center gap-2 transition-colors text-sm'><i class='fas fa-eye'></i> Ver Detalhes</button>`;
            html += `<button class='btn-equipamentos bg-teal-500 hover:bg-teal-600 text-white font-semibold py-1 px-2 rounded-lg shadow flex items-center gap-2 transition-colors text-sm' data-sala='${sala.id}' type='button'><i class='fas fa-plug'></i> <span id='labelBtn${sala.id}'>Mostrar Equipamentos</span></button>`;
            html += `</div>`;
            html += `<div id='equipamentos_sala_${sala.id}' style='display:none;'></div>`;
            html += `</div>`;
        });
        container.innerHTML = html;
        renderizarResumo(todasSalas);

        // Adiciona eventos aos bot√µes de mostrar/ocultar equipamentos
        document.querySelectorAll('.btn-equipamentos').forEach(btn => {
            btn.addEventListener('click', async function(e) {
                e.stopPropagation();
                const salaId = this.getAttribute('data-sala');
                const cardId = `equipamentos_sala_${salaId}`;
                const divEquip = document.getElementById(cardId);
                const labelBtn = document.getElementById('labelBtn'+salaId);
                if (divEquip.style.display === 'none') {
                    divEquip.innerHTML = `<div class='text-gray-400 dark:text-gray-500 py-2'>Carregando...</div>`;
                    divEquip.style.display = 'block';
                    const equipamentos = await buscarEquipamentosSala(salaId);
                    divEquip.innerHTML = renderEquipamentos(equipamentos);
                    labelBtn.innerText = 'Ocultar Equipamentos';
                } else {
                    divEquip.style.display = 'none';
                    labelBtn.innerText = 'Mostrar Equipamentos';
                }
            });
        });
    }

    // Carrega as salas e renderiza os cards
    function carregarSalas() {
        fetch('/salas')
            .then(resp => resp.json())
            .then(salas => {
                todasSalas = salas;
                renderCardsSalas(salas);
                renderizarResumo(salas);
            });
    }
    // Filtro de salas avan√ßado
    document.addEventListener('DOMContentLoaded', function() {
        const filtro = document.getElementById('filtroSala');
        filtro.addEventListener('input', function() {
            const termo = this.value.trim().toLowerCase();
            // Aplicar filtro de texto sobre o filtro de tipo ativo
            let salasParaFiltrar = todasSalas;
            if (filtroAtivo && filtroAtivo !== 'total') {
                salasParaFiltrar = todasSalas.filter(sala => sala.tipo === filtroAtivo);
            }
            
            const filtrados = termo ? salasParaFiltrar.filter(sala => {
                // Busca por nome da sala
                const nomeMatch = (sala.nome || '').toLowerCase().includes(termo);
                
                // Busca por tipo
                const tipoMatch = (sala.tipo || '').toLowerCase().includes(termo);
                
                // Busca por descri√ß√£o
                const descricaoMatch = (sala.descricao || '').toLowerCase().includes(termo);
                
                // Busca por andar
                const andarMatch = (sala.andar_id !== null && sala.andar_id !== undefined) ? 
                    String(sala.andar_id).toLowerCase().includes(termo) : false;
                
                return nomeMatch || tipoMatch || descricaoMatch || andarMatch;
            }) : salasParaFiltrar;
            
            renderCardsSalas(filtrados);
            atualizarIndicadorResultados(filtrados, termo);
        });

        // Buscar perfil primeiro e s√≥ ent√£o renderizar as salas
        fetch('/perfil')
            .then(resp => resp.json())
            .then(perfil => {
                localStorage.setItem('perfil', JSON.stringify(perfil));
                carregarSalas();
                // Bind modal Add Sala
                inicializarModalAddSala();
            })
            .catch(() => {
                // Em caso de erro, ainda assim tenta carregar as salas
                carregarSalas();
            });
    });
    // Removido carregarSalas() imediato para evitar condi√ß√£o de corrida com o perfil

    function voltarPainelConfig() {
        fetch('/perfil').then(resp => resp.json()).then(perfil => {
            if (perfil.nivel === 'admin') {
                window.location.href = 'config-admin.html';
            } else if (perfil.nivel === 'tecnico') {
                window.location.href = 'config-tecnico.html';
            } else {
                window.location.href = 'config-usuario.html';
            }
        });
    }

    window.addEventListener('DOMContentLoaded', function() {
        fetch('/empresa_atual')
            .then(resp => resp.json())
            .then(data => {
                LogoManager.loadEmpresaLogo(data);
            });
    });

    // --- Modal Adicionar Sala ---
    function abrirModalAddSala(){
        const m = document.getElementById('modalAddSala');
        if (m) m.style.display = 'flex';
        // limpar
        const f = document.getElementById('formAddSala');
        if (f) f.reset();
        carregarFotosExistentesAddSala();
        carregarEquipSemSalaAddSala();
    }
    function fecharModalAddSala(){ const m = document.getElementById('modalAddSala'); if (m) m.style.display = 'none'; }
    async function carregarFotosExistentesAddSala(){
        const select = document.getElementById('addSala-fotoExistente');
        if (!select) return;
        try {
            const resp = await fetch('/fotos-salas');
            const data = await resp.json();
            select.innerHTML = '<option value="">Nenhuma</option>';
            (data.imagens||[]).forEach(url => { const nome = url.split('/').pop(); select.innerHTML += `<option value="${url}">${nome}</option>`; });
        } catch {}
    }
    async function carregarEquipSemSalaAddSala(){
        const tabelaDiv = document.getElementById('addSala-equipTabela');
        if (!tabelaDiv) return;
        tabelaDiv.innerHTML = '<em>Carregando...</em>';
        const resp = await fetch('/equipamentos-disponiveis');
        const equipamentos = await resp.json();
        if (!equipamentos.length) { tabelaDiv.innerHTML = '<em class="text-gray-600 dark:text-gray-300">Nenhum equipamento dispon√≠vel.</em>'; return; }
        let html = `<table class="tabela-equipamentos" style="min-width:900px;width:100%;border-collapse:collapse;background:#2c3e50;color:#eee;">`+
                   `<thead><tr><th></th><th>Nome</th><th>Tipo</th><th>Marca</th><th>Modelo</th><th>S√©rie</th></tr></thead><tbody>`;
        equipamentos.forEach(eq => {
            const serie = (eq.dados && eq.dados.serie) ? eq.dados.serie : '';
            html += `<tr><td style="text-align:center"><input type='checkbox' value='${eq.id}' class='addSala-eq-cb'></td>`+
                    `<td>${eq.nome||''}</td><td>${eq.tipo||''}</td><td>${eq.marca||''}</td><td>${eq.modelo||''}</td><td>${serie}</td></tr>`;
        });
        html += '</tbody></table>';
        tabelaDiv.innerHTML = html;
    }
    function inicializarModalAddSala(){
        const fechar = document.getElementById('addSala-fechar');
        if (fechar) fechar.onclick = fecharModalAddSala;
        const cancelar = document.getElementById('addSala-cancelar');
        if (cancelar) cancelar.onclick = fecharModalAddSala;
        const form = document.getElementById('formAddSala');
        if (form) form.onsubmit = async function(e){
            e.preventDefault();
            const formData = new FormData(form);
            // equipamentos selecionados
            const selecionados = Array.from(document.querySelectorAll('.addSala-eq-cb:checked')).map(cb => cb.value);
            selecionados.forEach(id => formData.append('equipamentos_ids[]', id));
            const resp = await fetch('/adicionar-sala', { method: 'POST', body: formData });
            const json = await resp.json();
            const msg = document.getElementById('addSala-msg');
            if (json.status === 'ok') {
                msg.textContent = 'Sala cadastrada com sucesso!';
                msg.className = 'text-green-500 font-semibold';
                fecharModalAddSala();
                carregarSalas();
            } else {
                msg.textContent = (json && json.mensagem) || 'Erro ao cadastrar!';
                msg.className = 'text-red-500 font-semibold';
            }
        };
        const selectFoto = document.getElementById('addSala-fotoExistente');
        if (selectFoto) selectFoto.addEventListener('change', function(){
            const url = this.value; const preview = document.getElementById('addSala-fotoPreview');
            if (url) { preview.innerHTML = `<img src='${url}' alt='Foto da sala' style='max-width:180px;max-height:90px;object-fit:cover;border-radius:6px;'>`; }
            else { preview.innerHTML = "<span style='color:#aaa;'>Sem foto cadastrada</span>"; }
        });
    }
    
    // Fun√ß√£o para iniciar o tour da p√°gina
    function iniciarTour() {
        if (window.sistemaTour) {
            window.sistemaTour.iniciarTour('ver-salas');
        } else {
            alert('Sistema de tour n√£o carregado. Recarregue a p√°gina.');
        }
    }
    </script>
    <script src="static/js/logo-manager.js"></script>
    </body>
</html> 
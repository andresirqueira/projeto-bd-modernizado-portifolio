<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link rel="icon" type="image/png" href="static/img/favicon-login.png">
    <script src="https://cdn.tailwindcss.com"></script>    <script src="static/js/demo-banner.js"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <style>
      .horus-bg {
        background: radial-gradient(1200px 600px at 10% 10%, rgba(99,102,241,0.25), transparent 40%),
                    radial-gradient(1000px 500px at 90% 20%, rgba(147,51,234,0.22), transparent 45%),
                    radial-gradient(900px 600px at 20% 90%, rgba(59,130,246,0.18), transparent 50%),
                    linear-gradient(135deg, #0f172a 0%, #111827 40%, #0b1220 100%);
      }
      .horus-blob {
        position: absolute;
        border-radius: 9999px;
        filter: blur(40px);
        opacity: .35;
        mix-blend-mode: screen;
        animation: float 16s ease-in-out infinite;
      }
      .horus-blob:nth-child(2){ animation-duration: 20s; animation-delay: -4s; }
      .horus-blob:nth-child(3){ animation-duration: 22s; animation-delay: -8s; }
      @keyframes float {
        0%, 100% { transform: translateY(0) translateX(0) scale(1); }
        50%      { transform: translateY(-18px) translateX(10px) scale(1.05); }
      }
      /* Hexagon mesh canvas */
      .hex-layer { position: absolute; inset: 0; pointer-events: none; }
      .hex-layer canvas { width: 100%; height: 100%; display: block; }
    </style>
    <script>
      // Dark mode toggle
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
      }
      // Persist theme on load
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
 </head>
<body class="relative min-h-screen flex items-center justify-center overflow-hidden bg-gradient-to-br from-indigo-200 to-purple-200 dark:horus-bg">
    <div aria-hidden="true" class="pointer-events-none absolute inset-0">
        <span class="horus-blob" style="top:-10%; left:-8%; width:340px; height:340px; background: rgba(99,102,241,0.45);"></span>
        <span class="horus-blob" style="top:15%; right:-6%; width:420px; height:420px; background: rgba(147,51,234,0.40);"></span>
        <span class="horus-blob" style="bottom:-12%; left:30%; width:480px; height:480px; background: rgba(59,130,246,0.38);"></span>
    </div>
    <!-- Interactive hexagon mesh -->
    <div class="hex-layer" aria-hidden="true">
        <canvas id="hexMesh"></canvas>
    </div>
    <div class="w-full max-w-md bg-white dark:bg-gray-900 rounded-xl shadow-2xl p-10 text-center relative">
        <button onclick="toggleDarkMode()" class="absolute top-4 right-4 bg-gray-200 dark:bg-gray-700 rounded-full p-2 transition-colors" title="Alternar modo escuro">
            <span class="dark:hidden">🌙</span><span class="hidden dark:inline">☀️</span>
        </button>
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-6">
            <i class="fas fa-sign-in-alt text-indigo-600 dark:text-indigo-400 mr-3"></i>
            Login
        </h1>
        <form id="login-form" autocomplete="off" class="flex flex-col gap-4">
            <label for="username" class="text-left text-gray-700 dark:text-gray-200">Usuário:</label>
            <input type="text" id="username" name="username" required class="input-login px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white">
            <label for="password" class="text-left text-gray-700 dark:text-gray-200">Senha:</label>
            <input type="password" id="password" name="password" required class="input-login px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white">
            <button type="submit" id="btn-login" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 rounded-lg shadow transition-colors mt-4">OK</button>
        </form>
        <div id="empresa-select-container" style="display:none;" class="mt-6">
            <label for="empresaSelect" class="text-gray-700 dark:text-gray-200">Escolha a empresa:</label>
            <select id="empresaSelect" class="input-login px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:text-white mt-2"></select>
            <button id="btn-empresa" onclick="confirmarEmpresa()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 rounded-lg shadow transition-colors mt-2">Acessar</button>
        </div>
        <div id="msg-erro" class="text-red-600 mt-4"></div>
    </div>
    <script>
        // Hexagon interactive background (dark mode)
        (function(){
            const canvas = document.getElementById('hexMesh');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            let width, height, dpr, hexR, grid = [], mouse = {x:-9999,y:-9999};

            function setSize(){
                dpr = Math.min(window.devicePixelRatio || 1, 2);
                width = canvas.clientWidth;
                height = canvas.clientHeight;
                canvas.width = Math.floor(width * dpr);
                canvas.height = Math.floor(height * dpr);
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                buildGrid();
            }

            function buildGrid(){
                grid = [];
                // target approximately fixed visual size across breakpoints
                const targetCols = Math.max(18, Math.round(width / 64));
                const stepX = width / targetCols;
                hexR = stepX * 0.6667;            // 2/3 of stepX to get tight honeycomb
                const hexH = Math.sqrt(3) * hexR / 2;
                const stepCol = hexR * 1.5;       // horizontal distance between centers
                const stepRow = hexH * 2;         // vertical distance between centers
                const cols = Math.ceil(width / stepCol) + 3;
                const rows = Math.ceil(height / stepRow) + 3;
                for(let r=0; r<rows; r++){
                    const offsetX = (r % 2) ? hexR * 0.75 : 0; // perfect staggering
                    for(let c=0; c<cols; c++){
                        const x = c * stepCol + offsetX - hexR;
                        const y = r * stepRow - hexH;
                        grid.push({x, y, off: Math.random()*Math.PI*2});
                    }
                }
            }

            function drawHex(cx, cy, r, color, alpha, lineW){
                ctx.globalAlpha = alpha;
                ctx.beginPath();
                for(let i=0;i<6;i++){
                    const a = (Math.PI/3)*i + Math.PI/6; // flat-top
                    const x = cx + r * Math.cos(a);
                    const y = cy + r * Math.sin(a);
                    if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.strokeStyle = color;
                ctx.lineWidth = lineW;
                ctx.stroke();
                ctx.globalAlpha = 1;
            }

            function dist2(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return dx*dx+dy*dy; }

            function animate(t){
                const isDark = document.documentElement.classList.contains('dark');

                ctx.clearRect(0,0,width,height);
                const base = isDark ? '#64748b' : '#94a3b8'; // slate-500/400
                const glow = isDark ? '#818cf8' : '#6366f1'; // indigo accent
                const baseAlpha = isDark ? 0.28 : 0.55;      // ensure always visible in light
                const boost = isDark ? 0.35 : 0.25;          // hover boost
                const lineW = isDark ? 1.2 : 1.4;
                const hoverR = 140; const hoverR2 = hoverR*hoverR;

                for(const cell of grid){
                    const dx = Math.cos(t*0.00015 + cell.off) * 1.5;
                    const dy = Math.sin(t*0.00012 + cell.off) * 1.5;
                    const px = cell.x + dx;
                    const py = cell.y + dy;
                    const d2 = dist2({x:px,y:py}, mouse);
                    const near = d2 < hoverR2;
                    const k = near ? 1 - (d2/hoverR2) : 0;
                    const r = hexR * (0.86 + k*0.18);        // subtle size pulse near cursor
                    const alpha = baseAlpha + k*boost;        // always visible + hover glow
                    const color = near ? glow : base;
                    drawHex(px, py, r, color, alpha, lineW);
                }
                requestAnimationFrame(animate);
            }

            window.addEventListener('resize', setSize);
            window.addEventListener('mousemove', (e)=>{
                const rect = canvas.getBoundingClientRect();
                mouse.x = (e.clientX - rect.left);
                mouse.y = (e.clientY - rect.top);
            }, {passive:true});
            window.addEventListener('mouseleave', ()=>{ mouse.x=-9999; mouse.y=-9999; }, {passive:true});
            setSize();
            requestAnimationFrame(animate);
        })();

        let empresasGlobais = [];
        document.getElementById('login-form').onsubmit = async function(event) {
            event.preventDefault();
            document.getElementById('msg-erro').innerText = '';
            const dados = {
                username: document.getElementById('username').value,
                senha: document.getElementById('password').value
            };
            const resp = await fetch('/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(dados)
            });
            const json = await resp.json();
            if(json.status === 'ok') {
                if (json.redirect) {
                    window.location.href = json.redirect;
                    return;
                }
                empresasGlobais = json.empresas;
                if (empresasGlobais.length === 1) {
                    escolherEmpresa(empresasGlobais[0].db_file);
                } else {
                    mostrarSelecaoEmpresas(empresasGlobais);
                }
            } else {
                document.getElementById('msg-erro').innerText = json.mensagem || 'Usuário ou senha inválidos!';
            }
        };
        function mostrarSelecaoEmpresas(empresas) {
            document.getElementById('login-form').style.display = 'none';
            const select = document.getElementById('empresaSelect');
            select.innerHTML = '';
            empresas.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.db_file;
                opt.textContent = e.nome;
                select.appendChild(opt);
            });
            document.getElementById('empresa-select-container').style.display = 'block';
        }
        function confirmarEmpresa() {
            const db_file = document.getElementById('empresaSelect').value;
            escolherEmpresa(db_file);
        }
        function escolherEmpresa(db_file) {
            fetch('/escolher_empresa', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({db_file})
            })
            .then(resp => resp.json())
            .then(data => {
                if (data.status === 'ok') {
                    window.location.href = data.redirect;
                } else {
                    document.getElementById('msg-erro').innerText = 'Erro ao escolher empresa';
                }
            });
        }
    </script>
</body>
</html>
